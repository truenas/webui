584f61e63588f055f9509e0516bf85b0
"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const testbed_1 = require("@angular/cdk/testing/testbed");
const testing_1 = require("@angular/material/button/testing");
const jest_1 = require("@ngneat/spectator/jest");
const ng_mocks_1 = require("ng-mocks");
const rxjs_1 = require("rxjs");
const mock_websocket_utils_1 = require("app/core/testing/utils/mock-websocket.utils");
const _2fa_1 = require("app/helptext/system/2fa");
const dialog_service_1 = require("app/modules/dialog/dialog.service");
const ix_warning_component_1 = require("app/modules/forms/ix-forms/components/ix-warning/ix-warning.component");
const qr_viewer_component_1 = require("app/pages/two-factor-auth/components/two-factor/qr-viewer/qr-viewer.component");
const two_factor_component_1 = require("app/pages/two-factor-auth/components/two-factor/two-factor.component");
const auth_service_1 = require("app/services/auth/auth.service");
const ws_service_1 = require("app/services/ws.service");
describe('TwoFactorComponent', () => {
    let spectator;
    let loader;
    let ws;
    const createComponent = (0, jest_1.createComponentFactory)({
        component: two_factor_component_1.TwoFactorComponent,
        declarations: [
            (0, ng_mocks_1.MockComponent)(ix_warning_component_1.IxWarningComponent),
            (0, ng_mocks_1.MockComponent)(qr_viewer_component_1.QrViewerComponent),
        ],
        providers: [
            (0, jest_1.mockProvider)(dialog_service_1.DialogService, {
                confirm: jest.fn(() => (0, rxjs_1.of)(true)),
            }),
            (0, mock_websocket_utils_1.mockWebSocket)([
                (0, mock_websocket_utils_1.mockCall)('user.renew_2fa_secret'),
            ]),
            (0, jest_1.mockProvider)(auth_service_1.AuthService, {
                user$: (0, rxjs_1.of)({
                    pw_name: 'dummy',
                    two_factor_config: {
                        secret_configured: true,
                    },
                }),
                userTwoFactorConfig$: (0, rxjs_1.of)({
                    provisioning_uri: 'somepath://here/iXsystems:first-test?secret=KYC',
                    interval: 30,
                    otp_digits: 6,
                    secret_configured: true,
                }),
                getGlobalTwoFactorConfig: jest.fn(() => (0, rxjs_1.of)({ enabled: false })),
            }),
        ],
    });
    beforeEach(() => {
        spectator = createComponent();
        loader = testbed_1.TestbedHarnessEnvironment.loader(spectator.fixture);
        ws = spectator.inject(ws_service_1.WebSocketService);
    });
    it('shows warning when global setting is disabled', () => {
        jest.spyOn(spectator.inject(auth_service_1.AuthService), 'getGlobalTwoFactorConfig').mockImplementation(() => (0, rxjs_1.of)({
            enabled: true,
        }));
        const warning = spectator.query(ix_warning_component_1.IxWarningComponent);
        expect(warning).toBeTruthy();
        expect(warning).toHaveAttribute('message', _2fa_1.helptext2fa.two_factor.global_disabled);
    });
    it('shows warning when global setting is enabled but user disabled', () => {
        spectator.component.ngOnInit();
        spectator.component.userTwoFactorAuthConfigured = false;
        spectator.detectChanges();
        const warning = spectator.query(ix_warning_component_1.IxWarningComponent);
        expect(warning).toBeTruthy();
        expect(warning).toHaveAttribute('message', _2fa_1.helptext2fa.two_factor.global_enabled_user_disabled);
    });
    it('shows warning when global setting is enabled and user enabled', () => {
        spectator.component.ngOnInit();
        spectator.detectChanges();
        const warning = spectator.query(ix_warning_component_1.IxWarningComponent);
        expect(warning).toBeTruthy();
        expect(warning).toHaveAttribute('message', _2fa_1.helptext2fa.two_factor.global_enabled_user_enabled);
    });
    it('renews secret when button is clicked', () => __awaiter(void 0, void 0, void 0, function* () {
        const renewBtn = yield loader.getHarness(testing_1.MatButtonHarness.with({ text: 'Renew 2FA Secret' }));
        yield renewBtn.click();
        expect(spectator.inject(dialog_service_1.DialogService).confirm).toHaveBeenCalledWith({
            title: _2fa_1.helptext2fa.two_factor.renewSecret.title,
            message: _2fa_1.helptext2fa.two_factor.renewSecret.message,
            hideCheckbox: true,
            buttonText: _2fa_1.helptext2fa.two_factor.renewSecret.btn,
        });
        expect(ws.call).toHaveBeenCalledWith('user.renew_2fa_secret', ['dummy', {
                interval: 30,
                otp_digits: 6,
            }]);
    }));
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21hY2Jvb2sva2FycG92LXdvcmsvVHJ1ZU5BUy93ZWJ1aS9zcmMvYXBwL3BhZ2VzL3R3by1mYWN0b3ItYXV0aC9jb21wb25lbnRzL3R3by1mYWN0b3IvdHdvLWZhY3Rvci5jb21wb25lbnQuc3BlYy50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUNBLDBEQUF5RTtBQUN6RSw4REFBb0U7QUFDcEUsaURBQXlGO0FBQ3pGLHVDQUF5QztBQUN6QywrQkFBMEI7QUFDMUIsc0ZBQXNGO0FBQ3RGLGtEQUFzRDtBQUd0RCxzRUFBa0U7QUFDbEUsZ0hBQTJHO0FBQzNHLHVIQUFrSDtBQUNsSCwrR0FBMEc7QUFDMUcsaUVBQTZEO0FBQzdELHdEQUEyRDtBQUUzRCxRQUFRLENBQUMsb0JBQW9CLEVBQUUsR0FBRyxFQUFFO0lBQ2xDLElBQUksU0FBd0MsQ0FBQztJQUM3QyxJQUFJLE1BQXFCLENBQUM7SUFDMUIsSUFBSSxFQUFvQixDQUFDO0lBRXpCLE1BQU0sZUFBZSxHQUFHLElBQUEsNkJBQXNCLEVBQUM7UUFDN0MsU0FBUyxFQUFFLHlDQUFrQjtRQUM3QixZQUFZLEVBQUU7WUFDWixJQUFBLHdCQUFhLEVBQUMseUNBQWtCLENBQUM7WUFDakMsSUFBQSx3QkFBYSxFQUFDLHVDQUFpQixDQUFDO1NBQ2pDO1FBQ0QsU0FBUyxFQUFFO1lBQ1QsSUFBQSxtQkFBWSxFQUFDLDhCQUFhLEVBQUU7Z0JBQzFCLE9BQU8sRUFBRSxJQUFJLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUEsU0FBRSxFQUFDLElBQUksQ0FBQyxDQUFDO2FBQ2pDLENBQUM7WUFDRixJQUFBLG9DQUFhLEVBQUM7Z0JBQ1osSUFBQSwrQkFBUSxFQUFDLHVCQUF1QixDQUFDO2FBQ2xDLENBQUM7WUFDRixJQUFBLG1CQUFZLEVBQUMsMEJBQVcsRUFBRTtnQkFDeEIsS0FBSyxFQUFFLElBQUEsU0FBRSxFQUFDO29CQUNSLE9BQU8sRUFBRSxPQUFPO29CQUNoQixpQkFBaUIsRUFBRTt3QkFDakIsaUJBQWlC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QVMsQ0FBQyxNQUFNLENBQUMsOEJBQWEsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLG9CQUFvQixDQUFDO1lBQ25FLEtBQUssRUFBRSxrQkFBVyxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsS0FBSztZQUMvQyxPQUFPLEVBQUUsa0JBQVcsQ0FBQyxVQUFVLENBQUMsV0FBVyxDQUFDLE9BQU87WUFDbkQsWUFBWSxFQUFFLElBQUk7WUFDbEIsVUFBVSxFQUFFLGtCQUFXLENBQUMsVUFBVSxDQUFDLFdBQVcsQ0FBQyxHQUFHO1NBQ25ELENBQUMsQ0FBQztRQUVILE1BQU0sQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsb0JBQW9CLENBQUMsdUJBQXVCLEVBQUUsQ0FBQyxPQUFPLEVBQUU7Z0JBQ3RFLFFBQVEsRUFBRSxFQUFFO2dCQUNaLFVBQVUsRUFBRSxDQUFDO2FBQ2QsQ0FBQyxDQUFDLENBQUM7SUFDTixDQUFDLENBQUEsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL21hY2Jvb2sva2FycG92LXdvcmsvVHJ1ZU5BUy93ZWJ1aS9zcmMvYXBwL3BhZ2VzL3R3by1mYWN0b3ItYXV0aC9jb21wb25lbnRzL3R3by1mYWN0b3IvdHdvLWZhY3Rvci5jb21wb25lbnQuc3BlYy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBIYXJuZXNzTG9hZGVyIH0gZnJvbSAnQGFuZ3VsYXIvY2RrL3Rlc3RpbmcnO1xuaW1wb3J0IHsgVGVzdGJlZEhhcm5lc3NFbnZpcm9ubWVudCB9IGZyb20gJ0Bhbmd1bGFyL2Nkay90ZXN0aW5nL3Rlc3RiZWQnO1xuaW1wb3J0IHsgTWF0QnV0dG9uSGFybmVzcyB9IGZyb20gJ0Bhbmd1bGFyL21hdGVyaWFsL2J1dHRvbi90ZXN0aW5nJztcbmltcG9ydCB7IFNwZWN0YXRvciwgY3JlYXRlQ29tcG9uZW50RmFjdG9yeSwgbW9ja1Byb3ZpZGVyIH0gZnJvbSAnQG5nbmVhdC9zcGVjdGF0b3IvamVzdCc7XG5pbXBvcnQgeyBNb2NrQ29tcG9uZW50IH0gZnJvbSAnbmctbW9ja3MnO1xuaW1wb3J0IHsgb2YgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IG1vY2tDYWxsLCBtb2NrV2ViU29ja2V0IH0gZnJvbSAnYXBwL2NvcmUvdGVzdGluZy91dGlscy9tb2NrLXdlYnNvY2tldC51dGlscyc7XG5pbXBvcnQgeyBoZWxwdGV4dDJmYSB9IGZyb20gJ2FwcC9oZWxwdGV4dC9zeXN0ZW0vMmZhJztcbmltcG9ydCB7IExvZ2dlZEluVXNlciB9IGZyb20gJ2FwcC9pbnRlcmZhY2VzL2RzLWNhY2hlLmludGVyZmFjZSc7XG5pbXBvcnQgeyBHbG9iYWxUd29GYWN0b3JDb25maWcsIFVzZXJUd29GYWN0b3JDb25maWcgfSBmcm9tICdhcHAvaW50ZXJmYWNlcy90d28tZmFjdG9yLWNvbmZpZy5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgRGlhbG9nU2VydmljZSB9IGZyb20gJ2FwcC9tb2R1bGVzL2RpYWxvZy9kaWFsb2cuc2VydmljZSc7XG5pbXBvcnQgeyBJeFdhcm5pbmdDb21wb25lbnQgfSBmcm9tICdhcHAvbW9kdWxlcy9mb3Jtcy9peC1mb3Jtcy9jb21wb25lbnRzL2l4LXdhcm5pbmcvaXgtd2FybmluZy5jb21wb25lbnQnO1xuaW1wb3J0IHsgUXJWaWV3ZXJDb21wb25lbnQgfSBmcm9tICdhcHAvcGFnZXMvdHdvLWZhY3Rvci1hdXRoL2NvbXBvbmVudHMvdHdvLWZhY3Rvci9xci12aWV3ZXIvcXItdmlld2VyLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBUd29GYWN0b3JDb21wb25lbnQgfSBmcm9tICdhcHAvcGFnZXMvdHdvLWZhY3Rvci1hdXRoL2NvbXBvbmVudHMvdHdvLWZhY3Rvci90d28tZmFjdG9yLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBBdXRoU2VydmljZSB9IGZyb20gJ2FwcC9zZXJ2aWNlcy9hdXRoL2F1dGguc2VydmljZSc7XG5pbXBvcnQgeyBXZWJTb2NrZXRTZXJ2aWNlIH0gZnJvbSAnYXBwL3NlcnZpY2VzL3dzLnNlcnZpY2UnO1xuXG5kZXNjcmliZSgnVHdvRmFjdG9yQ29tcG9uZW50JywgKCkgPT4ge1xuICBsZXQgc3BlY3RhdG9yOiBTcGVjdGF0b3I8VHdvRmFjdG9yQ29tcG9uZW50PjtcbiAgbGV0IGxvYWRlcjogSGFybmVzc0xvYWRlcjtcbiAgbGV0IHdzOiBXZWJTb2NrZXRTZXJ2aWNlO1xuXG4gIGNvbnN0IGNyZWF0ZUNvbXBvbmVudCA9IGNyZWF0ZUNvbXBvbmVudEZhY3Rvcnkoe1xuICAgIGNvbXBvbmVudDogVHdvRmFjdG9yQ29tcG9uZW50LFxuICAgIGRlY2xhcmF0aW9uczogW1xuICAgICAgTW9ja0NvbXBvbmVudChJeFdhcm5pbmdDb21wb25lbnQpLFxuICAgICAgTW9ja0NvbXBvbmVudChRclZpZXdlckNvbXBvbmVudCksXG4gICAgXSxcbiAgICBwcm92aWRlcnM6IFtcbiAgICAgIG1vY2tQcm92aWRlcihEaWFsb2dTZXJ2aWNlLCB7XG4gICAgICAgIGNvbmZpcm06IGplc3QuZm4oKCkgPT4gb2YodHJ1ZSkpLFxuICAgICAgfSksXG4gICAgICBtb2NrV2ViU29ja2V0KFtcbiAgICAgICAgbW9ja0NhbGwoJ3VzZXIucmVuZXdfMmZhX3NlY3JldCcpLFxuICAgICAgXSksXG4gICAgICBtb2NrUHJvdmlkZXIoQXV0aFNlcnZpY2UsIHtcbiAgICAgICAgdXNlciQ6IG9mKHtcbiAgICAgICAgICBwd19uYW1lOiAnZHVtbXknLFxuICAgICAgICAgIHR3b19mYWN0b3JfY29uZmlnOiB7XG4gICAgICAgICAgICBzZWNyZXRfY29uZmlndXJlZDogdHJ1ZSxcbiAgICAgICAgICB9LFxuICAgICAgICB9IGFzIExvZ2dlZEluVXNlciksXG4gICAgICAgIHVzZXJUd29GYWN0b3JDb25maWckOiBvZih7XG4gICAgICAgICAgcHJvdmlzaW9uaW5nX3VyaTogJ3NvbWVwYXRoOi8vaGVyZS9pWHN5c3RlbXM6Zmlyc3QtdGVzdD9zZWNyZXQ9S1lDJyxcbiAgICAgICAgICBpbnRlcnZhbDogMzAsXG4gICAgICAgICAgb3RwX2RpZ2l0czogNixcbiAgICAgICAgICBzZWNyZXRfY29uZmlndXJlZDogdHJ1ZSxcbiAgICAgICAgfSBhcyBVc2VyVHdvRmFjdG9yQ29uZmlnKSxcbiAgICAgICAgZ2V0R2xvYmFsVHdvRmFjdG9yQ29uZmlnOiBqZXN0LmZuKCgpID0+IG9mKHsgZW5hYmxlZDogZmFsc2UgfSBhcyBHbG9iYWxUd29GYWN0b3JDb25maWcpKSxcbiAgICAgIH0pLFxuICAgIF0sXG4gIH0pO1xuXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIHNwZWN0YXRvciA9IGNyZWF0ZUNvbXBvbmVudCgpO1xuICAgIGxvYWRlciA9IFRlc3RiZWRIYXJuZXNzRW52aXJvbm1lbnQubG9hZGVyKHNwZWN0YXRvci5maXh0dXJlKTtcbiAgICB3cyA9IHNwZWN0YXRvci5pbmplY3QoV2ViU29ja2V0U2VydmljZSk7XG4gIH0pO1xuXG4gIGl0KCdzaG93cyB3YXJuaW5nIHdoZW4gZ2xvYmFsIHNldHRpbmcgaXMgZGlzYWJsZWQnLCAoKSA9PiB7XG4gICAgamVzdC5zcHlPbihzcGVjdGF0b3IuaW5qZWN0KEF1dGhTZXJ2aWNlKSwgJ2dldEdsb2JhbFR3b0ZhY3RvckNvbmZpZycpLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiBvZih7XG4gICAgICBlbmFibGVkOiB0cnVlLFxuICAgIH0gYXMgR2xvYmFsVHdvRmFjdG9yQ29uZmlnKSk7XG4gICAgY29uc3Qgd2FybmluZyA9IHNwZWN0YXRvci5xdWVyeShJeFdhcm5pbmdDb21wb25lbnQpO1xuICAgIGV4cGVjdCh3YXJuaW5nKS50b0JlVHJ1dGh5KCk7XG4gICAgZXhwZWN0KHdhcm5pbmcpLnRvSGF2ZUF0dHJpYnV0ZSgnbWVzc2FnZScsIGhlbHB0ZXh0MmZhLnR3b19mYWN0b3IuZ2xvYmFsX2Rpc2FibGVkKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3dzIHdhcm5pbmcgd2hlbiBnbG9iYWwgc2V0dGluZyBpcyBlbmFibGVkIGJ1dCB1c2VyIGRpc2FibGVkJywgKCkgPT4ge1xuICAgIHNwZWN0YXRvci5jb21wb25lbnQubmdPbkluaXQoKTtcbiAgICBzcGVjdGF0b3IuY29tcG9uZW50LnVzZXJUd29GYWN0b3JBdXRoQ29uZmlndXJlZCA9IGZhbHNlO1xuICAgIHNwZWN0YXRvci5kZXRlY3RDaGFuZ2VzKCk7XG4gICAgY29uc3Qgd2FybmluZyA9IHNwZWN0YXRvci5xdWVyeShJeFdhcm5pbmdDb21wb25lbnQpO1xuICAgIGV4cGVjdCh3YXJuaW5nKS50b0JlVHJ1dGh5KCk7XG4gICAgZXhwZWN0KHdhcm5pbmcpLnRvSGF2ZUF0dHJpYnV0ZSgnbWVzc2FnZScsIGhlbHB0ZXh0MmZhLnR3b19mYWN0b3IuZ2xvYmFsX2VuYWJsZWRfdXNlcl9kaXNhYmxlZCk7XG4gIH0pO1xuXG4gIGl0KCdzaG93cyB3YXJuaW5nIHdoZW4gZ2xvYmFsIHNldHRpbmcgaXMgZW5hYmxlZCBhbmQgdXNlciBlbmFibGVkJywgKCkgPT4ge1xuICAgIHNwZWN0YXRvci5jb21wb25lbnQubmdPbkluaXQoKTtcbiAgICBzcGVjdGF0b3IuZGV0ZWN0Q2hhbmdlcygpO1xuICAgIGNvbnN0IHdhcm5pbmcgPSBzcGVjdGF0b3IucXVlcnkoSXhXYXJuaW5nQ29tcG9uZW50KTtcbiAgICBleHBlY3Qod2FybmluZykudG9CZVRydXRoeSgpO1xuICAgIGV4cGVjdCh3YXJuaW5nKS50b0hhdmVBdHRyaWJ1dGUoJ21lc3NhZ2UnLCBoZWxwdGV4dDJmYS50d29fZmFjdG9yLmdsb2JhbF9lbmFibGVkX3VzZXJfZW5hYmxlZCk7XG4gIH0pO1xuXG4gIGl0KCdyZW5ld3Mgc2VjcmV0IHdoZW4gYnV0dG9uIGlzIGNsaWNrZWQnLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgcmVuZXdCdG4gPSBhd2FpdCBsb2FkZXIuZ2V0SGFybmVzcyhNYXRCdXR0b25IYXJuZXNzLndpdGgoeyB0ZXh0OiAnUmVuZXcgMkZBIFNlY3JldCcgfSkpO1xuICAgIGF3YWl0IHJlbmV3QnRuLmNsaWNrKCk7XG5cbiAgICBleHBlY3Qoc3BlY3RhdG9yLmluamVjdChEaWFsb2dTZXJ2aWNlKS5jb25maXJtKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCh7XG4gICAgICB0aXRsZTogaGVscHRleHQyZmEudHdvX2ZhY3Rvci5yZW5ld1NlY3JldC50aXRsZSxcbiAgICAgIG1lc3NhZ2U6IGhlbHB0ZXh0MmZhLnR3b19mYWN0b3IucmVuZXdTZWNyZXQubWVzc2FnZSxcbiAgICAgIGhpZGVDaGVja2JveDogdHJ1ZSxcbiAgICAgIGJ1dHRvblRleHQ6IGhlbHB0ZXh0MmZhLnR3b19mYWN0b3IucmVuZXdTZWNyZXQuYnRuLFxuICAgIH0pO1xuXG4gICAgZXhwZWN0KHdzLmNhbGwpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCd1c2VyLnJlbmV3XzJmYV9zZWNyZXQnLCBbJ2R1bW15Jywge1xuICAgICAgaW50ZXJ2YWw6IDMwLFxuICAgICAgb3RwX2RpZ2l0czogNixcbiAgICB9XSk7XG4gIH0pO1xufSk7XG4iXSwidmVyc2lvbiI6M30=