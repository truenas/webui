0ff9a27b1e86c58a1e3b8f2d8296adba
"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const testbed_1 = require("@angular/cdk/testing/testbed");
const testing_1 = require("@angular/material/button/testing");
const jest_1 = require("@ngneat/spectator/jest");
const ng_mocks_1 = require("ng-mocks");
const rxjs_1 = require("rxjs");
const mock_websocket_utils_1 = require("app/core/testing/utils/mock-websocket.utils");
const _2fa_1 = require("app/helptext/system/2fa");
const copy_button_component_1 = require("app/modules/buttons/copy-button/copy-button.component");
const dialog_service_1 = require("app/modules/dialog/dialog.service");
const ix_warning_component_1 = require("app/modules/forms/ix-forms/components/ix-warning/ix-warning.component");
const qr_viewer_component_1 = require("app/pages/two-factor-auth/components/two-factor/qr-viewer/qr-viewer.component");
const two_factor_component_1 = require("app/pages/two-factor-auth/components/two-factor/two-factor.component");
const auth_service_1 = require("app/services/auth/auth.service");
const ws_service_1 = require("app/services/ws.service");
describe('TwoFactorComponent', () => {
    let spectator;
    let loader;
    let ws;
    const createComponent = (0, jest_1.createComponentFactory)({
        component: two_factor_component_1.TwoFactorComponent,
        declarations: [
            (0, ng_mocks_1.MockComponent)(ix_warning_component_1.IxWarningComponent),
            (0, ng_mocks_1.MockComponent)(qr_viewer_component_1.QrViewerComponent),
            (0, ng_mocks_1.MockComponent)(copy_button_component_1.CopyButtonComponent),
        ],
        providers: [
            (0, jest_1.mockProvider)(dialog_service_1.DialogService, {
                confirm: jest.fn(() => (0, rxjs_1.of)(true)),
            }),
            (0, mock_websocket_utils_1.mockWebSocket)([
                (0, mock_websocket_utils_1.mockCall)('user.renew_2fa_secret'),
            ]),
            (0, jest_1.mockProvider)(auth_service_1.AuthService, {
                user$: (0, rxjs_1.of)({
                    pw_name: 'dummy',
                    two_factor_config: {
                        secret_configured: true,
                    },
                }),
                userTwoFactorConfig$: (0, rxjs_1.of)({
                    provisioning_uri: 'somepath://here/iXsystems:first-test?secret=KYC123',
                    interval: 30,
                    otp_digits: 6,
                    secret_configured: true,
                }),
                getGlobalTwoFactorConfig: jest.fn(() => (0, rxjs_1.of)({ enabled: false })),
            }),
        ],
    });
    beforeEach(() => {
        spectator = createComponent();
        loader = testbed_1.TestbedHarnessEnvironment.loader(spectator.fixture);
        ws = spectator.inject(ws_service_1.WebSocketService);
    });
    it('shows the QR code viewer with correct provisioning URI when 2FA is configured', () => {
        spectator.component.userTwoFactorAuthConfigured = true;
        spectator.detectChanges();
        const qrViewer = spectator.query(qr_viewer_component_1.QrViewerComponent);
        expect(qrViewer).toBeTruthy();
        expect(qrViewer).toHaveProperty('qrInfo', 'otpauth://totp/iXsystems:dummy@TrueNAS?secret=KYC123&issuer=iXsystems');
    });
    it('displays the secret from provisioning URI in the component', () => {
        spectator.component.userTwoFactorAuthConfigured = true;
        spectator.detectChanges();
        const secretElement = spectator.query('.secret p');
        expect(secretElement).toBeTruthy();
        expect(secretElement).toHaveText('KYC123');
    });
    it('shows a copy button with the correct secret', () => {
        spectator.component.userTwoFactorAuthConfigured = true;
        spectator.detectChanges();
        const copyButton = spectator.query(copy_button_component_1.CopyButtonComponent);
        expect(copyButton).toBeTruthy();
        expect(copyButton).toHaveProperty('text', 'KYC123');
    });
    it('shows warning when global setting is disabled', () => {
        jest.spyOn(spectator.inject(auth_service_1.AuthService), 'getGlobalTwoFactorConfig').mockImplementation(() => (0, rxjs_1.of)({
            enabled: true,
        }));
        const warning = spectator.query(ix_warning_component_1.IxWarningComponent);
        expect(warning).toBeTruthy();
        expect(warning).toHaveAttribute('message', _2fa_1.helptext2fa.two_factor.global_disabled);
    });
    it('shows warning when global setting is enabled but user disabled', () => {
        spectator.component.ngOnInit();
        spectator.component.userTwoFactorAuthConfigured = false;
        spectator.detectChanges();
        const warning = spectator.query(ix_warning_component_1.IxWarningComponent);
        expect(warning).toBeTruthy();
        expect(warning).toHaveAttribute('message', _2fa_1.helptext2fa.two_factor.global_enabled_user_disabled);
    });
    it('shows warning when global setting is enabled and user enabled', () => {
        spectator.component.ngOnInit();
        spectator.detectChanges();
        const warning = spectator.query(ix_warning_component_1.IxWarningComponent);
        expect(warning).toBeTruthy();
        expect(warning).toHaveAttribute('message', _2fa_1.helptext2fa.two_factor.global_enabled_user_enabled);
    });
    it('renews secret when button is clicked', () => __awaiter(void 0, void 0, void 0, function* () {
        const renewBtn = yield loader.getHarness(testing_1.MatButtonHarness.with({ text: 'Renew 2FA Secret' }));
        yield renewBtn.click();
        expect(spectator.inject(dialog_service_1.DialogService).confirm).toHaveBeenCalledWith({
            title: _2fa_1.helptext2fa.two_factor.renewSecret.title,
            message: _2fa_1.helptext2fa.two_factor.renewSecret.message,
            hideCheckbox: true,
            buttonText: _2fa_1.helptext2fa.two_factor.renewSecret.btn,
        });
        expect(ws.call).toHaveBeenCalledWith('user.renew_2fa_secret', ['dummy', {
                interval: 30,
                otp_digits: 6,
            }]);
    }));
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21hY2Jvb2sva2FycG92LXdvcmsvVHJ1ZU5BUy93ZWJ1aS9zcmMvYXBwL3BhZ2VzL3R3by1mYWN0b3ItYXV0aC9jb21wb25lbnRzL3R3by1mYWN0b3IvdHdvLWZhY3Rvci5jb21wb25lbnQuc3BlYy50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUNBLDBEQUF5RTtBQUN6RSw4REFBb0U7QUFDcEUsaURBQXlGO0FBQ3pGLHVDQUF5QztBQUN6QywrQkFBMEI7QUFDMUIsc0ZBQXNGO0FBQ3RGLGtEQUFzRDtBQUd0RCxpR0FBNEY7QUFDNUYsc0VBQWtFO0FBQ2xFLGdIQUEyRztBQUMzRyx1SEFBa0g7QUFDbEgsK0dBQTBHO0FBQzFHLGlFQUE2RDtBQUM3RCx3REFBMkQ7QUFFM0QsUUFBUSxDQUFDLG9CQUFvQixFQUFFLEdBQUcsRUFBRTtJQUNsQyxJQUFJLFNBQXdDLENBQUM7SUFDN0MsSUFBSSxNQUFxQixDQUFDO0lBQzFCLElBQUksRUFBb0IsQ0FBQztJQUV6QixNQUFNLGVBQWUsR0FBRyxJQUFBLDZCQUFzQixFQUFDO1FBQzdDLFNBQVMsRUFBRSx5Q0FBa0I7UUFDN0IsWUFBWSxFQUFFO1lBQ1osSUFBQSx3QkFBYSxFQUFDLHlDQUFrQixDQUFDO1lBQ2pDLElBQUEsd0JBQWEsRUFBQyx1Q0FBaUIsQ0FBQztZQUNoQyxJQUFBLHdCQUFhLEVBQUMsMkNBQW1CLENBQUM7U0FDbkM7UUFDRCxTQUFTLEVBQUU7WUFDVCxJQUFBLG1CQUFZLEVBQUMsOEJBQWEsRUFBRTtnQkFDMUIsT0FBTyxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBQSxTQUFFLEVBQUMsSUFBSSxDQUFDLENBQUM7YUFDakMsQ0FBQztZQUNGLElBQUEsb0NBQWEsRUFBQztnQkFDWixJQUFBLCtCQUFRLEVBQUMsdUJBQXVCLENBQUM7YUFDbEMsQ0FBQztZQUNGLElBQUEsbUJBQVksRUFBQywwQkFBVyxFQUFFO2dCQUN4QixLQUFLLEVBQUUsSUFBQSxTQUFFLEVBQUM7b0JBQ1Is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QUFDO1FBQzlGLE1BQU0sUUFBUSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBRXZCLE1BQU0sQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLDhCQUFhLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxvQkFBb0IsQ0FBQztZQUNuRSxLQUFLLEVBQUUsa0JBQVcsQ0FBQyxVQUFVLENBQUMsV0FBVyxDQUFDLEtBQUs7WUFDL0MsT0FBTyxFQUFFLGtCQUFXLENBQUMsVUFBVSxDQUFDLFdBQVcsQ0FBQyxPQUFPO1lBQ25ELFlBQVksRUFBRSxJQUFJO1lBQ2xCLFVBQVUsRUFBRSxrQkFBVyxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsR0FBRztTQUNuRCxDQUFDLENBQUM7UUFFSCxNQUFNLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLG9CQUFvQixDQUFDLHVCQUF1QixFQUFFLENBQUMsT0FBTyxFQUFFO2dCQUN0RSxRQUFRLEVBQUUsRUFBRTtnQkFDWixVQUFVLEVBQUUsQ0FBQzthQUNkLENBQUMsQ0FBQyxDQUFDO0lBQ04sQ0FBQyxDQUFBLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9tYWNib29rL2thcnBvdi13b3JrL1RydWVOQVMvd2VidWkvc3JjL2FwcC9wYWdlcy90d28tZmFjdG9yLWF1dGgvY29tcG9uZW50cy90d28tZmFjdG9yL3R3by1mYWN0b3IuY29tcG9uZW50LnNwZWMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSGFybmVzc0xvYWRlciB9IGZyb20gJ0Bhbmd1bGFyL2Nkay90ZXN0aW5nJztcbmltcG9ydCB7IFRlc3RiZWRIYXJuZXNzRW52aXJvbm1lbnQgfSBmcm9tICdAYW5ndWxhci9jZGsvdGVzdGluZy90ZXN0YmVkJztcbmltcG9ydCB7IE1hdEJ1dHRvbkhhcm5lc3MgfSBmcm9tICdAYW5ndWxhci9tYXRlcmlhbC9idXR0b24vdGVzdGluZyc7XG5pbXBvcnQgeyBTcGVjdGF0b3IsIGNyZWF0ZUNvbXBvbmVudEZhY3RvcnksIG1vY2tQcm92aWRlciB9IGZyb20gJ0BuZ25lYXQvc3BlY3RhdG9yL2plc3QnO1xuaW1wb3J0IHsgTW9ja0NvbXBvbmVudCB9IGZyb20gJ25nLW1vY2tzJztcbmltcG9ydCB7IG9mIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBtb2NrQ2FsbCwgbW9ja1dlYlNvY2tldCB9IGZyb20gJ2FwcC9jb3JlL3Rlc3RpbmcvdXRpbHMvbW9jay13ZWJzb2NrZXQudXRpbHMnO1xuaW1wb3J0IHsgaGVscHRleHQyZmEgfSBmcm9tICdhcHAvaGVscHRleHQvc3lzdGVtLzJmYSc7XG5pbXBvcnQgeyBMb2dnZWRJblVzZXIgfSBmcm9tICdhcHAvaW50ZXJmYWNlcy9kcy1jYWNoZS5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgR2xvYmFsVHdvRmFjdG9yQ29uZmlnLCBVc2VyVHdvRmFjdG9yQ29uZmlnIH0gZnJvbSAnYXBwL2ludGVyZmFjZXMvdHdvLWZhY3Rvci1jb25maWcuaW50ZXJmYWNlJztcbmltcG9ydCB7IENvcHlCdXR0b25Db21wb25lbnQgfSBmcm9tICdhcHAvbW9kdWxlcy9idXR0b25zL2NvcHktYnV0dG9uL2NvcHktYnV0dG9uLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBEaWFsb2dTZXJ2aWNlIH0gZnJvbSAnYXBwL21vZHVsZXMvZGlhbG9nL2RpYWxvZy5zZXJ2aWNlJztcbmltcG9ydCB7IEl4V2FybmluZ0NvbXBvbmVudCB9IGZyb20gJ2FwcC9tb2R1bGVzL2Zvcm1zL2l4LWZvcm1zL2NvbXBvbmVudHMvaXgtd2FybmluZy9peC13YXJuaW5nLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBRclZpZXdlckNvbXBvbmVudCB9IGZyb20gJ2FwcC9wYWdlcy90d28tZmFjdG9yLWF1dGgvY29tcG9uZW50cy90d28tZmFjdG9yL3FyLXZpZXdlci9xci12aWV3ZXIuY29tcG9uZW50JztcbmltcG9ydCB7IFR3b0ZhY3RvckNvbXBvbmVudCB9IGZyb20gJ2FwcC9wYWdlcy90d28tZmFjdG9yLWF1dGgvY29tcG9uZW50cy90d28tZmFjdG9yL3R3by1mYWN0b3IuY29tcG9uZW50JztcbmltcG9ydCB7IEF1dGhTZXJ2aWNlIH0gZnJvbSAnYXBwL3NlcnZpY2VzL2F1dGgvYXV0aC5zZXJ2aWNlJztcbmltcG9ydCB7IFdlYlNvY2tldFNlcnZpY2UgfSBmcm9tICdhcHAvc2VydmljZXMvd3Muc2VydmljZSc7XG5cbmRlc2NyaWJlKCdUd29GYWN0b3JDb21wb25lbnQnLCAoKSA9PiB7XG4gIGxldCBzcGVjdGF0b3I6IFNwZWN0YXRvcjxUd29GYWN0b3JDb21wb25lbnQ+O1xuICBsZXQgbG9hZGVyOiBIYXJuZXNzTG9hZGVyO1xuICBsZXQgd3M6IFdlYlNvY2tldFNlcnZpY2U7XG5cbiAgY29uc3QgY3JlYXRlQ29tcG9uZW50ID0gY3JlYXRlQ29tcG9uZW50RmFjdG9yeSh7XG4gICAgY29tcG9uZW50OiBUd29GYWN0b3JDb21wb25lbnQsXG4gICAgZGVjbGFyYXRpb25zOiBbXG4gICAgICBNb2NrQ29tcG9uZW50KEl4V2FybmluZ0NvbXBvbmVudCksXG4gICAgICBNb2NrQ29tcG9uZW50KFFyVmlld2VyQ29tcG9uZW50KSxcbiAgICAgIE1vY2tDb21wb25lbnQoQ29weUJ1dHRvbkNvbXBvbmVudCksXG4gICAgXSxcbiAgICBwcm92aWRlcnM6IFtcbiAgICAgIG1vY2tQcm92aWRlcihEaWFsb2dTZXJ2aWNlLCB7XG4gICAgICAgIGNvbmZpcm06IGplc3QuZm4oKCkgPT4gb2YodHJ1ZSkpLFxuICAgICAgfSksXG4gICAgICBtb2NrV2ViU29ja2V0KFtcbiAgICAgICAgbW9ja0NhbGwoJ3VzZXIucmVuZXdfMmZhX3NlY3JldCcpLFxuICAgICAgXSksXG4gICAgICBtb2NrUHJvdmlkZXIoQXV0aFNlcnZpY2UsIHtcbiAgICAgICAgdXNlciQ6IG9mKHtcbiAgICAgICAgICBwd19uYW1lOiAnZHVtbXknLFxuICAgICAgICAgIHR3b19mYWN0b3JfY29uZmlnOiB7XG4gICAgICAgICAgICBzZWNyZXRfY29uZmlndXJlZDogdHJ1ZSxcbiAgICAgICAgICB9LFxuICAgICAgICB9IGFzIExvZ2dlZEluVXNlciksXG4gICAgICAgIHVzZXJUd29GYWN0b3JDb25maWckOiBvZih7XG4gICAgICAgICAgcHJvdmlzaW9uaW5nX3VyaTogJ3NvbWVwYXRoOi8vaGVyZS9pWHN5c3RlbXM6Zmlyc3QtdGVzdD9zZWNyZXQ9S1lDMTIzJyxcbiAgICAgICAgICBpbnRlcnZhbDogMzAsXG4gICAgICAgICAgb3RwX2RpZ2l0czogNixcbiAgICAgICAgICBzZWNyZXRfY29uZmlndXJlZDogdHJ1ZSxcbiAgICAgICAgfSBhcyBVc2VyVHdvRmFjdG9yQ29uZmlnKSxcbiAgICAgICAgZ2V0R2xvYmFsVHdvRmFjdG9yQ29uZmlnOiBqZXN0LmZuKCgpID0+IG9mKHsgZW5hYmxlZDogZmFsc2UgfSBhcyBHbG9iYWxUd29GYWN0b3JDb25maWcpKSxcbiAgICAgIH0pLFxuICAgIF0sXG4gIH0pO1xuXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIHNwZWN0YXRvciA9IGNyZWF0ZUNvbXBvbmVudCgpO1xuICAgIGxvYWRlciA9IFRlc3RiZWRIYXJuZXNzRW52aXJvbm1lbnQubG9hZGVyKHNwZWN0YXRvci5maXh0dXJlKTtcbiAgICB3cyA9IHNwZWN0YXRvci5pbmplY3QoV2ViU29ja2V0U2VydmljZSk7XG4gIH0pO1xuXG4gIGl0KCdzaG93cyB0aGUgUVIgY29kZSB2aWV3ZXIgd2l0aCBjb3JyZWN0IHByb3Zpc2lvbmluZyBVUkkgd2hlbiAyRkEgaXMgY29uZmlndXJlZCcsICgpID0+IHtcbiAgICBzcGVjdGF0b3IuY29tcG9uZW50LnVzZXJUd29GYWN0b3JBdXRoQ29uZmlndXJlZCA9IHRydWU7XG4gICAgc3BlY3RhdG9yLmRldGVjdENoYW5nZXMoKTtcblxuICAgIGNvbnN0IHFyVmlld2VyID0gc3BlY3RhdG9yLnF1ZXJ5KFFyVmlld2VyQ29tcG9uZW50KTtcbiAgICBleHBlY3QocXJWaWV3ZXIpLnRvQmVUcnV0aHkoKTtcbiAgICBleHBlY3QocXJWaWV3ZXIpLnRvSGF2ZVByb3BlcnR5KCdxckluZm8nLCAnb3RwYXV0aDovL3RvdHAvaVhzeXN0ZW1zOmR1bW15QFRydWVOQVM/c2VjcmV0PUtZQzEyMyZpc3N1ZXI9aVhzeXN0ZW1zJyk7XG4gIH0pO1xuXG4gIGl0KCdkaXNwbGF5cyB0aGUgc2VjcmV0IGZyb20gcHJvdmlzaW9uaW5nIFVSSSBpbiB0aGUgY29tcG9uZW50JywgKCkgPT4ge1xuICAgIHNwZWN0YXRvci5jb21wb25lbnQudXNlclR3b0ZhY3RvckF1dGhDb25maWd1cmVkID0gdHJ1ZTtcbiAgICBzcGVjdGF0b3IuZGV0ZWN0Q2hhbmdlcygpO1xuXG4gICAgY29uc3Qgc2VjcmV0RWxlbWVudCA9IHNwZWN0YXRvci5xdWVyeSgnLnNlY3JldCBwJyk7XG4gICAgZXhwZWN0KHNlY3JldEVsZW1lbnQpLnRvQmVUcnV0aHkoKTtcbiAgICBleHBlY3Qoc2VjcmV0RWxlbWVudCkudG9IYXZlVGV4dCgnS1lDMTIzJyk7XG4gIH0pO1xuXG4gIGl0KCdzaG93cyBhIGNvcHkgYnV0dG9uIHdpdGggdGhlIGNvcnJlY3Qgc2VjcmV0JywgKCkgPT4ge1xuICAgIHNwZWN0YXRvci5jb21wb25lbnQudXNlclR3b0ZhY3RvckF1dGhDb25maWd1cmVkID0gdHJ1ZTtcbiAgICBzcGVjdGF0b3IuZGV0ZWN0Q2hhbmdlcygpO1xuXG4gICAgY29uc3QgY29weUJ1dHRvbiA9IHNwZWN0YXRvci5xdWVyeShDb3B5QnV0dG9uQ29tcG9uZW50KTtcbiAgICBleHBlY3QoY29weUJ1dHRvbikudG9CZVRydXRoeSgpO1xuICAgIGV4cGVjdChjb3B5QnV0dG9uKS50b0hhdmVQcm9wZXJ0eSgndGV4dCcsICdLWUMxMjMnKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3dzIHdhcm5pbmcgd2hlbiBnbG9iYWwgc2V0dGluZyBpcyBkaXNhYmxlZCcsICgpID0+IHtcbiAgICBqZXN0LnNweU9uKHNwZWN0YXRvci5pbmplY3QoQXV0aFNlcnZpY2UpLCAnZ2V0R2xvYmFsVHdvRmFjdG9yQ29uZmlnJykubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+IG9mKHtcbiAgICAgIGVuYWJsZWQ6IHRydWUsXG4gICAgfSBhcyBHbG9iYWxUd29GYWN0b3JDb25maWcpKTtcbiAgICBjb25zdCB3YXJuaW5nID0gc3BlY3RhdG9yLnF1ZXJ5KEl4V2FybmluZ0NvbXBvbmVudCk7XG4gICAgZXhwZWN0KHdhcm5pbmcpLnRvQmVUcnV0aHkoKTtcbiAgICBleHBlY3Qod2FybmluZykudG9IYXZlQXR0cmlidXRlKCdtZXNzYWdlJywgaGVscHRleHQyZmEudHdvX2ZhY3Rvci5nbG9iYWxfZGlzYWJsZWQpO1xuICB9KTtcblxuICBpdCgnc2hvd3Mgd2FybmluZyB3aGVuIGdsb2JhbCBzZXR0aW5nIGlzIGVuYWJsZWQgYnV0IHVzZXIgZGlzYWJsZWQnLCAoKSA9PiB7XG4gICAgc3BlY3RhdG9yLmNvbXBvbmVudC5uZ09uSW5pdCgpO1xuICAgIHNwZWN0YXRvci5jb21wb25lbnQudXNlclR3b0ZhY3RvckF1dGhDb25maWd1cmVkID0gZmFsc2U7XG4gICAgc3BlY3RhdG9yLmRldGVjdENoYW5nZXMoKTtcbiAgICBjb25zdCB3YXJuaW5nID0gc3BlY3RhdG9yLnF1ZXJ5KEl4V2FybmluZ0NvbXBvbmVudCk7XG4gICAgZXhwZWN0KHdhcm5pbmcpLnRvQmVUcnV0aHkoKTtcbiAgICBleHBlY3Qod2FybmluZykudG9IYXZlQXR0cmlidXRlKCdtZXNzYWdlJywgaGVscHRleHQyZmEudHdvX2ZhY3Rvci5nbG9iYWxfZW5hYmxlZF91c2VyX2Rpc2FibGVkKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3dzIHdhcm5pbmcgd2hlbiBnbG9iYWwgc2V0dGluZyBpcyBlbmFibGVkIGFuZCB1c2VyIGVuYWJsZWQnLCAoKSA9PiB7XG4gICAgc3BlY3RhdG9yLmNvbXBvbmVudC5uZ09uSW5pdCgpO1xuICAgIHNwZWN0YXRvci5kZXRlY3RDaGFuZ2VzKCk7XG4gICAgY29uc3Qgd2FybmluZyA9IHNwZWN0YXRvci5xdWVyeShJeFdhcm5pbmdDb21wb25lbnQpO1xuICAgIGV4cGVjdCh3YXJuaW5nKS50b0JlVHJ1dGh5KCk7XG4gICAgZXhwZWN0KHdhcm5pbmcpLnRvSGF2ZUF0dHJpYnV0ZSgnbWVzc2FnZScsIGhlbHB0ZXh0MmZhLnR3b19mYWN0b3IuZ2xvYmFsX2VuYWJsZWRfdXNlcl9lbmFibGVkKTtcbiAgfSk7XG5cbiAgaXQoJ3JlbmV3cyBzZWNyZXQgd2hlbiBidXR0b24gaXMgY2xpY2tlZCcsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCByZW5ld0J0biA9IGF3YWl0IGxvYWRlci5nZXRIYXJuZXNzKE1hdEJ1dHRvbkhhcm5lc3Mud2l0aCh7IHRleHQ6ICdSZW5ldyAyRkEgU2VjcmV0JyB9KSk7XG4gICAgYXdhaXQgcmVuZXdCdG4uY2xpY2soKTtcblxuICAgIGV4cGVjdChzcGVjdGF0b3IuaW5qZWN0KERpYWxvZ1NlcnZpY2UpLmNvbmZpcm0pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHtcbiAgICAgIHRpdGxlOiBoZWxwdGV4dDJmYS50d29fZmFjdG9yLnJlbmV3U2VjcmV0LnRpdGxlLFxuICAgICAgbWVzc2FnZTogaGVscHRleHQyZmEudHdvX2ZhY3Rvci5yZW5ld1NlY3JldC5tZXNzYWdlLFxuICAgICAgaGlkZUNoZWNrYm94OiB0cnVlLFxuICAgICAgYnV0dG9uVGV4dDogaGVscHRleHQyZmEudHdvX2ZhY3Rvci5yZW5ld1NlY3JldC5idG4sXG4gICAgfSk7XG5cbiAgICBleHBlY3Qod3MuY2FsbCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ3VzZXIucmVuZXdfMmZhX3NlY3JldCcsIFsnZHVtbXknLCB7XG4gICAgICBpbnRlcnZhbDogMzAsXG4gICAgICBvdHBfZGlnaXRzOiA2LFxuICAgIH1dKTtcbiAgfSk7XG59KTtcbiJdLCJ2ZXJzaW9uIjozfQ==