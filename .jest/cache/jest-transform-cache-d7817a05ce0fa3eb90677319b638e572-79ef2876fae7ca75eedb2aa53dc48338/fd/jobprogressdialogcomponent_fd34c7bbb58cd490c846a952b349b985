ba4cc4ac88f764e9443657edbb094585
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.JobProgressDialogComponent = void 0;
const scrolling_1 = require("@angular/cdk/scrolling");
const common_1 = require("@angular/common");
const core_1 = require("@angular/core");
const button_1 = require("@angular/material/button");
const dialog_1 = require("@angular/material/dialog");
const progress_bar_1 = require("@angular/material/progress-bar");
const until_destroy_1 = require("@ngneat/until-destroy");
const core_2 = require("@ngx-translate/core");
const rxjs_1 = require("rxjs");
const job_state_enum_1 = require("app/enums/job-state.enum");
const ix_icon_component_1 = require("app/modules/ix-icon/ix-icon.component");
const test_directive_1 = require("app/modules/test-id/test.directive");
const error_handler_service_1 = require("app/services/error-handler.service");
const ws_service_1 = require("app/services/ws.service");
const i0 = __importStar(require("@angular/core"));
let JobProgressDialogComponent = class JobProgressDialogComponent {
    get isJobRunning() {
        var _a;
        return ((_a = this.job) === null || _a === void 0 ? void 0 : _a.state) === job_state_enum_1.JobState.Running;
    }
    get hasAbortButton() {
        var _a;
        return this.job.abortable && [job_state_enum_1.JobState.Running, job_state_enum_1.JobState.Waiting].includes((_a = this.job) === null || _a === void 0 ? void 0 : _a.state);
    }
    get isJobStateDeterminate() {
        var _a;
        return [
            job_state_enum_1.JobState.Aborted,
            job_state_enum_1.JobState.Error,
            job_state_enum_1.JobState.Failed,
            job_state_enum_1.JobState.Finished,
            job_state_enum_1.JobState.Success,
        ].includes((_a = this.job) === null || _a === void 0 ? void 0 : _a.state) || this.isJobRunning;
    }
    constructor(dialogRef, data, ws, cdr, errorHandler) {
        this.dialogRef = dialogRef;
        this.data = data;
        this.ws = ws;
        this.cdr = cdr;
        this.errorHandler = errorHandler;
        this.jobSuccess = (0, core_1.output)();
        this.jobFailure = (0, core_1.output)();
        this.jobAborted = (0, core_1.output)();
        this.jobProgress = (0, core_1.output)();
        this.job = {};
        this.JobState = job_state_enum_1.JobState;
        this.realtimeLogsSubscribed = false;
        this.realtimeLogs = '';
        this.showMinimizeButton = true;
        this.progressTotalPercent = 0;
        this.hideProgressValue = false;
        this.showRealtimeLogs = false;
        this.isAbortingJob = false;
    }
    ngOnInit() {
        var _a, _b, _c, _d;
        this.title = (_a = this.data) === null || _a === void 0 ? void 0 : _a.title;
        this.description = (_b = this.data) === null || _b === void 0 ? void 0 : _b.description;
        this.showRealtimeLogs = ((_c = this.data) === null || _c === void 0 ? void 0 : _c.showRealtimeLogs) || false;
        this.showMinimizeButton = ((_d = this.data) === null || _d === void 0 ? void 0 : _d.canMinimize) || false;
        this.dialogRef.disableClose = !this.showMinimizeButton;
        let logsSubscription = null;
        this.cdr.markForCheck();
        this.data.job$.pipe((0, until_destroy_1.untilDestroyed)(this)).subscribe({
            next: (job) => {
                this.job = job;
                if (!this.title) {
                    this.title = this.job.method;
                }
                if (!this.description) {
                    this.description = this.job.description;
                }
                if (this.data.showRealtimeLogs
                    && this.job.logs_path
                    && !this.realtimeLogsSubscribed) {
                    logsSubscription = this.getRealtimeLogs();
                }
                if (job.progress && !this.data.showRealtimeLogs) {
                    this.jobProgress.emit(job.progress);
                    if (job.progress.description) {
                        this.description = job.progress.description;
                    }
                    if (job.progress.percent) {
                        this.progressTotalPercent = job.progress.percent;
                    }
                    this.hideProgressValue = job.progress.percent === null;
                }
                this.cdr.markForCheck();
            },
            error: (error) => {
                this.jobFailure.emit(error);
                this.dialogRef.close();
            },
            complete: () => {
                switch (this.job.state) {
                    case job_state_enum_1.JobState.Failed:
                        this.jobFailure.emit(this.job);
                        this.dialogRef.close();
                        break;
                    case job_state_enum_1.JobState.Aborted:
                        this.jobAborted.emit(this.job);
                        this.dialogRef.close();
                        break;
                    case job_state_enum_1.JobState.Success:
                        this.jobSuccess.emit(this.job);
                        this.dialogRef.close();
                        break;
                }
                if (this.realtimeLogsSubscribed) {
                    logsSubscription.unsubscribe();
                }
                this.cdr.markForCheck();
            },
        });
    }
    ngAfterViewChecked() {
        this.scrollBottom();
    }
    scrollBottom() {
        const cardContainer = document.getElementsByClassName('job-dialog')[0];
        const logsContainer = cardContainer.getElementsByClassName('logs-container')[0];
        if (!logsContainer) {
            return;
        }
        logsContainer.scrollTop = logsContainer.scrollHeight;
        this.cdr.markForCheck();
    }
    abortJob() {
        this.ws.call('core.job_abort', [this.job.id]).pipe(this.errorHandler.catchError(), (0, until_destroy_1.untilDestroyed)(this))
            .subscribe(() => {
            this.isAbortingJob = true;
            this.cdr.markForCheck();
        });
    }
    /**
     * This method returns the subscription id that is used when subscribing to real time
     * websocket updates. The subscription id is used to unsubscribe form those real time
     * websocket updates at a later time. Unsubscription is not possible without this id
     */
    getRealtimeLogs() {
        this.realtimeLogsSubscribed = true;
        const subName = 'filesystem.file_tail_follow:' + this.job.logs_path;
        this.cdr.markForCheck();
        return this.ws.subscribeToLogs(subName)
            .pipe((0, rxjs_1.map)((apiEvent) => apiEvent.fields), (0, until_destroy_1.untilDestroyed)(this))
            .subscribe((logs) => {
            if ((logs === null || logs === void 0 ? void 0 : logs.data) && typeof logs.data === 'string') {
                this.realtimeLogs += logs.data;
            }
            this.cdr.markForCheck();
        });
    }
};
exports.JobProgressDialogComponent = JobProgressDialogComponent;
JobProgressDialogComponent.ctorParameters = () => [
    { type: dialog_1.MatDialogRef },
    { type: undefined, decorators: [{ type: core_1.Inject, args: [dialog_1.MAT_DIALOG_DATA,] }] },
    { type: ws_service_1.WebSocketService },
    { type: core_1.ChangeDetectorRef },
    { type: error_handler_service_1.ErrorHandlerService }
];
JobProgressDialogComponent.propDecorators = {
    jobSuccess: [{ type: i0.Output, args: ["jobSuccess",] }],
    jobFailure: [{ type: i0.Output, args: ["jobFailure",] }],
    jobAborted: [{ type: i0.Output, args: ["jobAborted",] }],
    jobProgress: [{ type: i0.Output, args: ["jobProgress",] }]
};
exports.JobProgressDialogComponent = JobProgressDialogComponent = __decorate([
    (0, until_destroy_1.UntilDestroy)(),
    (0, core_1.Component)({
        selector: 'ix-job-progress-dialog',
        template: require("./job-progress-dialog.component.html"),
        changeDetection: core_1.ChangeDetectionStrategy.OnPush,
        standalone: true,
        imports: [
            dialog_1.MatDialogTitle,
            scrolling_1.CdkScrollable,
            dialog_1.MatDialogContent,
            progress_bar_1.MatProgressBar,
            dialog_1.MatDialogActions,
            button_1.MatButton,
            button_1.MatIconButton,
            dialog_1.MatDialogClose,
            ix_icon_component_1.IxIconComponent,
            core_2.TranslateModule,
            common_1.DecimalPipe,
            test_directive_1.TestDirective,
            test_directive_1.TestDirective,
        ],
    })
], JobProgressDialogComponent);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21hY2Jvb2sva2FycG92LXdvcmsvVHJ1ZU5BUy93ZWJ1aS9zcmMvYXBwL21vZHVsZXMvZGlhbG9nL2NvbXBvbmVudHMvam9iLXByb2dyZXNzL2pvYi1wcm9ncmVzcy1kaWFsb2cuY29tcG9uZW50LnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsc0RBQXVEO0FBQ3ZELDRDQUE4QztBQUM5Qyx3Q0FFdUI7QUFDdkIscURBQW9FO0FBQ3BFLHFEQUVrQztBQUNsQyxpRUFBZ0U7QUFDaEUseURBQXFFO0FBQ3JFLDhDQUFzRDtBQUN0RCwrQkFBcUQ7QUFDckQsNkRBQW9EO0FBRXBELDZFQUF3RTtBQUN4RSx1RUFBbUU7QUFDbkUsOEVBQXlFO0FBQ3pFLHdEQUEyRDs7QUFtRHBELElBQU0sMEJBQTBCLEdBQWhDLE1BQU0sMEJBQTBCO0lBcUJyQyxJQUFJLFlBQVk7O1FBQ2QsT0FBTyxDQUFBLE1BQUEsSUFBSSxDQUFDLEdBQUcsMENBQUUsS0FBSyxNQUFLLHlCQUFRLENBQUMsT0FBTyxDQUFDO0lBQzlDLENBQUM7SUFFRCxJQUFJLGNBQWM7O1FBQ2hCLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxTQUFTLElBQUksQ0FBQyx5QkFBUSxDQUFDLE9BQU8sRUFBRSx5QkFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLFFBQVEsQ0FBQyxNQUFBLElBQUksQ0FBQyxHQUFHLDBDQUFFLEtBQUssQ0FBQyxDQUFDO0lBQzlGLENBQUM7SUFFRCxJQUFJLHFCQUFxQjs7UUFDdkIsT0FBTztZQUNMLHlCQUFRLENBQUMsT0FBTztZQUNoQix5QkFBUSxDQUFDLEtBQUs7WUFDZCx5QkFBUSxDQUFDLE1BQU07WUFDZix5QkFBUSxDQUFDLFFBQVE7WUFDakIseUJBQVEsQ0FBQyxPQUFPO1NBQ2pCLENBQUMsUUFBUSxDQUFDLE1BQUEsSUFBSSxDQUFDLEdBQUcsMENBQUUsS0FBSyxDQUFDLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQztJQUNuRCxDQUFDO0lBRUQs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ZDtLQUNGLENBQUM7R0FDVywwQkFBMEIsQ0ErSnRDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9tYWNib29rL2thcnBvdi13b3JrL1RydWVOQVMvd2VidWkvc3JjL2FwcC9tb2R1bGVzL2RpYWxvZy9jb21wb25lbnRzL2pvYi1wcm9ncmVzcy9qb2ItcHJvZ3Jlc3MtZGlhbG9nLmNvbXBvbmVudC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDZGtTY3JvbGxhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY2RrL3Njcm9sbGluZyc7XG5pbXBvcnQgeyBEZWNpbWFsUGlwZSB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5pbXBvcnQge1xuICBBZnRlclZpZXdDaGVja2VkLCBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneSwgQ2hhbmdlRGV0ZWN0b3JSZWYsIENvbXBvbmVudCwgSW5qZWN0LCBPbkluaXQsIG91dHB1dCxcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBNYXRCdXR0b24sIE1hdEljb25CdXR0b24gfSBmcm9tICdAYW5ndWxhci9tYXRlcmlhbC9idXR0b24nO1xuaW1wb3J0IHtcbiAgTUFUX0RJQUxPR19EQVRBLCBNYXREaWFsb2dDb25maWcsIE1hdERpYWxvZ1JlZiwgTWF0RGlhbG9nVGl0bGUsIE1hdERpYWxvZ0NvbnRlbnQsIE1hdERpYWxvZ0FjdGlvbnMsIE1hdERpYWxvZ0Nsb3NlLFxufSBmcm9tICdAYW5ndWxhci9tYXRlcmlhbC9kaWFsb2cnO1xuaW1wb3J0IHsgTWF0UHJvZ3Jlc3NCYXIgfSBmcm9tICdAYW5ndWxhci9tYXRlcmlhbC9wcm9ncmVzcy1iYXInO1xuaW1wb3J0IHsgVW50aWxEZXN0cm95LCB1bnRpbERlc3Ryb3llZCB9IGZyb20gJ0BuZ25lYXQvdW50aWwtZGVzdHJveSc7XG5pbXBvcnQgeyBUcmFuc2xhdGVNb2R1bGUgfSBmcm9tICdAbmd4LXRyYW5zbGF0ZS9jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YnNjcmlwdGlvbiwgbWFwIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBKb2JTdGF0ZSB9IGZyb20gJ2FwcC9lbnVtcy9qb2Itc3RhdGUuZW51bSc7XG5pbXBvcnQgeyBKb2IsIEpvYlByb2dyZXNzIH0gZnJvbSAnYXBwL2ludGVyZmFjZXMvam9iLmludGVyZmFjZSc7XG5pbXBvcnQgeyBJeEljb25Db21wb25lbnQgfSBmcm9tICdhcHAvbW9kdWxlcy9peC1pY29uL2l4LWljb24uY29tcG9uZW50JztcbmltcG9ydCB7IFRlc3REaXJlY3RpdmUgfSBmcm9tICdhcHAvbW9kdWxlcy90ZXN0LWlkL3Rlc3QuZGlyZWN0aXZlJztcbmltcG9ydCB7IEVycm9ySGFuZGxlclNlcnZpY2UgfSBmcm9tICdhcHAvc2VydmljZXMvZXJyb3ItaGFuZGxlci5zZXJ2aWNlJztcbmltcG9ydCB7IFdlYlNvY2tldFNlcnZpY2UgfSBmcm9tICdhcHAvc2VydmljZXMvd3Muc2VydmljZSc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgSm9iUHJvZ3Jlc3NEaWFsb2dDb25maWc8UmVzdWx0PiB7XG4gIGpvYiQ6IE9ic2VydmFibGU8Sm9iPFJlc3VsdD4+O1xuXG4gIC8qKlxuICAgKiBEZWZhdWx0cyB0byBqb2IubWV0aG9kLlxuICAgKi9cbiAgdGl0bGU/OiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIERlZmF1bHRzIHRvIGpvYi5kZXNjcmlwdGlvbjtcbiAgICovXG4gIGRlc2NyaXB0aW9uPzogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBEZWZhdWx0cyB0byBmYWxzZTtcbiAgICovXG4gIHNob3dSZWFsdGltZUxvZ3M/OiBib29sZWFuO1xuXG4gIC8qKlxuICAgKiBXaGV0aGVyIHVzZXIgY2FuIG1pbmltaXplIHRoZSBqb2IgZGlhbG9nXG4gICAqIERlZmF1bHRzIHRvIGZhbHNlLlxuICAgKiBNaW5pbWl6aW5nIHRoZSBkaWFsb2cgd2lsbCBub3Qgc3RvcCB0aGUgam9iLCBidXQgd2lsbCBkZXN0cm95IHRoZSBjb21wb25lbnQgYW5kIHRodXMgYWxsIHRoZSBjb2RlIGluIHN1YnNjcmlwdGlvbi5cbiAgICovXG4gIGNhbk1pbmltaXplPzogYm9vbGVhbjtcbn1cblxuQFVudGlsRGVzdHJveSgpXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdpeC1qb2ItcHJvZ3Jlc3MtZGlhbG9nJyxcbiAgdGVtcGxhdGVVcmw6ICcuL2pvYi1wcm9ncmVzcy1kaWFsb2cuY29tcG9uZW50Lmh0bWwnLFxuICBzdHlsZVVybHM6IFsnLi9qb2ItcHJvZ3Jlc3MtZGlhbG9nLmNvbXBvbmVudC5zY3NzJ10sXG4gIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoLFxuICBzdGFuZGFsb25lOiB0cnVlLFxuICBpbXBvcnRzOiBbXG4gICAgTWF0RGlhbG9nVGl0bGUsXG4gICAgQ2RrU2Nyb2xsYWJsZSxcbiAgICBNYXREaWFsb2dDb250ZW50LFxuICAgIE1hdFByb2dyZXNzQmFyLFxuICAgIE1hdERpYWxvZ0FjdGlvbnMsXG4gICAgTWF0QnV0dG9uLFxuICAgIE1hdEljb25CdXR0b24sXG4gICAgTWF0RGlhbG9nQ2xvc2UsXG4gICAgSXhJY29uQ29tcG9uZW50LFxuICAgIFRyYW5zbGF0ZU1vZHVsZSxcbiAgICBEZWNpbWFsUGlwZSxcbiAgICBUZXN0RGlyZWN0aXZlLFxuICAgIFRlc3REaXJlY3RpdmUsXG4gIF0sXG59KVxuZXhwb3J0IGNsYXNzIEpvYlByb2dyZXNzRGlhbG9nQ29tcG9uZW50PFQ+IGltcGxlbWVudHMgT25Jbml0LCBBZnRlclZpZXdDaGVja2VkIHtcbiAgcmVhZG9ubHkgam9iU3VjY2VzcyA9IG91dHB1dDxKb2I8VD4+KCk7XG4gIHJlYWRvbmx5IGpvYkZhaWx1cmUgPSBvdXRwdXQ8dW5rbm93bj4oKTtcbiAgcmVhZG9ubHkgam9iQWJvcnRlZCA9IG91dHB1dDxKb2I8VD4+KCk7XG4gIHJlYWRvbmx5IGpvYlByb2dyZXNzID0gb3V0cHV0PEpvYlByb2dyZXNzPigpO1xuXG4gIHByb3RlY3RlZCBqb2IgPSB7fSBhcyBKb2I8VD47XG5cbiAgcmVhZG9ubHkgSm9iU3RhdGUgPSBKb2JTdGF0ZTtcblxuICBwcm90ZWN0ZWQgdGl0bGU6IHN0cmluZztcbiAgcHJvdGVjdGVkIGRlc2NyaXB0aW9uOiBzdHJpbmc7XG4gIHByaXZhdGUgcmVhbHRpbWVMb2dzU3Vic2NyaWJlZCA9IGZhbHNlO1xuICBwcm90ZWN0ZWQgcmVhbHRpbWVMb2dzID0gJyc7XG4gIHByb3RlY3RlZCBzaG93TWluaW1pemVCdXR0b24gPSB0cnVlO1xuICBwcm90ZWN0ZWQgcHJvZ3Jlc3NUb3RhbFBlcmNlbnQgPSAwO1xuICBwcm90ZWN0ZWQgaGlkZVByb2dyZXNzVmFsdWUgPSBmYWxzZTtcbiAgcHJvdGVjdGVkIHNob3dSZWFsdGltZUxvZ3MgPSBmYWxzZTtcblxuICBwcm90ZWN0ZWQgaXNBYm9ydGluZ0pvYiA9IGZhbHNlO1xuXG4gIGdldCBpc0pvYlJ1bm5pbmcoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuam9iPy5zdGF0ZSA9PT0gSm9iU3RhdGUuUnVubmluZztcbiAgfVxuXG4gIGdldCBoYXNBYm9ydEJ1dHRvbigpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5qb2IuYWJvcnRhYmxlICYmIFtKb2JTdGF0ZS5SdW5uaW5nLCBKb2JTdGF0ZS5XYWl0aW5nXS5pbmNsdWRlcyh0aGlzLmpvYj8uc3RhdGUpO1xuICB9XG5cbiAgZ2V0IGlzSm9iU3RhdGVEZXRlcm1pbmF0ZSgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gW1xuICAgICAgSm9iU3RhdGUuQWJvcnRlZCxcbiAgICAgIEpvYlN0YXRlLkVycm9yLFxuICAgICAgSm9iU3RhdGUuRmFpbGVkLFxuICAgICAgSm9iU3RhdGUuRmluaXNoZWQsXG4gICAgICBKb2JTdGF0ZS5TdWNjZXNzLFxuICAgIF0uaW5jbHVkZXModGhpcy5qb2I/LnN0YXRlKSB8fCB0aGlzLmlzSm9iUnVubmluZztcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgZGlhbG9nUmVmOiBNYXREaWFsb2dSZWY8Sm9iUHJvZ3Jlc3NEaWFsb2dDb21wb25lbnQ8VD4sIE1hdERpYWxvZ0NvbmZpZz4sXG4gICAgQEluamVjdChNQVRfRElBTE9HX0RBVEEpIHB1YmxpYyBkYXRhOiBKb2JQcm9ncmVzc0RpYWxvZ0NvbmZpZzxUPixcbiAgICBwcml2YXRlIHdzOiBXZWJTb2NrZXRTZXJ2aWNlLFxuICAgIHByaXZhdGUgY2RyOiBDaGFuZ2VEZXRlY3RvclJlZixcbiAgICBwcml2YXRlIGVycm9ySGFuZGxlcjogRXJyb3JIYW5kbGVyU2VydmljZSxcbiAgKSB7IH1cblxuICBuZ09uSW5pdCgpOiB2b2lkIHtcbiAgICB0aGlzLnRpdGxlID0gdGhpcy5kYXRhPy50aXRsZTtcbiAgICB0aGlzLmRlc2NyaXB0aW9uID0gdGhpcy5kYXRhPy5kZXNjcmlwdGlvbjtcbiAgICB0aGlzLnNob3dSZWFsdGltZUxvZ3MgPSB0aGlzLmRhdGE/LnNob3dSZWFsdGltZUxvZ3MgfHwgZmFsc2U7XG4gICAgdGhpcy5zaG93TWluaW1pemVCdXR0b24gPSB0aGlzLmRhdGE/LmNhbk1pbmltaXplIHx8IGZhbHNlO1xuICAgIHRoaXMuZGlhbG9nUmVmLmRpc2FibGVDbG9zZSA9ICF0aGlzLnNob3dNaW5pbWl6ZUJ1dHRvbjtcblxuICAgIGxldCBsb2dzU3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb24gPSBudWxsO1xuICAgIHRoaXMuY2RyLm1hcmtGb3JDaGVjaygpO1xuXG4gICAgdGhpcy5kYXRhLmpvYiQucGlwZShcbiAgICAgIHVudGlsRGVzdHJveWVkKHRoaXMpLFxuICAgICkuc3Vic2NyaWJlKHtcbiAgICAgIG5leHQ6IChqb2IpID0+IHtcbiAgICAgICAgdGhpcy5qb2IgPSBqb2I7XG4gICAgICAgIGlmICghdGhpcy50aXRsZSkge1xuICAgICAgICAgIHRoaXMudGl0bGUgPSB0aGlzLmpvYi5tZXRob2Q7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCF0aGlzLmRlc2NyaXB0aW9uKSB7XG4gICAgICAgICAgdGhpcy5kZXNjcmlwdGlvbiA9IHRoaXMuam9iLmRlc2NyaXB0aW9uO1xuICAgICAgICB9XG4gICAgICAgIGlmIChcbiAgICAgICAgICB0aGlzLmRhdGEuc2hvd1JlYWx0aW1lTG9nc1xuICAgICAgICAgICYmIHRoaXMuam9iLmxvZ3NfcGF0aFxuICAgICAgICAgICYmICF0aGlzLnJlYWx0aW1lTG9nc1N1YnNjcmliZWRcbiAgICAgICAgKSB7XG4gICAgICAgICAgbG9nc1N1YnNjcmlwdGlvbiA9IHRoaXMuZ2V0UmVhbHRpbWVMb2dzKCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGpvYi5wcm9ncmVzcyAmJiAhdGhpcy5kYXRhLnNob3dSZWFsdGltZUxvZ3MpIHtcbiAgICAgICAgICB0aGlzLmpvYlByb2dyZXNzLmVtaXQoam9iLnByb2dyZXNzKTtcbiAgICAgICAgICBpZiAoam9iLnByb2dyZXNzLmRlc2NyaXB0aW9uKSB7XG4gICAgICAgICAgICB0aGlzLmRlc2NyaXB0aW9uID0gam9iLnByb2dyZXNzLmRlc2NyaXB0aW9uO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoam9iLnByb2dyZXNzLnBlcmNlbnQpIHtcbiAgICAgICAgICAgIHRoaXMucHJvZ3Jlc3NUb3RhbFBlcmNlbnQgPSBqb2IucHJvZ3Jlc3MucGVyY2VudDtcbiAgICAgICAgICB9XG4gICAgICAgICAgdGhpcy5oaWRlUHJvZ3Jlc3NWYWx1ZSA9IGpvYi5wcm9ncmVzcy5wZXJjZW50ID09PSBudWxsO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5jZHIubWFya0ZvckNoZWNrKCk7XG4gICAgICB9LFxuICAgICAgZXJyb3I6IChlcnJvcjogdW5rbm93bikgPT4ge1xuICAgICAgICB0aGlzLmpvYkZhaWx1cmUuZW1pdChlcnJvcik7XG4gICAgICAgIHRoaXMuZGlhbG9nUmVmLmNsb3NlKCk7XG4gICAgICB9LFxuICAgICAgY29tcGxldGU6ICgpID0+IHtcbiAgICAgICAgc3dpdGNoICh0aGlzLmpvYi5zdGF0ZSkge1xuICAgICAgICAgIGNhc2UgSm9iU3RhdGUuRmFpbGVkOlxuICAgICAgICAgICAgdGhpcy5qb2JGYWlsdXJlLmVtaXQodGhpcy5qb2IpO1xuICAgICAgICAgICAgdGhpcy5kaWFsb2dSZWYuY2xvc2UoKTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGNhc2UgSm9iU3RhdGUuQWJvcnRlZDpcbiAgICAgICAgICAgIHRoaXMuam9iQWJvcnRlZC5lbWl0KHRoaXMuam9iKTtcbiAgICAgICAgICAgIHRoaXMuZGlhbG9nUmVmLmNsb3NlKCk7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBjYXNlIEpvYlN0YXRlLlN1Y2Nlc3M6XG4gICAgICAgICAgICB0aGlzLmpvYlN1Y2Nlc3MuZW1pdCh0aGlzLmpvYik7XG4gICAgICAgICAgICB0aGlzLmRpYWxvZ1JlZi5jbG9zZSgpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5yZWFsdGltZUxvZ3NTdWJzY3JpYmVkKSB7XG4gICAgICAgICAgbG9nc1N1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuY2RyLm1hcmtGb3JDaGVjaygpO1xuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIG5nQWZ0ZXJWaWV3Q2hlY2tlZCgpOiB2b2lkIHtcbiAgICB0aGlzLnNjcm9sbEJvdHRvbSgpO1xuICB9XG5cbiAgc2Nyb2xsQm90dG9tKCk6IHZvaWQge1xuICAgIGNvbnN0IGNhcmRDb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCdqb2ItZGlhbG9nJylbMF07XG4gICAgY29uc3QgbG9nc0NvbnRhaW5lciA9IGNhcmRDb250YWluZXIuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgnbG9ncy1jb250YWluZXInKVswXTtcbiAgICBpZiAoIWxvZ3NDb250YWluZXIpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgbG9nc0NvbnRhaW5lci5zY3JvbGxUb3AgPSBsb2dzQ29udGFpbmVyLnNjcm9sbEhlaWdodDtcbiAgICB0aGlzLmNkci5tYXJrRm9yQ2hlY2soKTtcbiAgfVxuXG4gIGFib3J0Sm9iKCk6IHZvaWQge1xuICAgIHRoaXMud3MuY2FsbCgnY29yZS5qb2JfYWJvcnQnLCBbdGhpcy5qb2IuaWRdKS5waXBlKFxuICAgICAgdGhpcy5lcnJvckhhbmRsZXIuY2F0Y2hFcnJvcigpLFxuICAgICAgdW50aWxEZXN0cm95ZWQodGhpcyksXG4gICAgKVxuICAgICAgLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICAgIHRoaXMuaXNBYm9ydGluZ0pvYiA9IHRydWU7XG4gICAgICAgIHRoaXMuY2RyLm1hcmtGb3JDaGVjaygpO1xuICAgICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogVGhpcyBtZXRob2QgcmV0dXJucyB0aGUgc3Vic2NyaXB0aW9uIGlkIHRoYXQgaXMgdXNlZCB3aGVuIHN1YnNjcmliaW5nIHRvIHJlYWwgdGltZVxuICAgKiB3ZWJzb2NrZXQgdXBkYXRlcy4gVGhlIHN1YnNjcmlwdGlvbiBpZCBpcyB1c2VkIHRvIHVuc3Vic2NyaWJlIGZvcm0gdGhvc2UgcmVhbCB0aW1lXG4gICAqIHdlYnNvY2tldCB1cGRhdGVzIGF0IGEgbGF0ZXIgdGltZS4gVW5zdWJzY3JpcHRpb24gaXMgbm90IHBvc3NpYmxlIHdpdGhvdXQgdGhpcyBpZFxuICAgKi9cbiAgZ2V0UmVhbHRpbWVMb2dzKCk6IFN1YnNjcmlwdGlvbiB7XG4gICAgdGhpcy5yZWFsdGltZUxvZ3NTdWJzY3JpYmVkID0gdHJ1ZTtcbiAgICBjb25zdCBzdWJOYW1lID0gJ2ZpbGVzeXN0ZW0uZmlsZV90YWlsX2ZvbGxvdzonICsgdGhpcy5qb2IubG9nc19wYXRoO1xuICAgIHRoaXMuY2RyLm1hcmtGb3JDaGVjaygpO1xuICAgIHJldHVybiB0aGlzLndzLnN1YnNjcmliZVRvTG9ncyhzdWJOYW1lKVxuICAgICAgLnBpcGUobWFwKChhcGlFdmVudCkgPT4gYXBpRXZlbnQuZmllbGRzKSwgdW50aWxEZXN0cm95ZWQodGhpcykpXG4gICAgICAuc3Vic2NyaWJlKChsb2dzKSA9PiB7XG4gICAgICAgIGlmIChsb2dzPy5kYXRhICYmIHR5cGVvZiBsb2dzLmRhdGEgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgdGhpcy5yZWFsdGltZUxvZ3MgKz0gbG9ncy5kYXRhO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuY2RyLm1hcmtGb3JDaGVjaygpO1xuICAgICAgfSk7XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==