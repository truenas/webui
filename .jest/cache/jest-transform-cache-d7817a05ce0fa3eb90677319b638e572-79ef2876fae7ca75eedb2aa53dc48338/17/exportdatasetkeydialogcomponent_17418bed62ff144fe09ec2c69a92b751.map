{"file":"/Users/macbook/karpov-work/TrueNAS/webui/src/app/pages/datasets/modules/encryption/components/export-dataset-key-dialog/export-dataset-key-dialog.component.ts","mappings":"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","names":[],"sources":["/Users/macbook/karpov-work/TrueNAS/webui/src/app/pages/datasets/modules/encryption/components/export-dataset-key-dialog/export-dataset-key-dialog.component.ts"],"sourcesContent":["import { HttpErrorResponse } from '@angular/common/http';\nimport {\n  ChangeDetectionStrategy, ChangeDetectorRef, Component, Inject, OnInit,\n} from '@angular/core';\nimport { MAT_DIALOG_DATA, MatDialogRef } from '@angular/material/dialog';\nimport { UntilDestroy, untilDestroyed } from '@ngneat/until-destroy';\nimport { switchMap } from 'rxjs/operators';\nimport { JobState } from 'app/enums/job-state.enum';\nimport { Dataset } from 'app/interfaces/dataset.interface';\nimport { Job } from 'app/interfaces/job.interface';\nimport { WebSocketError } from 'app/interfaces/websocket-error.interface';\nimport { DialogService } from 'app/modules/dialog/dialog.service';\nimport { AppLoaderService } from 'app/modules/loader/app-loader.service';\nimport { DownloadService } from 'app/services/download.service';\nimport { ErrorHandlerService } from 'app/services/error-handler.service';\nimport { WebSocketService } from 'app/services/ws.service';\n\n@UntilDestroy()\n@Component({\n  selector: 'ix-export-dataset-key-dialog',\n  templateUrl: './export-dataset-key-dialog.component.html',\n  styleUrls: ['./export-dataset-key-dialog.component.scss'],\n  changeDetection: ChangeDetectionStrategy.OnPush,\n})\nexport class ExportDatasetKeyDialogComponent implements OnInit {\n  key: string;\n\n  constructor(\n    private ws: WebSocketService,\n    private loader: AppLoaderService,\n    private errorHandler: ErrorHandlerService,\n    private dialogRef: MatDialogRef<ExportDatasetKeyDialogComponent>,\n    private dialogService: DialogService,\n    private storageService: DownloadService,\n    private cdr: ChangeDetectorRef,\n    @Inject(MAT_DIALOG_DATA) public dataset: Dataset,\n  ) { }\n\n  ngOnInit(): void {\n    this.loadKey();\n  }\n\n  onDownload(): void {\n    const fileName = `dataset_${this.dataset.name}_key.json`;\n    const mimetype = 'application/json';\n\n    this.ws.call('core.download', ['pool.dataset.export_key', [this.dataset.id, true], fileName])\n      .pipe(\n        this.loader.withLoader(),\n        switchMap(([, url]) => this.storageService.downloadUrl(url, fileName, mimetype)),\n        untilDestroyed(this),\n      )\n      .subscribe({\n        next: () => {\n          this.dialogRef.close();\n        },\n        error: (error: WebSocketError | HttpErrorResponse) => {\n          this.dialogService.error(this.errorHandler.parseError(error));\n        },\n      });\n  }\n\n  private loadKey(): void {\n    this.ws.job('pool.dataset.export_key', [this.dataset.id])\n      .pipe(this.loader.withLoader(), untilDestroyed(this))\n      .subscribe({\n        next: (job) => {\n          if (job.state === JobState.Failed) {\n            this.dialogService.error(this.errorHandler.parseError(job));\n          } else if (job.state !== JobState.Success) {\n            return;\n          }\n          this.key = job.result;\n          this.cdr.markForCheck();\n        },\n        error: (error: Job | WebSocketError) => {\n          this.dialogService.error(this.errorHandler.parseError(error));\n        },\n      });\n  }\n}\n"],"version":3}