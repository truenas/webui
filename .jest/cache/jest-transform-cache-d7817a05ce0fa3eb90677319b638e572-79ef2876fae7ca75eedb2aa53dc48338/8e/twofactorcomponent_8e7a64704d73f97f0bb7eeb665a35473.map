{"file":"/Users/macbook/karpov-work/TrueNAS/webui/src/app/pages/two-factor-auth/components/two-factor/two-factor.component.ts","mappings":"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","names":[],"sources":["/Users/macbook/karpov-work/TrueNAS/webui/src/app/pages/two-factor-auth/components/two-factor/two-factor.component.ts"],"sourcesContent":["import {\n  ChangeDetectionStrategy,\n  ChangeDetectorRef, Component, Inject, OnDestroy, OnInit,\n} from '@angular/core';\nimport { MatDialog } from '@angular/material/dialog';\nimport { UntilDestroy, untilDestroyed } from '@ngneat/until-destroy';\nimport { TranslateService } from '@ngx-translate/core';\nimport {\n  Observable, forkJoin, of,\n} from 'rxjs';\nimport {\n  catchError,\n  filter, switchMap, take, tap,\n} from 'rxjs/operators';\nimport { WINDOW } from 'app/helpers/window.helper';\nimport { helptext2fa } from 'app/helptext/system/2fa';\nimport { ErrorReport } from 'app/interfaces/error-report.interface';\nimport { WebSocketError } from 'app/interfaces/websocket-error.interface';\nimport { DialogService } from 'app/modules/dialog/dialog.service';\nimport { twoFactorElements } from 'app/pages/two-factor-auth/components/two-factor/two-factor.elements';\nimport { AuthService } from 'app/services/auth/auth.service';\nimport { WebSocketService } from 'app/services/ws.service';\n\n@UntilDestroy()\n@Component({\n  selector: 'ix-two-factor',\n  templateUrl: './two-factor.component.html',\n  styleUrls: ['./two-factor.component.scss'],\n  changeDetection: ChangeDetectionStrategy.OnPush,\n})\nexport class TwoFactorComponent implements OnInit, OnDestroy {\n  protected readonly searchableElements = twoFactorElements;\n\n  userTwoFactorAuthConfigured = false;\n  isDataLoading = false;\n  isFormLoading = false;\n  globalTwoFactorEnabled: boolean;\n  showQrCodeWarning = false;\n\n  get global2FaMsg(): string {\n    if (!this.globalTwoFactorEnabled) {\n      return this.translate.instant(helptext2fa.two_factor.global_disabled);\n    }\n    if (this.userTwoFactorAuthConfigured) {\n      return this.translate.instant(helptext2fa.two_factor.global_enabled_user_enabled);\n    }\n    return this.translate.instant(helptext2fa.two_factor.global_enabled_user_disabled);\n  }\n\n  readonly helptext = helptext2fa;\n\n  readonly labels = {\n    secret: helptext2fa.two_factor.secret.placeholder,\n    uri: helptext2fa.two_factor.uri.placeholder,\n  };\n\n  readonly tooltips = {\n    secret: helptext2fa.two_factor.secret.tooltip,\n    uri: helptext2fa.two_factor.uri.tooltip,\n  };\n\n  constructor(\n    public authService: AuthService,\n    private cdr: ChangeDetectorRef,\n    private dialogService: DialogService,\n    private translate: TranslateService,\n    protected matDialog: MatDialog,\n    private ws: WebSocketService,\n    @Inject(WINDOW) private window: Window,\n  ) {}\n\n  ngOnInit(): void {\n    this.loadTwoFactorConfigs();\n\n    this.showQrCodeWarning = this.window.localStorage.getItem('showQr2FaWarning') === 'true';\n  }\n\n  ngOnDestroy(): void {\n    this.window.localStorage.setItem('showQr2FaWarning', 'false');\n  }\n\n  loadTwoFactorConfigs(): void {\n    this.isDataLoading = true;\n    this.cdr.markForCheck();\n    forkJoin([\n      this.authService.userTwoFactorConfig$.pipe(take(1)),\n      this.authService.getGlobalTwoFactorConfig(),\n    ])\n      .pipe(untilDestroyed(this))\n      .subscribe({\n        next: ([userConfig, globalConfig]) => {\n          this.isDataLoading = false;\n          this.userTwoFactorAuthConfigured = userConfig.secret_configured;\n          this.globalTwoFactorEnabled = globalConfig.enabled;\n          this.cdr.markForCheck();\n        },\n      });\n  }\n\n  renewSecretOrEnable2Fa(): void {\n    this.getConfirmation().pipe(\n      filter(Boolean),\n      switchMap(() => this.renewSecretForUser()),\n      tap(() => this.toggleLoading(false)),\n      catchError((error: WebSocketError) => this.handleError(error)),\n      untilDestroyed(this),\n    ).subscribe();\n  }\n\n  getProvisioningUriSecret(uri: string): string {\n    const url = new URL(uri);\n    const params = new URLSearchParams(url.search);\n\n    return params.get('secret');\n  }\n\n  private handleError(error: WebSocketError): Observable<boolean> {\n    this.toggleLoading(false);\n\n    return this.dialogService.error({\n      title: helptext2fa.two_factor.error,\n      message: error.reason,\n      backtrace: error.trace?.formatted,\n    } as ErrorReport);\n  }\n\n  private renewSecretForUser(): Observable<void> {\n    this.toggleLoading(true);\n\n    this.window.localStorage.setItem('showQr2FaWarning', 'true');\n\n    return this.authService.user$.pipe(\n      take(1),\n      switchMap((user) => this.ws.call('user.renew_2fa_secret', [user.pw_name, { interval: 30, otp_digits: 6 }])),\n      switchMap(() => this.authService.refreshUser()),\n      tap(() => {\n        this.userTwoFactorAuthConfigured = true;\n        this.showQrCodeWarning = true;\n      }),\n      untilDestroyed(this),\n    );\n  }\n\n  private getConfirmation(): Observable<boolean> {\n    if (this.userTwoFactorAuthConfigured) {\n      return this.dialogService.confirm({\n        title: helptext2fa.two_factor.renewSecret.title,\n        message: helptext2fa.two_factor.renewSecret.message,\n        hideCheckbox: true,\n        buttonText: helptext2fa.two_factor.renewSecret.btn,\n      });\n    }\n    return of(true);\n  }\n\n  private toggleLoading(isLoading: boolean): void {\n    this.isFormLoading = isLoading;\n    this.cdr.markForCheck();\n  }\n}\n"],"version":3}