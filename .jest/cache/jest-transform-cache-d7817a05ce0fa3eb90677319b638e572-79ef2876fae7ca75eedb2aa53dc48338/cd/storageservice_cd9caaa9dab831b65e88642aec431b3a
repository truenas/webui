6c1bdeb963cd56aa8c97695b634fde83
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.StorageService = void 0;
const core_1 = require("@angular/core");
const operators_1 = require("rxjs/operators");
const bytes_constant_1 = require("app/constants/bytes.constant");
const v_dev_type_enum_1 = require("app/enums/v-dev-type.enum");
const ws_service_1 = require("app/services/ws.service");
let StorageService = class StorageService {
    constructor(ws) {
        this.ws = ws;
        this.diskResource = 'disk.query';
    }
    filesystemStat(path) {
        return this.ws.call('filesystem.stat', [path]);
    }
    listDisks() {
        return this.ws.call(this.diskResource, []);
    }
    getDatasetNameOptions() {
        return this.ws
            .call('pool.filesystem_choices')
            .pipe((0, operators_1.map)((response) => response.map((value) => ({ label: value, value }))));
    }
    /**
     * @param path The path of the dataset excluding "/mnt/"
     */
    isDatasetTopLevel(path) {
        if (typeof path !== 'string') {
            throw new Error('isDatasetTopLevel received "path" parameter that is not of type "string."');
        }
        /**
         * Strip leading forward slash if present
         * /zpool/d0 -> zpool/d0
         */
        path = path.startsWith('/') ? path.substring(1) : path;
        return !path.includes('/');
    }
    getRedundancyLevel(vdev) {
        switch (vdev.type) {
            case v_dev_type_enum_1.TopologyItemType.Disk:
            case v_dev_type_enum_1.TopologyItemType.Stripe:
                return 0;
            case v_dev_type_enum_1.TopologyItemType.Mirror:
                return vdev.children.length - 1;
            case v_dev_type_enum_1.TopologyItemType.Raidz:
            case v_dev_type_enum_1.TopologyItemType.Raidz1:
                return 1;
            case v_dev_type_enum_1.TopologyItemType.Raidz2:
                return 2;
            case v_dev_type_enum_1.TopologyItemType.Raidz3:
                return 3;
            default:
                // VDEV type property also includes values unrelated to layout.
                return -1;
        }
    }
    getVdevWidths(vdevs) {
        const allVdevWidths = new Set(); // There should only be one value
        vdevs === null || vdevs === void 0 ? void 0 : vdevs.forEach((vdev) => {
            let vdevWidthCounter = 0;
            if (vdev.type === v_dev_type_enum_1.TopologyItemType.Disk || vdev.type === v_dev_type_enum_1.TopologyItemType.Stripe || vdev.children.length === 0) {
                // Width of single disk VDEVs should be 1
                allVdevWidths.add(1);
            }
            else {
                vdev.children.forEach(() => {
                    vdevWidthCounter += 1;
                });
                allVdevWidths.add(vdevWidthCounter);
            }
        });
        return allVdevWidths;
    }
    isMixedWidth(allVdevWidths) {
        return allVdevWidths.size > 1;
    }
    // Get usable space on VDEV.
    getVdevCapacities(vdevs) {
        const allVdevCapacities = new Set(); // There should only be one value
        vdevs === null || vdevs === void 0 ? void 0 : vdevs.forEach((vdev) => {
            allVdevCapacities.add(vdev.stats.size);
        });
        return allVdevCapacities;
    }
    // Check to see if every VDEV has the same capacity. Best practices dictate every vdev should be uniform
    isMixedVdevCapacity(allVdevCapacities) {
        const max = Math.max(...allVdevCapacities);
        const min = Math.min(...allVdevCapacities);
        const fivePercentOfMax = max * (5 / 100);
        return min + fivePercentOfMax + bytes_constant_1.GiB * 2 < max;
    }
    getVdevDiskCapacities(vdevs, disks) {
        const allDiskCapacities = [];
        vdevs === null || vdevs === void 0 ? void 0 : vdevs.forEach((vdev) => {
            const vdevDiskCapacities = new Set(); // There should only be one value
            if (vdev.children.length) {
                vdev.children.forEach((child) => {
                    const diskIndex = disks === null || disks === void 0 ? void 0 : disks.findIndex((disk) => disk.name === child.disk);
                    if (diskIndex >= 0 && disks[diskIndex].size) {
                        vdevDiskCapacities.add(disks[diskIndex].size);
                    }
                });
            }
            else {
                // Topology items of type DISK will not have children
                vdevDiskCapacities.add(vdev.stats.size);
            }
            allDiskCapacities.push(vdevDiskCapacities);
        });
        return allDiskCapacities;
    }
    // Check to see if any individual VDEVs have non-uniform disk sizes.
    // Every disk in a VDEV should ideally be the same size
    isMixedVdevDiskCapacity(allVdevDiskCapacities) {
        const isMixed = allVdevDiskCapacities.filter((vdev) => vdev.size > 1);
        return isMixed.length > 0;
    }
    getVdevTypes(vdevs) {
        const vdevTypes = new Set();
        vdevs === null || vdevs === void 0 ? void 0 : vdevs.forEach((vdev) => {
            vdevTypes.add(vdev.type);
        });
        return vdevTypes;
    }
    isMixedVdevType(vdevTypes) {
        return vdevTypes.size > 1;
    }
    validateVdevs(category, vdevs, disks) {
        const warnings = [];
        let isMixedVdevCapacity = false;
        let isMixedDiskCapacity = false;
        let isMixedWidth = false;
        let isMixedLayout = false;
        // Check for non-uniform VDEV Capacities
        const allVdevCapacities = this.getVdevCapacities(vdevs); // There should only be one value
        isMixedVdevCapacity = this.isMixedVdevCapacity(allVdevCapacities);
        // Check for non-uniform Disk Capacities within each VDEV
        const allVdevDiskCapacities = this.getVdevDiskCapacities(vdevs, disks);
        isMixedDiskCapacity = this.isMixedVdevDiskCapacity(allVdevDiskCapacities);
        // Check VDEV Widths
        const allVdevWidths = this.getVdevWidths(vdevs); // There should only be one value
        isMixedWidth = this.isMixedWidth(allVdevWidths);
        // While not recommended, ZFS does allow creating a pool with mixed VDEV types.
        // Even though the UI does not allow such pools to be created,
        // users might still try to import such a pool.
        const allVdevLayouts = this.getVdevTypes(vdevs);
        isMixedLayout = this.isMixedVdevType(allVdevLayouts);
        if (vdevs.length) {
            if (isMixedLayout) {
                warnings.push(v_dev_type_enum_1.TopologyWarning.MixedVdevLayout);
            }
            if (isMixedDiskCapacity) {
                warnings.push(v_dev_type_enum_1.TopologyWarning.MixedDiskCapacity);
            }
            if (isMixedVdevCapacity) {
                warnings.push(v_dev_type_enum_1.TopologyWarning.MixedVdevCapacity);
            }
            if (isMixedWidth) {
                warnings.push(v_dev_type_enum_1.TopologyWarning.MixedVdevWidth);
            }
            // Check Redundancy
            if ([v_dev_type_enum_1.VdevType.Data, v_dev_type_enum_1.VdevType.Dedup, v_dev_type_enum_1.VdevType.Special].includes(category)
                && this.hasZeroRedundancyLevelVdev(vdevs)) {
                warnings.push(v_dev_type_enum_1.TopologyWarning.NoRedundancy);
            }
        }
        return warnings;
    }
    hasZeroRedundancyLevelVdev(vdevs) {
        return vdevs.filter((vdev) => this.getRedundancyLevel(vdev) === 0).length > 0;
    }
};
exports.StorageService = StorageService;
StorageService.ctorParameters = () => [
    { type: ws_service_1.WebSocketService }
];
exports.StorageService = StorageService = __decorate([
    (0, core_1.Injectable)({ providedIn: 'root' })
], StorageService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21hY2Jvb2sva2FycG92LXdvcmsvVHJ1ZU5BUy93ZWJ1aS9zcmMvYXBwL3NlcnZpY2VzL3N0b3JhZ2Uuc2VydmljZS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBQSx3Q0FBMkM7QUFFM0MsOENBQXFDO0FBQ3JDLGlFQUFtRDtBQUNuRCwrREFBd0Y7QUFLeEYsd0RBQTJEO0FBR3BELElBQU0sY0FBYyxHQUFwQixNQUFNLGNBQWM7SUFHekIsWUFDWSxFQUFvQjtRQUFwQixPQUFFLEdBQUYsRUFBRSxDQUFrQjtRQUh0QixpQkFBWSxHQUFHLFlBQXFCLENBQUM7SUFJNUMsQ0FBQztJQUVKLGNBQWMsQ0FBQyxJQUFZO1FBQ3pCLE9BQU8sSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQ2pELENBQUM7SUFFRCxTQUFTO1FBQ1AsT0FBTyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQzdDLENBQUM7SUFFRCxxQkFBcUI7UUFDbkIsT0FBTyxJQUFJLENBQUMsRUFBRTthQUNYLElBQUksQ0FBQyx5QkFBeUIsQ0FBQzthQUMvQixJQUFJLENBQUMsSUFBQSxlQUFHLEVBQUMsQ0FBQyxRQUFRLEVBQUUsRUFBRSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUMsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDakYsQ0FBQztJQUVEOztPQUVHO0lBQ0gsaUJBQWlCLENBQUMsSUFBWTtRQUM1QixJQUFJLE9BQU8sSUFBSSxLQUFLLFFBQVEsRUFBRSxDQUFDO1lBQzdCLE1BQU0sSUFBSSxLQUFLLENBQUMsMkVBQTJFLENBQUMsQ0FBQztRQUMvRixDQUFDO1FBRUQ7OztXQUdHO1FBQ0gsSUFBSSxHQUFHLElBQUksQ0FBQyxV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Q3pDLENBQUM7Z0JBQ0QsUUFBUSxDQUFDLElBQUksQ0FBQyxpQ0FBZSxDQUFDLFlBQVksQ0FBQyxDQUFDO1lBQzlDLENBQUM7UUFDSCxDQUFDO1FBRUQsT0FBTyxRQUFRLENBQUM7SUFDbEIsQ0FBQztJQUVPLDBCQUEwQixDQUFDLEtBQXFCO1FBQ3RELE9BQU8sS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUM7SUFDaEYsQ0FBQzs7QUF2TVUsd0NBQWM7Ozs7eUJBQWQsY0FBYztJQUQxQixJQUFBLGlCQUFVLEVBQUMsRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLENBQUM7R0FDdEIsY0FBYyxDQXdNMUIiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL21hY2Jvb2sva2FycG92LXdvcmsvVHJ1ZU5BUy93ZWJ1aS9zcmMvYXBwL3NlcnZpY2VzL3N0b3JhZ2Uuc2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBHaUIgfSBmcm9tICdhcHAvY29uc3RhbnRzL2J5dGVzLmNvbnN0YW50JztcbmltcG9ydCB7IFRvcG9sb2d5SXRlbVR5cGUsIFRvcG9sb2d5V2FybmluZywgVmRldlR5cGUgfSBmcm9tICdhcHAvZW51bXMvdi1kZXYtdHlwZS5lbnVtJztcbmltcG9ydCB7IERpc2sgfSBmcm9tICdhcHAvaW50ZXJmYWNlcy9kaXNrLmludGVyZmFjZSc7XG5pbXBvcnQgeyBGaWxlU3lzdGVtU3RhdCB9IGZyb20gJ2FwcC9pbnRlcmZhY2VzL2ZpbGVzeXN0ZW0tc3RhdC5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgT3B0aW9uIH0gZnJvbSAnYXBwL2ludGVyZmFjZXMvb3B0aW9uLmludGVyZmFjZSc7XG5pbXBvcnQgeyBUb3BvbG9neUl0ZW0gfSBmcm9tICdhcHAvaW50ZXJmYWNlcy9zdG9yYWdlLmludGVyZmFjZSc7XG5pbXBvcnQgeyBXZWJTb2NrZXRTZXJ2aWNlIH0gZnJvbSAnYXBwL3NlcnZpY2VzL3dzLnNlcnZpY2UnO1xuXG5ASW5qZWN0YWJsZSh7IHByb3ZpZGVkSW46ICdyb290JyB9KVxuZXhwb3J0IGNsYXNzIFN0b3JhZ2VTZXJ2aWNlIHtcbiAgcHJvdGVjdGVkIGRpc2tSZXNvdXJjZSA9ICdkaXNrLnF1ZXJ5JyBhcyBjb25zdDtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcm90ZWN0ZWQgd3M6IFdlYlNvY2tldFNlcnZpY2UsXG4gICkge31cblxuICBmaWxlc3lzdGVtU3RhdChwYXRoOiBzdHJpbmcpOiBPYnNlcnZhYmxlPEZpbGVTeXN0ZW1TdGF0PiB7XG4gICAgcmV0dXJuIHRoaXMud3MuY2FsbCgnZmlsZXN5c3RlbS5zdGF0JywgW3BhdGhdKTtcbiAgfVxuXG4gIGxpc3REaXNrcygpOiBPYnNlcnZhYmxlPERpc2tbXT4ge1xuICAgIHJldHVybiB0aGlzLndzLmNhbGwodGhpcy5kaXNrUmVzb3VyY2UsIFtdKTtcbiAgfVxuXG4gIGdldERhdGFzZXROYW1lT3B0aW9ucygpOiBPYnNlcnZhYmxlPE9wdGlvbltdPiB7XG4gICAgcmV0dXJuIHRoaXMud3NcbiAgICAgIC5jYWxsKCdwb29sLmZpbGVzeXN0ZW1fY2hvaWNlcycpXG4gICAgICAucGlwZShtYXAoKHJlc3BvbnNlKSA9PiByZXNwb25zZS5tYXAoKHZhbHVlKSA9PiAoeyBsYWJlbDogdmFsdWUsIHZhbHVlIH0pKSkpO1xuICB9XG5cbiAgLyoqXG4gICAqIEBwYXJhbSBwYXRoIFRoZSBwYXRoIG9mIHRoZSBkYXRhc2V0IGV4Y2x1ZGluZyBcIi9tbnQvXCJcbiAgICovXG4gIGlzRGF0YXNldFRvcExldmVsKHBhdGg6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIGlmICh0eXBlb2YgcGF0aCAhPT0gJ3N0cmluZycpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignaXNEYXRhc2V0VG9wTGV2ZWwgcmVjZWl2ZWQgXCJwYXRoXCIgcGFyYW1ldGVyIHRoYXQgaXMgbm90IG9mIHR5cGUgXCJzdHJpbmcuXCInKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTdHJpcCBsZWFkaW5nIGZvcndhcmQgc2xhc2ggaWYgcHJlc2VudFxuICAgICAqIC96cG9vbC9kMCAtPiB6cG9vbC9kMFxuICAgICAqL1xuICAgIHBhdGggPSBwYXRoLnN0YXJ0c1dpdGgoJy8nKSA/IHBhdGguc3Vic3RyaW5nKDEpIDogcGF0aDtcblxuICAgIHJldHVybiAhcGF0aC5pbmNsdWRlcygnLycpO1xuICB9XG5cbiAgZ2V0UmVkdW5kYW5jeUxldmVsKHZkZXY6IFRvcG9sb2d5SXRlbSk6IG51bWJlciB7XG4gICAgc3dpdGNoICh2ZGV2LnR5cGUpIHtcbiAgICAgIGNhc2UgVG9wb2xvZ3lJdGVtVHlwZS5EaXNrOlxuICAgICAgY2FzZSBUb3BvbG9neUl0ZW1UeXBlLlN0cmlwZTpcbiAgICAgICAgcmV0dXJuIDA7XG4gICAgICBjYXNlIFRvcG9sb2d5SXRlbVR5cGUuTWlycm9yOlxuICAgICAgICByZXR1cm4gdmRldi5jaGlsZHJlbi5sZW5ndGggLSAxO1xuICAgICAgY2FzZSBUb3BvbG9neUl0ZW1UeXBlLlJhaWR6OlxuICAgICAgY2FzZSBUb3BvbG9neUl0ZW1UeXBlLlJhaWR6MTpcbiAgICAgICAgcmV0dXJuIDE7XG4gICAgICBjYXNlIFRvcG9sb2d5SXRlbVR5cGUuUmFpZHoyOlxuICAgICAgICByZXR1cm4gMjtcbiAgICAgIGNhc2UgVG9wb2xvZ3lJdGVtVHlwZS5SYWlkejM6XG4gICAgICAgIHJldHVybiAzO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgLy8gVkRFViB0eXBlIHByb3BlcnR5IGFsc28gaW5jbHVkZXMgdmFsdWVzIHVucmVsYXRlZCB0byBsYXlvdXQuXG4gICAgICAgIHJldHVybiAtMTtcbiAgICB9XG4gIH1cblxuICBnZXRWZGV2V2lkdGhzKHZkZXZzOiBUb3BvbG9neUl0ZW1bXSk6IFNldDxudW1iZXI+IHtcbiAgICBjb25zdCBhbGxWZGV2V2lkdGhzID0gbmV3IFNldDxudW1iZXI+KCk7IC8vIFRoZXJlIHNob3VsZCBvbmx5IGJlIG9uZSB2YWx1ZVxuXG4gICAgdmRldnM/LmZvckVhY2goKHZkZXYpID0+IHtcbiAgICAgIGxldCB2ZGV2V2lkdGhDb3VudGVyID0gMDtcblxuICAgICAgaWYgKHZkZXYudHlwZSA9PT0gVG9wb2xvZ3lJdGVtVHlwZS5EaXNrIHx8IHZkZXYudHlwZSA9PT0gVG9wb2xvZ3lJdGVtVHlwZS5TdHJpcGUgfHwgdmRldi5jaGlsZHJlbi5sZW5ndGggPT09IDApIHtcbiAgICAgICAgLy8gV2lkdGggb2Ygc2luZ2xlIGRpc2sgVkRFVnMgc2hvdWxkIGJlIDFcbiAgICAgICAgYWxsVmRldldpZHRocy5hZGQoMSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB2ZGV2LmNoaWxkcmVuLmZvckVhY2goKCkgPT4ge1xuICAgICAgICAgIHZkZXZXaWR0aENvdW50ZXIgKz0gMTtcbiAgICAgICAgfSk7XG4gICAgICAgIGFsbFZkZXZXaWR0aHMuYWRkKHZkZXZXaWR0aENvdW50ZXIpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIGFsbFZkZXZXaWR0aHM7XG4gIH1cblxuICBpc01peGVkV2lkdGgoYWxsVmRldldpZHRoczogU2V0PG51bWJlcj4pOiBib29sZWFuIHtcbiAgICByZXR1cm4gYWxsVmRldldpZHRocy5zaXplID4gMTtcbiAgfVxuXG4gIC8vIEdldCB1c2FibGUgc3BhY2Ugb24gVkRFVi5cbiAgZ2V0VmRldkNhcGFjaXRpZXModmRldnM6IFRvcG9sb2d5SXRlbVtdKTogU2V0PG51bWJlcj4ge1xuICAgIGNvbnN0IGFsbFZkZXZDYXBhY2l0aWVzID0gbmV3IFNldDxudW1iZXI+KCk7IC8vIFRoZXJlIHNob3VsZCBvbmx5IGJlIG9uZSB2YWx1ZVxuICAgIHZkZXZzPy5mb3JFYWNoKCh2ZGV2KSA9PiB7XG4gICAgICBhbGxWZGV2Q2FwYWNpdGllcy5hZGQodmRldi5zdGF0cy5zaXplKTtcbiAgICB9KTtcbiAgICByZXR1cm4gYWxsVmRldkNhcGFjaXRpZXM7XG4gIH1cblxuICAvLyBDaGVjayB0byBzZWUgaWYgZXZlcnkgVkRFViBoYXMgdGhlIHNhbWUgY2FwYWNpdHkuIEJlc3QgcHJhY3RpY2VzIGRpY3RhdGUgZXZlcnkgdmRldiBzaG91bGQgYmUgdW5pZm9ybVxuICBpc01peGVkVmRldkNhcGFjaXR5KGFsbFZkZXZDYXBhY2l0aWVzOiBTZXQ8bnVtYmVyPik6IGJvb2xlYW4ge1xuICAgIGNvbnN0IG1heCA9IE1hdGgubWF4KC4uLmFsbFZkZXZDYXBhY2l0aWVzKTtcbiAgICBjb25zdCBtaW4gPSBNYXRoLm1pbiguLi5hbGxWZGV2Q2FwYWNpdGllcyk7XG4gICAgY29uc3QgZml2ZVBlcmNlbnRPZk1heCA9IG1heCAqICg1IC8gMTAwKTtcblxuICAgIHJldHVybiBtaW4gKyBmaXZlUGVyY2VudE9mTWF4ICsgR2lCICogMiA8IG1heDtcbiAgfVxuXG4gIGdldFZkZXZEaXNrQ2FwYWNpdGllcyh2ZGV2czogVG9wb2xvZ3lJdGVtW10sIGRpc2tzOiBEaXNrW10pOiBTZXQ8bnVtYmVyPltdIHtcbiAgICBjb25zdCBhbGxEaXNrQ2FwYWNpdGllczogU2V0PG51bWJlcj5bXSA9IFtdO1xuICAgIHZkZXZzPy5mb3JFYWNoKCh2ZGV2KSA9PiB7XG4gICAgICBjb25zdCB2ZGV2RGlza0NhcGFjaXRpZXMgPSBuZXcgU2V0PG51bWJlcj4oKTsgLy8gVGhlcmUgc2hvdWxkIG9ubHkgYmUgb25lIHZhbHVlXG4gICAgICBpZiAodmRldi5jaGlsZHJlbi5sZW5ndGgpIHtcbiAgICAgICAgdmRldi5jaGlsZHJlbi5mb3JFYWNoKChjaGlsZCkgPT4ge1xuICAgICAgICAgIGNvbnN0IGRpc2tJbmRleCA9IGRpc2tzPy5maW5kSW5kZXgoKGRpc2spID0+IGRpc2submFtZSA9PT0gY2hpbGQuZGlzayk7XG4gICAgICAgICAgaWYgKGRpc2tJbmRleCA+PSAwICYmIGRpc2tzW2Rpc2tJbmRleF0uc2l6ZSkge1xuICAgICAgICAgICAgdmRldkRpc2tDYXBhY2l0aWVzLmFkZChkaXNrc1tkaXNrSW5kZXhdLnNpemUpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBUb3BvbG9neSBpdGVtcyBvZiB0eXBlIERJU0sgd2lsbCBub3QgaGF2ZSBjaGlsZHJlblxuICAgICAgICB2ZGV2RGlza0NhcGFjaXRpZXMuYWRkKHZkZXYuc3RhdHMuc2l6ZSk7XG4gICAgICB9XG4gICAgICBhbGxEaXNrQ2FwYWNpdGllcy5wdXNoKHZkZXZEaXNrQ2FwYWNpdGllcyk7XG4gICAgfSk7XG4gICAgcmV0dXJuIGFsbERpc2tDYXBhY2l0aWVzO1xuICB9XG5cbiAgLy8gQ2hlY2sgdG8gc2VlIGlmIGFueSBpbmRpdmlkdWFsIFZERVZzIGhhdmUgbm9uLXVuaWZvcm0gZGlzayBzaXplcy5cbiAgLy8gRXZlcnkgZGlzayBpbiBhIFZERVYgc2hvdWxkIGlkZWFsbHkgYmUgdGhlIHNhbWUgc2l6ZVxuICBpc01peGVkVmRldkRpc2tDYXBhY2l0eShhbGxWZGV2RGlza0NhcGFjaXRpZXM6IFNldDxudW1iZXI+W10pOiBib29sZWFuIHtcbiAgICBjb25zdCBpc01peGVkID0gYWxsVmRldkRpc2tDYXBhY2l0aWVzLmZpbHRlcigodmRldikgPT4gdmRldi5zaXplID4gMSk7XG4gICAgcmV0dXJuIGlzTWl4ZWQubGVuZ3RoID4gMDtcbiAgfVxuXG4gIGdldFZkZXZUeXBlcyh2ZGV2czogVG9wb2xvZ3lJdGVtW10pOiBTZXQ8c3RyaW5nPiB7XG4gICAgY29uc3QgdmRldlR5cGVzID0gbmV3IFNldDxzdHJpbmc+KCk7XG4gICAgdmRldnM/LmZvckVhY2goKHZkZXYpID0+IHtcbiAgICAgIHZkZXZUeXBlcy5hZGQodmRldi50eXBlKTtcbiAgICB9KTtcbiAgICByZXR1cm4gdmRldlR5cGVzO1xuICB9XG5cbiAgaXNNaXhlZFZkZXZUeXBlKHZkZXZUeXBlczogU2V0PHN0cmluZz4pOiBib29sZWFuIHtcbiAgICByZXR1cm4gdmRldlR5cGVzLnNpemUgPiAxO1xuICB9XG5cbiAgdmFsaWRhdGVWZGV2cyhcbiAgICBjYXRlZ29yeTogVmRldlR5cGUsXG4gICAgdmRldnM6IFRvcG9sb2d5SXRlbVtdLFxuICAgIGRpc2tzOiBEaXNrW10sXG4gICk6IHN0cmluZ1tdIHtcbiAgICBjb25zdCB3YXJuaW5nczogc3RyaW5nW10gPSBbXTtcbiAgICBsZXQgaXNNaXhlZFZkZXZDYXBhY2l0eSA9IGZhbHNlO1xuICAgIGxldCBpc01peGVkRGlza0NhcGFjaXR5ID0gZmFsc2U7XG4gICAgbGV0IGlzTWl4ZWRXaWR0aCA9IGZhbHNlO1xuICAgIGxldCBpc01peGVkTGF5b3V0ID0gZmFsc2U7XG5cbiAgICAvLyBDaGVjayBmb3Igbm9uLXVuaWZvcm0gVkRFViBDYXBhY2l0aWVzXG4gICAgY29uc3QgYWxsVmRldkNhcGFjaXRpZXM6IFNldDxudW1iZXI+ID0gdGhpcy5nZXRWZGV2Q2FwYWNpdGllcyh2ZGV2cyk7IC8vIFRoZXJlIHNob3VsZCBvbmx5IGJlIG9uZSB2YWx1ZVxuICAgIGlzTWl4ZWRWZGV2Q2FwYWNpdHkgPSB0aGlzLmlzTWl4ZWRWZGV2Q2FwYWNpdHkoYWxsVmRldkNhcGFjaXRpZXMpO1xuXG4gICAgLy8gQ2hlY2sgZm9yIG5vbi11bmlmb3JtIERpc2sgQ2FwYWNpdGllcyB3aXRoaW4gZWFjaCBWREVWXG4gICAgY29uc3QgYWxsVmRldkRpc2tDYXBhY2l0aWVzOiBTZXQ8bnVtYmVyPltdID0gdGhpcy5nZXRWZGV2RGlza0NhcGFjaXRpZXModmRldnMsIGRpc2tzKTtcbiAgICBpc01peGVkRGlza0NhcGFjaXR5ID0gdGhpcy5pc01peGVkVmRldkRpc2tDYXBhY2l0eShhbGxWZGV2RGlza0NhcGFjaXRpZXMpO1xuXG4gICAgLy8gQ2hlY2sgVkRFViBXaWR0aHNcbiAgICBjb25zdCBhbGxWZGV2V2lkdGhzOiBTZXQ8bnVtYmVyPiA9IHRoaXMuZ2V0VmRldldpZHRocyh2ZGV2cyk7IC8vIFRoZXJlIHNob3VsZCBvbmx5IGJlIG9uZSB2YWx1ZVxuICAgIGlzTWl4ZWRXaWR0aCA9IHRoaXMuaXNNaXhlZFdpZHRoKGFsbFZkZXZXaWR0aHMpO1xuXG4gICAgLy8gV2hpbGUgbm90IHJlY29tbWVuZGVkLCBaRlMgZG9lcyBhbGxvdyBjcmVhdGluZyBhIHBvb2wgd2l0aCBtaXhlZCBWREVWIHR5cGVzLlxuICAgIC8vIEV2ZW4gdGhvdWdoIHRoZSBVSSBkb2VzIG5vdCBhbGxvdyBzdWNoIHBvb2xzIHRvIGJlIGNyZWF0ZWQsXG4gICAgLy8gdXNlcnMgbWlnaHQgc3RpbGwgdHJ5IHRvIGltcG9ydCBzdWNoIGEgcG9vbC5cbiAgICBjb25zdCBhbGxWZGV2TGF5b3V0cyA9IHRoaXMuZ2V0VmRldlR5cGVzKHZkZXZzKTtcbiAgICBpc01peGVkTGF5b3V0ID0gdGhpcy5pc01peGVkVmRldlR5cGUoYWxsVmRldkxheW91dHMpO1xuXG4gICAgaWYgKHZkZXZzLmxlbmd0aCkge1xuICAgICAgaWYgKGlzTWl4ZWRMYXlvdXQpIHtcbiAgICAgICAgd2FybmluZ3MucHVzaChUb3BvbG9neVdhcm5pbmcuTWl4ZWRWZGV2TGF5b3V0KTtcbiAgICAgIH1cblxuICAgICAgaWYgKGlzTWl4ZWREaXNrQ2FwYWNpdHkpIHtcbiAgICAgICAgd2FybmluZ3MucHVzaChUb3BvbG9neVdhcm5pbmcuTWl4ZWREaXNrQ2FwYWNpdHkpO1xuICAgICAgfVxuXG4gICAgICBpZiAoaXNNaXhlZFZkZXZDYXBhY2l0eSkge1xuICAgICAgICB3YXJuaW5ncy5wdXNoKFRvcG9sb2d5V2FybmluZy5NaXhlZFZkZXZDYXBhY2l0eSk7XG4gICAgICB9XG5cbiAgICAgIGlmIChpc01peGVkV2lkdGgpIHtcbiAgICAgICAgd2FybmluZ3MucHVzaChUb3BvbG9neVdhcm5pbmcuTWl4ZWRWZGV2V2lkdGgpO1xuICAgICAgfVxuXG4gICAgICAvLyBDaGVjayBSZWR1bmRhbmN5XG4gICAgICBpZiAoXG4gICAgICAgIFtWZGV2VHlwZS5EYXRhLCBWZGV2VHlwZS5EZWR1cCwgVmRldlR5cGUuU3BlY2lhbF0uaW5jbHVkZXMoY2F0ZWdvcnkpXG4gICAgICAgICYmIHRoaXMuaGFzWmVyb1JlZHVuZGFuY3lMZXZlbFZkZXYodmRldnMpXG4gICAgICApIHtcbiAgICAgICAgd2FybmluZ3MucHVzaChUb3BvbG9neVdhcm5pbmcuTm9SZWR1bmRhbmN5KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gd2FybmluZ3M7XG4gIH1cblxuICBwcml2YXRlIGhhc1plcm9SZWR1bmRhbmN5TGV2ZWxWZGV2KHZkZXZzOiBUb3BvbG9neUl0ZW1bXSk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB2ZGV2cy5maWx0ZXIoKHZkZXYpID0+IHRoaXMuZ2V0UmVkdW5kYW5jeUxldmVsKHZkZXYpID09PSAwKS5sZW5ndGggPiAwO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=