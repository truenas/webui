bf905aa17dd5dd8172ba647da0f707ff
"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const testing_1 = require("@angular/core/testing");
const jest_1 = require("@ngneat/spectator/jest");
const core_1 = require("@ngx-translate/core");
const angular2_uuid_1 = require("angular2-uuid");
const rxjs_1 = require("rxjs");
const api_message_type_enum_1 = require("app/enums/api-message-type.enum");
const job_state_enum_1 = require("app/enums/job-state.enum");
const websocket_connection_service_1 = require("app/services/websocket-connection.service");
const ws_service_1 = require("app/services/ws.service");
const mockWebSocketConnectionService = {
    send: jest.fn(),
    buildSubscriber: jest.fn().mockReturnValue(new rxjs_1.Subject()),
    websocket$: new rxjs_1.BehaviorSubject(null),
};
const apiEventSubscription1$ = new rxjs_1.BehaviorSubject(null);
const apiEventSubscription2$ = new rxjs_1.BehaviorSubject(null);
const mockEventSubscriptions = new Map([
    ['event1', apiEventSubscription1$],
    ['event2', apiEventSubscription2$],
]);
describe('WebSocketService', () => {
    let service;
    beforeEach(() => {
        testing_1.TestBed.configureTestingModule({
            providers: [
                ws_service_1.WebSocketService,
                (0, jest_1.mockProvider)(core_1.TranslateService),
                { provide: websocket_connection_service_1.WebSocketConnectionService, useValue: mockWebSocketConnectionService },
            ],
        });
        service = testing_1.TestBed.inject(ws_service_1.WebSocketService);
        jest.spyOn(service.clearSubscriptions$, 'next');
        service.eventSubscribers = mockEventSubscriptions;
        jest.clearAllMocks();
    });
    describe('call', () => {
        it('should make a WS call and get a response', () => {
            const uuid = 'fakeUUID';
            jest.spyOn(angular2_uuid_1.UUID, 'UUID').mockReturnValue(uuid);
            mockWebSocketConnectionService.websocket$.next({
                id: uuid,
                msg: api_message_type_enum_1.IncomingApiMessageType.Result,
                result: {},
            });
            service.call('cloudsync.providers').subscribe((result) => {
                // TODO: Actually do nothing
                expect(result).toEqual({});
            });
            expect(mockWebSocketConnectionService.send).toHaveBeenCalled();
        });
        it('should handle WS call errors', () => {
            jest.spyOn(console, 'error').mockImplementation();
            const uuid = 'fakeUUID';
            jest.spyOn(angular2_uuid_1.UUID, 'UUID').mockReturnValue(uuid);
            mockWebSocketConnectionService.websocket$.next({
                id: uuid,
                msg: api_message_type_enum_1.IncomingApiMessageType.Result,
                error: 'Test Error',
            });
            service.call('cloudsync.providers').subscribe({
                next: () => { },
                error: (error) => {
                    expect(error).toBe('Test Error');
                },
            });
        });
    });
    describe('callAndSubscribe', () => {
        it('should call and subscribe to updates', () => __awaiter(void 0, void 0, void 0, function* () {
            const pools = [{ name: 'pool1' }, { name: 'pool2' }];
            const uuid = 'fakeUUID';
            jest.spyOn(angular2_uuid_1.UUID, 'UUID').mockReturnValue(uuid);
            mockWebSocketConnectionService.websocket$.next({
                id: uuid,
                msg: api_message_type_enum_1.IncomingApiMessageType.Result,
                result: pools,
            });
            expect(yield (0, rxjs_1.firstValueFrom)(service.callAndSubscribe('pool.query'))).toEqual([
                { name: 'pool1' }, { name: 'pool2' },
            ]);
        }));
    });
    describe('job', () => {
        it('should start a job successfully', () => {
            const uuid = 'fakeUUID';
            const mockJobId = 1234;
            jest.spyOn(angular2_uuid_1.UUID, 'UUID').mockReturnValue(uuid);
            mockWebSocketConnectionService.websocket$.next({
                id: uuid,
                msg: api_message_type_enum_1.IncomingApiMessageType.Result,
                result: mockJobId,
            });
            service.startJob('boot.attach').subscribe((response) => {
                expect(response).toEqual(mockJobId);
            });
        });
        it('should handle a successful job', () => {
            service.job('boot.attach').subscribe((result) => {
                expect(result.state).toEqual(job_state_enum_1.JobState.Failed);
            });
        });
    });
    describe('subscribe', () => {
        it('should successfully subscribe', () => {
            const eventData = { data: 'test' };
            mockWebSocketConnectionService.buildSubscriber().next(eventData);
            service.subscribe('alert.list').subscribe((data) => {
                // TODO: Actually do nothing
                expect(data).toEqual({});
            });
            expect(mockWebSocketConnectionService.buildSubscriber).toHaveBeenCalled();
        });
    });
    describe('subscribeToLogs', () => {
        it('should successfully subscribe to logs', () => {
            const logData = { data: 'log test' };
            mockWebSocketConnectionService.buildSubscriber().next(logData);
            service.subscribeToLogs('logName').subscribe((data) => {
                // TODO: Actually do nothing
                expect(data).toEqual({});
            });
        });
    });
    describe('clearSubscriptions', () => {
        it('should clear all event subscriptions', () => {
            service.clearSubscriptions();
            expect(service.clearSubscriptions$.next).toHaveBeenCalled();
            expect(mockEventSubscriptions.size).toBe(0);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21hY2Jvb2sva2FycG92LXdvcmsvVHJ1ZU5BUy93ZWJ1aS9zcmMvYXBwL3NlcnZpY2VzL3dzLnNlcnZpY2Uuc3BlYy50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBLG1EQUFnRDtBQUNoRCxpREFBc0Q7QUFDdEQsOENBQXVEO0FBQ3ZELGlEQUFxQztBQUNyQywrQkFJYztBQUNkLDJFQUF5RTtBQUN6RSw2REFBb0Q7QUFHcEQsNEZBQXVGO0FBQ3ZGLHdEQUEyRDtBQUUzRCxNQUFNLDhCQUE4QixHQUFHO0lBQ3JDLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO0lBQ2YsZUFBZSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxlQUFlLENBQUMsSUFBSSxjQUFPLEVBQVcsQ0FBQztJQUNsRSxVQUFVLEVBQUUsSUFBSSxzQkFBZSxDQUFVLElBQUksQ0FBQztDQUMvQyxDQUFDO0FBRUYsTUFBTSxzQkFBc0IsR0FBRyxJQUFJLHNCQUFlLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDekQsTUFBTSxzQkFBc0IsR0FBRyxJQUFJLHNCQUFlLENBQUMsSUFBSSxDQUFDLENBQUM7QUFFekQsTUFBTSxzQkFBc0IsR0FBRyxJQUFJLEdBQUcsQ0FBK0I7SUFDbkUsQ0FBQyxRQUFRLEVBQUUsc0JBQXNCLENBQUM7SUFDbEMsQ0FBQyxRQUFRLEVBQUUsc0JBQXNCLENBQUM7Q0FDbkMsQ0FBQyxDQUFDO0FBRUgsUUFBUSxDQUFDLGtCQUFrQixFQUFFLEdBQUcsRUFBRTtJQUNoQyxJQUFJLE9BQXlCLENBQUM7SUFFOUIsVUFBVSxDQUFDLEdBQUcsRUFBRTtRQUNkLGlCQUFPLENBQUMsc0JBQXNCLENBQUM7WUFDN0IsU0FBUyxFQUFFO2dCQUNULDZCQUFnQjtnQkFDaEIsSUFBQSxtQkFBWSxFQUFDLHVCQUFnQixDQUFDO2dCQUM5QixFQUFFLE9BQU8sRUFBRSx5REFBMEIsRUFBRSxRQUFRLEVBQUUsOEJBQThCLEVBQUU7YUFDbEY7U0FDRixDQUFDLENBQUM7UUFFSCxPQUFPLEdB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QUUsQ0FBQyxzQ0FBc0MsRUFBRSxHQUFHLEVBQUU7WUFDOUMsT0FBTyxDQUFDLGtCQUFrQixFQUFFLENBQUM7WUFFN0IsTUFBTSxDQUFDLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1lBQzVELE1BQU0sQ0FBQyxzQkFBc0IsQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDOUMsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9tYWNib29rL2thcnBvdi13b3JrL1RydWVOQVMvd2VidWkvc3JjL2FwcC9zZXJ2aWNlcy93cy5zZXJ2aWNlLnNwZWMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVGVzdEJlZCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUvdGVzdGluZyc7XG5pbXBvcnQgeyBtb2NrUHJvdmlkZXIgfSBmcm9tICdAbmduZWF0L3NwZWN0YXRvci9qZXN0JztcbmltcG9ydCB7IFRyYW5zbGF0ZVNlcnZpY2UgfSBmcm9tICdAbmd4LXRyYW5zbGF0ZS9jb3JlJztcbmltcG9ydCB7IFVVSUQgfSBmcm9tICdhbmd1bGFyMi11dWlkJztcbmltcG9ydCB7XG4gIEJlaGF2aW9yU3ViamVjdCwgT2JzZXJ2YWJsZSxcbiAgU3ViamVjdCxcbiAgZmlyc3RWYWx1ZUZyb20sXG59IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgSW5jb21pbmdBcGlNZXNzYWdlVHlwZSB9IGZyb20gJ2FwcC9lbnVtcy9hcGktbWVzc2FnZS10eXBlLmVudW0nO1xuaW1wb3J0IHsgSm9iU3RhdGUgfSBmcm9tICdhcHAvZW51bXMvam9iLXN0YXRlLmVudW0nO1xuaW1wb3J0IHsgQXBpRXZlbnQgfSBmcm9tICdhcHAvaW50ZXJmYWNlcy9hcGktbWVzc2FnZS5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgUG9vbCB9IGZyb20gJ2FwcC9pbnRlcmZhY2VzL3Bvb2wuaW50ZXJmYWNlJztcbmltcG9ydCB7IFdlYlNvY2tldENvbm5lY3Rpb25TZXJ2aWNlIH0gZnJvbSAnYXBwL3NlcnZpY2VzL3dlYnNvY2tldC1jb25uZWN0aW9uLnNlcnZpY2UnO1xuaW1wb3J0IHsgV2ViU29ja2V0U2VydmljZSB9IGZyb20gJ2FwcC9zZXJ2aWNlcy93cy5zZXJ2aWNlJztcblxuY29uc3QgbW9ja1dlYlNvY2tldENvbm5lY3Rpb25TZXJ2aWNlID0ge1xuICBzZW5kOiBqZXN0LmZuKCksXG4gIGJ1aWxkU3Vic2NyaWJlcjogamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZShuZXcgU3ViamVjdDx1bmtub3duPigpKSxcbiAgd2Vic29ja2V0JDogbmV3IEJlaGF2aW9yU3ViamVjdDx1bmtub3duPihudWxsKSxcbn07XG5cbmNvbnN0IGFwaUV2ZW50U3Vic2NyaXB0aW9uMSQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0KG51bGwpO1xuY29uc3QgYXBpRXZlbnRTdWJzY3JpcHRpb24yJCA9IG5ldyBCZWhhdmlvclN1YmplY3QobnVsbCk7XG5cbmNvbnN0IG1vY2tFdmVudFN1YnNjcmlwdGlvbnMgPSBuZXcgTWFwPHN0cmluZywgT2JzZXJ2YWJsZTxBcGlFdmVudD4+KFtcbiAgWydldmVudDEnLCBhcGlFdmVudFN1YnNjcmlwdGlvbjEkXSxcbiAgWydldmVudDInLCBhcGlFdmVudFN1YnNjcmlwdGlvbjIkXSxcbl0pO1xuXG5kZXNjcmliZSgnV2ViU29ja2V0U2VydmljZScsICgpID0+IHtcbiAgbGV0IHNlcnZpY2U6IFdlYlNvY2tldFNlcnZpY2U7XG5cbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgVGVzdEJlZC5jb25maWd1cmVUZXN0aW5nTW9kdWxlKHtcbiAgICAgIHByb3ZpZGVyczogW1xuICAgICAgICBXZWJTb2NrZXRTZXJ2aWNlLFxuICAgICAgICBtb2NrUHJvdmlkZXIoVHJhbnNsYXRlU2VydmljZSksXG4gICAgICAgIHsgcHJvdmlkZTogV2ViU29ja2V0Q29ubmVjdGlvblNlcnZpY2UsIHVzZVZhbHVlOiBtb2NrV2ViU29ja2V0Q29ubmVjdGlvblNlcnZpY2UgfSxcbiAgICAgIF0sXG4gICAgfSk7XG5cbiAgICBzZXJ2aWNlID0gVGVzdEJlZC5pbmplY3QoV2ViU29ja2V0U2VydmljZSk7XG5cbiAgICBqZXN0LnNweU9uKHNlcnZpY2UuY2xlYXJTdWJzY3JpcHRpb25zJCwgJ25leHQnKTtcblxuICAgIChzZXJ2aWNlIGFzIHVua25vd24gYXMge1xuICAgICAgZXZlbnRTdWJzY3JpYmVyczogTWFwPHN0cmluZywgT2JzZXJ2YWJsZTxBcGlFdmVudD4+O1xuICAgIH0pLmV2ZW50U3Vic2NyaWJlcnMgPSBtb2NrRXZlbnRTdWJzY3JpcHRpb25zO1xuXG4gICAgamVzdC5jbGVhckFsbE1vY2tzKCk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdjYWxsJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgbWFrZSBhIFdTIGNhbGwgYW5kIGdldCBhIHJlc3BvbnNlJywgKCkgPT4ge1xuICAgICAgY29uc3QgdXVpZCA9ICdmYWtlVVVJRCc7XG4gICAgICBqZXN0LnNweU9uKFVVSUQsICdVVUlEJykubW9ja1JldHVyblZhbHVlKHV1aWQpO1xuICAgICAgbW9ja1dlYlNvY2tldENvbm5lY3Rpb25TZXJ2aWNlLndlYnNvY2tldCQubmV4dCh7XG4gICAgICAgIGlkOiB1dWlkLFxuICAgICAgICBtc2c6IEluY29taW5nQXBpTWVzc2FnZVR5cGUuUmVzdWx0LFxuICAgICAgICByZXN1bHQ6IHt9LFxuICAgICAgfSk7XG5cbiAgICAgIHNlcnZpY2UuY2FsbCgnY2xvdWRzeW5jLnByb3ZpZGVycycpLnN1YnNjcmliZSgocmVzdWx0KSA9PiB7XG4gICAgICAgIC8vIFRPRE86IEFjdHVhbGx5IGRvIG5vdGhpbmdcbiAgICAgICAgZXhwZWN0KHJlc3VsdCkudG9FcXVhbCh7fSk7XG4gICAgICB9KTtcblxuICAgICAgZXhwZWN0KG1vY2tXZWJTb2NrZXRDb25uZWN0aW9uU2VydmljZS5zZW5kKS50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGhhbmRsZSBXUyBjYWxsIGVycm9ycycsICgpID0+IHtcbiAgICAgIGplc3Quc3B5T24oY29uc29sZSwgJ2Vycm9yJykubW9ja0ltcGxlbWVudGF0aW9uKCk7XG4gICAgICBjb25zdCB1dWlkID0gJ2Zha2VVVUlEJztcbiAgICAgIGplc3Quc3B5T24oVVVJRCwgJ1VVSUQnKS5tb2NrUmV0dXJuVmFsdWUodXVpZCk7XG4gICAgICBtb2NrV2ViU29ja2V0Q29ubmVjdGlvblNlcnZpY2Uud2Vic29ja2V0JC5uZXh0KHtcbiAgICAgICAgaWQ6IHV1aWQsXG4gICAgICAgIG1zZzogSW5jb21pbmdBcGlNZXNzYWdlVHlwZS5SZXN1bHQsXG4gICAgICAgIGVycm9yOiAnVGVzdCBFcnJvcicsXG4gICAgICB9KTtcblxuICAgICAgc2VydmljZS5jYWxsKCdjbG91ZHN5bmMucHJvdmlkZXJzJykuc3Vic2NyaWJlKFxuICAgICAgICB7XG4gICAgICAgICAgbmV4dDogKCkgPT4ge30sXG4gICAgICAgICAgZXJyb3I6IChlcnJvcikgPT4ge1xuICAgICAgICAgICAgZXhwZWN0KGVycm9yKS50b0JlKCdUZXN0IEVycm9yJyk7XG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdjYWxsQW5kU3Vic2NyaWJlJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgY2FsbCBhbmQgc3Vic2NyaWJlIHRvIHVwZGF0ZXMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBwb29scyA9IFt7IG5hbWU6ICdwb29sMScgfSwgeyBuYW1lOiAncG9vbDInIH1dIGFzIFBvb2xbXTtcbiAgICAgIGNvbnN0IHV1aWQgPSAnZmFrZVVVSUQnO1xuICAgICAgamVzdC5zcHlPbihVVUlELCAnVVVJRCcpLm1vY2tSZXR1cm5WYWx1ZSh1dWlkKTtcbiAgICAgIG1vY2tXZWJTb2NrZXRDb25uZWN0aW9uU2VydmljZS53ZWJzb2NrZXQkLm5leHQoe1xuICAgICAgICBpZDogdXVpZCxcbiAgICAgICAgbXNnOiBJbmNvbWluZ0FwaU1lc3NhZ2VUeXBlLlJlc3VsdCxcbiAgICAgICAgcmVzdWx0OiBwb29scyxcbiAgICAgIH0pO1xuXG4gICAgICBleHBlY3QoYXdhaXQgZmlyc3RWYWx1ZUZyb20oc2VydmljZS5jYWxsQW5kU3Vic2NyaWJlKCdwb29sLnF1ZXJ5JykpKS50b0VxdWFsKFtcbiAgICAgICAgeyBuYW1lOiAncG9vbDEnIH0sIHsgbmFtZTogJ3Bvb2wyJyB9LFxuICAgICAgXSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdqb2InLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBzdGFydCBhIGpvYiBzdWNjZXNzZnVsbHknLCAoKSA9PiB7XG4gICAgICBjb25zdCB1dWlkID0gJ2Zha2VVVUlEJztcbiAgICAgIGNvbnN0IG1vY2tKb2JJZCA9IDEyMzQ7XG4gICAgICBqZXN0LnNweU9uKFVVSUQsICdVVUlEJykubW9ja1JldHVyblZhbHVlKHV1aWQpO1xuICAgICAgbW9ja1dlYlNvY2tldENvbm5lY3Rpb25TZXJ2aWNlLndlYnNvY2tldCQubmV4dCh7XG4gICAgICAgIGlkOiB1dWlkLFxuICAgICAgICBtc2c6IEluY29taW5nQXBpTWVzc2FnZVR5cGUuUmVzdWx0LFxuICAgICAgICByZXN1bHQ6IG1vY2tKb2JJZCxcbiAgICAgIH0pO1xuXG4gICAgICBzZXJ2aWNlLnN0YXJ0Sm9iKCdib290LmF0dGFjaCcpLnN1YnNjcmliZSgocmVzcG9uc2UpID0+IHtcbiAgICAgICAgZXhwZWN0KHJlc3BvbnNlKS50b0VxdWFsKG1vY2tKb2JJZCk7XG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaGFuZGxlIGEgc3VjY2Vzc2Z1bCBqb2InLCAoKSA9PiB7XG4gICAgICBzZXJ2aWNlLmpvYignYm9vdC5hdHRhY2gnKS5zdWJzY3JpYmUoKHJlc3VsdCkgPT4ge1xuICAgICAgICBleHBlY3QocmVzdWx0LnN0YXRlKS50b0VxdWFsKEpvYlN0YXRlLkZhaWxlZCk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ3N1YnNjcmliZScsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHN1Y2Nlc3NmdWxseSBzdWJzY3JpYmUnLCAoKSA9PiB7XG4gICAgICBjb25zdCBldmVudERhdGEgPSB7IGRhdGE6ICd0ZXN0JyB9O1xuICAgICAgKG1vY2tXZWJTb2NrZXRDb25uZWN0aW9uU2VydmljZS5idWlsZFN1YnNjcmliZXIoKSBhcyBTdWJqZWN0PHVua25vd24+KS5uZXh0KGV2ZW50RGF0YSk7XG5cbiAgICAgIHNlcnZpY2Uuc3Vic2NyaWJlKCdhbGVydC5saXN0Jykuc3Vic2NyaWJlKChkYXRhKSA9PiB7XG4gICAgICAgIC8vIFRPRE86IEFjdHVhbGx5IGRvIG5vdGhpbmdcbiAgICAgICAgZXhwZWN0KGRhdGEpLnRvRXF1YWwoe30pO1xuICAgICAgfSk7XG5cbiAgICAgIGV4cGVjdChtb2NrV2ViU29ja2V0Q29ubmVjdGlvblNlcnZpY2UuYnVpbGRTdWJzY3JpYmVyKS50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdzdWJzY3JpYmVUb0xvZ3MnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBzdWNjZXNzZnVsbHkgc3Vic2NyaWJlIHRvIGxvZ3MnLCAoKSA9PiB7XG4gICAgICBjb25zdCBsb2dEYXRhID0geyBkYXRhOiAnbG9nIHRlc3QnIH07XG4gICAgICAobW9ja1dlYlNvY2tldENvbm5lY3Rpb25TZXJ2aWNlLmJ1aWxkU3Vic2NyaWJlcigpIGFzIFN1YmplY3Q8dW5rbm93bj4pLm5leHQobG9nRGF0YSk7XG5cbiAgICAgIHNlcnZpY2Uuc3Vic2NyaWJlVG9Mb2dzKCdsb2dOYW1lJykuc3Vic2NyaWJlKChkYXRhKSA9PiB7XG4gICAgICAgIC8vIFRPRE86IEFjdHVhbGx5IGRvIG5vdGhpbmdcbiAgICAgICAgZXhwZWN0KGRhdGEpLnRvRXF1YWwoe30pO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdjbGVhclN1YnNjcmlwdGlvbnMnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBjbGVhciBhbGwgZXZlbnQgc3Vic2NyaXB0aW9ucycsICgpID0+IHtcbiAgICAgIHNlcnZpY2UuY2xlYXJTdWJzY3JpcHRpb25zKCk7XG5cbiAgICAgIGV4cGVjdChzZXJ2aWNlLmNsZWFyU3Vic2NyaXB0aW9ucyQubmV4dCkudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgICAgZXhwZWN0KG1vY2tFdmVudFN1YnNjcmlwdGlvbnMuc2l6ZSkudG9CZSgwKTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdLCJ2ZXJzaW9uIjozfQ==