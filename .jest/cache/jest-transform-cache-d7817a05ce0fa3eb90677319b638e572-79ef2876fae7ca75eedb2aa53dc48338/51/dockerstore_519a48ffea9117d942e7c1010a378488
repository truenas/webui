597bf899af96d3694bacc6601d2716aa
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.DockerStore = void 0;
const core_1 = require("@angular/core");
const component_store_1 = require("@ngrx/component-store");
const core_2 = require("@ngx-translate/core");
const rxjs_1 = require("rxjs");
const docker_status_enum_1 = require("app/enums/docker-status.enum");
const job_state_enum_1 = require("app/enums/job-state.enum");
const dialog_service_1 = require("app/modules/dialog/dialog.service");
const error_handler_service_1 = require("app/services/error-handler.service");
const ws_service_1 = require("app/services/ws.service");
const initialState = {
    isLoading: false,
    dockerConfig: null,
    nvidiaDriversInstalled: false,
    lacksNvidiaDrivers: false,
    statusData: {
        status: null,
        description: null,
    },
};
let DockerStore = class DockerStore extends component_store_1.ComponentStore {
    constructor(ws, dialogService, translate, errorHandler) {
        super(initialState);
        this.ws = ws;
        this.dialogService = dialogService;
        this.translate = translate;
        this.errorHandler = errorHandler;
        this.isLoading$ = this.select((state) => state.isLoading);
        this.dockerConfig$ = this.select((state) => state.dockerConfig);
        this.selectedPool$ = this.select((state) => { var _a; return ((_a = state.dockerConfig) === null || _a === void 0 ? void 0 : _a.pool) || null; });
        this.nvidiaDriversInstalled$ = this.select((state) => state.nvidiaDriversInstalled);
        this.lacksNvidiaDrivers$ = this.select((state) => state.lacksNvidiaDrivers);
        this.isDockerStarted$ = this.select((state) => docker_status_enum_1.DockerStatus.Running === state.statusData.status);
        this.status$ = this.select((state) => state.statusData.status);
        this.statusDescription$ = this.select((state) => state.statusData.description);
        this.initialize = this.effect((trigger$) => {
            return trigger$.pipe((0, rxjs_1.tap)(() => {
                this.patchState({
                    isLoading: true,
                });
            }), (0, rxjs_1.switchMap)(() => (0, rxjs_1.forkJoin)([
                this.getDockerConfig(),
                this.getDockerStatus(),
                this.getLacksNvidiaDrivers(),
            ])), (0, rxjs_1.tap)(([dockerConfig, statusData, lacksNvidiaDrivers]) => {
                this.patchState({
                    dockerConfig,
                    nvidiaDriversInstalled: dockerConfig.nvidia,
                    lacksNvidiaDrivers,
                    statusData,
                    isLoading: false,
                });
            }));
        });
    }
    getDockerConfig() {
        return this.ws.call('docker.config');
    }
    getLacksNvidiaDrivers() {
        return this.ws.call('docker.lacks_nvidia_drivers');
    }
    getDockerStatus() {
        return this.ws.call('docker.status');
    }
    setDockerPool(poolName) {
        return this.dialogService.jobDialog(this.ws.job('docker.update', [{ pool: poolName }]), { title: this.translate.instant('Configuring...') })
            .afterClosed()
            .pipe((0, rxjs_1.tap)((job) => {
            if (job.state === job_state_enum_1.JobState.Success) {
                this.patchState((state) => (Object.assign(Object.assign({}, state), { dockerConfig: Object.assign(Object.assign({}, state.dockerConfig), { pool: poolName }) })));
            }
            else if ([job_state_enum_1.JobState.Failed, job_state_enum_1.JobState.Aborted, job_state_enum_1.JobState.Error].includes(job.state)) {
                this.patchState((state) => (Object.assign(Object.assign({}, state), { dockerConfig: Object.assign(Object.assign({}, state.dockerConfig), { pool: null }) })));
            }
        }), this.errorHandler.catchError());
    }
    reloadDockerConfig() {
        return this.getDockerConfig().pipe((0, rxjs_1.tap)((dockerConfig) => {
            this.patchState({ dockerConfig });
        }));
    }
    setDockerNvidia(nvidiaDriversInstalled) {
        return this.dialogService.jobDialog(this.ws.job('docker.update', [{ nvidia: nvidiaDriversInstalled }]), { title: this.translate.instant('Configuring...') })
            .afterClosed()
            .pipe((0, rxjs_1.tap)((job) => {
            if (job.state === job_state_enum_1.JobState.Success) {
                this.patchState({
                    nvidiaDriversInstalled,
                });
            }
        }), this.errorHandler.catchError());
    }
    /**
     * Updates docker status in `DockerStore` service
     * @returns An observable that should be subscribed to at component level. This event subscription should only
     * stay alive until the component subscription stays alive i.e., until the component is destroyed
     */
    dockerStatusEventUpdates() {
        return this.ws.subscribe('docker.state').pipe((0, rxjs_1.map)((event) => event.fields), (0, rxjs_1.tap)((statusData) => {
            this.patchState({ statusData });
        }));
    }
};
exports.DockerStore = DockerStore;
DockerStore.ctorParameters = () => [
    { type: ws_service_1.WebSocketService },
    { type: dialog_service_1.DialogService },
    { type: core_2.TranslateService },
    { type: error_handler_service_1.ErrorHandlerService }
];
exports.DockerStore = DockerStore = __decorate([
    (0, core_1.Injectable)()
], DockerStore);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21hY2Jvb2sva2FycG92LXdvcmsvVHJ1ZU5BUy93ZWJ1aS9zcmMvYXBwL3BhZ2VzL2FwcHMvc3RvcmUvZG9ja2VyLnN0b3JlLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBLHdDQUEyQztBQUMzQywyREFBdUQ7QUFDdkQsOENBQXVEO0FBQ3ZELCtCQUVjO0FBRWQscUVBQTREO0FBQzVELDZEQUFvRDtBQUVwRCxzRUFBa0U7QUFDbEUsOEVBQXlFO0FBQ3pFLHdEQUEyRDtBQVUzRCxNQUFNLFlBQVksR0FBc0I7SUFDdEMsU0FBUyxFQUFFLEtBQUs7SUFDaEIsWUFBWSxFQUFFLElBQUk7SUFDbEIsc0JBQXNCLEVBQUUsS0FBSztJQUM3QixrQkFBa0IsRUFBRSxLQUFLO0lBQ3pCLFVBQVUsRUFBRTtRQUNWLE1BQU0sRUFBRSxJQUFJO1FBQ1osV0FBVyxFQUFFLElBQUk7S0FDbEI7Q0FDRixDQUFDO0FBR0ssSUFBTSxXQUFXLEdBQWpCLE1BQU0sV0FBWSxTQUFRLGdDQUFpQztJQVVoRSxZQUNVLEVBQW9CLEVBQ3BCLGFBQTRCLEVBQzVCLFNBQTJCLEVBQzNCLFlBQWlDO1FBRXpDLEtBQUssQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUxaLE9BQUUsR0FBRixFQUFFLENBQWtCO1FBQ3BCLGtCQUFhLEdBQWIsYUFBYSxDQUFlO1FBQzVCLGNBQVMsR0FBVCxTQUFTLENBQWtCO1FBQzNCLGlCQUFZLEdBQVosWUFBWSxDQUFxQjtRQWJsQyxlQUFVLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3JELGtCQUFhLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQzNELGtCQUFhLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFLFdBQUMsT0FBQSxDQUFBLE1BQUEsS0FBSyxD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QUFRLENBQUMsT0FBTyxFQUFFLENBQUM7Z0JBQ25DLElBQUksQ0FBQyxVQUFVLENBQUM7b0JBQ2Qsc0JBQXNCO2lCQUN2QixDQUFDLENBQUM7WUFDTCxDQUFDO1FBQ0gsQ0FBQyxDQUFDLEVBQ0YsSUFBSSxDQUFDLFlBQVksQ0FBQyxVQUFVLEVBQUUsQ0FDL0IsQ0FBQztJQUNOLENBQUM7SUFFRDs7OztPQUlHO0lBQ0gsd0JBQXdCO1FBQ3RCLE9BQU8sSUFBSSxDQUFDLEVBQUUsQ0FBQyxTQUFTLENBQUMsY0FBYyxDQUFDLENBQUMsSUFBSSxDQUMzQyxJQUFBLFVBQUcsRUFBQyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxFQUM1QixJQUFBLFVBQUcsRUFBQyxDQUFDLFVBQVUsRUFBRSxFQUFFO1lBQ2pCLElBQUksQ0FBQyxVQUFVLENBQUMsRUFBRSxVQUFVLEVBQUUsQ0FBQyxDQUFDO1FBQ2xDLENBQUMsQ0FBQyxDQUNILENBQUM7SUFDSixDQUFDOztBQTdIVSxrQ0FBVzs7Ozs7OztzQkFBWCxXQUFXO0lBRHZCLElBQUEsaUJBQVUsR0FBRTtHQUNBLFdBQVcsQ0E4SHZCIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9tYWNib29rL2thcnBvdi13b3JrL1RydWVOQVMvd2VidWkvc3JjL2FwcC9wYWdlcy9hcHBzL3N0b3JlL2RvY2tlci5zdG9yZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBDb21wb25lbnRTdG9yZSB9IGZyb20gJ0BuZ3J4L2NvbXBvbmVudC1zdG9yZSc7XG5pbXBvcnQgeyBUcmFuc2xhdGVTZXJ2aWNlIH0gZnJvbSAnQG5neC10cmFuc2xhdGUvY29yZSc7XG5pbXBvcnQge1xuICBmb3JrSm9pbiwgbWFwLCBPYnNlcnZhYmxlLCBzd2l0Y2hNYXAsIHRhcCxcbn0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBEb2NrZXJDb25maWcsIERvY2tlclN0YXR1c0RhdGEgfSBmcm9tICdhcHAvZW51bXMvZG9ja2VyLWNvbmZpZy5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgRG9ja2VyU3RhdHVzIH0gZnJvbSAnYXBwL2VudW1zL2RvY2tlci1zdGF0dXMuZW51bSc7XG5pbXBvcnQgeyBKb2JTdGF0ZSB9IGZyb20gJ2FwcC9lbnVtcy9qb2Itc3RhdGUuZW51bSc7XG5pbXBvcnQgeyBKb2IgfSBmcm9tICdhcHAvaW50ZXJmYWNlcy9qb2IuaW50ZXJmYWNlJztcbmltcG9ydCB7IERpYWxvZ1NlcnZpY2UgfSBmcm9tICdhcHAvbW9kdWxlcy9kaWFsb2cvZGlhbG9nLnNlcnZpY2UnO1xuaW1wb3J0IHsgRXJyb3JIYW5kbGVyU2VydmljZSB9IGZyb20gJ2FwcC9zZXJ2aWNlcy9lcnJvci1oYW5kbGVyLnNlcnZpY2UnO1xuaW1wb3J0IHsgV2ViU29ja2V0U2VydmljZSB9IGZyb20gJ2FwcC9zZXJ2aWNlcy93cy5zZXJ2aWNlJztcblxuZXhwb3J0IGludGVyZmFjZSBEb2NrZXJDb25maWdTdGF0ZSB7XG4gIGlzTG9hZGluZzogYm9vbGVhbjtcbiAgZG9ja2VyQ29uZmlnOiBEb2NrZXJDb25maWc7XG4gIG52aWRpYURyaXZlcnNJbnN0YWxsZWQ6IGJvb2xlYW47XG4gIGxhY2tzTnZpZGlhRHJpdmVyczogYm9vbGVhbjtcbiAgc3RhdHVzRGF0YTogRG9ja2VyU3RhdHVzRGF0YTtcbn1cblxuY29uc3QgaW5pdGlhbFN0YXRlOiBEb2NrZXJDb25maWdTdGF0ZSA9IHtcbiAgaXNMb2FkaW5nOiBmYWxzZSxcbiAgZG9ja2VyQ29uZmlnOiBudWxsLFxuICBudmlkaWFEcml2ZXJzSW5zdGFsbGVkOiBmYWxzZSxcbiAgbGFja3NOdmlkaWFEcml2ZXJzOiBmYWxzZSxcbiAgc3RhdHVzRGF0YToge1xuICAgIHN0YXR1czogbnVsbCxcbiAgICBkZXNjcmlwdGlvbjogbnVsbCxcbiAgfSxcbn07XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBEb2NrZXJTdG9yZSBleHRlbmRzIENvbXBvbmVudFN0b3JlPERvY2tlckNvbmZpZ1N0YXRlPiB7XG4gIHJlYWRvbmx5IGlzTG9hZGluZyQgPSB0aGlzLnNlbGVjdCgoc3RhdGUpID0+IHN0YXRlLmlzTG9hZGluZyk7XG4gIHJlYWRvbmx5IGRvY2tlckNvbmZpZyQgPSB0aGlzLnNlbGVjdCgoc3RhdGUpID0+IHN0YXRlLmRvY2tlckNvbmZpZyk7XG4gIHJlYWRvbmx5IHNlbGVjdGVkUG9vbCQgPSB0aGlzLnNlbGVjdCgoc3RhdGUpID0+IHN0YXRlLmRvY2tlckNvbmZpZz8ucG9vbCB8fCBudWxsKTtcbiAgcmVhZG9ubHkgbnZpZGlhRHJpdmVyc0luc3RhbGxlZCQgPSB0aGlzLnNlbGVjdCgoc3RhdGUpID0+IHN0YXRlLm52aWRpYURyaXZlcnNJbnN0YWxsZWQpO1xuICByZWFkb25seSBsYWNrc052aWRpYURyaXZlcnMkID0gdGhpcy5zZWxlY3QoKHN0YXRlKSA9PiBzdGF0ZS5sYWNrc052aWRpYURyaXZlcnMpO1xuICByZWFkb25seSBpc0RvY2tlclN0YXJ0ZWQkID0gdGhpcy5zZWxlY3QoKHN0YXRlKSA9PiBEb2NrZXJTdGF0dXMuUnVubmluZyA9PT0gc3RhdGUuc3RhdHVzRGF0YS5zdGF0dXMpO1xuICByZWFkb25seSBzdGF0dXMkID0gdGhpcy5zZWxlY3QoKHN0YXRlKSA9PiBzdGF0ZS5zdGF0dXNEYXRhLnN0YXR1cyk7XG4gIHJlYWRvbmx5IHN0YXR1c0Rlc2NyaXB0aW9uJCA9IHRoaXMuc2VsZWN0KChzdGF0ZSkgPT4gc3RhdGUuc3RhdHVzRGF0YS5kZXNjcmlwdGlvbik7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSB3czogV2ViU29ja2V0U2VydmljZSxcbiAgICBwcml2YXRlIGRpYWxvZ1NlcnZpY2U6IERpYWxvZ1NlcnZpY2UsXG4gICAgcHJpdmF0ZSB0cmFuc2xhdGU6IFRyYW5zbGF0ZVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBlcnJvckhhbmRsZXI6IEVycm9ySGFuZGxlclNlcnZpY2UsXG4gICkge1xuICAgIHN1cGVyKGluaXRpYWxTdGF0ZSk7XG4gIH1cblxuICBpbml0aWFsaXplID0gdGhpcy5lZmZlY3QoKHRyaWdnZXIkOiBPYnNlcnZhYmxlPHZvaWQ+KSA9PiB7XG4gICAgcmV0dXJuIHRyaWdnZXIkLnBpcGUoXG4gICAgICB0YXAoKCkgPT4ge1xuICAgICAgICB0aGlzLnBhdGNoU3RhdGUoe1xuICAgICAgICAgIGlzTG9hZGluZzogdHJ1ZSxcbiAgICAgICAgfSk7XG4gICAgICB9KSxcbiAgICAgIHN3aXRjaE1hcCgoKSA9PiBmb3JrSm9pbihbXG4gICAgICAgIHRoaXMuZ2V0RG9ja2VyQ29uZmlnKCksXG4gICAgICAgIHRoaXMuZ2V0RG9ja2VyU3RhdHVzKCksXG4gICAgICAgIHRoaXMuZ2V0TGFja3NOdmlkaWFEcml2ZXJzKCksXG4gICAgICBdKSksXG4gICAgICB0YXAoXG4gICAgICAgIChbZG9ja2VyQ29uZmlnLCBzdGF0dXNEYXRhLCBsYWNrc052aWRpYURyaXZlcnNdOiBbRG9ja2VyQ29uZmlnLCBEb2NrZXJTdGF0dXNEYXRhLCBib29sZWFuXSkgPT4ge1xuICAgICAgICAgIHRoaXMucGF0Y2hTdGF0ZSh7XG4gICAgICAgICAgICBkb2NrZXJDb25maWcsXG4gICAgICAgICAgICBudmlkaWFEcml2ZXJzSW5zdGFsbGVkOiBkb2NrZXJDb25maWcubnZpZGlhLFxuICAgICAgICAgICAgbGFja3NOdmlkaWFEcml2ZXJzLFxuICAgICAgICAgICAgc3RhdHVzRGF0YSxcbiAgICAgICAgICAgIGlzTG9hZGluZzogZmFsc2UsXG4gICAgICAgICAgfSk7XG4gICAgICAgIH0sXG4gICAgICApLFxuICAgICk7XG4gIH0pO1xuXG4gIHByaXZhdGUgZ2V0RG9ja2VyQ29uZmlnKCk6IE9ic2VydmFibGU8RG9ja2VyQ29uZmlnPiB7XG4gICAgcmV0dXJuIHRoaXMud3MuY2FsbCgnZG9ja2VyLmNvbmZpZycpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRMYWNrc052aWRpYURyaXZlcnMoKTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XG4gICAgcmV0dXJuIHRoaXMud3MuY2FsbCgnZG9ja2VyLmxhY2tzX252aWRpYV9kcml2ZXJzJyk7XG4gIH1cblxuICBwcml2YXRlIGdldERvY2tlclN0YXR1cygpOiBPYnNlcnZhYmxlPERvY2tlclN0YXR1c0RhdGE+IHtcbiAgICByZXR1cm4gdGhpcy53cy5jYWxsKCdkb2NrZXIuc3RhdHVzJyk7XG4gIH1cblxuICBzZXREb2NrZXJQb29sKHBvb2xOYW1lOiBzdHJpbmcpOiBPYnNlcnZhYmxlPEpvYjxEb2NrZXJDb25maWc+PiB7XG4gICAgcmV0dXJuIHRoaXMuZGlhbG9nU2VydmljZS5qb2JEaWFsb2coXG4gICAgICB0aGlzLndzLmpvYignZG9ja2VyLnVwZGF0ZScsIFt7IHBvb2w6IHBvb2xOYW1lIH1dKSxcbiAgICAgIHsgdGl0bGU6IHRoaXMudHJhbnNsYXRlLmluc3RhbnQoJ0NvbmZpZ3VyaW5nLi4uJykgfSxcbiAgICApXG4gICAgICAuYWZ0ZXJDbG9zZWQoKVxuICAgICAgLnBpcGUoXG4gICAgICAgIHRhcCgoam9iKSA9PiB7XG4gICAgICAgICAgaWYgKGpvYi5zdGF0ZSA9PT0gSm9iU3RhdGUuU3VjY2Vzcykge1xuICAgICAgICAgICAgdGhpcy5wYXRjaFN0YXRlKChzdGF0ZSkgPT4gKHtcbiAgICAgICAgICAgICAgLi4uc3RhdGUsXG4gICAgICAgICAgICAgIGRvY2tlckNvbmZpZzoge1xuICAgICAgICAgICAgICAgIC4uLnN0YXRlLmRvY2tlckNvbmZpZyxcbiAgICAgICAgICAgICAgICBwb29sOiBwb29sTmFtZSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0pKTtcbiAgICAgICAgICB9IGVsc2UgaWYgKFtKb2JTdGF0ZS5GYWlsZWQsIEpvYlN0YXRlLkFib3J0ZWQsIEpvYlN0YXRlLkVycm9yXS5pbmNsdWRlcyhqb2Iuc3RhdGUpKSB7XG4gICAgICAgICAgICB0aGlzLnBhdGNoU3RhdGUoKHN0YXRlKSA9PiAoe1xuICAgICAgICAgICAgICAuLi5zdGF0ZSxcbiAgICAgICAgICAgICAgZG9ja2VyQ29uZmlnOiB7XG4gICAgICAgICAgICAgICAgLi4uc3RhdGUuZG9ja2VyQ29uZmlnLFxuICAgICAgICAgICAgICAgIHBvb2w6IG51bGwsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9KSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KSxcbiAgICAgICAgdGhpcy5lcnJvckhhbmRsZXIuY2F0Y2hFcnJvcigpLFxuICAgICAgKTtcbiAgfVxuXG4gIHJlbG9hZERvY2tlckNvbmZpZygpOiBPYnNlcnZhYmxlPERvY2tlckNvbmZpZz4ge1xuICAgIHJldHVybiB0aGlzLmdldERvY2tlckNvbmZpZygpLnBpcGUoXG4gICAgICB0YXAoKGRvY2tlckNvbmZpZykgPT4ge1xuICAgICAgICB0aGlzLnBhdGNoU3RhdGUoeyBkb2NrZXJDb25maWcgfSk7XG4gICAgICB9KSxcbiAgICApO1xuICB9XG5cbiAgc2V0RG9ja2VyTnZpZGlhKG52aWRpYURyaXZlcnNJbnN0YWxsZWQ6IGJvb2xlYW4pOiBPYnNlcnZhYmxlPEpvYjxEb2NrZXJDb25maWc+PiB7XG4gICAgcmV0dXJuIHRoaXMuZGlhbG9nU2VydmljZS5qb2JEaWFsb2coXG4gICAgICB0aGlzLndzLmpvYignZG9ja2VyLnVwZGF0ZScsIFt7IG52aWRpYTogbnZpZGlhRHJpdmVyc0luc3RhbGxlZCB9XSksXG4gICAgICB7IHRpdGxlOiB0aGlzLnRyYW5zbGF0ZS5pbnN0YW50KCdDb25maWd1cmluZy4uLicpIH0sXG4gICAgKVxuICAgICAgLmFmdGVyQ2xvc2VkKClcbiAgICAgIC5waXBlKFxuICAgICAgICB0YXAoKGpvYikgPT4ge1xuICAgICAgICAgIGlmIChqb2Iuc3RhdGUgPT09IEpvYlN0YXRlLlN1Y2Nlc3MpIHtcbiAgICAgICAgICAgIHRoaXMucGF0Y2hTdGF0ZSh7XG4gICAgICAgICAgICAgIG52aWRpYURyaXZlcnNJbnN0YWxsZWQsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pLFxuICAgICAgICB0aGlzLmVycm9ySGFuZGxlci5jYXRjaEVycm9yKCksXG4gICAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIFVwZGF0ZXMgZG9ja2VyIHN0YXR1cyBpbiBgRG9ja2VyU3RvcmVgIHNlcnZpY2VcbiAgICogQHJldHVybnMgQW4gb2JzZXJ2YWJsZSB0aGF0IHNob3VsZCBiZSBzdWJzY3JpYmVkIHRvIGF0IGNvbXBvbmVudCBsZXZlbC4gVGhpcyBldmVudCBzdWJzY3JpcHRpb24gc2hvdWxkIG9ubHlcbiAgICogc3RheSBhbGl2ZSB1bnRpbCB0aGUgY29tcG9uZW50IHN1YnNjcmlwdGlvbiBzdGF5cyBhbGl2ZSBpLmUuLCB1bnRpbCB0aGUgY29tcG9uZW50IGlzIGRlc3Ryb3llZFxuICAgKi9cbiAgZG9ja2VyU3RhdHVzRXZlbnRVcGRhdGVzKCk6IE9ic2VydmFibGU8RG9ja2VyU3RhdHVzRGF0YT4ge1xuICAgIHJldHVybiB0aGlzLndzLnN1YnNjcmliZSgnZG9ja2VyLnN0YXRlJykucGlwZShcbiAgICAgIG1hcCgoZXZlbnQpID0+IGV2ZW50LmZpZWxkcyksXG4gICAgICB0YXAoKHN0YXR1c0RhdGEpID0+IHtcbiAgICAgICAgdGhpcy5wYXRjaFN0YXRlKHsgc3RhdHVzRGF0YSB9KTtcbiAgICAgIH0pLFxuICAgICk7XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==