924d067ea107e7231c0550b78efa8889
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.WebSocketService = void 0;
const core_1 = require("@angular/core");
const router_1 = require("@angular/router");
const core_2 = require("@ngx-translate/core");
const angular2_uuid_1 = require("angular2-uuid");
const rxjs_1 = require("rxjs");
const operators_1 = require("rxjs/operators");
const api_message_type_enum_1 = require("app/enums/api-message-type.enum");
const response_error_type_enum_1 = require("app/enums/response-error-type.enum");
const websocket_error_name_enum_1 = require("app/enums/websocket-error-name.enum");
const apply_api_event_operator_1 = require("app/helpers/operators/apply-api-event.operator");
const observe_job_operator_1 = require("app/helpers/operators/observe-job.operator");
const websocket_connection_service_1 = require("app/services/websocket-connection.service");
let WebSocketService = class WebSocketService {
    constructor(router, wsManager, translate) {
        var _a;
        this.router = router;
        this.wsManager = wsManager;
        this.translate = translate;
        this.eventSubscribers = new Map();
        this.clearSubscriptions$ = new rxjs_1.Subject();
        (_a = this.wsManager.isConnected$) === null || _a === void 0 ? void 0 : _a.subscribe((isConnected) => {
            if (!isConnected) {
                this.clearSubscriptions();
            }
        });
    }
    get ws$() {
        return this.wsManager.websocket$;
    }
    call(method, params) {
        return this.callMethod(method, params);
    }
    /**
     * For jobs better to use the `selectJob` store selector.
     */
    callAndSubscribe(method, params) {
        return this.callMethod(method, params)
            .pipe((0, operators_1.switchMap)((items) => this.subscribe(method).pipe((0, operators_1.startWith)(null), (0, operators_1.map)((event) => ([items, event])))), (0, apply_api_event_operator_1.applyApiEvent)(), (0, operators_1.takeUntil)(this.clearSubscriptions$));
    }
    /**
     * Use `job` when you care about job progress or result.
     */
    startJob(method, params) {
        return this.callMethod(method, params);
    }
    /**
     * In your subscription, next will be next job update, complete will be when the job is complete.
     */
    job(method, params) {
        return this.callMethod(method, params).pipe((0, operators_1.switchMap)((jobId) => {
            return (0, rxjs_1.merge)(this.subscribeToJobUpdates(jobId), 
            // Get job status here for jobs that complete too fast.
            this.call('core.get_jobs', [[['id', '=', jobId]]]).pipe((0, operators_1.map)((jobs) => jobs[0])))
                .pipe((0, observe_job_operator_1.observeJob)());
        }), (0, operators_1.takeUntil)(this.clearSubscriptions$));
    }
    subscribe(method) {
        if (this.eventSubscribers.has(method)) {
            return this.eventSubscribers.get(method);
        }
        const observable$ = new rxjs_1.Observable((trigger) => {
            const subscription = this.wsManager.buildSubscriber(method).subscribe(trigger);
            return () => {
                subscription.unsubscribe();
                this.eventSubscribers.delete(method);
            };
        }).pipe((0, operators_1.switchMap)((apiEvent) => {
            const erroredEvent = apiEvent;
            if (erroredEvent === null || erroredEvent === void 0 ? void 0 : erroredEvent.error) {
                console.error('Error: ', erroredEvent.error);
                return (0, rxjs_1.throwError)(() => erroredEvent.error);
            }
            return (0, rxjs_1.of)(apiEvent);
        }), (0, operators_1.share)(), (0, operators_1.takeUntil)(this.clearSubscriptions$));
        this.eventSubscribers.set(method, observable$);
        return observable$;
    }
    subscribeToLogs(name) {
        return this.subscribe(name);
    }
    clearSubscriptions() {
        this.clearSubscriptions$.next();
        this.eventSubscribers.clear();
    }
    getWebSocketStream$() {
        return this.ws$;
    }
    callMethod(method, params) {
        const uuid = angular2_uuid_1.UUID.UUID();
        return (0, rxjs_1.of)(uuid).pipe((0, operators_1.tap)(() => {
            performance.mark(`${method} - ${uuid} - start`);
            this.wsManager.send({
                id: uuid, msg: api_message_type_enum_1.IncomingApiMessageType.Method, method, params,
            });
        }), (0, operators_1.switchMap)(() => this.ws$), (0, operators_1.filter)((data) => data.msg === api_message_type_enum_1.IncomingApiMessageType.Result && data.id === uuid), (0, operators_1.switchMap)((data) => {
            if ('error' in data && data.error) {
                this.printError(data.error, { method, params });
                const error = this.enhanceError(data.error, { method });
                return (0, rxjs_1.throwError)(() => error);
            }
            performance.mark(`${method} - ${uuid} - end`);
            performance.measure(method, `${method} - ${uuid} - start`, `${method} - ${uuid} - end`);
            return (0, rxjs_1.of)(data);
        }), (0, operators_1.map)((data) => data.result), (0, operators_1.take)(1));
    }
    subscribeToJobUpdates(jobId) {
        return this.subscribe('core.get_jobs').pipe((0, operators_1.filter)((apiEvent) => apiEvent.id === jobId), (0, operators_1.map)((apiEvent) => apiEvent.fields), (0, operators_1.takeUntil)(this.clearSubscriptions$));
    }
    printError(error, context) {
        if (error.errname === websocket_error_name_enum_1.WebSocketErrorName.NoAccess) {
            console.error(`Access denied to ${context.method} with ${context.params ? JSON.stringify(context.params) : 'no params'}`);
            return;
        }
        // Do not log validation errors.
        if (error.type === response_error_type_enum_1.ResponseErrorType.Validation) {
            return;
        }
        console.error('Error: ', error);
    }
    // TODO: Probably doesn't belong here. Consider building something similar to interceptors.
    enhanceError(error, context) {
        if (error.errname === websocket_error_name_enum_1.WebSocketErrorName.NoAccess) {
            return Object.assign(Object.assign({}, error), { reason: this.translate.instant('Access denied to {method}', { method: context.method }) });
        }
        return error;
    }
};
exports.WebSocketService = WebSocketService;
WebSocketService.ctorParameters = () => [
    { type: router_1.Router },
    { type: websocket_connection_service_1.WebSocketConnectionService },
    { type: core_2.TranslateService }
];
exports.WebSocketService = WebSocketService = __decorate([
    (0, core_1.Injectable)({
        providedIn: 'root',
    })
], WebSocketService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21hY2Jvb2sva2FycG92LXdvcmsvVHJ1ZU5BUy93ZWJ1aS9zcmMvYXBwL3NlcnZpY2VzL3dzLnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUEsd0NBQTJDO0FBQzNDLDRDQUF5QztBQUN6Qyw4Q0FBdUQ7QUFDdkQsaURBQXFDO0FBQ3JDLCtCQUVjO0FBQ2QsOENBRXdCO0FBQ3hCLDJFQUF5RTtBQUN6RSxpRkFBdUU7QUFDdkUsbUZBQXlFO0FBQ3pFLDZGQUErRTtBQUMvRSxxRkFBd0U7QUFpQnhFLDRGQUF1RjtBQUtoRixJQUFNLGdCQUFnQixHQUF0QixNQUFNLGdCQUFnQjtJQUkzQixZQUNZLE1BQWMsRUFDZCxTQUFxQyxFQUNyQyxTQUEyQjs7UUFGM0IsV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQUNkLGNBQVMsR0FBVCxTQUFTLENBQTRCO1FBQ3JDLGNBQVMsR0FBVCxTQUFTLENBQWtCO1FBTnRCLHFCQUFnQixHQUFHLElBQUksR0FBRyxFQUE2QyxDQUFDO1FBQ2hGLHdCQUFtQixHQUFHLElBQUksY0FBTyxFQUFRLENBQUM7UUFPakQsTUFBQSxJQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksMENBQUUsU0FBUyxDQUFDLENBQUMsV0FBVyxFQUFFLEVBQUU7WUFDckQsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO2dCQUNqQixJQUFJLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztZQUM1QixDQUFDO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsSUFBWSxHQUFHO1FBQ2IsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQztJQUNuQyxDQUFDO0lBRUQsSUFBSSxDQUEwQixNQUFTLEVBQUUsTUFBeUI7UUFDaEUsT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sRUFBRSxNQUFNLENBQUMsQ0FBQztJQUN6QyxDQUFDO0lBRUQ7O09BRUc7SUFDSCxnQkFBZ0IsQ0FDZCxNQUFTLEVBQ1QsTUFBeUI7UUFFekIsT0FBTyxJQUFJLENBQUMsVUFB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L3NyYy9hcHAvc2VydmljZXMvd3Muc2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBSb3V0ZXIgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgVHJhbnNsYXRlU2VydmljZSB9IGZyb20gJ0BuZ3gtdHJhbnNsYXRlL2NvcmUnO1xuaW1wb3J0IHsgVVVJRCB9IGZyb20gJ2FuZ3VsYXIyLXV1aWQnO1xuaW1wb3J0IHtcbiAgbWVyZ2UsIE9ic2VydmFibGUsIG9mLCBTdWJqZWN0LCBTdWJzY3JpYmVyLCB0aHJvd0Vycm9yLFxufSBmcm9tICdyeGpzJztcbmltcG9ydCB7XG4gIGZpbHRlciwgbWFwLCBzaGFyZSwgc3RhcnRXaXRoLCBzd2l0Y2hNYXAsIHRha2UsIHRha2VVbnRpbCwgdGFwLFxufSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBJbmNvbWluZ0FwaU1lc3NhZ2VUeXBlIH0gZnJvbSAnYXBwL2VudW1zL2FwaS1tZXNzYWdlLXR5cGUuZW51bSc7XG5pbXBvcnQgeyBSZXNwb25zZUVycm9yVHlwZSB9IGZyb20gJ2FwcC9lbnVtcy9yZXNwb25zZS1lcnJvci10eXBlLmVudW0nO1xuaW1wb3J0IHsgV2ViU29ja2V0RXJyb3JOYW1lIH0gZnJvbSAnYXBwL2VudW1zL3dlYnNvY2tldC1lcnJvci1uYW1lLmVudW0nO1xuaW1wb3J0IHsgYXBwbHlBcGlFdmVudCB9IGZyb20gJ2FwcC9oZWxwZXJzL29wZXJhdG9ycy9hcHBseS1hcGktZXZlbnQub3BlcmF0b3InO1xuaW1wb3J0IHsgb2JzZXJ2ZUpvYiB9IGZyb20gJ2FwcC9oZWxwZXJzL29wZXJhdG9ycy9vYnNlcnZlLWpvYi5vcGVyYXRvcic7XG5pbXBvcnQgeyBBcGlDYWxsQW5kU3Vic2NyaWJlTWV0aG9kLCBBcGlDYWxsQW5kU3Vic2NyaWJlUmVzcG9uc2UgfSBmcm9tICdhcHAvaW50ZXJmYWNlcy9hcGkvYXBpLWNhbGwtYW5kLXN1YnNjcmliZS1kaXJlY3RvcnkuaW50ZXJmYWNlJztcbmltcG9ydCB7XG4gIEFwaUNhbGxNZXRob2QsXG4gIEFwaUNhbGxQYXJhbXMsXG4gIEFwaUNhbGxSZXNwb25zZSxcbn0gZnJvbSAnYXBwL2ludGVyZmFjZXMvYXBpL2FwaS1jYWxsLWRpcmVjdG9yeS5pbnRlcmZhY2UnO1xuaW1wb3J0IHtcbiAgQXBpSm9iTWV0aG9kLFxuICBBcGlKb2JQYXJhbXMsXG4gIEFwaUpvYlJlc3BvbnNlLFxufSBmcm9tICdhcHAvaW50ZXJmYWNlcy9hcGkvYXBpLWpvYi1kaXJlY3RvcnkuaW50ZXJmYWNlJztcbmltcG9ydCB7XG4gIEFwaUV2ZW50LCBBcGlFdmVudE1ldGhvZCwgQXBpRXZlbnRUeXBlZCwgSW5jb21pbmdXZWJTb2NrZXRNZXNzYWdlLCBSZXN1bHRNZXNzYWdlLFxufSBmcm9tICdhcHAvaW50ZXJmYWNlcy9hcGktbWVzc2FnZS5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgSm9iIH0gZnJvbSAnYXBwL2ludGVyZmFjZXMvam9iLmludGVyZmFjZSc7XG5pbXBvcnQgeyBXZWJTb2NrZXRFcnJvciB9IGZyb20gJ2FwcC9pbnRlcmZhY2VzL3dlYnNvY2tldC1lcnJvci5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgV2ViU29ja2V0Q29ubmVjdGlvblNlcnZpY2UgfSBmcm9tICdhcHAvc2VydmljZXMvd2Vic29ja2V0LWNvbm5lY3Rpb24uc2VydmljZSc7XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnLFxufSlcbmV4cG9ydCBjbGFzcyBXZWJTb2NrZXRTZXJ2aWNlIHtcbiAgcHJpdmF0ZSByZWFkb25seSBldmVudFN1YnNjcmliZXJzID0gbmV3IE1hcDxBcGlFdmVudE1ldGhvZCwgT2JzZXJ2YWJsZTxBcGlFdmVudFR5cGVkPj4oKTtcbiAgcmVhZG9ubHkgY2xlYXJTdWJzY3JpcHRpb25zJCA9IG5ldyBTdWJqZWN0PHZvaWQ+KCk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJvdGVjdGVkIHJvdXRlcjogUm91dGVyLFxuICAgIHByb3RlY3RlZCB3c01hbmFnZXI6IFdlYlNvY2tldENvbm5lY3Rpb25TZXJ2aWNlLFxuICAgIHByb3RlY3RlZCB0cmFuc2xhdGU6IFRyYW5zbGF0ZVNlcnZpY2UsXG4gICkge1xuICAgIHRoaXMud3NNYW5hZ2VyLmlzQ29ubmVjdGVkJD8uc3Vic2NyaWJlKChpc0Nvbm5lY3RlZCkgPT4ge1xuICAgICAgaWYgKCFpc0Nvbm5lY3RlZCkge1xuICAgICAgICB0aGlzLmNsZWFyU3Vic2NyaXB0aW9ucygpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXQgd3MkKCk6IE9ic2VydmFibGU8dW5rbm93bj4ge1xuICAgIHJldHVybiB0aGlzLndzTWFuYWdlci53ZWJzb2NrZXQkO1xuICB9XG5cbiAgY2FsbDxNIGV4dGVuZHMgQXBpQ2FsbE1ldGhvZD4obWV0aG9kOiBNLCBwYXJhbXM/OiBBcGlDYWxsUGFyYW1zPE0+KTogT2JzZXJ2YWJsZTxBcGlDYWxsUmVzcG9uc2U8TT4+IHtcbiAgICByZXR1cm4gdGhpcy5jYWxsTWV0aG9kKG1ldGhvZCwgcGFyYW1zKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBGb3Igam9icyBiZXR0ZXIgdG8gdXNlIHRoZSBgc2VsZWN0Sm9iYCBzdG9yZSBzZWxlY3Rvci5cbiAgICovXG4gIGNhbGxBbmRTdWJzY3JpYmU8TSBleHRlbmRzIEFwaUNhbGxBbmRTdWJzY3JpYmVNZXRob2Q+KFxuICAgIG1ldGhvZDogTSxcbiAgICBwYXJhbXM/OiBBcGlDYWxsUGFyYW1zPE0+LFxuICApOiBPYnNlcnZhYmxlPEFwaUNhbGxBbmRTdWJzY3JpYmVSZXNwb25zZTxNPltdPiB7XG4gICAgcmV0dXJuIHRoaXMuY2FsbE1ldGhvZDxNPihtZXRob2QsIHBhcmFtcylcbiAgICAgIC5waXBlKFxuICAgICAgICBzd2l0Y2hNYXAoKGl0ZW1zKSA9PiB0aGlzLnN1YnNjcmliZShtZXRob2QpLnBpcGUoXG4gICAgICAgICAgc3RhcnRXaXRoKG51bGwpLFxuICAgICAgICAgIG1hcCgoZXZlbnQpID0+IChbaXRlbXMsIGV2ZW50XSkpLFxuICAgICAgICApKSxcbiAgICAgICAgYXBwbHlBcGlFdmVudCgpLFxuICAgICAgICB0YWtlVW50aWwodGhpcy5jbGVhclN1YnNjcmlwdGlvbnMkKSxcbiAgICAgICk7XG4gIH1cblxuICAvKipcbiAgICogVXNlIGBqb2JgIHdoZW4geW91IGNhcmUgYWJvdXQgam9iIHByb2dyZXNzIG9yIHJlc3VsdC5cbiAgICovXG4gIHN0YXJ0Sm9iPE0gZXh0ZW5kcyBBcGlKb2JNZXRob2Q+KG1ldGhvZDogTSwgcGFyYW1zPzogQXBpSm9iUGFyYW1zPE0+KTogT2JzZXJ2YWJsZTxudW1iZXI+IHtcbiAgICByZXR1cm4gdGhpcy5jYWxsTWV0aG9kKG1ldGhvZCwgcGFyYW1zKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBJbiB5b3VyIHN1YnNjcmlwdGlvbiwgbmV4dCB3aWxsIGJlIG5leHQgam9iIHVwZGF0ZSwgY29tcGxldGUgd2lsbCBiZSB3aGVuIHRoZSBqb2IgaXMgY29tcGxldGUuXG4gICAqL1xuICBqb2I8TSBleHRlbmRzIEFwaUpvYk1ldGhvZD4oXG4gICAgbWV0aG9kOiBNLFxuICAgIHBhcmFtcz86IEFwaUpvYlBhcmFtczxNPixcbiAgKTogT2JzZXJ2YWJsZTxKb2I8QXBpSm9iUmVzcG9uc2U8TT4+PiB7XG4gICAgcmV0dXJuIHRoaXMuY2FsbE1ldGhvZChtZXRob2QsIHBhcmFtcykucGlwZShcbiAgICAgIHN3aXRjaE1hcCgoam9iSWQ6IG51bWJlcikgPT4ge1xuICAgICAgICByZXR1cm4gbWVyZ2UoXG4gICAgICAgICAgdGhpcy5zdWJzY3JpYmVUb0pvYlVwZGF0ZXMoam9iSWQpLFxuICAgICAgICAgIC8vIEdldCBqb2Igc3RhdHVzIGhlcmUgZm9yIGpvYnMgdGhhdCBjb21wbGV0ZSB0b28gZmFzdC5cbiAgICAgICAgICB0aGlzLmNhbGwoJ2NvcmUuZ2V0X2pvYnMnLCBbW1snaWQnLCAnPScsIGpvYklkXV1dKS5waXBlKG1hcCgoam9icykgPT4gam9ic1swXSkpLFxuICAgICAgICApXG4gICAgICAgICAgLnBpcGUob2JzZXJ2ZUpvYigpKTtcbiAgICAgIH0pLFxuICAgICAgdGFrZVVudGlsKHRoaXMuY2xlYXJTdWJzY3JpcHRpb25zJCksXG4gICAgKSBhcyBPYnNlcnZhYmxlPEpvYjxBcGlKb2JSZXNwb25zZTxNPj4+O1xuICB9XG5cbiAgc3Vic2NyaWJlPEsgZXh0ZW5kcyBBcGlFdmVudE1ldGhvZCA9IEFwaUV2ZW50TWV0aG9kPihtZXRob2Q6IEsgfCBgJHtLfToke3N0cmluZ31gKTogT2JzZXJ2YWJsZTxBcGlFdmVudFR5cGVkPEs+PiB7XG4gICAgaWYgKHRoaXMuZXZlbnRTdWJzY3JpYmVycy5oYXMobWV0aG9kIGFzIEspKSB7XG4gICAgICByZXR1cm4gdGhpcy5ldmVudFN1YnNjcmliZXJzLmdldChtZXRob2QgYXMgSyk7XG4gICAgfVxuICAgIGNvbnN0IG9ic2VydmFibGUkID0gbmV3IE9ic2VydmFibGUoKHRyaWdnZXI6IFN1YnNjcmliZXI8QXBpRXZlbnRUeXBlZDxLPj4pID0+IHtcbiAgICAgIGNvbnN0IHN1YnNjcmlwdGlvbiA9IHRoaXMud3NNYW5hZ2VyLmJ1aWxkU3Vic2NyaWJlcjxLLCBBcGlFdmVudFR5cGVkPEs+PihtZXRob2QgYXMgSykuc3Vic2NyaWJlKHRyaWdnZXIpO1xuICAgICAgcmV0dXJuICgpID0+IHtcbiAgICAgICAgc3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgICAgIHRoaXMuZXZlbnRTdWJzY3JpYmVycy5kZWxldGUobWV0aG9kIGFzIEspO1xuICAgICAgfTtcbiAgICB9KS5waXBlKFxuICAgICAgc3dpdGNoTWFwKChhcGlFdmVudCkgPT4ge1xuICAgICAgICBjb25zdCBlcnJvcmVkRXZlbnQgPSBhcGlFdmVudCBhcyB1bmtub3duIGFzIFJlc3VsdE1lc3NhZ2U7XG4gICAgICAgIGlmIChlcnJvcmVkRXZlbnQ/LmVycm9yKSB7XG4gICAgICAgICAgY29uc29sZS5lcnJvcignRXJyb3I6ICcsIGVycm9yZWRFdmVudC5lcnJvcik7XG4gICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoKCkgPT4gZXJyb3JlZEV2ZW50LmVycm9yKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gb2YoYXBpRXZlbnQpO1xuICAgICAgfSksXG4gICAgICBzaGFyZSgpLFxuICAgICAgdGFrZVVudGlsKHRoaXMuY2xlYXJTdWJzY3JpcHRpb25zJCksXG4gICAgKTtcblxuICAgIHRoaXMuZXZlbnRTdWJzY3JpYmVycy5zZXQobWV0aG9kIGFzIEssIG9ic2VydmFibGUkKTtcbiAgICByZXR1cm4gb2JzZXJ2YWJsZSQ7XG4gIH1cblxuICBzdWJzY3JpYmVUb0xvZ3MobmFtZTogc3RyaW5nKTogT2JzZXJ2YWJsZTxBcGlFdmVudDx7IGRhdGE6IHN0cmluZyB9Pj4ge1xuICAgIHJldHVybiB0aGlzLnN1YnNjcmliZShuYW1lIGFzIEFwaUV2ZW50TWV0aG9kKSBhcyB1bmtub3duIGFzIE9ic2VydmFibGU8QXBpRXZlbnQ8eyBkYXRhOiBzdHJpbmcgfT4+O1xuICB9XG5cbiAgY2xlYXJTdWJzY3JpcHRpb25zKCk6IHZvaWQge1xuICAgIHRoaXMuY2xlYXJTdWJzY3JpcHRpb25zJC5uZXh0KCk7XG4gICAgdGhpcy5ldmVudFN1YnNjcmliZXJzLmNsZWFyKCk7XG4gIH1cblxuICBnZXRXZWJTb2NrZXRTdHJlYW0kKCk6IE9ic2VydmFibGU8dW5rbm93bj4ge1xuICAgIHJldHVybiB0aGlzLndzJDtcbiAgfVxuXG4gIHByaXZhdGUgY2FsbE1ldGhvZDxNIGV4dGVuZHMgQXBpQ2FsbE1ldGhvZD4obWV0aG9kOiBNLCBwYXJhbXM/OiBBcGlDYWxsUGFyYW1zPE0+KTogT2JzZXJ2YWJsZTxBcGlDYWxsUmVzcG9uc2U8TT4+O1xuICBwcml2YXRlIGNhbGxNZXRob2Q8TSBleHRlbmRzIEFwaUpvYk1ldGhvZD4obWV0aG9kOiBNLCBwYXJhbXM/OiBBcGlKb2JQYXJhbXM8TT4pOiBPYnNlcnZhYmxlPG51bWJlcj47XG4gIHByaXZhdGUgY2FsbE1ldGhvZDxNIGV4dGVuZHMgQXBpQ2FsbE1ldGhvZCB8IEFwaUpvYk1ldGhvZD4obWV0aG9kOiBNLCBwYXJhbXM/OiB1bmtub3duKTogT2JzZXJ2YWJsZTx1bmtub3duPiB7XG4gICAgY29uc3QgdXVpZCA9IFVVSUQuVVVJRCgpO1xuICAgIHJldHVybiBvZih1dWlkKS5waXBlKFxuICAgICAgdGFwKCgpID0+IHtcbiAgICAgICAgcGVyZm9ybWFuY2UubWFyayhgJHttZXRob2R9IC0gJHt1dWlkfSAtIHN0YXJ0YCk7XG4gICAgICAgIHRoaXMud3NNYW5hZ2VyLnNlbmQoe1xuICAgICAgICAgIGlkOiB1dWlkLCBtc2c6IEluY29taW5nQXBpTWVzc2FnZVR5cGUuTWV0aG9kLCBtZXRob2QsIHBhcmFtcyxcbiAgICAgICAgfSk7XG4gICAgICB9KSxcbiAgICAgIHN3aXRjaE1hcCgoKSA9PiB0aGlzLndzJCksXG4gICAgICBmaWx0ZXIoKGRhdGE6IEluY29taW5nV2ViU29ja2V0TWVzc2FnZSkgPT4gZGF0YS5tc2cgPT09IEluY29taW5nQXBpTWVzc2FnZVR5cGUuUmVzdWx0ICYmIGRhdGEuaWQgPT09IHV1aWQpLFxuICAgICAgc3dpdGNoTWFwKChkYXRhOiBJbmNvbWluZ1dlYlNvY2tldE1lc3NhZ2UpID0+IHtcbiAgICAgICAgaWYgKCdlcnJvcicgaW4gZGF0YSAmJiBkYXRhLmVycm9yKSB7XG4gICAgICAgICAgdGhpcy5wcmludEVycm9yKGRhdGEuZXJyb3IsIHsgbWV0aG9kLCBwYXJhbXMgfSk7XG4gICAgICAgICAgY29uc3QgZXJyb3IgPSB0aGlzLmVuaGFuY2VFcnJvcihkYXRhLmVycm9yLCB7IG1ldGhvZCB9KTtcbiAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcigoKSA9PiBlcnJvcik7XG4gICAgICAgIH1cblxuICAgICAgICBwZXJmb3JtYW5jZS5tYXJrKGAke21ldGhvZH0gLSAke3V1aWR9IC0gZW5kYCk7XG4gICAgICAgIHBlcmZvcm1hbmNlLm1lYXN1cmUobWV0aG9kLCBgJHttZXRob2R9IC0gJHt1dWlkfSAtIHN0YXJ0YCwgYCR7bWV0aG9kfSAtICR7dXVpZH0gLSBlbmRgKTtcbiAgICAgICAgcmV0dXJuIG9mKGRhdGEpO1xuICAgICAgfSksXG5cbiAgICAgIG1hcCgoZGF0YTogUmVzdWx0TWVzc2FnZSkgPT4gZGF0YS5yZXN1bHQpLFxuICAgICAgdGFrZSgxKSxcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBzdWJzY3JpYmVUb0pvYlVwZGF0ZXMoam9iSWQ6IG51bWJlcik6IE9ic2VydmFibGU8Sm9iPiB7XG4gICAgcmV0dXJuIHRoaXMuc3Vic2NyaWJlKCdjb3JlLmdldF9qb2JzJykucGlwZShcbiAgICAgIGZpbHRlcigoYXBpRXZlbnQpID0+IGFwaUV2ZW50LmlkID09PSBqb2JJZCksXG4gICAgICBtYXAoKGFwaUV2ZW50KSA9PiBhcGlFdmVudC5maWVsZHMpLFxuICAgICAgdGFrZVVudGlsKHRoaXMuY2xlYXJTdWJzY3JpcHRpb25zJCksXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgcHJpbnRFcnJvcihlcnJvcjogV2ViU29ja2V0RXJyb3IsIGNvbnRleHQ6IHsgbWV0aG9kOiBzdHJpbmc7IHBhcmFtczogdW5rbm93biB9KTogdm9pZCB7XG4gICAgaWYgKGVycm9yLmVycm5hbWUgPT09IFdlYlNvY2tldEVycm9yTmFtZS5Ob0FjY2Vzcykge1xuICAgICAgY29uc29sZS5lcnJvcihgQWNjZXNzIGRlbmllZCB0byAke2NvbnRleHQubWV0aG9kfSB3aXRoICR7Y29udGV4dC5wYXJhbXMgPyBKU09OLnN0cmluZ2lmeShjb250ZXh0LnBhcmFtcykgOiAnbm8gcGFyYW1zJ31gKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyBEbyBub3QgbG9nIHZhbGlkYXRpb24gZXJyb3JzLlxuICAgIGlmIChlcnJvci50eXBlID09PSBSZXNwb25zZUVycm9yVHlwZS5WYWxpZGF0aW9uKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc29sZS5lcnJvcignRXJyb3I6ICcsIGVycm9yKTtcbiAgfVxuXG4gIC8vIFRPRE86IFByb2JhYmx5IGRvZXNuJ3QgYmVsb25nIGhlcmUuIENvbnNpZGVyIGJ1aWxkaW5nIHNvbWV0aGluZyBzaW1pbGFyIHRvIGludGVyY2VwdG9ycy5cbiAgcHJpdmF0ZSBlbmhhbmNlRXJyb3IoZXJyb3I6IFdlYlNvY2tldEVycm9yLCBjb250ZXh0OiB7IG1ldGhvZDogc3RyaW5nIH0pOiBXZWJTb2NrZXRFcnJvciB7XG4gICAgaWYgKGVycm9yLmVycm5hbWUgPT09IFdlYlNvY2tldEVycm9yTmFtZS5Ob0FjY2Vzcykge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgLi4uZXJyb3IsXG4gICAgICAgIHJlYXNvbjogdGhpcy50cmFuc2xhdGUuaW5zdGFudCgnQWNjZXNzIGRlbmllZCB0byB7bWV0aG9kfScsIHsgbWV0aG9kOiBjb250ZXh0Lm1ldGhvZCB9KSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgcmV0dXJuIGVycm9yO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=