1f37847430883b741aca4dcf6fe17f75
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.OauthButtonComponent = void 0;
const core_1 = require("@angular/core");
const core_2 = require("@ngx-translate/core");
const window_helper_1 = require("app/helpers/window.helper");
const oauth_button_interface_1 = require("app/modules/buttons/oauth-button/interfaces/oauth-button.interface");
const dialog_service_1 = require("app/modules/dialog/dialog.service");
const i0 = __importStar(require("@angular/core"));
let OauthButtonComponent = class OauthButtonComponent {
    get buttonText() {
        switch (this.oauthType) {
            case oauth_button_interface_1.OauthButtonType.Jira:
                if (this.isLoggedIn) {
                    return this.translate.instant('Logged In To Jira');
                }
                return this.translate.instant('Login To Jira To Submit');
            case oauth_button_interface_1.OauthButtonType.Provider:
                if (this.isLoggedIn) {
                    return this.translate.instant('Logged In To Provider');
                }
                return this.translate.instant('Log In To Provider');
            case oauth_button_interface_1.OauthButtonType.Gmail:
                if (this.isLoggedIn) {
                    return this.translate.instant('Logged In To Gmail');
                }
                return this.translate.instant('Log In To Gmail');
        }
        return '';
    }
    constructor(cdr, dialogService, translate, window) {
        this.cdr = cdr;
        this.dialogService = dialogService;
        this.translate = translate;
        this.window = window;
        this.isLoggedIn = false;
        this.disabled = false;
        this.loggedIn = (0, core_1.output)();
        this.jiraAuthFn = (message) => this.onLogInWithJiraSuccess(message);
        this.gmailAuthFn = (message) => {
            this.onLogInWithGmailSuccess(message);
        };
        this.onLoggedInWithProviderSuccess = (message) => {
            if (message.origin !== 'https://www.truenas.com') {
                return;
            }
            if (!('oauth_portal' in message.data)) {
                return;
            }
            if (message.data.error) {
                this.handleProviderError(message.data.error);
                return;
            }
            this.loggedIn.emit(message.data.result);
        };
    }
    ngOnDestroy() {
        this.window.removeEventListener('message', this.jiraAuthFn, false);
        this.window.removeEventListener('message', this.gmailAuthFn, false);
    }
    onOauthClicked() {
        switch (this.oauthType) {
            case oauth_button_interface_1.OauthButtonType.Jira:
                this.onLoginWithJira();
                break;
            case oauth_button_interface_1.OauthButtonType.Provider:
                this.onLogInWithProvider();
                break;
            case oauth_button_interface_1.OauthButtonType.Gmail:
                this.onLoginWithGmail();
                break;
        }
    }
    onLoginWithJira() {
        this.doCommonOauthLoginLogic(this.jiraAuthFn);
    }
    onLogInWithJiraSuccess(message) {
        const token = message.data;
        if (typeof token !== 'string') {
            return;
        }
        this.loggedIn.emit(token);
        this.cdr.markForCheck();
    }
    onLoginWithGmail() {
        this.doCommonOauthLoginLogic(this.gmailAuthFn);
    }
    onLogInWithGmailSuccess(message) {
        if (message.data.oauth_portal) {
            if (message.data.error) {
                this.handleProviderError(message.data.error);
            }
            else {
                this.loggedIn.emit(message.data.result);
                this.cdr.markForCheck();
            }
        }
    }
    onLogInWithProvider() {
        const authFn = (message) => this.onLoggedInWithProviderSuccess(message);
        this.doCommonOauthLoginLogic(authFn);
    }
    doCommonOauthLoginLogic(authFn) {
        this.window.removeEventListener('message', authFn, false);
        this.window.open(this.oauthUrl + encodeURIComponent(this.window.location.toString()), '_blank', 'width=640,height=480');
        this.window.addEventListener('message', authFn, false);
    }
    handleProviderError(error) {
        this.dialogService.closeAllDialogs();
        this.dialogService.error({
            title: this.translate.instant('Error'),
            message: error.includes('Missing code parameter in response')
                ? this.translate.instant('Login was canceled. Please try again if you want to connect your account.')
                : this.translate.instant(error),
        });
    }
};
exports.OauthButtonComponent = OauthButtonComponent;
OauthButtonComponent.ctorParameters = () => [
    { type: core_1.ChangeDetectorRef },
    { type: dialog_service_1.DialogService },
    { type: core_2.TranslateService },
    { type: Window, decorators: [{ type: core_1.Inject, args: [window_helper_1.WINDOW,] }] }
];
OauthButtonComponent.propDecorators = {
    oauthType: [{ type: core_1.Input }],
    isLoggedIn: [{ type: core_1.Input }],
    disabled: [{ type: core_1.Input }],
    oauthUrl: [{ type: core_1.Input }],
    testId: [{ type: core_1.Input }],
    loggedIn: [{ type: i0.Output, args: ["loggedIn",] }]
};
exports.OauthButtonComponent = OauthButtonComponent = __decorate([
    (0, core_1.Component)({
        selector: 'ix-oauth-button',
        template: require("./oauth-button.component.html"),
        changeDetection: core_1.ChangeDetectionStrategy.OnPush,
    })
], OauthButtonComponent);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21hY2Jvb2sva2FycG92LXdvcmsvVHJ1ZU5BUy93ZWJ1aS9zcmMvYXBwL21vZHVsZXMvYnV0dG9ucy9vYXV0aC1idXR0b24vY29tcG9uZW50cy9vYXV0aC1idXR0b24vb2F1dGgtYnV0dG9uLmNvbXBvbmVudC50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLHdDQUV1QjtBQUN2Qiw4Q0FBdUQ7QUFDdkQsNkRBQW1EO0FBR25ELCtHQUFxRztBQUNyRyxzRUFBa0U7O0FBVTNELElBQU0sb0JBQW9CLEdBQTFCLE1BQU0sb0JBQW9CO0lBYy9CLElBQUksVUFBVTtRQUNaLFFBQVEsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO1lBQ3ZCLEtBQUssd0NBQWUsQ0FBQyxJQUFJO2dCQUN2QixJQUFJLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztvQkFDcEIsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO2dCQUNyRCxDQUFDO2dCQUNELE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMseUJBQXlCLENBQUMsQ0FBQztZQUUzRCxLQUFLLHdDQUFlLENBQUMsUUFBUTtnQkFDM0IsSUFBSSxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7b0JBQ3BCLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsdUJBQXVCLENBQUMsQ0FBQztnQkFDekQsQ0FBQztnQkFDRCxPQUFPLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLG9CQUFvQixDQUFDLENBQUM7WUFFdEQsS0FBSyx3Q0FBZSxDQUFDLEtBQUs7Z0JBQ3hCLElBQUksSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO29CQUNwQixPQUFPLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLG9CQUFvQixDQUFDLENBQUM7Z0JBQ3RELENBQUM7Z0JBQ0QsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxpQkFB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QUN0QyxPQUFPLEVBQUUsS0FBSyxDQUFDLFFBQVEsQ0FBQyxvQ0FBb0MsQ0FBQztnQkFDM0QsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLDJFQUEyRSxDQUFDO2dCQUNyRyxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDO1NBQ2xDLENBQUMsQ0FBQztJQUNMLENBQUM7O0FBeElVLG9EQUFvQjs7Ozs7eUNBMEM1QixhQUFNLFNBQUMsc0JBQU07Ozt3QkF6Q2YsWUFBSzt5QkFDTCxZQUFLO3VCQUNMLFlBQUs7dUJBQ0wsWUFBSztxQkFDTCxZQUFLOzs7K0JBTEssb0JBQW9CO0lBTmhDLElBQUEsZ0JBQVMsRUFBQztRQUNULFFBQVEsRUFBRSxpQkFBaUI7UUFDM0Isa0RBQTRDO1FBRTVDLGVBQWUsRUFBRSw4QkFBdUIsQ0FBQyxNQUFNO0tBQ2hELENBQUM7R0FDVyxvQkFBb0IsQ0F5SWhDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9tYWNib29rL2thcnBvdi13b3JrL1RydWVOQVMvd2VidWkvc3JjL2FwcC9tb2R1bGVzL2J1dHRvbnMvb2F1dGgtYnV0dG9uL2NvbXBvbmVudHMvb2F1dGgtYnV0dG9uL29hdXRoLWJ1dHRvbi5jb21wb25lbnQudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3ksIENoYW5nZURldGVjdG9yUmVmLCBDb21wb25lbnQsIEluamVjdCwgSW5wdXQsIE9uRGVzdHJveSwgb3V0cHV0LFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFRyYW5zbGF0ZVNlcnZpY2UgfSBmcm9tICdAbmd4LXRyYW5zbGF0ZS9jb3JlJztcbmltcG9ydCB7IFdJTkRPVyB9IGZyb20gJ2FwcC9oZWxwZXJzL3dpbmRvdy5oZWxwZXInO1xuaW1wb3J0IHsgR21haWxPYXV0aENvbmZpZyB9IGZyb20gJ2FwcC9pbnRlcmZhY2VzL21haWwtY29uZmlnLmludGVyZmFjZSc7XG5pbXBvcnQgeyBPYXV0aE1lc3NhZ2UgfSBmcm9tICdhcHAvaW50ZXJmYWNlcy9vYXV0aC1tZXNzYWdlLmludGVyZmFjZSc7XG5pbXBvcnQgeyBPYXV0aEJ1dHRvblR5cGUgfSBmcm9tICdhcHAvbW9kdWxlcy9idXR0b25zL29hdXRoLWJ1dHRvbi9pbnRlcmZhY2VzL29hdXRoLWJ1dHRvbi5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgRGlhbG9nU2VydmljZSB9IGZyb20gJ2FwcC9tb2R1bGVzL2RpYWxvZy9kaWFsb2cuc2VydmljZSc7XG5pbXBvcnQgeyBPYXV0aEppcmFNZXNzYWdlIH0gZnJvbSAnYXBwL21vZHVsZXMvZmVlZGJhY2svaW50ZXJmYWNlcy9maWxlLXRpY2tldC5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgT2F1dGhQcm92aWRlckRhdGEgfSBmcm9tICdhcHAvcGFnZXMvY3JlZGVudGlhbHMvYmFja3VwLWNyZWRlbnRpYWxzL2Nsb3VkLWNyZWRlbnRpYWxzLWZvcm0vb2F1dGgtcHJvdmlkZXIvb2F1dGgtcHJvdmlkZXIuY29tcG9uZW50JztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnaXgtb2F1dGgtYnV0dG9uJyxcbiAgdGVtcGxhdGVVcmw6ICcuL29hdXRoLWJ1dHRvbi5jb21wb25lbnQuaHRtbCcsXG4gIHN0eWxlVXJsczogWycuL29hdXRoLWJ1dHRvbi5jb21wb25lbnQuc2NzcyddLFxuICBjaGFuZ2VEZXRlY3Rpb246IENoYW5nZURldGVjdGlvblN0cmF0ZWd5Lk9uUHVzaCxcbn0pXG5leHBvcnQgY2xhc3MgT2F1dGhCdXR0b25Db21wb25lbnQgaW1wbGVtZW50cyBPbkRlc3Ryb3kge1xuICBASW5wdXQoKSBvYXV0aFR5cGU6IE9hdXRoQnV0dG9uVHlwZTtcbiAgQElucHV0KCkgaXNMb2dnZWRJbiA9IGZhbHNlO1xuICBASW5wdXQoKSBkaXNhYmxlZCA9IGZhbHNlO1xuICBASW5wdXQoKSBvYXV0aFVybDogc3RyaW5nO1xuICBASW5wdXQoKSB0ZXN0SWQ6IHN0cmluZztcblxuICByZWFkb25seSBsb2dnZWRJbiA9IG91dHB1dDx1bmtub3duPigpO1xuXG4gIHByaXZhdGUgcmVhZG9ubHkgamlyYUF1dGhGbiA9IChtZXNzYWdlOiBPYXV0aEppcmFNZXNzYWdlKTogdm9pZCA9PiB0aGlzLm9uTG9nSW5XaXRoSmlyYVN1Y2Nlc3MobWVzc2FnZSk7XG4gIHByaXZhdGUgcmVhZG9ubHkgZ21haWxBdXRoRm4gPSAobWVzc2FnZTogT2F1dGhNZXNzYWdlPEdtYWlsT2F1dGhDb25maWc+KTogdm9pZCA9PiB7XG4gICAgdGhpcy5vbkxvZ0luV2l0aEdtYWlsU3VjY2VzcyhtZXNzYWdlKTtcbiAgfTtcblxuICBnZXQgYnV0dG9uVGV4dCgpOiBzdHJpbmcge1xuICAgIHN3aXRjaCAodGhpcy5vYXV0aFR5cGUpIHtcbiAgICAgIGNhc2UgT2F1dGhCdXR0b25UeXBlLkppcmE6XG4gICAgICAgIGlmICh0aGlzLmlzTG9nZ2VkSW4pIHtcbiAgICAgICAgICByZXR1cm4gdGhpcy50cmFuc2xhdGUuaW5zdGFudCgnTG9nZ2VkIEluIFRvIEppcmEnKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy50cmFuc2xhdGUuaW5zdGFudCgnTG9naW4gVG8gSmlyYSBUbyBTdWJtaXQnKTtcblxuICAgICAgY2FzZSBPYXV0aEJ1dHRvblR5cGUuUHJvdmlkZXI6XG4gICAgICAgIGlmICh0aGlzLmlzTG9nZ2VkSW4pIHtcbiAgICAgICAgICByZXR1cm4gdGhpcy50cmFuc2xhdGUuaW5zdGFudCgnTG9nZ2VkIEluIFRvIFByb3ZpZGVyJyk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMudHJhbnNsYXRlLmluc3RhbnQoJ0xvZyBJbiBUbyBQcm92aWRlcicpO1xuXG4gICAgICBjYXNlIE9hdXRoQnV0dG9uVHlwZS5HbWFpbDpcbiAgICAgICAgaWYgKHRoaXMuaXNMb2dnZWRJbikge1xuICAgICAgICAgIHJldHVybiB0aGlzLnRyYW5zbGF0ZS5pbnN0YW50KCdMb2dnZWQgSW4gVG8gR21haWwnKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy50cmFuc2xhdGUuaW5zdGFudCgnTG9nIEluIFRvIEdtYWlsJyk7XG4gICAgfVxuXG4gICAgcmV0dXJuICcnO1xuICB9XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBjZHI6IENoYW5nZURldGVjdG9yUmVmLFxuICAgIHByaXZhdGUgZGlhbG9nU2VydmljZTogRGlhbG9nU2VydmljZSxcbiAgICBwcml2YXRlIHRyYW5zbGF0ZTogVHJhbnNsYXRlU2VydmljZSxcbiAgICBASW5qZWN0KFdJTkRPVykgcHJpdmF0ZSB3aW5kb3c6IFdpbmRvdyxcbiAgKSB7fVxuXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIHRoaXMud2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21lc3NhZ2UnLCB0aGlzLmppcmFBdXRoRm4sIGZhbHNlKTtcbiAgICB0aGlzLndpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgdGhpcy5nbWFpbEF1dGhGbiwgZmFsc2UpO1xuICB9XG5cbiAgb25PYXV0aENsaWNrZWQoKTogdm9pZCB7XG4gICAgc3dpdGNoICh0aGlzLm9hdXRoVHlwZSkge1xuICAgICAgY2FzZSBPYXV0aEJ1dHRvblR5cGUuSmlyYTpcbiAgICAgICAgdGhpcy5vbkxvZ2luV2l0aEppcmEoKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIE9hdXRoQnV0dG9uVHlwZS5Qcm92aWRlcjpcbiAgICAgICAgdGhpcy5vbkxvZ0luV2l0aFByb3ZpZGVyKCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBPYXV0aEJ1dHRvblR5cGUuR21haWw6XG4gICAgICAgIHRoaXMub25Mb2dpbldpdGhHbWFpbCgpO1xuICAgICAgICBicmVhaztcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIG9uTG9naW5XaXRoSmlyYSgpOiB2b2lkIHtcbiAgICB0aGlzLmRvQ29tbW9uT2F1dGhMb2dpbkxvZ2ljKHRoaXMuamlyYUF1dGhGbik7XG4gIH1cblxuICBwcml2YXRlIG9uTG9nSW5XaXRoSmlyYVN1Y2Nlc3MobWVzc2FnZTogT2F1dGhKaXJhTWVzc2FnZSk6IHZvaWQge1xuICAgIGNvbnN0IHRva2VuID0gbWVzc2FnZS5kYXRhIGFzIHN0cmluZztcbiAgICBpZiAodHlwZW9mIHRva2VuICE9PSAnc3RyaW5nJykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLmxvZ2dlZEluLmVtaXQodG9rZW4pO1xuICAgIHRoaXMuY2RyLm1hcmtGb3JDaGVjaygpO1xuICB9XG5cbiAgcHJpdmF0ZSBvbkxvZ2luV2l0aEdtYWlsKCk6IHZvaWQge1xuICAgIHRoaXMuZG9Db21tb25PYXV0aExvZ2luTG9naWModGhpcy5nbWFpbEF1dGhGbik7XG4gIH1cblxuICBwcml2YXRlIG9uTG9nSW5XaXRoR21haWxTdWNjZXNzKG1lc3NhZ2U6IE9hdXRoTWVzc2FnZTxHbWFpbE9hdXRoQ29uZmlnPik6IHZvaWQge1xuICAgIGlmIChtZXNzYWdlLmRhdGEub2F1dGhfcG9ydGFsKSB7XG4gICAgICBpZiAobWVzc2FnZS5kYXRhLmVycm9yKSB7XG4gICAgICAgIHRoaXMuaGFuZGxlUHJvdmlkZXJFcnJvcihtZXNzYWdlLmRhdGEuZXJyb3IpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5sb2dnZWRJbi5lbWl0KG1lc3NhZ2UuZGF0YS5yZXN1bHQpO1xuICAgICAgICB0aGlzLmNkci5tYXJrRm9yQ2hlY2soKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIG9uTG9nSW5XaXRoUHJvdmlkZXIoKTogdm9pZCB7XG4gICAgY29uc3QgYXV0aEZuID0gKG1lc3NhZ2U6IE9hdXRoTWVzc2FnZTxPYXV0aFByb3ZpZGVyRGF0YT4pOiB2b2lkID0+IHRoaXMub25Mb2dnZWRJbldpdGhQcm92aWRlclN1Y2Nlc3MobWVzc2FnZSk7XG4gICAgdGhpcy5kb0NvbW1vbk9hdXRoTG9naW5Mb2dpYyhhdXRoRm4pO1xuICB9XG5cbiAgcHJpdmF0ZSBvbkxvZ2dlZEluV2l0aFByb3ZpZGVyU3VjY2VzcyA9IChtZXNzYWdlOiBPYXV0aE1lc3NhZ2U8T2F1dGhQcm92aWRlckRhdGE+KTogdm9pZCA9PiB7XG4gICAgaWYgKG1lc3NhZ2Uub3JpZ2luICE9PSAnaHR0cHM6Ly93d3cudHJ1ZW5hcy5jb20nKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmICghKCdvYXV0aF9wb3J0YWwnIGluIG1lc3NhZ2UuZGF0YSkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAobWVzc2FnZS5kYXRhLmVycm9yKSB7XG4gICAgICB0aGlzLmhhbmRsZVByb3ZpZGVyRXJyb3IobWVzc2FnZS5kYXRhLmVycm9yKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLmxvZ2dlZEluLmVtaXQobWVzc2FnZS5kYXRhLnJlc3VsdCk7XG4gIH07XG5cbiAgcHJpdmF0ZSBkb0NvbW1vbk9hdXRoTG9naW5Mb2dpYyhcbiAgICBhdXRoRm46IChcbiAgICAgIG1lc3NhZ2U6IE9hdXRoTWVzc2FnZTxHbWFpbE9hdXRoQ29uZmlnPiB8IE9hdXRoTWVzc2FnZTxPYXV0aFByb3ZpZGVyRGF0YT4gfCBPYXV0aEppcmFNZXNzYWdlXG4gICAgKSA9PiB2b2lkLFxuICApOiB2b2lkIHtcbiAgICB0aGlzLndpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgYXV0aEZuLCBmYWxzZSk7XG4gICAgdGhpcy53aW5kb3cub3BlbihcbiAgICAgIHRoaXMub2F1dGhVcmwgKyBlbmNvZGVVUklDb21wb25lbnQodGhpcy53aW5kb3cubG9jYXRpb24udG9TdHJpbmcoKSksXG4gICAgICAnX2JsYW5rJyxcbiAgICAgICd3aWR0aD02NDAsaGVpZ2h0PTQ4MCcsXG4gICAgKTtcbiAgICB0aGlzLndpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgYXV0aEZuLCBmYWxzZSk7XG4gIH1cblxuICBwcml2YXRlIGhhbmRsZVByb3ZpZGVyRXJyb3IoZXJyb3I6IHN0cmluZyk6IHZvaWQge1xuICAgIHRoaXMuZGlhbG9nU2VydmljZS5jbG9zZUFsbERpYWxvZ3MoKTtcblxuICAgIHRoaXMuZGlhbG9nU2VydmljZS5lcnJvcih7XG4gICAgICB0aXRsZTogdGhpcy50cmFuc2xhdGUuaW5zdGFudCgnRXJyb3InKSxcbiAgICAgIG1lc3NhZ2U6IGVycm9yLmluY2x1ZGVzKCdNaXNzaW5nIGNvZGUgcGFyYW1ldGVyIGluIHJlc3BvbnNlJylcbiAgICAgICAgPyB0aGlzLnRyYW5zbGF0ZS5pbnN0YW50KCdMb2dpbiB3YXMgY2FuY2VsZWQuIFBsZWFzZSB0cnkgYWdhaW4gaWYgeW91IHdhbnQgdG8gY29ubmVjdCB5b3VyIGFjY291bnQuJylcbiAgICAgICAgOiB0aGlzLnRyYW5zbGF0ZS5pbnN0YW50KGVycm9yKSxcbiAgICB9KTtcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9