16cca825fa880aa6b2486be4a72e20d1
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.ErrorHandlerService = void 0;
const http_1 = require("@angular/common/http");
const core_1 = require("@angular/core");
const core_2 = require("@ngx-translate/core");
const Sentry = __importStar(require("@sentry/angular"));
const rxjs_1 = require("rxjs");
const error_parser_helper_1 = require("app/helpers/error-parser.helper");
const websocket_helper_1 = require("app/helpers/websocket.helper");
const dialog_service_1 = require("app/modules/dialog/dialog.service");
let ErrorHandlerService = class ErrorHandlerService {
    get translate() {
        if (!this.translateService) {
            this.translateService = this.injector.get(core_2.TranslateService);
        }
        return this.translateService;
    }
    get dialog() {
        if (!this.dialogService) {
            this.dialogService = this.injector.get(dialog_service_1.DialogService);
        }
        return this.dialogService;
    }
    constructor(injector) {
        this.injector = injector;
    }
    handleError(error) {
        console.error(error);
        const parsedError = this.parseError(error);
        if (parsedError) {
            error = parsedError;
        }
        if (!this.shouldLogToSentry(error)) {
            return;
        }
        this.logToSentry(error);
    }
    parseError(error) {
        var _a;
        if (this.isWebSocketError(error)) {
            return this.parseWsError(error);
        }
        if (this.isJobError(error)) {
            return this.parseJobError(error);
        }
        if (this.isHttpError(error)) {
            return this.parseHttpError(error);
        }
        if (error instanceof Error) {
            return {
                title: ((_a = this.translate) === null || _a === void 0 ? void 0 : _a.instant('Error')) || 'Error',
                message: error.message,
            };
        }
        return null;
    }
    logToSentry(error) {
        Sentry.captureException((0, error_parser_helper_1.sentryCustomExceptionExtraction)(error));
    }
    isWebSocketError(error) {
        return (0, websocket_helper_1.isWebSocketError)(error);
    }
    isJobError(obj) {
        return typeof obj === 'object'
            && ('state' in obj
                && 'error' in obj
                && 'exception' in obj
                && 'exc_info' in obj);
    }
    isHttpError(obj) {
        return obj instanceof http_1.HttpErrorResponse;
    }
    catchError() {
        return (source$) => {
            return source$.pipe((0, rxjs_1.catchError)((error) => {
                this.showErrorModal(error);
                return rxjs_1.EMPTY;
            }));
        };
    }
    showErrorModal(error) {
        this.dialog.error(this.parseError(error));
    }
    parseWsError(error) {
        var _a, _b, _c;
        return {
            title: error.type || ((_a = error.trace) === null || _a === void 0 ? void 0 : _a.class) || this.translate.instant('Error'),
            message: error.reason || ((_b = error === null || error === void 0 ? void 0 : error.error) === null || _b === void 0 ? void 0 : _b.toString()),
            backtrace: ((_c = error.trace) === null || _c === void 0 ? void 0 : _c.formatted) || '',
        };
    }
    parseJobError(failedJob) {
        var _a;
        const errorJob = Object.assign({}, failedJob);
        if ((_a = errorJob.exc_info) === null || _a === void 0 ? void 0 : _a.extra) {
            errorJob.extra = errorJob.exc_info.extra;
        }
        if (errorJob.extra && Array.isArray(errorJob.extra)) {
            return this.parseJobWithArrayExtra(errorJob);
        }
        return {
            title: errorJob.state,
            message: errorJob.error,
            backtrace: errorJob.logs_excerpt || errorJob.exception,
        };
    }
    parseJobWithArrayExtra(errorJob) {
        const errors = [];
        errorJob.extra.forEach((extraItem) => {
            var _a, _b;
            const field = extraItem[0].split('.')[1];
            const extractedError = extraItem[1];
            const parsedError = this.parseJobExtractedError(errorJob, extractedError);
            if (Array.isArray(parsedError)) {
                for (const err of parsedError) {
                    if (err.title === (((_a = this.translate) === null || _a === void 0 ? void 0 : _a.instant('Error')) || 'Error')) {
                        err.title = err.title + ': ' + field;
                    }
                    else {
                        err.title = field + ': ' + err.title;
                    }
                    errors.push(err);
                }
            }
            else {
                if (parsedError.title === (((_b = this.translate) === null || _b === void 0 ? void 0 : _b.instant('Error')) || 'Error')) {
                    parsedError.title = parsedError.title + ': ' + field;
                }
                else {
                    parsedError.title = field + ': ' + parsedError.title;
                }
                errors.push(parsedError);
            }
        });
        return errors;
    }
    parseJobExtractedError(errorJob, extractedError) {
        var _a;
        let parsedError;
        if (this.isWebSocketError(extractedError)) {
            parsedError = this.parseWsError(extractedError);
        }
        else if (this.isJobError(extractedError)) {
            parsedError = this.parseJobError(extractedError);
        }
        else if (typeof extractedError === 'string') {
            parsedError = {
                title: (((_a = this.translate) === null || _a === void 0 ? void 0 : _a.instant('Error')) || 'Error'),
                message: extractedError,
                backtrace: errorJob.logs_path || errorJob.exception,
            };
        }
        return parsedError;
    }
    parseHttpErrorObject(error) {
        const errors = [];
        Object.keys(error.error).forEach((fieldKey) => {
            var _a;
            const errorEntity = error.error[fieldKey];
            if (typeof errorEntity === 'string') {
                errors.push({
                    title: ((_a = this.translate) === null || _a === void 0 ? void 0 : _a.instant('Error')) || 'Error',
                    message: errorEntity,
                });
            }
            else {
                errorEntity.forEach((item) => {
                    var _a;
                    errors.push({
                        title: ((_a = this.translate) === null || _a === void 0 ? void 0 : _a.instant('Error')) || 'Error',
                        message: item,
                    });
                });
            }
        });
        return errors;
    }
    parseHttpError(error) {
        var _a, _b, _c, _d, _e, _f, _g;
        console.error(error);
        switch (error.status) {
            case 401:
            case 403:
            case 404: {
                return {
                    title: error.statusText,
                    message: error.message,
                };
            }
            case 409: {
                return this.parseHttpErrorObject(error);
            }
            case 400: {
                if (typeof error.error === 'object') {
                    return this.parseHttpErrorObject(error);
                }
                return {
                    title: ((_a = this.translate) === null || _a === void 0 ? void 0 : _a.instant('Error ({code})', { code: error.status }))
                        || `Error (${error.status})`,
                    message: String(error.error),
                };
            }
            case 500: {
                const errorMessage = (_b = error.error) === null || _b === void 0 ? void 0 : _b.error_message;
                if (errorMessage) {
                    return {
                        title: ((_c = this.translate) === null || _c === void 0 ? void 0 : _c.instant('Error ({code})', { code: error.status }))
                            || `Error (${error.status})`,
                        message: errorMessage,
                    };
                }
                return {
                    title: ((_d = this.translate) === null || _d === void 0 ? void 0 : _d.instant('Error ({code})', { code: error.status }))
                        || `Error (${error.status})`,
                    message: ((_e = this.translate) === null || _e === void 0 ? void 0 : _e.instant('Server error: {error}', { error: error.message || error.error }))
                        || `Server error: ${error.message || error.error}`,
                };
            }
            default: {
                return {
                    title: ((_f = this.translate) === null || _f === void 0 ? void 0 : _f.instant('Error ({code})', { code: error.status }))
                        || `Error (${error.status})`,
                    message: error.message || ((_g = this.translate) === null || _g === void 0 ? void 0 : _g.instant('Fatal error! Check logs.')) || 'Fatal error! Check logs.',
                };
            }
        }
    }
    shouldLogToSentry(error) {
        if (error instanceof CloseEvent) {
            return false;
        }
        return true;
    }
};
exports.ErrorHandlerService = ErrorHandlerService;
ErrorHandlerService.ctorParameters = () => [
    { type: core_1.Injector }
];
exports.ErrorHandlerService = ErrorHandlerService = __decorate([
    (0, core_1.Injectable)({
        providedIn: 'root',
    })
], ErrorHandlerService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21hY2Jvb2sva2FycG92LXdvcmsvVHJ1ZU5BUy93ZWJ1aS9zcmMvYXBwL3NlcnZpY2VzL2Vycm9yLWhhbmRsZXIuc2VydmljZS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLCtDQUF5RDtBQUN6RCx3Q0FBbUU7QUFDbkUsOENBQXVEO0FBQ3ZELHdEQUEwQztBQUMxQywrQkFFYztBQUNkLHlFQUFrRjtBQUNsRixtRUFBZ0U7QUFJaEUsc0VBQWtFO0FBSzNELElBQU0sbUJBQW1CLEdBQXpCLE1BQU0sbUJBQW1CO0lBRzlCLElBQUksU0FBUztRQUNYLElBQUksQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztZQUMzQixJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsdUJBQWdCLENBQUMsQ0FBQztRQUM5RCxDQUFDO1FBQ0QsT0FBTyxJQUFJLENBQUMsZ0JBQWdCLENBQUM7SUFDL0IsQ0FBQztJQUVELElBQUksTUFBTTtRQUNSLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7WUFDeEIsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyw4QkFBYSxDQUFDLENBQUM7UUFDeEQsQ0FBQztRQUNELE9BQU8sSUFBSSxDQUFDLGFBQWEsQ0FBQztJQUM1QixDQUFDO0lBRUQsWUFBb0IsUUFBa0I7UUFBbEIsYUFBUSxHQUFSLFFBQVEsQ0FBVTtJQUFJLENBQUM7SUFFM0MsV0FBVyxDQUFDLEtBQWM7UUFDeEIsT0FBTyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNyQixNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzNDLElBQUksV0FBVyxFQUFFLENBQUM7WUFDaEIsS0FBSyxHQUFHLFdBQVcsQ0FBQztRQUN0QixDQUFDO1FBRUQsSUFBSSxDQUFDLElBQUksQ0FBQyxp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QUFFLENBQUM7WUFDaEMsT0FBTyxLQUFLLENBQUM7UUFDZixDQUFDO1FBRUQsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDOztBQTlPVSxrREFBbUI7Ozs7OEJBQW5CLG1CQUFtQjtJQUgvQixJQUFBLGlCQUFVLEVBQUM7UUFDVixVQUFVLEVBQUUsTUFBTTtLQUNuQixDQUFDO0dBQ1csbUJBQW1CLENBK08vQiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvbWFjYm9vay9rYXJwb3Ytd29yay9UcnVlTkFTL3dlYnVpL3NyYy9hcHAvc2VydmljZXMvZXJyb3ItaGFuZGxlci5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEh0dHBFcnJvclJlc3BvbnNlIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHsgRXJyb3JIYW5kbGVyLCBJbmplY3RhYmxlLCBJbmplY3RvciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgVHJhbnNsYXRlU2VydmljZSB9IGZyb20gJ0BuZ3gtdHJhbnNsYXRlL2NvcmUnO1xuaW1wb3J0ICogYXMgU2VudHJ5IGZyb20gJ0BzZW50cnkvYW5ndWxhcic7XG5pbXBvcnQge1xuICBjYXRjaEVycm9yLCBFTVBUWSwgTW9ub1R5cGVPcGVyYXRvckZ1bmN0aW9uLCBPYnNlcnZhYmxlLFxufSBmcm9tICdyeGpzJztcbmltcG9ydCB7IHNlbnRyeUN1c3RvbUV4Y2VwdGlvbkV4dHJhY3Rpb24gfSBmcm9tICdhcHAvaGVscGVycy9lcnJvci1wYXJzZXIuaGVscGVyJztcbmltcG9ydCB7IGlzV2ViU29ja2V0RXJyb3IgfSBmcm9tICdhcHAvaGVscGVycy93ZWJzb2NrZXQuaGVscGVyJztcbmltcG9ydCB7IEVycm9yUmVwb3J0IH0gZnJvbSAnYXBwL2ludGVyZmFjZXMvZXJyb3ItcmVwb3J0LmludGVyZmFjZSc7XG5pbXBvcnQgeyBKb2IgfSBmcm9tICdhcHAvaW50ZXJmYWNlcy9qb2IuaW50ZXJmYWNlJztcbmltcG9ydCB7IFdlYlNvY2tldEVycm9yIH0gZnJvbSAnYXBwL2ludGVyZmFjZXMvd2Vic29ja2V0LWVycm9yLmludGVyZmFjZSc7XG5pbXBvcnQgeyBEaWFsb2dTZXJ2aWNlIH0gZnJvbSAnYXBwL21vZHVsZXMvZGlhbG9nL2RpYWxvZy5zZXJ2aWNlJztcblxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCcsXG59KVxuZXhwb3J0IGNsYXNzIEVycm9ySGFuZGxlclNlcnZpY2UgaW1wbGVtZW50cyBFcnJvckhhbmRsZXIge1xuICBwcml2YXRlIGRpYWxvZ1NlcnZpY2U6IERpYWxvZ1NlcnZpY2U7XG4gIHByaXZhdGUgdHJhbnNsYXRlU2VydmljZTogVHJhbnNsYXRlU2VydmljZTtcbiAgZ2V0IHRyYW5zbGF0ZSgpOiBUcmFuc2xhdGVTZXJ2aWNlIHtcbiAgICBpZiAoIXRoaXMudHJhbnNsYXRlU2VydmljZSkge1xuICAgICAgdGhpcy50cmFuc2xhdGVTZXJ2aWNlID0gdGhpcy5pbmplY3Rvci5nZXQoVHJhbnNsYXRlU2VydmljZSk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLnRyYW5zbGF0ZVNlcnZpY2U7XG4gIH1cblxuICBnZXQgZGlhbG9nKCk6IERpYWxvZ1NlcnZpY2Uge1xuICAgIGlmICghdGhpcy5kaWFsb2dTZXJ2aWNlKSB7XG4gICAgICB0aGlzLmRpYWxvZ1NlcnZpY2UgPSB0aGlzLmluamVjdG9yLmdldChEaWFsb2dTZXJ2aWNlKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuZGlhbG9nU2VydmljZTtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yKSB7IH1cblxuICBoYW5kbGVFcnJvcihlcnJvcjogdW5rbm93bik6IHZvaWQge1xuICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgIGNvbnN0IHBhcnNlZEVycm9yID0gdGhpcy5wYXJzZUVycm9yKGVycm9yKTtcbiAgICBpZiAocGFyc2VkRXJyb3IpIHtcbiAgICAgIGVycm9yID0gcGFyc2VkRXJyb3I7XG4gICAgfVxuXG4gICAgaWYgKCF0aGlzLnNob3VsZExvZ1RvU2VudHJ5KGVycm9yKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRoaXMubG9nVG9TZW50cnkoZXJyb3IpO1xuICB9XG5cbiAgcGFyc2VFcnJvcihlcnJvcjogdW5rbm93bik6IEVycm9yUmVwb3J0IHwgRXJyb3JSZXBvcnRbXSB7XG4gICAgaWYgKHRoaXMuaXNXZWJTb2NrZXRFcnJvcihlcnJvcikpIHtcbiAgICAgIHJldHVybiB0aGlzLnBhcnNlV3NFcnJvcihlcnJvcik7XG4gICAgfVxuICAgIGlmICh0aGlzLmlzSm9iRXJyb3IoZXJyb3IpKSB7XG4gICAgICByZXR1cm4gdGhpcy5wYXJzZUpvYkVycm9yKGVycm9yKTtcbiAgICB9XG4gICAgaWYgKHRoaXMuaXNIdHRwRXJyb3IoZXJyb3IpKSB7XG4gICAgICByZXR1cm4gdGhpcy5wYXJzZUh0dHBFcnJvcihlcnJvcik7XG4gICAgfVxuICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEVycm9yKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICB0aXRsZTogdGhpcy50cmFuc2xhdGU/Lmluc3RhbnQoJ0Vycm9yJykgfHwgJ0Vycm9yJyxcbiAgICAgICAgbWVzc2FnZTogZXJyb3IubWVzc2FnZSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBsb2dUb1NlbnRyeShlcnJvcjogdW5rbm93bik6IHZvaWQge1xuICAgIFNlbnRyeS5jYXB0dXJlRXhjZXB0aW9uKHNlbnRyeUN1c3RvbUV4Y2VwdGlvbkV4dHJhY3Rpb24oZXJyb3IpKTtcbiAgfVxuXG4gIGlzV2ViU29ja2V0RXJyb3IoZXJyb3I6IHVua25vd24pOiBlcnJvciBpcyBXZWJTb2NrZXRFcnJvciB7XG4gICAgcmV0dXJuIGlzV2ViU29ja2V0RXJyb3IoZXJyb3IpO1xuICB9XG5cbiAgaXNKb2JFcnJvcihvYmo6IHVua25vd24pOiBvYmogaXMgSm9iIHtcbiAgICByZXR1cm4gdHlwZW9mIG9iaiA9PT0gJ29iamVjdCdcbiAgICAmJiAoJ3N0YXRlJyBpbiBvYmpcbiAgICAgICYmICdlcnJvcicgaW4gb2JqXG4gICAgICAmJiAnZXhjZXB0aW9uJyBpbiBvYmpcbiAgICAgICYmICdleGNfaW5mbycgaW4gb2JqKTtcbiAgfVxuXG4gIGlzSHR0cEVycm9yKG9iajogdW5rbm93bik6IG9iaiBpcyBIdHRwRXJyb3JSZXNwb25zZSB7XG4gICAgcmV0dXJuIG9iaiBpbnN0YW5jZW9mIEh0dHBFcnJvclJlc3BvbnNlO1xuICB9XG5cbiAgY2F0Y2hFcnJvcjxUPigpOiBNb25vVHlwZU9wZXJhdG9yRnVuY3Rpb248VD4ge1xuICAgIHJldHVybiAoc291cmNlJDogT2JzZXJ2YWJsZTxUPikgPT4ge1xuICAgICAgcmV0dXJuIHNvdXJjZSQucGlwZShcbiAgICAgICAgY2F0Y2hFcnJvcigoZXJyb3I6IHVua25vd24pID0+IHtcbiAgICAgICAgICB0aGlzLnNob3dFcnJvck1vZGFsKGVycm9yKTtcbiAgICAgICAgICByZXR1cm4gRU1QVFk7XG4gICAgICAgIH0pLFxuICAgICAgKTtcbiAgICB9O1xuICB9XG5cbiAgc2hvd0Vycm9yTW9kYWwoZXJyb3I6IHVua25vd24pOiB2b2lkIHtcbiAgICB0aGlzLmRpYWxvZy5lcnJvcih0aGlzLnBhcnNlRXJyb3IoZXJyb3IpKTtcbiAgfVxuXG4gIHByaXZhdGUgcGFyc2VXc0Vycm9yKGVycm9yOiBXZWJTb2NrZXRFcnJvcik6IEVycm9yUmVwb3J0IHtcbiAgICByZXR1cm4ge1xuICAgICAgdGl0bGU6IGVycm9yLnR5cGUgfHwgZXJyb3IudHJhY2U/LmNsYXNzIHx8IHRoaXMudHJhbnNsYXRlLmluc3RhbnQoJ0Vycm9yJyksXG4gICAgICBtZXNzYWdlOiBlcnJvci5yZWFzb24gfHwgZXJyb3I/LmVycm9yPy50b1N0cmluZygpLFxuICAgICAgYmFja3RyYWNlOiBlcnJvci50cmFjZT8uZm9ybWF0dGVkIHx8ICcnLFxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIHBhcnNlSm9iRXJyb3IoZmFpbGVkSm9iOiBKb2IpOiBFcnJvclJlcG9ydCB8IEVycm9yUmVwb3J0W10ge1xuICAgIGNvbnN0IGVycm9ySm9iID0geyAuLi5mYWlsZWRKb2IgfTtcbiAgICBpZiAoZXJyb3JKb2IuZXhjX2luZm8/LmV4dHJhKSB7XG4gICAgICBlcnJvckpvYi5leHRyYSA9IGVycm9ySm9iLmV4Y19pbmZvLmV4dHJhIGFzIFJlY29yZDxzdHJpbmcsIHVua25vd24+O1xuICAgIH1cblxuICAgIGlmIChlcnJvckpvYi5leHRyYSAmJiBBcnJheS5pc0FycmF5KGVycm9ySm9iLmV4dHJhKSkge1xuICAgICAgcmV0dXJuIHRoaXMucGFyc2VKb2JXaXRoQXJyYXlFeHRyYShlcnJvckpvYik7XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIHRpdGxlOiBlcnJvckpvYi5zdGF0ZSxcbiAgICAgIG1lc3NhZ2U6IGVycm9ySm9iLmVycm9yLFxuICAgICAgYmFja3RyYWNlOiBlcnJvckpvYi5sb2dzX2V4Y2VycHQgfHwgZXJyb3JKb2IuZXhjZXB0aW9uLFxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIHBhcnNlSm9iV2l0aEFycmF5RXh0cmEoZXJyb3JKb2I6IEpvYik6IEVycm9yUmVwb3J0W10ge1xuICAgIGNvbnN0IGVycm9yczogRXJyb3JSZXBvcnRbXSA9IFtdO1xuICAgIChlcnJvckpvYi5leHRyYSBhcyB1bmtub3duIGFzIHVua25vd25bXSkuZm9yRWFjaCgoZXh0cmFJdGVtOiBbc3RyaW5nLCB1bmtub3duXSkgPT4ge1xuICAgICAgY29uc3QgZmllbGQgPSBleHRyYUl0ZW1bMF0uc3BsaXQoJy4nKVsxXTtcbiAgICAgIGNvbnN0IGV4dHJhY3RlZEVycm9yID0gZXh0cmFJdGVtWzFdIGFzIHN0cmluZyB8IFdlYlNvY2tldEVycm9yIHwgSm9iO1xuXG4gICAgICBjb25zdCBwYXJzZWRFcnJvciA9IHRoaXMucGFyc2VKb2JFeHRyYWN0ZWRFcnJvcihlcnJvckpvYiwgZXh0cmFjdGVkRXJyb3IpO1xuXG4gICAgICBpZiAoQXJyYXkuaXNBcnJheShwYXJzZWRFcnJvcikpIHtcbiAgICAgICAgZm9yIChjb25zdCBlcnIgb2YgcGFyc2VkRXJyb3IpIHtcbiAgICAgICAgICBpZiAoZXJyLnRpdGxlID09PSAodGhpcy50cmFuc2xhdGU/Lmluc3RhbnQoJ0Vycm9yJykgfHwgJ0Vycm9yJykpIHtcbiAgICAgICAgICAgIGVyci50aXRsZSA9IGVyci50aXRsZSArICc6ICcgKyBmaWVsZDtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZXJyLnRpdGxlID0gZmllbGQgKyAnOiAnICsgZXJyLnRpdGxlO1xuICAgICAgICAgIH1cbiAgICAgICAgICBlcnJvcnMucHVzaChlcnIpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAocGFyc2VkRXJyb3IudGl0bGUgPT09ICh0aGlzLnRyYW5zbGF0ZT8uaW5zdGFudCgnRXJyb3InKSB8fCAnRXJyb3InKSkge1xuICAgICAgICAgIHBhcnNlZEVycm9yLnRpdGxlID0gcGFyc2VkRXJyb3IudGl0bGUgKyAnOiAnICsgZmllbGQ7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcGFyc2VkRXJyb3IudGl0bGUgPSBmaWVsZCArICc6ICcgKyBwYXJzZWRFcnJvci50aXRsZTtcbiAgICAgICAgfVxuICAgICAgICBlcnJvcnMucHVzaChwYXJzZWRFcnJvcik7XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIGVycm9ycztcbiAgfVxuXG4gIHByaXZhdGUgcGFyc2VKb2JFeHRyYWN0ZWRFcnJvcihcbiAgICBlcnJvckpvYjogSm9iLFxuICAgIGV4dHJhY3RlZEVycm9yOiBzdHJpbmcgfCBXZWJTb2NrZXRFcnJvciB8IEpvYixcbiAgKTogRXJyb3JSZXBvcnQgfCBFcnJvclJlcG9ydFtdIHtcbiAgICBsZXQgcGFyc2VkRXJyb3I6IEVycm9yUmVwb3J0IHwgRXJyb3JSZXBvcnRbXTtcbiAgICBpZiAodGhpcy5pc1dlYlNvY2tldEVycm9yKGV4dHJhY3RlZEVycm9yKSkge1xuICAgICAgcGFyc2VkRXJyb3IgPSB0aGlzLnBhcnNlV3NFcnJvcihleHRyYWN0ZWRFcnJvcik7XG4gICAgfSBlbHNlIGlmICh0aGlzLmlzSm9iRXJyb3IoZXh0cmFjdGVkRXJyb3IpKSB7XG4gICAgICBwYXJzZWRFcnJvciA9IHRoaXMucGFyc2VKb2JFcnJvcihleHRyYWN0ZWRFcnJvcik7XG4gICAgfSBlbHNlIGlmICh0eXBlb2YgZXh0cmFjdGVkRXJyb3IgPT09ICdzdHJpbmcnKSB7XG4gICAgICBwYXJzZWRFcnJvciA9IHtcbiAgICAgICAgdGl0bGU6ICh0aGlzLnRyYW5zbGF0ZT8uaW5zdGFudCgnRXJyb3InKSB8fCAnRXJyb3InKSxcbiAgICAgICAgbWVzc2FnZTogZXh0cmFjdGVkRXJyb3IsXG4gICAgICAgIGJhY2t0cmFjZTogZXJyb3JKb2IubG9nc19wYXRoIHx8IGVycm9ySm9iLmV4Y2VwdGlvbixcbiAgICAgIH07XG4gICAgfVxuICAgIHJldHVybiBwYXJzZWRFcnJvcjtcbiAgfVxuXG4gIHByaXZhdGUgcGFyc2VIdHRwRXJyb3JPYmplY3QoZXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKTogRXJyb3JSZXBvcnRbXSB7XG4gICAgY29uc3QgZXJyb3JzOiBFcnJvclJlcG9ydFtdID0gW107XG4gICAgT2JqZWN0LmtleXMoZXJyb3IuZXJyb3IgYXMgUmVjb3JkPHN0cmluZywgc3RyaW5nIHwgc3RyaW5nW10+KS5mb3JFYWNoKChmaWVsZEtleSkgPT4ge1xuICAgICAgY29uc3QgZXJyb3JFbnRpdHkgPSAoZXJyb3IuZXJyb3IgYXMgUmVjb3JkPHN0cmluZywgc3RyaW5nIHwgc3RyaW5nW10+KVtmaWVsZEtleV07XG4gICAgICBpZiAodHlwZW9mIGVycm9yRW50aXR5ID09PSAnc3RyaW5nJykge1xuICAgICAgICBlcnJvcnMucHVzaCh7XG4gICAgICAgICAgdGl0bGU6IHRoaXMudHJhbnNsYXRlPy5pbnN0YW50KCdFcnJvcicpIHx8ICdFcnJvcicsXG4gICAgICAgICAgbWVzc2FnZTogZXJyb3JFbnRpdHksXG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZXJyb3JFbnRpdHkuZm9yRWFjaCgoaXRlbTogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgZXJyb3JzLnB1c2goe1xuICAgICAgICAgICAgdGl0bGU6IHRoaXMudHJhbnNsYXRlPy5pbnN0YW50KCdFcnJvcicpIHx8ICdFcnJvcicsXG4gICAgICAgICAgICBtZXNzYWdlOiBpdGVtLFxuICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gZXJyb3JzO1xuICB9XG5cbiAgcGFyc2VIdHRwRXJyb3IoZXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKTogRXJyb3JSZXBvcnQgfCBFcnJvclJlcG9ydFtdIHtcbiAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAgICBzd2l0Y2ggKGVycm9yLnN0YXR1cykge1xuICAgICAgY2FzZSA0MDE6XG4gICAgICBjYXNlIDQwMzpcbiAgICAgIGNhc2UgNDA0OiB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgdGl0bGU6IGVycm9yLnN0YXR1c1RleHQsXG4gICAgICAgICAgbWVzc2FnZTogZXJyb3IubWVzc2FnZSxcbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICAgIGNhc2UgNDA5OiB7XG4gICAgICAgIHJldHVybiB0aGlzLnBhcnNlSHR0cEVycm9yT2JqZWN0KGVycm9yKTtcbiAgICAgIH1cbiAgICAgIGNhc2UgNDAwOiB7XG4gICAgICAgIGlmICh0eXBlb2YgZXJyb3IuZXJyb3IgPT09ICdvYmplY3QnKSB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMucGFyc2VIdHRwRXJyb3JPYmplY3QoZXJyb3IpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgdGl0bGU6IHRoaXMudHJhbnNsYXRlPy5pbnN0YW50KCdFcnJvciAoe2NvZGV9KScsIHsgY29kZTogZXJyb3Iuc3RhdHVzIH0pXG4gICAgICAgICAgICAgIHx8IGBFcnJvciAoJHtlcnJvci5zdGF0dXN9KWAsXG4gICAgICAgICAgbWVzc2FnZTogU3RyaW5nKGVycm9yLmVycm9yKSxcbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICAgIGNhc2UgNTAwOiB7XG4gICAgICAgIGNvbnN0IGVycm9yTWVzc2FnZSA9IChlcnJvci5lcnJvciBhcyBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+KT8uZXJyb3JfbWVzc2FnZTtcbiAgICAgICAgaWYgKGVycm9yTWVzc2FnZSkge1xuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICB0aXRsZTogdGhpcy50cmFuc2xhdGU/Lmluc3RhbnQoJ0Vycm9yICh7Y29kZX0pJywgeyBjb2RlOiBlcnJvci5zdGF0dXMgfSlcbiAgICAgICAgICAgICAgfHwgYEVycm9yICgke2Vycm9yLnN0YXR1c30pYCxcbiAgICAgICAgICAgIG1lc3NhZ2U6IGVycm9yTWVzc2FnZSxcbiAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgdGl0bGU6IHRoaXMudHJhbnNsYXRlPy5pbnN0YW50KCdFcnJvciAoe2NvZGV9KScsIHsgY29kZTogZXJyb3Iuc3RhdHVzIH0pXG4gICAgICAgICAgICB8fCBgRXJyb3IgKCR7ZXJyb3Iuc3RhdHVzfSlgLFxuICAgICAgICAgIG1lc3NhZ2U6IHRoaXMudHJhbnNsYXRlPy5pbnN0YW50KCdTZXJ2ZXIgZXJyb3I6IHtlcnJvcn0nLCB7IGVycm9yOiBlcnJvci5tZXNzYWdlIHx8IGVycm9yLmVycm9yIH0pXG4gICAgICAgICAgICB8fCBgU2VydmVyIGVycm9yOiAke2Vycm9yLm1lc3NhZ2UgfHwgZXJyb3IuZXJyb3J9YCxcbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICAgIGRlZmF1bHQ6IHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICB0aXRsZTogdGhpcy50cmFuc2xhdGU/Lmluc3RhbnQoJ0Vycm9yICh7Y29kZX0pJywgeyBjb2RlOiBlcnJvci5zdGF0dXMgfSlcbiAgICAgICAgICAgIHx8IGBFcnJvciAoJHtlcnJvci5zdGF0dXN9KWAsXG4gICAgICAgICAgbWVzc2FnZTogZXJyb3IubWVzc2FnZSB8fCB0aGlzLnRyYW5zbGF0ZT8uaW5zdGFudCgnRmF0YWwgZXJyb3IhIENoZWNrIGxvZ3MuJykgfHwgJ0ZhdGFsIGVycm9yISBDaGVjayBsb2dzLicsXG4gICAgICAgIH07XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzaG91bGRMb2dUb1NlbnRyeShlcnJvcjogdW5rbm93bik6IGJvb2xlYW4ge1xuICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIENsb3NlRXZlbnQpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9