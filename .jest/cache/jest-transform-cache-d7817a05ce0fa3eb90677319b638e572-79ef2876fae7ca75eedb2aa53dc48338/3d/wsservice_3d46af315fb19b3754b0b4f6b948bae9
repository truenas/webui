7f3293bc37ef2661e3083395cde7af13
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.WebSocketService = void 0;
const core_1 = require("@angular/core");
const router_1 = require("@angular/router");
const core_2 = require("@ngx-translate/core");
const angular2_uuid_1 = require("angular2-uuid");
const rxjs_1 = require("rxjs");
const operators_1 = require("rxjs/operators");
const api_message_type_enum_1 = require("app/enums/api-message-type.enum");
const response_error_type_enum_1 = require("app/enums/response-error-type.enum");
const websocket_error_name_enum_1 = require("app/enums/websocket-error-name.enum");
const apply_api_event_operator_1 = require("app/helpers/operators/apply-api-event.operator");
const observe_job_operator_1 = require("app/helpers/operators/observe-job.operator");
const websocket_connection_service_1 = require("app/services/websocket-connection.service");
let WebSocketService = class WebSocketService {
    constructor(router, wsManager, translate) {
        var _a;
        this.router = router;
        this.wsManager = wsManager;
        this.translate = translate;
        this.eventSubscribers = new Map();
        this.clearSubscriptions$ = new rxjs_1.Subject();
        (_a = this.wsManager.isConnected$) === null || _a === void 0 ? void 0 : _a.subscribe((isConnected) => {
            if (!isConnected) {
                this.clearSubscriptions();
            }
        });
    }
    get ws$() {
        return this.wsManager.websocket$;
    }
    call(method, params) {
        return this.callMethod(method, params);
    }
    /**
     * For jobs better to use the `selectJob` store selector.
     */
    callAndSubscribe(method, params) {
        return this.callMethod(method, params)
            .pipe((0, operators_1.switchMap)((items) => this.subscribe(method).pipe((0, operators_1.startWith)(null), (0, operators_1.map)((event) => ([items, event])))), (0, apply_api_event_operator_1.applyApiEvent)(), (0, operators_1.takeUntil)(this.clearSubscriptions$));
    }
    /**
     * Use `job` when you care about job progress or result.
     */
    startJob(method, params) {
        return this.callMethod(method, params);
    }
    /**
     * In your subscription, next will be next job update, complete will be when the job is complete.
     */
    job(method, params) {
        return this.callMethod(method, params).pipe((0, operators_1.switchMap)((jobId) => {
            return (0, rxjs_1.merge)(this.subscribeToJobUpdates(jobId), 
            // Get job status here for jobs that complete too fast.
            this.call('core.get_jobs', [[['id', '=', jobId]]]).pipe((0, operators_1.map)((jobs) => jobs[0])))
                .pipe((0, observe_job_operator_1.observeJob)());
        }), (0, operators_1.takeUntil)(this.clearSubscriptions$));
    }
    subscribe(method) {
        if (this.eventSubscribers.has(method)) {
            return this.eventSubscribers.get(method);
        }
        const observable$ = new rxjs_1.Observable((trigger) => {
            const subscription = this.wsManager.buildSubscriber(method).subscribe(trigger);
            return () => {
                subscription.unsubscribe();
                this.eventSubscribers.delete(method);
            };
        }).pipe((0, operators_1.switchMap)((apiEvent) => {
            const erroredEvent = apiEvent;
            if (erroredEvent === null || erroredEvent === void 0 ? void 0 : erroredEvent.error) {
                console.error('Error: ', erroredEvent.error);
                return (0, rxjs_1.throwError)(() => erroredEvent.error);
            }
            return (0, rxjs_1.of)(apiEvent);
        }), (0, operators_1.share)(), (0, operators_1.takeUntil)(this.clearSubscriptions$));
        this.eventSubscribers.set(method, observable$);
        return observable$;
    }
    subscribeToLogs(name) {
        return this.subscribe(name);
    }
    clearSubscriptions() {
        this.clearSubscriptions$.next();
        this.eventSubscribers.clear();
    }
    getWebSocketStream$() {
        return this.ws$;
    }
    callMethod(method, params) {
        const uuid = angular2_uuid_1.UUID.UUID();
        return (0, rxjs_1.of)(uuid).pipe((0, operators_1.tap)(() => {
            performance.mark(`${method} - ${uuid} - start`);
            this.wsManager.send({
                id: uuid, msg: api_message_type_enum_1.IncomingApiMessageType.Method, method, params,
            });
        }), (0, operators_1.switchMap)(() => this.ws$), (0, operators_1.filter)((data) => data.msg === api_message_type_enum_1.IncomingApiMessageType.Result && data.id === uuid), (0, operators_1.switchMap)((data) => {
            if ('error' in data && data.error) {
                this.printError(data.error, { method, params });
                const error = this.enhanceError(data.error, { method });
                return (0, rxjs_1.throwError)(() => error);
            }
            performance.mark(`${method} - ${uuid} - end`);
            performance.measure(method, `${method} - ${uuid} - start`, `${method} - ${uuid} - end`);
            return (0, rxjs_1.of)(data);
        }), (0, operators_1.map)((data) => data.result), (0, operators_1.take)(1));
    }
    subscribeToJobUpdates(jobId) {
        return this.subscribe('core.get_jobs').pipe((0, operators_1.filter)((apiEvent) => apiEvent.id === jobId), (0, operators_1.map)((apiEvent) => apiEvent.fields), (0, operators_1.takeUntil)(this.clearSubscriptions$));
    }
    printError(error, context) {
        if (error.errname === websocket_error_name_enum_1.WebSocketErrorName.NoAccess) {
            console.error(`Access denied to ${context.method} with ${context.params ? JSON.stringify(context.params) : 'no params'}`);
            return;
        }
        // Do not log validation errors.
        if (error.type === response_error_type_enum_1.ResponseErrorType.Validation) {
            return;
        }
        console.error('Error: ', error);
    }
    // TODO: Probably doesn't belong here. Consider building something similar to interceptors.
    enhanceError(error, context) {
        if (error.errname === websocket_error_name_enum_1.WebSocketErrorName.NoAccess) {
            return Object.assign(Object.assign({}, error), { reason: this.translate.instant('Access denied to {method}', { method: context.method }) });
        }
        return error;
    }
};
exports.WebSocketService = WebSocketService;
WebSocketService.ctorParameters = () => [
    { type: router_1.Router },
    { type: websocket_connection_service_1.WebSocketConnectionService },
    { type: core_2.TranslateService }
];
exports.WebSocketService = WebSocketService = __decorate([
    (0, core_1.Injectable)({
        providedIn: 'root',
    })
], WebSocketService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21hY2Jvb2sva2FycG92LXdvcmsvVHJ1ZU5BUy93ZWJ1aS9zcmMvYXBwL3NlcnZpY2VzL3dzLnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUEsd0NBQTJDO0FBQzNDLDRDQUF5QztBQUN6Qyw4Q0FBdUQ7QUFDdkQsaURBQXFDO0FBQ3JDLCtCQUVjO0FBQ2QsOENBRXdCO0FBQ3hCLDJFQUF5RTtBQUN6RSxpRkFBdUU7QUFDdkUsbUZBQXlFO0FBQ3pFLDZGQUErRTtBQUMvRSxxRkFBd0U7QUFpQnhFLDRGQUF1RjtBQUtoRixJQUFNLGdCQUFnQixHQUF0QixNQUFNLGdCQUFnQjtJQUkzQixZQUNZLE1BQWMsRUFDZCxTQUFxQyxFQUNyQyxTQUEyQjs7UUFGM0IsV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQUNkLGNBQVMsR0FBVCxTQUFTLENBQTRCO1FBQ3JDLGNBQVMsR0FBVCxTQUFTLENBQWtCO1FBTnRCLHFCQUFnQixHQUFHLElBQUksR0FBRyxFQUE2QyxDQUFDO1FBQ2hGLHdCQUFtQixHQUFHLElBQUksY0FBTyxFQUFRLENBQUM7UUFPakQsTUFBQSxJQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksMENBQUUsU0FBUyxDQUFDLENBQUMsV0FBVyxFQUFFLEVBQUU7WUFDckQsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO2dCQUNqQixJQUFJLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztZQUM1QixDQUFDO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsSUFBWSxHQUFHO1FBQ2IsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQztJQUNuQyxDQUFDO0lBRUQsSUFBSSxDQUEwQixNQUFTLEVBQUUsTUFBeUI7UUFDaEUsT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sRUFBRSxNQUFNLENBQUMsQ0FBQztJQUN6QyxDQUFDO0lBRUQ7O09BRUc7SUFDSCxnQkFBZ0IsQ0FDZCxNQUFTLEVBQ1QsTUFBeUI7UUFFekIsT0FBTyxJQUFJLENBQUMsVUFB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c3JjL2FwcC9zZXJ2aWNlcy93cy5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFJvdXRlciB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5pbXBvcnQgeyBUcmFuc2xhdGVTZXJ2aWNlIH0gZnJvbSAnQG5neC10cmFuc2xhdGUvY29yZSc7XG5pbXBvcnQgeyBVVUlEIH0gZnJvbSAnYW5ndWxhcjItdXVpZCc7XG5pbXBvcnQge1xuICBtZXJnZSwgT2JzZXJ2YWJsZSwgb2YsIFN1YmplY3QsIFN1YnNjcmliZXIsIHRocm93RXJyb3IsXG59IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtcbiAgZmlsdGVyLCBtYXAsIHNoYXJlLCBzdGFydFdpdGgsIHN3aXRjaE1hcCwgdGFrZSwgdGFrZVVudGlsLCB0YXAsXG59IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEluY29taW5nQXBpTWVzc2FnZVR5cGUgfSBmcm9tICdhcHAvZW51bXMvYXBpLW1lc3NhZ2UtdHlwZS5lbnVtJztcbmltcG9ydCB7IFJlc3BvbnNlRXJyb3JUeXBlIH0gZnJvbSAnYXBwL2VudW1zL3Jlc3BvbnNlLWVycm9yLXR5cGUuZW51bSc7XG5pbXBvcnQgeyBXZWJTb2NrZXRFcnJvck5hbWUgfSBmcm9tICdhcHAvZW51bXMvd2Vic29ja2V0LWVycm9yLW5hbWUuZW51bSc7XG5pbXBvcnQgeyBhcHBseUFwaUV2ZW50IH0gZnJvbSAnYXBwL2hlbHBlcnMvb3BlcmF0b3JzL2FwcGx5LWFwaS1ldmVudC5vcGVyYXRvcic7XG5pbXBvcnQgeyBvYnNlcnZlSm9iIH0gZnJvbSAnYXBwL2hlbHBlcnMvb3BlcmF0b3JzL29ic2VydmUtam9iLm9wZXJhdG9yJztcbmltcG9ydCB7IEFwaUNhbGxBbmRTdWJzY3JpYmVNZXRob2QsIEFwaUNhbGxBbmRTdWJzY3JpYmVSZXNwb25zZSB9IGZyb20gJ2FwcC9pbnRlcmZhY2VzL2FwaS9hcGktY2FsbC1hbmQtc3Vic2NyaWJlLWRpcmVjdG9yeS5pbnRlcmZhY2UnO1xuaW1wb3J0IHtcbiAgQXBpQ2FsbE1ldGhvZCxcbiAgQXBpQ2FsbFBhcmFtcyxcbiAgQXBpQ2FsbFJlc3BvbnNlLFxufSBmcm9tICdhcHAvaW50ZXJmYWNlcy9hcGkvYXBpLWNhbGwtZGlyZWN0b3J5LmludGVyZmFjZSc7XG5pbXBvcnQge1xuICBBcGlKb2JNZXRob2QsXG4gIEFwaUpvYlBhcmFtcyxcbiAgQXBpSm9iUmVzcG9uc2UsXG59IGZyb20gJ2FwcC9pbnRlcmZhY2VzL2FwaS9hcGktam9iLWRpcmVjdG9yeS5pbnRlcmZhY2UnO1xuaW1wb3J0IHtcbiAgQXBpRXZlbnQsIEFwaUV2ZW50TWV0aG9kLCBBcGlFdmVudFR5cGVkLCBJbmNvbWluZ1dlYlNvY2tldE1lc3NhZ2UsIFJlc3VsdE1lc3NhZ2UsXG59IGZyb20gJ2FwcC9pbnRlcmZhY2VzL2FwaS1tZXNzYWdlLmludGVyZmFjZSc7XG5pbXBvcnQgeyBKb2IgfSBmcm9tICdhcHAvaW50ZXJmYWNlcy9qb2IuaW50ZXJmYWNlJztcbmltcG9ydCB7IFdlYlNvY2tldEVycm9yIH0gZnJvbSAnYXBwL2ludGVyZmFjZXMvd2Vic29ja2V0LWVycm9yLmludGVyZmFjZSc7XG5pbXBvcnQgeyBXZWJTb2NrZXRDb25uZWN0aW9uU2VydmljZSB9IGZyb20gJ2FwcC9zZXJ2aWNlcy93ZWJzb2NrZXQtY29ubmVjdGlvbi5zZXJ2aWNlJztcblxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCcsXG59KVxuZXhwb3J0IGNsYXNzIFdlYlNvY2tldFNlcnZpY2Uge1xuICBwcml2YXRlIHJlYWRvbmx5IGV2ZW50U3Vic2NyaWJlcnMgPSBuZXcgTWFwPEFwaUV2ZW50TWV0aG9kLCBPYnNlcnZhYmxlPEFwaUV2ZW50VHlwZWQ+PigpO1xuICByZWFkb25seSBjbGVhclN1YnNjcmlwdGlvbnMkID0gbmV3IFN1YmplY3Q8dm9pZD4oKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcm90ZWN0ZWQgcm91dGVyOiBSb3V0ZXIsXG4gICAgcHJvdGVjdGVkIHdzTWFuYWdlcjogV2ViU29ja2V0Q29ubmVjdGlvblNlcnZpY2UsXG4gICAgcHJvdGVjdGVkIHRyYW5zbGF0ZTogVHJhbnNsYXRlU2VydmljZSxcbiAgKSB7XG4gICAgdGhpcy53c01hbmFnZXIuaXNDb25uZWN0ZWQkPy5zdWJzY3JpYmUoKGlzQ29ubmVjdGVkKSA9PiB7XG4gICAgICBpZiAoIWlzQ29ubmVjdGVkKSB7XG4gICAgICAgIHRoaXMuY2xlYXJTdWJzY3JpcHRpb25zKCk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGdldCB3cyQoKTogT2JzZXJ2YWJsZTx1bmtub3duPiB7XG4gICAgcmV0dXJuIHRoaXMud3NNYW5hZ2VyLndlYnNvY2tldCQ7XG4gIH1cblxuICBjYWxsPE0gZXh0ZW5kcyBBcGlDYWxsTWV0aG9kPihtZXRob2Q6IE0sIHBhcmFtcz86IEFwaUNhbGxQYXJhbXM8TT4pOiBPYnNlcnZhYmxlPEFwaUNhbGxSZXNwb25zZTxNPj4ge1xuICAgIHJldHVybiB0aGlzLmNhbGxNZXRob2QobWV0aG9kLCBwYXJhbXMpO1xuICB9XG5cbiAgLyoqXG4gICAqIEZvciBqb2JzIGJldHRlciB0byB1c2UgdGhlIGBzZWxlY3RKb2JgIHN0b3JlIHNlbGVjdG9yLlxuICAgKi9cbiAgY2FsbEFuZFN1YnNjcmliZTxNIGV4dGVuZHMgQXBpQ2FsbEFuZFN1YnNjcmliZU1ldGhvZD4oXG4gICAgbWV0aG9kOiBNLFxuICAgIHBhcmFtcz86IEFwaUNhbGxQYXJhbXM8TT4sXG4gICk6IE9ic2VydmFibGU8QXBpQ2FsbEFuZFN1YnNjcmliZVJlc3BvbnNlPE0+W10+IHtcbiAgICByZXR1cm4gdGhpcy5jYWxsTWV0aG9kPE0+KG1ldGhvZCwgcGFyYW1zKVxuICAgICAgLnBpcGUoXG4gICAgICAgIHN3aXRjaE1hcCgoaXRlbXMpID0+IHRoaXMuc3Vic2NyaWJlKG1ldGhvZCkucGlwZShcbiAgICAgICAgICBzdGFydFdpdGgobnVsbCksXG4gICAgICAgICAgbWFwKChldmVudCkgPT4gKFtpdGVtcywgZXZlbnRdKSksXG4gICAgICAgICkpLFxuICAgICAgICBhcHBseUFwaUV2ZW50KCksXG4gICAgICAgIHRha2VVbnRpbCh0aGlzLmNsZWFyU3Vic2NyaXB0aW9ucyQpLFxuICAgICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBVc2UgYGpvYmAgd2hlbiB5b3UgY2FyZSBhYm91dCBqb2IgcHJvZ3Jlc3Mgb3IgcmVzdWx0LlxuICAgKi9cbiAgc3RhcnRKb2I8TSBleHRlbmRzIEFwaUpvYk1ldGhvZD4obWV0aG9kOiBNLCBwYXJhbXM/OiBBcGlKb2JQYXJhbXM8TT4pOiBPYnNlcnZhYmxlPG51bWJlcj4ge1xuICAgIHJldHVybiB0aGlzLmNhbGxNZXRob2QobWV0aG9kLCBwYXJhbXMpO1xuICB9XG5cbiAgLyoqXG4gICAqIEluIHlvdXIgc3Vic2NyaXB0aW9uLCBuZXh0IHdpbGwgYmUgbmV4dCBqb2IgdXBkYXRlLCBjb21wbGV0ZSB3aWxsIGJlIHdoZW4gdGhlIGpvYiBpcyBjb21wbGV0ZS5cbiAgICovXG4gIGpvYjxNIGV4dGVuZHMgQXBpSm9iTWV0aG9kPihcbiAgICBtZXRob2Q6IE0sXG4gICAgcGFyYW1zPzogQXBpSm9iUGFyYW1zPE0+LFxuICApOiBPYnNlcnZhYmxlPEpvYjxBcGlKb2JSZXNwb25zZTxNPj4+IHtcbiAgICByZXR1cm4gdGhpcy5jYWxsTWV0aG9kKG1ldGhvZCwgcGFyYW1zKS5waXBlKFxuICAgICAgc3dpdGNoTWFwKChqb2JJZDogbnVtYmVyKSA9PiB7XG4gICAgICAgIHJldHVybiBtZXJnZShcbiAgICAgICAgICB0aGlzLnN1YnNjcmliZVRvSm9iVXBkYXRlcyhqb2JJZCksXG4gICAgICAgICAgLy8gR2V0IGpvYiBzdGF0dXMgaGVyZSBmb3Igam9icyB0aGF0IGNvbXBsZXRlIHRvbyBmYXN0LlxuICAgICAgICAgIHRoaXMuY2FsbCgnY29yZS5nZXRfam9icycsIFtbWydpZCcsICc9Jywgam9iSWRdXV0pLnBpcGUobWFwKChqb2JzKSA9PiBqb2JzWzBdKSksXG4gICAgICAgIClcbiAgICAgICAgICAucGlwZShvYnNlcnZlSm9iKCkpO1xuICAgICAgfSksXG4gICAgICB0YWtlVW50aWwodGhpcy5jbGVhclN1YnNjcmlwdGlvbnMkKSxcbiAgICApIGFzIE9ic2VydmFibGU8Sm9iPEFwaUpvYlJlc3BvbnNlPE0+Pj47XG4gIH1cblxuICBzdWJzY3JpYmU8SyBleHRlbmRzIEFwaUV2ZW50TWV0aG9kID0gQXBpRXZlbnRNZXRob2Q+KG1ldGhvZDogSyk6IE9ic2VydmFibGU8QXBpRXZlbnRUeXBlZDxLPj4ge1xuICAgIGlmICh0aGlzLmV2ZW50U3Vic2NyaWJlcnMuaGFzKG1ldGhvZCkpIHtcbiAgICAgIHJldHVybiB0aGlzLmV2ZW50U3Vic2NyaWJlcnMuZ2V0KG1ldGhvZCk7XG4gICAgfVxuICAgIGNvbnN0IG9ic2VydmFibGUkID0gbmV3IE9ic2VydmFibGUoKHRyaWdnZXI6IFN1YnNjcmliZXI8QXBpRXZlbnRUeXBlZDxLPj4pID0+IHtcbiAgICAgIGNvbnN0IHN1YnNjcmlwdGlvbiA9IHRoaXMud3NNYW5hZ2VyLmJ1aWxkU3Vic2NyaWJlcjxLLCBBcGlFdmVudFR5cGVkPEs+PihtZXRob2QpLnN1YnNjcmliZSh0cmlnZ2VyKTtcbiAgICAgIHJldHVybiAoKSA9PiB7XG4gICAgICAgIHN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgICAgICB0aGlzLmV2ZW50U3Vic2NyaWJlcnMuZGVsZXRlKG1ldGhvZCk7XG4gICAgICB9O1xuICAgIH0pLnBpcGUoXG4gICAgICBzd2l0Y2hNYXAoKGFwaUV2ZW50KSA9PiB7XG4gICAgICAgIGNvbnN0IGVycm9yZWRFdmVudCA9IGFwaUV2ZW50IGFzIHVua25vd24gYXMgUmVzdWx0TWVzc2FnZTtcbiAgICAgICAgaWYgKGVycm9yZWRFdmVudD8uZXJyb3IpIHtcbiAgICAgICAgICBjb25zb2xlLmVycm9yKCdFcnJvcjogJywgZXJyb3JlZEV2ZW50LmVycm9yKTtcbiAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcigoKSA9PiBlcnJvcmVkRXZlbnQuZXJyb3IpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBvZihhcGlFdmVudCk7XG4gICAgICB9KSxcbiAgICAgIHNoYXJlKCksXG4gICAgICB0YWtlVW50aWwodGhpcy5jbGVhclN1YnNjcmlwdGlvbnMkKSxcbiAgICApO1xuXG4gICAgdGhpcy5ldmVudFN1YnNjcmliZXJzLnNldChtZXRob2QsIG9ic2VydmFibGUkKTtcbiAgICByZXR1cm4gb2JzZXJ2YWJsZSQ7XG4gIH1cblxuICBzdWJzY3JpYmVUb0xvZ3MobmFtZTogc3RyaW5nKTogT2JzZXJ2YWJsZTxBcGlFdmVudDx7IGRhdGE6IHN0cmluZyB9Pj4ge1xuICAgIHJldHVybiB0aGlzLnN1YnNjcmliZShuYW1lIGFzIEFwaUV2ZW50TWV0aG9kKSBhcyB1bmtub3duIGFzIE9ic2VydmFibGU8QXBpRXZlbnQ8eyBkYXRhOiBzdHJpbmcgfT4+O1xuICB9XG5cbiAgY2xlYXJTdWJzY3JpcHRpb25zKCk6IHZvaWQge1xuICAgIHRoaXMuY2xlYXJTdWJzY3JpcHRpb25zJC5uZXh0KCk7XG4gICAgdGhpcy5ldmVudFN1YnNjcmliZXJzLmNsZWFyKCk7XG4gIH1cblxuICBnZXRXZWJTb2NrZXRTdHJlYW0kKCk6IE9ic2VydmFibGU8dW5rbm93bj4ge1xuICAgIHJldHVybiB0aGlzLndzJDtcbiAgfVxuXG4gIHByaXZhdGUgY2FsbE1ldGhvZDxNIGV4dGVuZHMgQXBpQ2FsbE1ldGhvZD4obWV0aG9kOiBNLCBwYXJhbXM/OiBBcGlDYWxsUGFyYW1zPE0+KTogT2JzZXJ2YWJsZTxBcGlDYWxsUmVzcG9uc2U8TT4+O1xuICBwcml2YXRlIGNhbGxNZXRob2Q8TSBleHRlbmRzIEFwaUpvYk1ldGhvZD4obWV0aG9kOiBNLCBwYXJhbXM/OiBBcGlKb2JQYXJhbXM8TT4pOiBPYnNlcnZhYmxlPG51bWJlcj47XG4gIHByaXZhdGUgY2FsbE1ldGhvZDxNIGV4dGVuZHMgQXBpQ2FsbE1ldGhvZCB8IEFwaUpvYk1ldGhvZD4obWV0aG9kOiBNLCBwYXJhbXM/OiB1bmtub3duKTogT2JzZXJ2YWJsZTx1bmtub3duPiB7XG4gICAgY29uc3QgdXVpZCA9IFVVSUQuVVVJRCgpO1xuICAgIHJldHVybiBvZih1dWlkKS5waXBlKFxuICAgICAgdGFwKCgpID0+IHtcbiAgICAgICAgcGVyZm9ybWFuY2UubWFyayhgJHttZXRob2R9IC0gJHt1dWlkfSAtIHN0YXJ0YCk7XG4gICAgICAgIHRoaXMud3NNYW5hZ2VyLnNlbmQoe1xuICAgICAgICAgIGlkOiB1dWlkLCBtc2c6IEluY29taW5nQXBpTWVzc2FnZVR5cGUuTWV0aG9kLCBtZXRob2QsIHBhcmFtcyxcbiAgICAgICAgfSk7XG4gICAgICB9KSxcbiAgICAgIHN3aXRjaE1hcCgoKSA9PiB0aGlzLndzJCksXG4gICAgICBmaWx0ZXIoKGRhdGE6IEluY29taW5nV2ViU29ja2V0TWVzc2FnZSkgPT4gZGF0YS5tc2cgPT09IEluY29taW5nQXBpTWVzc2FnZVR5cGUuUmVzdWx0ICYmIGRhdGEuaWQgPT09IHV1aWQpLFxuICAgICAgc3dpdGNoTWFwKChkYXRhOiBJbmNvbWluZ1dlYlNvY2tldE1lc3NhZ2UpID0+IHtcbiAgICAgICAgaWYgKCdlcnJvcicgaW4gZGF0YSAmJiBkYXRhLmVycm9yKSB7XG4gICAgICAgICAgdGhpcy5wcmludEVycm9yKGRhdGEuZXJyb3IsIHsgbWV0aG9kLCBwYXJhbXMgfSk7XG4gICAgICAgICAgY29uc3QgZXJyb3IgPSB0aGlzLmVuaGFuY2VFcnJvcihkYXRhLmVycm9yLCB7IG1ldGhvZCB9KTtcbiAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcigoKSA9PiBlcnJvcik7XG4gICAgICAgIH1cblxuICAgICAgICBwZXJmb3JtYW5jZS5tYXJrKGAke21ldGhvZH0gLSAke3V1aWR9IC0gZW5kYCk7XG4gICAgICAgIHBlcmZvcm1hbmNlLm1lYXN1cmUobWV0aG9kLCBgJHttZXRob2R9IC0gJHt1dWlkfSAtIHN0YXJ0YCwgYCR7bWV0aG9kfSAtICR7dXVpZH0gLSBlbmRgKTtcbiAgICAgICAgcmV0dXJuIG9mKGRhdGEpO1xuICAgICAgfSksXG5cbiAgICAgIG1hcCgoZGF0YTogUmVzdWx0TWVzc2FnZSkgPT4gZGF0YS5yZXN1bHQpLFxuICAgICAgdGFrZSgxKSxcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBzdWJzY3JpYmVUb0pvYlVwZGF0ZXMoam9iSWQ6IG51bWJlcik6IE9ic2VydmFibGU8Sm9iPiB7XG4gICAgcmV0dXJuIHRoaXMuc3Vic2NyaWJlKCdjb3JlLmdldF9qb2JzJykucGlwZShcbiAgICAgIGZpbHRlcigoYXBpRXZlbnQpID0+IGFwaUV2ZW50LmlkID09PSBqb2JJZCksXG4gICAgICBtYXAoKGFwaUV2ZW50KSA9PiBhcGlFdmVudC5maWVsZHMpLFxuICAgICAgdGFrZVVudGlsKHRoaXMuY2xlYXJTdWJzY3JpcHRpb25zJCksXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgcHJpbnRFcnJvcihlcnJvcjogV2ViU29ja2V0RXJyb3IsIGNvbnRleHQ6IHsgbWV0aG9kOiBzdHJpbmc7IHBhcmFtczogdW5rbm93biB9KTogdm9pZCB7XG4gICAgaWYgKGVycm9yLmVycm5hbWUgPT09IFdlYlNvY2tldEVycm9yTmFtZS5Ob0FjY2Vzcykge1xuICAgICAgY29uc29sZS5lcnJvcihgQWNjZXNzIGRlbmllZCB0byAke2NvbnRleHQubWV0aG9kfSB3aXRoICR7Y29udGV4dC5wYXJhbXMgPyBKU09OLnN0cmluZ2lmeShjb250ZXh0LnBhcmFtcykgOiAnbm8gcGFyYW1zJ31gKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyBEbyBub3QgbG9nIHZhbGlkYXRpb24gZXJyb3JzLlxuICAgIGlmIChlcnJvci50eXBlID09PSBSZXNwb25zZUVycm9yVHlwZS5WYWxpZGF0aW9uKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc29sZS5lcnJvcignRXJyb3I6ICcsIGVycm9yKTtcbiAgfVxuXG4gIC8vIFRPRE86IFByb2JhYmx5IGRvZXNuJ3QgYmVsb25nIGhlcmUuIENvbnNpZGVyIGJ1aWxkaW5nIHNvbWV0aGluZyBzaW1pbGFyIHRvIGludGVyY2VwdG9ycy5cbiAgcHJpdmF0ZSBlbmhhbmNlRXJyb3IoZXJyb3I6IFdlYlNvY2tldEVycm9yLCBjb250ZXh0OiB7IG1ldGhvZDogc3RyaW5nIH0pOiBXZWJTb2NrZXRFcnJvciB7XG4gICAgaWYgKGVycm9yLmVycm5hbWUgPT09IFdlYlNvY2tldEVycm9yTmFtZS5Ob0FjY2Vzcykge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgLi4uZXJyb3IsXG4gICAgICAgIHJlYXNvbjogdGhpcy50cmFuc2xhdGUuaW5zdGFudCgnQWNjZXNzIGRlbmllZCB0byB7bWV0aG9kfScsIHsgbWV0aG9kOiBjb250ZXh0Lm1ldGhvZCB9KSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgcmV0dXJuIGVycm9yO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=