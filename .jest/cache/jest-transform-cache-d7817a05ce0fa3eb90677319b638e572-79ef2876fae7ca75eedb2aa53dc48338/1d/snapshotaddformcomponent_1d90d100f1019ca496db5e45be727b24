3ad1aea7489c81dc590c01a6920f5182
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.SnapshotAddFormComponent = void 0;
const core_1 = require("@angular/core");
const forms_1 = require("@angular/forms");
const until_destroy_1 = require("@ngneat/until-destroy");
const core_2 = require("@ngx-translate/core");
const date_fns_tz_1 = require("date-fns-tz");
const rxjs_1 = require("rxjs");
const operators_1 = require("rxjs/operators");
const role_enum_1 = require("app/enums/role.enum");
const options_operators_1 = require("app/helpers/operators/options.operators");
const snapshots_1 = require("app/helptext/storage/snapshots/snapshots");
const ix_slide_in_ref_1 = require("app/modules/forms/ix-forms/components/ix-slide-in/ix-slide-in-ref");
const ix_slide_in_token_1 = require("app/modules/forms/ix-forms/components/ix-slide-in/ix-slide-in.token");
const form_error_handler_service_1 = require("app/modules/forms/ix-forms/services/form-error-handler.service");
const ix_validators_service_1 = require("app/modules/forms/ix-forms/services/ix-validators.service");
const at_least_one_validation_1 = require("app/modules/forms/ix-forms/validators/at-least-one-validation");
const required_empty_validation_1 = require("app/modules/forms/ix-forms/validators/required-empty-validation");
const snapshot_exclude_boot_constant_1 = require("app/pages/datasets/modules/snapshots/constants/snapshot-exclude-boot.constant");
const dataset_store_service_1 = require("app/pages/datasets/store/dataset-store.service");
const auth_service_1 = require("app/services/auth/auth.service");
const ws_service_1 = require("app/services/ws.service");
let SnapshotAddFormComponent = class SnapshotAddFormComponent {
    constructor(fb, cdr, ws, translate, authService, errorHandler, validatorsService, datasetStore, slideInRef, datasetId) {
        this.fb = fb;
        this.cdr = cdr;
        this.ws = ws;
        this.translate = translate;
        this.authService = authService;
        this.errorHandler = errorHandler;
        this.validatorsService = validatorsService;
        this.datasetStore = datasetStore;
        this.slideInRef = slideInRef;
        this.datasetId = datasetId;
        this.requiredRoles = [role_enum_1.Role.SnapshotWrite];
        this.isFormLoading = true;
        this.form = this.fb.group({
            dataset: ['', forms_1.Validators.required],
            name: [this.getDefaultSnapshotName(), [this.validatorsService.withMessage((0, at_least_one_validation_1.atLeastOne)('naming_schema', [snapshots_1.helptextSnapshots.snapshot_add_name_placeholder, snapshots_1.helptextSnapshots.snapshot_add_naming_schema_placeholder]), this.translate.instant('Name or Naming Schema must be provided.')), this.validatorsService.validateOnCondition((control) => { var _a; return control.value && ((_a = control.parent) === null || _a === void 0 ? void 0 : _a.get('naming_schema').value); }, this.validatorsService.withMessage((0, required_empty_validation_1.requiredEmpty)(), this.translate.instant('Name and Naming Schema cannot be provided at the same time.')))]],
            naming_schema: [''],
            recursive: [false],
            vmware_sync: [false],
        });
        this.hasVmsInDataset = false;
        this.helptext = snapshots_1.helptextSnapshots;
    }
    ngOnInit() {
        (0, rxjs_1.combineLatest)([
            this.getDatasetOptions(),
            this.getNamingSchemaOptions(),
        ]).pipe((0, until_destroy_1.untilDestroyed)(this)).subscribe({
            next: ([datasetOptions, namingSchemaOptions]) => {
                this.datasetOptions$ = (0, rxjs_1.of)(datasetOptions);
                this.namingSchemaOptions$ = (0, rxjs_1.of)(namingSchemaOptions);
                this.isFormLoading = false;
                this.form.controls.name.markAsTouched();
                this.checkForVmsInDataset();
                this.cdr.markForCheck();
            },
            error: (error) => {
                this.errorHandler.handleWsFormError(error, this.form);
                this.isFormLoading = false;
                this.cdr.markForCheck();
            },
        });
        (0, rxjs_1.merge)(this.form.controls.recursive.valueChanges, this.form.controls.dataset.valueChanges).pipe((0, until_destroy_1.untilDestroyed)(this)).subscribe(() => this.checkForVmsInDataset());
        if (this.datasetId) {
            this.setDataset();
        }
    }
    setDataset() {
        this.form.controls.dataset.setValue(this.datasetId);
    }
    onSubmit() {
        const values = this.form.value;
        const params = {
            dataset: values.dataset,
            recursive: values.recursive,
        };
        if (values.naming_schema) {
            params.naming_schema = values.naming_schema;
        }
        else {
            params.name = values.name;
        }
        if (this.hasVmsInDataset) {
            params.vmware_sync = values.vmware_sync;
        }
        this.isFormLoading = true;
        this.ws.call('zfs.snapshot.create', [params]).pipe((0, until_destroy_1.untilDestroyed)(this)).subscribe({
            next: () => {
                this.isFormLoading = false;
                this.slideInRef.close(true);
                this.datasetStore.datasetUpdated();
                this.cdr.markForCheck();
            },
            error: (error) => {
                this.isFormLoading = false;
                this.errorHandler.handleWsFormError(error, this.form);
                this.cdr.markForCheck();
            },
        });
    }
    getDefaultSnapshotName() {
        const datetime = (0, date_fns_tz_1.format)(new Date(), 'yyyy-MM-dd_HH-mm');
        return `manual-${datetime}`;
    }
    getDatasetOptions() {
        return this.ws.call('pool.dataset.query', [
            snapshot_exclude_boot_constant_1.snapshotExcludeBootQueryFilter,
            { extra: { flat: true } },
        ]).pipe((0, operators_1.map)((datasets) => datasets.map((dataset) => ({ label: dataset.name, value: dataset.name }))));
    }
    getNamingSchemaOptions() {
        return this.authService.hasRole([role_enum_1.Role.ReplicationTaskWrite, role_enum_1.Role.ReplicationTaskWritePull]).pipe((0, operators_1.switchMap)((hasAccess) => {
            if (!hasAccess) {
                return (0, rxjs_1.of)([]);
            }
            return this.ws.call('replication.list_naming_schemas').pipe((0, options_operators_1.singleArrayToOptions)());
        }));
    }
    checkForVmsInDataset() {
        this.isFormLoading = true;
        this.ws.call('vmware.dataset_has_vms', [this.form.controls.dataset.value, this.form.controls.recursive.value])
            .pipe((0, until_destroy_1.untilDestroyed)(this))
            .subscribe({
            next: (hasVmsInDataset) => {
                this.hasVmsInDataset = hasVmsInDataset;
                this.isFormLoading = false;
                this.cdr.markForCheck();
            },
            error: (error) => {
                this.errorHandler.handleWsFormError(error, this.form);
                this.isFormLoading = false;
                this.cdr.markForCheck();
            },
        });
    }
};
exports.SnapshotAddFormComponent = SnapshotAddFormComponent;
SnapshotAddFormComponent.ctorParameters = () => [
    { type: forms_1.FormBuilder },
    { type: core_1.ChangeDetectorRef },
    { type: ws_service_1.WebSocketService },
    { type: core_2.TranslateService },
    { type: auth_service_1.AuthService },
    { type: form_error_handler_service_1.FormErrorHandlerService },
    { type: ix_validators_service_1.IxValidatorsService },
    { type: dataset_store_service_1.DatasetTreeStore },
    { type: ix_slide_in_ref_1.IxSlideInRef },
    { type: String, decorators: [{ type: core_1.Inject, args: [ix_slide_in_token_1.SLIDE_IN_DATA,] }] }
];
exports.SnapshotAddFormComponent = SnapshotAddFormComponent = __decorate([
    (0, until_destroy_1.UntilDestroy)(),
    (0, core_1.Component)({
        selector: 'ix-snapshot-add-form',
        template: require("./snapshot-add-form.component.html"),
        changeDetection: core_1.ChangeDetectionStrategy.OnPush,
    })
], SnapshotAddFormComponent);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21hY2Jvb2sva2FycG92LXdvcmsvVHJ1ZU5BUy93ZWJ1aS9zcmMvYXBwL3BhZ2VzL2RhdGFzZXRzL21vZHVsZXMvc25hcHNob3RzL3NuYXBzaG90LWFkZC1mb3JtL3NuYXBzaG90LWFkZC1mb3JtLmNvbXBvbmVudC50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBQSx3Q0FFdUI7QUFDdkIsMENBQTBFO0FBQzFFLHlEQUFxRTtBQUNyRSw4Q0FBdUQ7QUFDdkQsNkNBQXFDO0FBQ3JDLCtCQUVjO0FBQ2QsOENBQWdEO0FBQ2hELG1EQUEyQztBQUMzQywrRUFBK0U7QUFDL0Usd0VBQTZFO0FBSzdFLHVHQUFpRztBQUNqRywyR0FBb0c7QUFDcEcsK0dBQXlHO0FBQ3pHLHFHQUFnRztBQUNoRywyR0FBMkY7QUFDM0YsK0dBQWdHO0FBQ2hHLGtJQUV1RjtBQUN2RiwwRkFBa0Y7QUFDbEYsaUVBQTZEO0FBQzdELHdEQUEyRDtBQVFwRCxJQUFNLHdCQUF3QixHQUE5QixNQUFNLHdCQUF3QjtJQTJCbkMsWUFDVSxFQUFlLEVBQ2YsR0FBc0IsRUFDdEIsRUFBb0IsRUFDcEIsU0FBMkIsRUFDM0IsV0FBd0IsRUFDeEIsWUFBcUMsRUFDckMsaUJBQXNDLEVBQ3RDLFlBQThCLEVBQzlCLFVBQWtELEVBQzNCLFNBQWlCO1FBVHhDLE9BQUUsR0FBRixFQUFFLENBQWE7UUFDZixRQUFHLEdBQUgsR0FBRyxDQUFtQjtRQUN0QixPQUFFLEdBQUYsRUFBRSxDQUFrQjtRQUNwQixjQUFTLEdBQVQsU0FBUyxDQUFrQjtRQUMzQixnQkFBVyxHQUFYLFdBQVcsQ0FBYTtRQUN4QixpQkFBWSxHQUFaLFlBQVksQ0FBeUI7UUFDckMsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUFxQjtRQUN0QyxpQkFBWSxHQUFaLFlBQVksQ0FBa0I7UUFDOUIsZUFBVSxHQUFWLFVBQVUsQ0FBd0M7UUFDM0IsY0FBUyxHQUFULFNBQVMsQ0FBUTtRQXBDekMsa0JBQWEsR0FBRyxDQUFDLGdCQUFJLENBQUMsYUFBYSxDQUFDLENB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LFNBQUMsaUNBQWE7O21DQXJDWix3QkFBd0I7SUFOcEMsSUFBQSw0QkFBWSxHQUFFO0lBQ2QsSUFBQSxnQkFBUyxFQUFDO1FBQ1QsUUFBUSxFQUFFLHNCQUFzQjtRQUNoQyx1REFBaUQ7UUFDakQsZUFBZSxFQUFFLDhCQUF1QixDQUFDLE1BQU07S0FDaEQsQ0FBQztHQUNXLHdCQUF3QixDQTJKcEMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL21hY2Jvb2sva2FycG92LXdvcmsvVHJ1ZU5BUy93ZWJ1aS9zcmMvYXBwL3BhZ2VzL2RhdGFzZXRzL21vZHVsZXMvc25hcHNob3RzL3NuYXBzaG90LWFkZC1mb3JtL3NuYXBzaG90LWFkZC1mb3JtLmNvbXBvbmVudC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneSwgQ2hhbmdlRGV0ZWN0b3JSZWYsIENvbXBvbmVudCwgSW5qZWN0LCBPbkluaXQsXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQWJzdHJhY3RDb250cm9sLCBGb3JtQnVpbGRlciwgVmFsaWRhdG9ycyB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7IFVudGlsRGVzdHJveSwgdW50aWxEZXN0cm95ZWQgfSBmcm9tICdAbmduZWF0L3VudGlsLWRlc3Ryb3knO1xuaW1wb3J0IHsgVHJhbnNsYXRlU2VydmljZSB9IGZyb20gJ0BuZ3gtdHJhbnNsYXRlL2NvcmUnO1xuaW1wb3J0IHsgZm9ybWF0IH0gZnJvbSAnZGF0ZS1mbnMtdHonO1xuaW1wb3J0IHtcbiAgY29tYmluZUxhdGVzdCwgbWVyZ2UsIE9ic2VydmFibGUsIG9mLFxufSBmcm9tICdyeGpzJztcbmltcG9ydCB7IG1hcCwgc3dpdGNoTWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgUm9sZSB9IGZyb20gJ2FwcC9lbnVtcy9yb2xlLmVudW0nO1xuaW1wb3J0IHsgc2luZ2xlQXJyYXlUb09wdGlvbnMgfSBmcm9tICdhcHAvaGVscGVycy9vcGVyYXRvcnMvb3B0aW9ucy5vcGVyYXRvcnMnO1xuaW1wb3J0IHsgaGVscHRleHRTbmFwc2hvdHMgfSBmcm9tICdhcHAvaGVscHRleHQvc3RvcmFnZS9zbmFwc2hvdHMvc25hcHNob3RzJztcbmltcG9ydCB7IERhdGFzZXQgfSBmcm9tICdhcHAvaW50ZXJmYWNlcy9kYXRhc2V0LmludGVyZmFjZSc7XG5pbXBvcnQgeyBPcHRpb24gfSBmcm9tICdhcHAvaW50ZXJmYWNlcy9vcHRpb24uaW50ZXJmYWNlJztcbmltcG9ydCB7IFF1ZXJ5RmlsdGVycyB9IGZyb20gJ2FwcC9pbnRlcmZhY2VzL3F1ZXJ5LWFwaS5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgQ3JlYXRlWmZzU25hcHNob3QgfSBmcm9tICdhcHAvaW50ZXJmYWNlcy96ZnMtc25hcHNob3QuaW50ZXJmYWNlJztcbmltcG9ydCB7IEl4U2xpZGVJblJlZiB9IGZyb20gJ2FwcC9tb2R1bGVzL2Zvcm1zL2l4LWZvcm1zL2NvbXBvbmVudHMvaXgtc2xpZGUtaW4vaXgtc2xpZGUtaW4tcmVmJztcbmltcG9ydCB7IFNMSURFX0lOX0RBVEEgfSBmcm9tICdhcHAvbW9kdWxlcy9mb3Jtcy9peC1mb3Jtcy9jb21wb25lbnRzL2l4LXNsaWRlLWluL2l4LXNsaWRlLWluLnRva2VuJztcbmltcG9ydCB7IEZvcm1FcnJvckhhbmRsZXJTZXJ2aWNlIH0gZnJvbSAnYXBwL21vZHVsZXMvZm9ybXMvaXgtZm9ybXMvc2VydmljZXMvZm9ybS1lcnJvci1oYW5kbGVyLnNlcnZpY2UnO1xuaW1wb3J0IHsgSXhWYWxpZGF0b3JzU2VydmljZSB9IGZyb20gJ2FwcC9tb2R1bGVzL2Zvcm1zL2l4LWZvcm1zL3NlcnZpY2VzL2l4LXZhbGlkYXRvcnMuc2VydmljZSc7XG5pbXBvcnQgeyBhdExlYXN0T25lIH0gZnJvbSAnYXBwL21vZHVsZXMvZm9ybXMvaXgtZm9ybXMvdmFsaWRhdG9ycy9hdC1sZWFzdC1vbmUtdmFsaWRhdGlvbic7XG5pbXBvcnQgeyByZXF1aXJlZEVtcHR5IH0gZnJvbSAnYXBwL21vZHVsZXMvZm9ybXMvaXgtZm9ybXMvdmFsaWRhdG9ycy9yZXF1aXJlZC1lbXB0eS12YWxpZGF0aW9uJztcbmltcG9ydCB7XG4gIHNuYXBzaG90RXhjbHVkZUJvb3RRdWVyeUZpbHRlcixcbn0gZnJvbSAnYXBwL3BhZ2VzL2RhdGFzZXRzL21vZHVsZXMvc25hcHNob3RzL2NvbnN0YW50cy9zbmFwc2hvdC1leGNsdWRlLWJvb3QuY29uc3RhbnQnO1xuaW1wb3J0IHsgRGF0YXNldFRyZWVTdG9yZSB9IGZyb20gJ2FwcC9wYWdlcy9kYXRhc2V0cy9zdG9yZS9kYXRhc2V0LXN0b3JlLnNlcnZpY2UnO1xuaW1wb3J0IHsgQXV0aFNlcnZpY2UgfSBmcm9tICdhcHAvc2VydmljZXMvYXV0aC9hdXRoLnNlcnZpY2UnO1xuaW1wb3J0IHsgV2ViU29ja2V0U2VydmljZSB9IGZyb20gJ2FwcC9zZXJ2aWNlcy93cy5zZXJ2aWNlJztcblxuQFVudGlsRGVzdHJveSgpXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdpeC1zbmFwc2hvdC1hZGQtZm9ybScsXG4gIHRlbXBsYXRlVXJsOiAnLi9zbmFwc2hvdC1hZGQtZm9ybS5jb21wb25lbnQuaHRtbCcsXG4gIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoLFxufSlcbmV4cG9ydCBjbGFzcyBTbmFwc2hvdEFkZEZvcm1Db21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQge1xuICByZWFkb25seSByZXF1aXJlZFJvbGVzID0gW1JvbGUuU25hcHNob3RXcml0ZV07XG5cbiAgaXNGb3JtTG9hZGluZyA9IHRydWU7XG4gIGZvcm0gPSB0aGlzLmZiLmdyb3VwKHtcbiAgICBkYXRhc2V0OiBbJycsIFZhbGlkYXRvcnMucmVxdWlyZWRdLFxuICAgIG5hbWU6IFt0aGlzLmdldERlZmF1bHRTbmFwc2hvdE5hbWUoKSwgW3RoaXMudmFsaWRhdG9yc1NlcnZpY2Uud2l0aE1lc3NhZ2UoXG4gICAgICBhdExlYXN0T25lKCduYW1pbmdfc2NoZW1hJywgW2hlbHB0ZXh0U25hcHNob3RzLnNuYXBzaG90X2FkZF9uYW1lX3BsYWNlaG9sZGVyLCBoZWxwdGV4dFNuYXBzaG90cy5zbmFwc2hvdF9hZGRfbmFtaW5nX3NjaGVtYV9wbGFjZWhvbGRlcl0pLFxuICAgICAgdGhpcy50cmFuc2xhdGUuaW5zdGFudCgnTmFtZSBvciBOYW1pbmcgU2NoZW1hIG11c3QgYmUgcHJvdmlkZWQuJyksXG4gICAgKSwgdGhpcy52YWxpZGF0b3JzU2VydmljZS52YWxpZGF0ZU9uQ29uZGl0aW9uKFxuICAgICAgKGNvbnRyb2w6IEFic3RyYWN0Q29udHJvbCkgPT4gY29udHJvbC52YWx1ZSAmJiBjb250cm9sLnBhcmVudD8uZ2V0KCduYW1pbmdfc2NoZW1hJykudmFsdWUsXG4gICAgICB0aGlzLnZhbGlkYXRvcnNTZXJ2aWNlLndpdGhNZXNzYWdlKFxuICAgICAgICByZXF1aXJlZEVtcHR5KCksXG4gICAgICAgIHRoaXMudHJhbnNsYXRlLmluc3RhbnQoJ05hbWUgYW5kIE5hbWluZyBTY2hlbWEgY2Fubm90IGJlIHByb3ZpZGVkIGF0IHRoZSBzYW1lIHRpbWUuJyksXG4gICAgICApLFxuICAgICldXSxcbiAgICBuYW1pbmdfc2NoZW1hOiBbJyddLFxuICAgIHJlY3Vyc2l2ZTogW2ZhbHNlXSxcbiAgICB2bXdhcmVfc3luYzogW2ZhbHNlXSxcbiAgfSk7XG5cbiAgZGF0YXNldE9wdGlvbnMkOiBPYnNlcnZhYmxlPE9wdGlvbltdPjtcbiAgbmFtaW5nU2NoZW1hT3B0aW9ucyQ6IE9ic2VydmFibGU8T3B0aW9uW10+O1xuICBoYXNWbXNJbkRhdGFzZXQgPSBmYWxzZTtcblxuICByZWFkb25seSBoZWxwdGV4dCA9IGhlbHB0ZXh0U25hcHNob3RzO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgZmI6IEZvcm1CdWlsZGVyLFxuICAgIHByaXZhdGUgY2RyOiBDaGFuZ2VEZXRlY3RvclJlZixcbiAgICBwcml2YXRlIHdzOiBXZWJTb2NrZXRTZXJ2aWNlLFxuICAgIHByaXZhdGUgdHJhbnNsYXRlOiBUcmFuc2xhdGVTZXJ2aWNlLFxuICAgIHByaXZhdGUgYXV0aFNlcnZpY2U6IEF1dGhTZXJ2aWNlLFxuICAgIHByaXZhdGUgZXJyb3JIYW5kbGVyOiBGb3JtRXJyb3JIYW5kbGVyU2VydmljZSxcbiAgICBwcml2YXRlIHZhbGlkYXRvcnNTZXJ2aWNlOiBJeFZhbGlkYXRvcnNTZXJ2aWNlLFxuICAgIHByaXZhdGUgZGF0YXNldFN0b3JlOiBEYXRhc2V0VHJlZVN0b3JlLFxuICAgIHByaXZhdGUgc2xpZGVJblJlZjogSXhTbGlkZUluUmVmPFNuYXBzaG90QWRkRm9ybUNvbXBvbmVudD4sXG4gICAgQEluamVjdChTTElERV9JTl9EQVRBKSBwcml2YXRlIGRhdGFzZXRJZDogc3RyaW5nLFxuICApIHt9XG5cbiAgbmdPbkluaXQoKTogdm9pZCB7XG4gICAgY29tYmluZUxhdGVzdChbXG4gICAgICB0aGlzLmdldERhdGFzZXRPcHRpb25zKCksXG4gICAgICB0aGlzLmdldE5hbWluZ1NjaGVtYU9wdGlvbnMoKSxcbiAgICBdKS5waXBlKFxuICAgICAgdW50aWxEZXN0cm95ZWQodGhpcyksXG4gICAgKS5zdWJzY3JpYmUoe1xuICAgICAgbmV4dDogKFtkYXRhc2V0T3B0aW9ucywgbmFtaW5nU2NoZW1hT3B0aW9uc10pID0+IHtcbiAgICAgICAgdGhpcy5kYXRhc2V0T3B0aW9ucyQgPSBvZihkYXRhc2V0T3B0aW9ucyk7XG4gICAgICAgIHRoaXMubmFtaW5nU2NoZW1hT3B0aW9ucyQgPSBvZihuYW1pbmdTY2hlbWFPcHRpb25zKTtcbiAgICAgICAgdGhpcy5pc0Zvcm1Mb2FkaW5nID0gZmFsc2U7XG4gICAgICAgIHRoaXMuZm9ybS5jb250cm9scy5uYW1lLm1hcmtBc1RvdWNoZWQoKTtcbiAgICAgICAgdGhpcy5jaGVja0ZvclZtc0luRGF0YXNldCgpO1xuICAgICAgICB0aGlzLmNkci5tYXJrRm9yQ2hlY2soKTtcbiAgICAgIH0sXG4gICAgICBlcnJvcjogKGVycm9yOiB1bmtub3duKSA9PiB7XG4gICAgICAgIHRoaXMuZXJyb3JIYW5kbGVyLmhhbmRsZVdzRm9ybUVycm9yKGVycm9yLCB0aGlzLmZvcm0pO1xuICAgICAgICB0aGlzLmlzRm9ybUxvYWRpbmcgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5jZHIubWFya0ZvckNoZWNrKCk7XG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgbWVyZ2UoXG4gICAgICB0aGlzLmZvcm0uY29udHJvbHMucmVjdXJzaXZlLnZhbHVlQ2hhbmdlcyxcbiAgICAgIHRoaXMuZm9ybS5jb250cm9scy5kYXRhc2V0LnZhbHVlQ2hhbmdlcyxcbiAgICApLnBpcGUodW50aWxEZXN0cm95ZWQodGhpcykpLnN1YnNjcmliZSgoKSA9PiB0aGlzLmNoZWNrRm9yVm1zSW5EYXRhc2V0KCkpO1xuXG4gICAgaWYgKHRoaXMuZGF0YXNldElkKSB7XG4gICAgICB0aGlzLnNldERhdGFzZXQoKTtcbiAgICB9XG4gIH1cblxuICBzZXREYXRhc2V0KCk6IHZvaWQge1xuICAgIHRoaXMuZm9ybS5jb250cm9scy5kYXRhc2V0LnNldFZhbHVlKHRoaXMuZGF0YXNldElkKTtcbiAgfVxuXG4gIG9uU3VibWl0KCk6IHZvaWQge1xuICAgIGNvbnN0IHZhbHVlcyA9IHRoaXMuZm9ybS52YWx1ZTtcbiAgICBjb25zdCBwYXJhbXM6IENyZWF0ZVpmc1NuYXBzaG90ID0ge1xuICAgICAgZGF0YXNldDogdmFsdWVzLmRhdGFzZXQsXG4gICAgICByZWN1cnNpdmU6IHZhbHVlcy5yZWN1cnNpdmUsXG4gICAgfTtcbiAgICBpZiAodmFsdWVzLm5hbWluZ19zY2hlbWEpIHtcbiAgICAgIHBhcmFtcy5uYW1pbmdfc2NoZW1hID0gdmFsdWVzLm5hbWluZ19zY2hlbWE7XG4gICAgfSBlbHNlIHtcbiAgICAgIHBhcmFtcy5uYW1lID0gdmFsdWVzLm5hbWU7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuaGFzVm1zSW5EYXRhc2V0KSB7XG4gICAgICBwYXJhbXMudm13YXJlX3N5bmMgPSB2YWx1ZXMudm13YXJlX3N5bmM7XG4gICAgfVxuXG4gICAgdGhpcy5pc0Zvcm1Mb2FkaW5nID0gdHJ1ZTtcbiAgICB0aGlzLndzLmNhbGwoJ3pmcy5zbmFwc2hvdC5jcmVhdGUnLCBbcGFyYW1zXSkucGlwZShcbiAgICAgIHVudGlsRGVzdHJveWVkKHRoaXMpLFxuICAgICkuc3Vic2NyaWJlKHtcbiAgICAgIG5leHQ6ICgpID0+IHtcbiAgICAgICAgdGhpcy5pc0Zvcm1Mb2FkaW5nID0gZmFsc2U7XG4gICAgICAgIHRoaXMuc2xpZGVJblJlZi5jbG9zZSh0cnVlKTtcbiAgICAgICAgdGhpcy5kYXRhc2V0U3RvcmUuZGF0YXNldFVwZGF0ZWQoKTtcbiAgICAgICAgdGhpcy5jZHIubWFya0ZvckNoZWNrKCk7XG4gICAgICB9LFxuICAgICAgZXJyb3I6IChlcnJvcjogdW5rbm93bikgPT4ge1xuICAgICAgICB0aGlzLmlzRm9ybUxvYWRpbmcgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5lcnJvckhhbmRsZXIuaGFuZGxlV3NGb3JtRXJyb3IoZXJyb3IsIHRoaXMuZm9ybSk7XG4gICAgICAgIHRoaXMuY2RyLm1hcmtGb3JDaGVjaygpO1xuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0RGVmYXVsdFNuYXBzaG90TmFtZSgpOiBzdHJpbmcge1xuICAgIGNvbnN0IGRhdGV0aW1lID0gZm9ybWF0KG5ldyBEYXRlKCksICd5eXl5LU1NLWRkX0hILW1tJyk7XG4gICAgcmV0dXJuIGBtYW51YWwtJHtkYXRldGltZX1gO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXREYXRhc2V0T3B0aW9ucygpOiBPYnNlcnZhYmxlPE9wdGlvbltdPiB7XG4gICAgcmV0dXJuIHRoaXMud3MuY2FsbCgncG9vbC5kYXRhc2V0LnF1ZXJ5JywgW1xuICAgICAgc25hcHNob3RFeGNsdWRlQm9vdFF1ZXJ5RmlsdGVyIGFzIFF1ZXJ5RmlsdGVyczxEYXRhc2V0PixcbiAgICAgIHsgZXh0cmE6IHsgZmxhdDogdHJ1ZSB9IH0sXG4gICAgXSkucGlwZShcbiAgICAgIG1hcCgoZGF0YXNldHMpID0+IGRhdGFzZXRzLm1hcCgoZGF0YXNldCkgPT4gKHsgbGFiZWw6IGRhdGFzZXQubmFtZSwgdmFsdWU6IGRhdGFzZXQubmFtZSB9KSkpLFxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGdldE5hbWluZ1NjaGVtYU9wdGlvbnMoKTogT2JzZXJ2YWJsZTxPcHRpb25bXT4ge1xuICAgIHJldHVybiB0aGlzLmF1dGhTZXJ2aWNlLmhhc1JvbGUoW1JvbGUuUmVwbGljYXRpb25UYXNrV3JpdGUsIFJvbGUuUmVwbGljYXRpb25UYXNrV3JpdGVQdWxsXSkucGlwZShcbiAgICAgIHN3aXRjaE1hcCgoaGFzQWNjZXNzKSA9PiB7XG4gICAgICAgIGlmICghaGFzQWNjZXNzKSB7XG4gICAgICAgICAgcmV0dXJuIG9mKFtdKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLndzLmNhbGwoJ3JlcGxpY2F0aW9uLmxpc3RfbmFtaW5nX3NjaGVtYXMnKS5waXBlKFxuICAgICAgICAgIHNpbmdsZUFycmF5VG9PcHRpb25zKCksXG4gICAgICAgICk7XG4gICAgICB9KSxcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBjaGVja0ZvclZtc0luRGF0YXNldCgpOiB2b2lkIHtcbiAgICB0aGlzLmlzRm9ybUxvYWRpbmcgPSB0cnVlO1xuICAgIHRoaXMud3MuY2FsbCgndm13YXJlLmRhdGFzZXRfaGFzX3ZtcycsIFt0aGlzLmZvcm0uY29udHJvbHMuZGF0YXNldC52YWx1ZSwgdGhpcy5mb3JtLmNvbnRyb2xzLnJlY3Vyc2l2ZS52YWx1ZV0pXG4gICAgICAucGlwZSh1bnRpbERlc3Ryb3llZCh0aGlzKSlcbiAgICAgIC5zdWJzY3JpYmUoe1xuICAgICAgICBuZXh0OiAoaGFzVm1zSW5EYXRhc2V0KSA9PiB7XG4gICAgICAgICAgdGhpcy5oYXNWbXNJbkRhdGFzZXQgPSBoYXNWbXNJbkRhdGFzZXQ7XG4gICAgICAgICAgdGhpcy5pc0Zvcm1Mb2FkaW5nID0gZmFsc2U7XG4gICAgICAgICAgdGhpcy5jZHIubWFya0ZvckNoZWNrKCk7XG4gICAgICAgIH0sXG4gICAgICAgIGVycm9yOiAoZXJyb3I6IHVua25vd24pID0+IHtcbiAgICAgICAgICB0aGlzLmVycm9ySGFuZGxlci5oYW5kbGVXc0Zvcm1FcnJvcihlcnJvciwgdGhpcy5mb3JtKTtcbiAgICAgICAgICB0aGlzLmlzRm9ybUxvYWRpbmcgPSBmYWxzZTtcbiAgICAgICAgICB0aGlzLmNkci5tYXJrRm9yQ2hlY2soKTtcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=