{"file":"/Users/macbook/karpov-work/TrueNAS/webui/src/app/pages/apps/components/custom-app-form/custom-app-form.component.ts","mappings":"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","names":[],"sources":["/Users/macbook/karpov-work/TrueNAS/webui/src/app/pages/apps/components/custom-app-form/custom-app-form.component.ts"],"sourcesContent":["import {\n  ChangeDetectionStrategy, Component,\n  Inject,\n  OnInit,\n  signal,\n} from '@angular/core';\nimport { Validators } from '@angular/forms';\nimport { Router } from '@angular/router';\nimport { FormBuilder } from '@ngneat/reactive-forms';\nimport { UntilDestroy, untilDestroyed } from '@ngneat/until-destroy';\nimport { TranslateService } from '@ngx-translate/core';\nimport { map } from 'rxjs';\nimport { CodeEditorLanguage } from 'app/enums/code-editor-language.enum';\nimport { Role } from 'app/enums/role.enum';\nimport { jsonToYaml } from 'app/helpers/json-to-yaml.helper';\nimport { App, AppCreate } from 'app/interfaces/app.interface';\nimport { DialogService } from 'app/modules/dialog/dialog.service';\nimport { IxSlideInRef } from 'app/modules/forms/ix-forms/components/ix-slide-in/ix-slide-in-ref';\nimport { SLIDE_IN_DATA } from 'app/modules/forms/ix-forms/components/ix-slide-in/ix-slide-in.token';\nimport { forbiddenAsyncValues } from 'app/modules/forms/ix-forms/validators/forbidden-values-validation/forbidden-values-validation';\nimport { ApplicationsService } from 'app/pages/apps/services/applications.service';\nimport { ErrorHandlerService } from 'app/services/error-handler.service';\nimport { WebSocketService } from 'app/services/ws.service';\n\n@UntilDestroy()\n@Component({\n  selector: 'ix-custom-app-form',\n  templateUrl: './custom-app-form.component.html',\n  changeDetection: ChangeDetectionStrategy.OnPush,\n})\nexport class CustomAppFormComponent implements OnInit {\n  protected isNew = signal(true);\n  protected requiredRoles = [Role.AppsWrite];\n  protected readonly CodeEditorLanguage = CodeEditorLanguage;\n  protected form = this.fb.group({\n    release_name: ['', Validators.required],\n    custom_compose_config_string: ['\\n\\n', Validators.required],\n  });\n  protected isLoading = signal(false);\n  protected forbiddenAppNames$ = this.appService.getAllApps().pipe(map((apps) => apps.map((app) => app.name)));\n\n  constructor(\n    private fb: FormBuilder,\n    private translate: TranslateService,\n    private ws: WebSocketService,\n    private errorHandler: ErrorHandlerService,\n    private dialogService: DialogService,\n    private appService: ApplicationsService,\n    private dialogRef: IxSlideInRef<CustomAppFormComponent>,\n    private router: Router,\n    @Inject(SLIDE_IN_DATA) public data: App,\n  ) {}\n\n  ngOnInit(): void {\n    if (this.data) {\n      this.setAppForEdit(this.data);\n    } else {\n      this.setNewApp();\n    }\n  }\n\n  private setNewApp(): void {\n    this.addForbiddenAppNamesValidator();\n  }\n\n  private setAppForEdit(app: App): void {\n    this.isNew.set(false);\n    this.form.patchValue({\n      release_name: app.id,\n      custom_compose_config_string: jsonToYaml(app.config),\n    });\n  }\n\n  protected addForbiddenAppNamesValidator(): void {\n    this.form.controls.release_name.setAsyncValidators(forbiddenAsyncValues(this.forbiddenAppNames$));\n    this.form.controls.release_name.updateValueAndValidity();\n  }\n\n  protected onSubmit(): void {\n    this.isLoading.set(true);\n    const data = this.form.value;\n\n    const appCreate$ = this.ws.job(\n      'app.create',\n      [{\n        custom_app: true,\n        app_name: data.release_name,\n        custom_compose_config_string: data.custom_compose_config_string,\n      } as AppCreate],\n    );\n\n    const appUpdate$ = this.ws.job('app.update', [\n      data.release_name,\n      { custom_compose_config_string: data.custom_compose_config_string },\n    ]);\n\n    const job$ = this.isNew() ? appCreate$ : appUpdate$;\n\n    this.dialogService.jobDialog(\n      job$,\n      {\n        title: this.translate.instant('Custom App'),\n        canMinimize: false,\n        description: this.isNew()\n          ? this.translate.instant('Creating custom app')\n          : this.translate.instant('Updating custom app'),\n      },\n    ).afterClosed().pipe(\n      untilDestroyed(this),\n    ).subscribe({\n      next: () => {\n        this.dialogRef.close();\n        if (this.isNew()) {\n          this.router.navigate(['/apps', 'installed']);\n        } else {\n          this.router.navigate(['/apps', 'installed', this.data.metadata.train, this.data.name]);\n        }\n      },\n      error: (error) => {\n        this.isLoading.set(false);\n        this.errorHandler.showErrorModal(error);\n      },\n    });\n  }\n}\n"],"version":3}