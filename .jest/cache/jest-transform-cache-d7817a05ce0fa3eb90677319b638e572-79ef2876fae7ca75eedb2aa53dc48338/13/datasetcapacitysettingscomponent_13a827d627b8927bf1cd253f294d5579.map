{"file":"/Users/macbook/karpov-work/TrueNAS/webui/src/app/pages/datasets/components/dataset-capacity-management-card/dataset-capacity-settings/dataset-capacity-settings.component.ts","mappings":";;;;;;;;;AAAA,wCAEuB;AACvB,0CAAyD;AACzD,yDAAqE;AACrE,8CAAuD;AACvD,iEAAmD;AACnD,mDAA2C;AAC3C,mEAAsD;AACtD,qFAAyF;AACzF,wEAAiF;AACjF,uGAAiG;AACjG,2GAAoG;AACpG,+GAAyG;AACzG,mGAA8F;AAC9F,qGAAgG;AAChG,qFAAiF;AACjF,0EAA4F;AAC5F,wDAA2D;AASpD,IAAM,gCAAgC,GAAtC,MAAM,gCAAgC;IAqD3C,YACU,EAAoB,EACpB,WAAwB,EACzB,SAA6B,EAC5B,GAAsB,EACtB,YAAqC,EACrC,eAAgC,EAChC,SAA2B,EAC3B,UAA+B,EAC/B,UAA0D,EACpC,OAAuB;QAT7C,OAAE,GAAF,EAAE,CAAkB;QACpB,gBAAW,GAAX,WAAW,CAAa;QACzB,cAAS,GAAT,SAAS,CAAoB;QAC5B,QAAG,GAAH,GAAG,CAAmB;QACtB,iBAAY,GAAZ,YAAY,CAAyB;QACrC,oBAAe,GAAf,eAAe,CAAiB;QAChC,cAAS,GAAT,SAAS,CAAkB;QAC3B,eAAU,GAAV,UAAU,CAAqB;QAC/B,eAAU,GAAV,UAAU,CAAgD;QACpC,YAAO,GAAP,OAAO,CAAgB;QA9D9C,kBAAa,GAAG,CAAC,gBAAI,CAAC,YAAY,CAAC,CAAC;QAEpC,wBAAmB,GAAG,EAAE,CAAC;QACzB,yBAAoB,GAAG,EAAE,CAAC;QAEnC,SAAI,GAAG,IAAI,CAAC,WAAW,CAAC,KAAK,CAAC;YAC5B,QAAQ,EAAE,CAAC,IAAc,EAAE,IAAI,CAAC,UAAU,CAAC,WAAW,CACpD,kBAAU,CAAC,GAAG,CAAC,oBAAG,CAAC,EACnB,IAAI,CAAC,SAAS,CAAC,OAAO,CAAC,kCAAmB,CAAC,4BAA4B,CAAC,CACzE,CAAC;YACF,gBAAgB,EAAE,CAAC,IAAI,CAAC,mBAAmB,EAAE;oBAC3C,kBAAU,CAAC,GAAG,CAAC,CAAC,CAAC;oBACjB,kBAAU,CAAC,GAAG,CAAC,GAAG,CAAC;iBACpB,CAAC;YACF,wBAAwB,EAAE,CAAC,KAAK,CAAC;YACjC,iBAAiB,EAAE,CAAC,IAAI,CAAC,oBAAoB,EAAE;oBAC7C,kBAAU,CAAC,GAAG,CAAC,CAAC,CAAC;oBACjB,kBAAU,CAAC,GAAG,CAAC,GAAG,CAAC;iBACpB,CAAC;YACF,yBAAyB,EAAE,CAAC,KAAK,CAAC;YAElC,KAAK,EAAE,CAAC,IAAc,EAAE,IAAI,CAAC,UAAU,CAAC,WAAW,CACjD,kBAAU,CAAC,GAAG,CAAC,oBAAG,CAAC,EACnB,IAAI,CAAC,SAAS,CAAC,OAAO,CAAC,kCAAmB,CAAC,4BAA4B,CAAC,CACzE,CAAC;YACF,aAAa,EAAE,CAAC,IAAI,CAAC,mBAAmB,EAAE;oBACxC,kBAAU,CAAC,GAAG,CAAC,CAAC,CAAC;oBACjB,kBAAU,CAAC,GAAG,CAAC,GAAG,CAAC;iBACpB,CAAC;YACF,qBAAqB,EAAE,CAAC,KAAK,CAAC;YAC9B,cAAc,EAAE,CAAC,IAAI,CAAC,oBAAoB,EAAE;oBAC1C,kBAAU,CAAC,GAAG,CAAC,CAAC,CAAC;oBACjB,kBAAU,CAAC,GAAG,CAAC,GAAG,CAAC;iBACpB,CAAC;YACF,sBAAsB,EAAE,CAAC,KAAK,CAAC;YAE/B,cAAc,EAAE,CAAC,IAAc,CAAC;YAChC,WAAW,EAAE,CAAC,IAAc,CAAC;SAC9B,CAAC,CAAC;QAEH,cAAS,GAAG,KAAK,CAAC;QAET,aAAQ,GAAG,kCAAmB,CAAC;QAGvB,qBAAgB,GAAG;YAClC,wBAAwB,EAAE,kBAAkB;YAC5C,yBAAyB,EAAE,mBAAmB;YAC9C,qBAAqB,EAAE,eAAe;YACtC,sBAAsB,EAAE,gBAAgB;SAChC,CAAC;QAcT,IAAI,CAAC,gBAAgB,EAAE,CAAC;IAC1B,CAAC;IAED,QAAQ;QACN,IAAI,IAAI,CAAC,OAAO,EAAE,CAAC;YACjB,IAAI,CAAC,iBAAiB,EAAE,CAAC;QAC3B,CAAC;IACH,CAAC;IAEO,gBAAgB;QACtB,IAAI,CAAC,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,IAAA,8BAAc,EAAC,IAAI,CAAC,CAAC,CAAC,SAAS,CAAC,CAAC,MAAM,EAAE,EAAE;YACrE,MAAM,CAAC,OAAO,CAAC,IAAI,CAAC,gBAAgB,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,YAAY,EAAE,UAAU,CAAC,EAAE,EAAE;gBAC3E,IAAI,MAAM,CAAC,YAA0E,CAAC,EAAE,CAAC;oBACvF,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,UAAU,CAAC,CAAC,OAAO,CAAC,EAAE,SAAS,EAAE,KAAK,EAAE,CAAC,CAAC;oBAC7D,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,UAAU,CAAC,CAAC,gBAAgB,CAAC,kBAAU,CAAC,QAAQ,CAAC,CAAC;gBACvE,CAAC;qBAAM,CAAC;oBACN,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,UAAU,CAAC,CAAC,MAAM,CAAC,EAAE,SAAS,EAAE,KAAK,EAAE,CAAC,CAAC;oBAC5D,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,UAAU,CAAC,CAAC,aAAa,CAAC,kBAAU,CAAC,QAAQ,CAAC,CAAC;gBACpE,CAAC;YACH,CAAC,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;IACL,CAAC;IAED,IAAI,MAAM;QACR,OAAO,IAAA,6BAAa,EAAC,IAAI,CAAC,OAAO,CAAC,CAAC;IACrC,CAAC;IAED,iBAAiB;;QACf,IAAI,CAAC,SAAS,GAAG;YACf,QAAQ,EAAE,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,MAAM;YACtC,gBAAgB,EAAE,MAAA,MAAA,IAAI,CAAC,OAAO,CAAC,gBAAgB,0CAAE,MAAM,mCAAI,IAAI,CAAC,mBAAmB;YACnF,wBAAwB,EAAE,IAAA,mCAAmB,EAAC,IAAI,CAAC,OAAO,CAAC,gBAAgB,CAAC;YAC5E,iBAAiB,EAAE,MAAA,MAAA,IAAI,CAAC,OAAO,CAAC,iBAAiB,0CAAE,MAAM,mCAAI,IAAI,CAAC,oBAAoB;YACtF,yBAAyB,EAAE,IAAA,mCAAmB,EAAC,IAAI,CAAC,OAAO,CAAC,iBAAiB,CAAC;YAC9E,KAAK,EAAE,IAAI,CAAC,OAAO,CAAC,KAAK,CAAC,MAAM;YAChC,aAAa,EAAE,MAAA,MAAA,IAAI,CAAC,OAAO,CAAC,aAAa,0CAAE,MAAM,mCAAI,IAAI,CAAC,mBAAmB;YAC7E,qBAAqB,EAAE,IAAA,mCAAmB,EAAC,IAAI,CAAC,OAAO,CAAC,aAAa,CAAC;YACtE,cAAc,EAAE,MAAA,MAAA,IAAI,CAAC,OAAO,CAAC,cAAc,0CAAE,MAAM,mCAAI,IAAI,CAAC,oBAAoB;YAChF,sBAAsB,EAAE,IAAA,mCAAmB,EAAC,IAAI,CAAC,OAAO,CAAC,cAAc,CAAC;YACxE,cAAc,EAAE,IAAI,CAAC,OAAO,CAAC,cAAc,CAAC,MAAM;YAClD,WAAW,EAAE,IAAI,CAAC,OAAO,CAAC,WAAW,CAAC,MAAM;SAC7C,CAAC;QACF,IAAI,CAAC,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;QACrC,IAAI,CAAC,GAAG,CAAC,YAAY,EAAE,CAAC;IAC1B,CAAC;IAED,QAAQ;QACN,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC;QACtB,IAAI,CAAC,GAAG,CAAC,YAAY,EAAE,CAAC;QACxB,MAAM,OAAO,GAAG,IAAI,CAAC,oBAAoB,EAAE,CAAC;QAE5C,IAAI,CAAC,EAAE,CAAC,IAAI,CAAC,qBAAqB,EAAE,CAAC,IAAI,CAAC,OAAO,CAAC,EAAE,EAAE,OAAO,CAAC,CAAC;aAC5D,IAAI,CAAC,IAAA,8BAAc,EAAC,IAAI,CAAC,CAAC;aAC1B,SAAS,CAAC;YACT,IAAI,EAAE,GAAG,EAAE;gBACT,IAAI,CAAC,SAAS,GAAG,KAAK,CAAC;gBACvB,IAAI,CAAC,eAAe,CAAC,OAAO,CAC1B,IAAI,CAAC,SAAS,CAAC,OAAO,CAAC,2BAA2B,CAAC,CACpD,CAAC;gBACF,IAAI,CAAC,UAAU,CAAC,KAAK,EAAE,CAAC;gBACxB,IAAI,CAAC,GAAG,CAAC,YAAY,EAAE,CAAC;YAC1B,CAAC;YACD,KAAK,EAAE,CAAC,KAAc,EAAE,EAAE;gBACxB,IAAI,CAAC,YAAY,CAAC,iBAAiB,CAAC,KAAK,EAAE,IAAI,CAAC,IAAI,CAAC,CAAC;gBACtD,IAAI,CAAC,SAAS,GAAG,KAAK,CAAC;gBACvB,IAAI,CAAC,GAAG,CAAC,YAAY,EAAE,CAAC;YAC1B,CAAC;SACF,CAAC,CAAC;IACP,CAAC;IAEO,oBAAoB;QAC1B,MAAM,SAAS,GAAG,IAAI,CAAC,IAAI,CAAC,WAAW,EAAE,CAAC;QAC1C,MAAM,SAAS,GAAG,IAAI,CAAC,SAAS,CAAC;QAEjC,MAAM,aAAa,GAAkB,EAAE,CAAC;QACvC,CAAC,UAAU,EAAE,OAAO,EAAE,gBAAgB,EAAE,aAAa,CAAW,CAAC,OAAO,CAAC,CAAC,KAAK,EAAE,EAAE;YAClF,IAAI,SAAS,CAAC,KAAK,CAAC,KAAK,SAAS,CAAC,KAAK,CAAC,EAAE,CAAC;gBAC1C,aAAa,CAAC,KAAK,CAAC,GAAG,SAAS,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC;YAC/C,CAAC;QACH,CAAC,CAAC,CAAC;QAEF,CAAC,kBAAkB,EAAE,mBAAmB,EAAE,eAAe,EAAE,gBAAgB,CAAW,CAAC,OAAO,CAAC,CAAC,KAAK,EAAE,EAAE;YACxG,IAAI,SAAS,CAAC,KAAK,CAAC,KAAK,SAAS,CAAC,KAAK,CAAC,EAAE,CAAC;gBAC1C,aAAa,CAAC,KAAK,CAAC,GAAG,SAAS,CAAC,KAAK,CAAC,CAAC;YAC1C,CAAC;QACH,CAAC,CAAC,CAAC;QAEH,MAAM,CAAC,OAAO,CAAC,IAAI,CAAC,gBAAgB,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,mBAAmB,EAAE,UAAU,CAAC,EAAE,EAAE;YAClF,MAAM,YAAY,GAAG,mBAAiF,CAAC;YACvG,IAAI,SAAS,CAAC,YAAY,CAAC,KAAK,SAAS,CAAC,YAAY,CAAC,EAAE,CAAC;gBACxD,IAAI,SAAS,CAAC,UAAU,CAAC,KAAK,SAAS,CAAC,UAAU,CAAC,EAAE,CAAC;oBACpD,kDAAkD;oBAClD,aAAa,CAAC,UAAU,CAAC,GAAG,SAAS,CAAC,UAAU,CAAC,CAAC;gBACpD,CAAC;gBACD,OAAO;YACT,CAAC;YAED,gCAAgC;YAChC,aAAa,CAAC,UAAU,CAAC,GAAG,SAAS,CAAC,YAAY,CAAC,CAAC,CAAC,CAAC,2BAAO,CAAC,CAAC,CAAC,SAAS,CAAC,UAAU,CAAC,CAAC;QACxF,CAAC,CAAC,CAAC;QAEH,OAAO,aAAa,CAAC;IACvB,CAAC;;AAvKU,4EAAgC;;;;;;;;;;;qEA+DxC,aAAM,SAAC,iCAAa;;2CA/DZ,gCAAgC;IAP5C,IAAA,4BAAY,GAAE;IACd,IAAA,gBAAS,EAAC;QACT,QAAQ,EAAE,8BAA8B;QACxC,+DAAyD;QAEzD,eAAe,EAAE,8BAAuB,CAAC,MAAM;KAChD,CAAC;GACW,gCAAgC,CAwK5C","names":[],"sources":["/Users/macbook/karpov-work/TrueNAS/webui/src/app/pages/datasets/components/dataset-capacity-management-card/dataset-capacity-settings/dataset-capacity-settings.component.ts"],"sourcesContent":["import {\n  ChangeDetectionStrategy, ChangeDetectorRef, Component, Inject, OnInit,\n} from '@angular/core';\nimport { FormBuilder, Validators } from '@angular/forms';\nimport { UntilDestroy, untilDestroyed } from '@ngneat/until-destroy';\nimport { TranslateService } from '@ngx-translate/core';\nimport { GiB } from 'app/constants/bytes.constant';\nimport { Role } from 'app/enums/role.enum';\nimport { inherit } from 'app/enums/with-inherit.enum';\nimport { helptextDatasetForm } from 'app/helptext/storage/volumes/datasets/dataset-form';\nimport { DatasetDetails, DatasetUpdate } from 'app/interfaces/dataset.interface';\nimport { IxSlideInRef } from 'app/modules/forms/ix-forms/components/ix-slide-in/ix-slide-in-ref';\nimport { SLIDE_IN_DATA } from 'app/modules/forms/ix-forms/components/ix-slide-in/ix-slide-in.token';\nimport { FormErrorHandlerService } from 'app/modules/forms/ix-forms/services/form-error-handler.service';\nimport { IxFormatterService } from 'app/modules/forms/ix-forms/services/ix-formatter.service';\nimport { IxValidatorsService } from 'app/modules/forms/ix-forms/services/ix-validators.service';\nimport { SnackbarService } from 'app/modules/snackbar/services/snackbar.service';\nimport { isPropertyInherited, isRootDataset } from 'app/pages/datasets/utils/dataset.utils';\nimport { WebSocketService } from 'app/services/ws.service';\n\n@UntilDestroy()\n@Component({\n  selector: 'ix-dataset-capacity-settings',\n  templateUrl: './dataset-capacity-settings.component.html',\n  styleUrls: ['./dataset-capacity-settings.component.scss'],\n  changeDetection: ChangeDetectionStrategy.OnPush,\n})\nexport class DatasetCapacitySettingsComponent implements OnInit {\n  readonly requiredRoles = [Role.DatasetWrite];\n\n  readonly defaultQuotaWarning = 80;\n  readonly defaultQuotaCritical = 95;\n\n  form = this.formBuilder.group({\n    refquota: [null as number, this.validators.withMessage(\n      Validators.min(GiB),\n      this.translate.instant(helptextDatasetForm.dataset_form_quota_too_small),\n    )],\n    refquota_warning: [this.defaultQuotaWarning, [\n      Validators.min(0),\n      Validators.max(100),\n    ]],\n    refquota_warning_inherit: [false],\n    refquota_critical: [this.defaultQuotaCritical, [\n      Validators.min(0),\n      Validators.max(100),\n    ]],\n    refquota_critical_inherit: [false],\n\n    quota: [null as number, this.validators.withMessage(\n      Validators.min(GiB),\n      this.translate.instant(helptextDatasetForm.dataset_form_quota_too_small),\n    )],\n    quota_warning: [this.defaultQuotaWarning, [\n      Validators.min(0),\n      Validators.max(100),\n    ]],\n    quota_warning_inherit: [false],\n    quota_critical: [this.defaultQuotaCritical, [\n      Validators.min(0),\n      Validators.max(100),\n    ]],\n    quota_critical_inherit: [false],\n\n    refreservation: [null as number],\n    reservation: [null as number],\n  });\n\n  isLoading = false;\n\n  readonly helptext = helptextDatasetForm;\n\n  private oldValues: DatasetCapacitySettingsComponent['form']['value'];\n  private readonly inheritRelations = {\n    refquota_warning_inherit: 'refquota_warning',\n    refquota_critical_inherit: 'refquota_critical',\n    quota_warning_inherit: 'quota_warning',\n    quota_critical_inherit: 'quota_critical',\n  } as const;\n\n  constructor(\n    private ws: WebSocketService,\n    private formBuilder: FormBuilder,\n    public formatter: IxFormatterService,\n    private cdr: ChangeDetectorRef,\n    private errorHandler: FormErrorHandlerService,\n    private snackbarService: SnackbarService,\n    private translate: TranslateService,\n    private validators: IxValidatorsService,\n    private slideInRef: IxSlideInRef<DatasetCapacitySettingsComponent>,\n    @Inject(SLIDE_IN_DATA) public dataset: DatasetDetails,\n  ) {\n    this.setFormRelations();\n  }\n\n  ngOnInit(): void {\n    if (this.dataset) {\n      this.setDatasetForEdit();\n    }\n  }\n\n  private setFormRelations(): void {\n    this.form.valueChanges.pipe(untilDestroyed(this)).subscribe((values) => {\n      Object.entries(this.inheritRelations).forEach(([inheritField, valueField]) => {\n        if (values[inheritField as keyof DatasetCapacitySettingsComponent['inheritRelations']]) {\n          this.form.controls[valueField].disable({ emitEvent: false });\n          this.form.controls[valueField].removeValidators(Validators.required);\n        } else {\n          this.form.controls[valueField].enable({ emitEvent: false });\n          this.form.controls[valueField].addValidators(Validators.required);\n        }\n      });\n    });\n  }\n\n  get isRoot(): boolean {\n    return isRootDataset(this.dataset);\n  }\n\n  setDatasetForEdit(): void {\n    this.oldValues = {\n      refquota: this.dataset.refquota.parsed,\n      refquota_warning: this.dataset.refquota_warning?.parsed ?? this.defaultQuotaWarning,\n      refquota_warning_inherit: isPropertyInherited(this.dataset.refquota_warning),\n      refquota_critical: this.dataset.refquota_critical?.parsed ?? this.defaultQuotaCritical,\n      refquota_critical_inherit: isPropertyInherited(this.dataset.refquota_critical),\n      quota: this.dataset.quota.parsed,\n      quota_warning: this.dataset.quota_warning?.parsed ?? this.defaultQuotaWarning,\n      quota_warning_inherit: isPropertyInherited(this.dataset.quota_warning),\n      quota_critical: this.dataset.quota_critical?.parsed ?? this.defaultQuotaCritical,\n      quota_critical_inherit: isPropertyInherited(this.dataset.quota_critical),\n      refreservation: this.dataset.refreservation.parsed,\n      reservation: this.dataset.reservation.parsed,\n    };\n    this.form.patchValue(this.oldValues);\n    this.cdr.markForCheck();\n  }\n\n  onSubmit(): void {\n    this.isLoading = true;\n    this.cdr.markForCheck();\n    const payload = this.getChangedFormValues();\n\n    this.ws.call('pool.dataset.update', [this.dataset.id, payload])\n      .pipe(untilDestroyed(this))\n      .subscribe({\n        next: () => {\n          this.isLoading = false;\n          this.snackbarService.success(\n            this.translate.instant('Dataset settings updated.'),\n          );\n          this.slideInRef.close();\n          this.cdr.markForCheck();\n        },\n        error: (error: unknown) => {\n          this.errorHandler.handleWsFormError(error, this.form);\n          this.isLoading = false;\n          this.cdr.markForCheck();\n        },\n      });\n  }\n\n  private getChangedFormValues(): DatasetUpdate {\n    const newValues = this.form.getRawValue();\n    const oldValues = this.oldValues;\n\n    const changedValues: DatasetUpdate = {};\n    (['refquota', 'quota', 'refreservation', 'reservation'] as const).forEach((field) => {\n      if (newValues[field] !== oldValues[field]) {\n        changedValues[field] = newValues[field] || 0;\n      }\n    });\n\n    (['refquota_warning', 'refquota_critical', 'quota_warning', 'quota_critical'] as const).forEach((field) => {\n      if (newValues[field] !== oldValues[field]) {\n        changedValues[field] = newValues[field];\n      }\n    });\n\n    Object.entries(this.inheritRelations).forEach(([untypedInheritField, valueField]) => {\n      const inheritField = untypedInheritField as keyof DatasetCapacitySettingsComponent['inheritRelations'];\n      if (newValues[inheritField] === oldValues[inheritField]) {\n        if (newValues[valueField] !== oldValues[valueField]) {\n          // Inherit checkbox wasn't changed, but value was.\n          changedValues[valueField] = newValues[valueField];\n        }\n        return;\n      }\n\n      // Inherit checkbox was changed.\n      changedValues[valueField] = newValues[inheritField] ? inherit : newValues[valueField];\n    });\n\n    return changedValues;\n  }\n}\n"],"version":3}