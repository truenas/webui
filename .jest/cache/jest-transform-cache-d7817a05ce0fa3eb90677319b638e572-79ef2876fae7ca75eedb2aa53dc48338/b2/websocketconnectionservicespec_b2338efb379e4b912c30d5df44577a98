e1fefae5c5dc6213c47969af3ae85d83
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const testing_1 = require("@angular/core/testing");
const jest_1 = require("@ngneat/spectator/jest");
const angular2_uuid_1 = require("angular2-uuid");
const webSocket_1 = require("rxjs/webSocket");
const api_message_type_enum_1 = require("app/enums/api-message-type.enum");
const websocket_helper_1 = require("app/helpers/websocket.helper");
const websocket_connection_service_1 = require("app/services/websocket-connection.service");
const fakeSocketUrl = 'ws://localhost:1234';
let fakeSocketConfig;
let fakeSocketsList;
function fakeSocket(urlConfigOrSource) {
    urlConfigOrSource.url = fakeSocketUrl;
    fakeSocketConfig = urlConfigOrSource;
    const fakeSocket$ = new webSocket_1.WebSocketSubject(urlConfigOrSource);
    fakeSocketsList.push(fakeSocket$);
    return fakeSocket$;
}
describe('WebSocketConnectionService', () => {
    let spectator;
    let nextFakeSocket$;
    const createService = (0, jest_1.createServiceFactory)({
        service: websocket_connection_service_1.WebSocketConnectionService,
        providers: [
            {
                provide: websocket_helper_1.WEBSOCKET,
                useFactory: () => fakeSocket,
            },
        ],
    });
    beforeEach(() => {
        fakeSocketsList = [];
        spectator = createService();
        if (fakeSocketsList.length) {
            nextFakeSocket$ = fakeSocketsList[fakeSocketsList.length - 1];
        }
    });
    it('checks socket config params', () => {
        expect(fakeSocketConfig.url).toBe(fakeSocketUrl);
        expect(typeof fakeSocketConfig.openObserver.next).toBe('function');
        expect(fakeSocketConfig.openObserver.next.name).toContain('onOpen');
        expect(typeof fakeSocketConfig.closeObserver.next).toBe('function');
        expect(fakeSocketConfig.closeObserver.next.name).toContain('onClose');
    });
    it('sets shutDownInProgress to false when open connection', () => {
        spectator.service.shutDownInProgress = true;
        expect(spectator.service.shutDownInProgress).toBe(true);
        fakeSocketConfig.openObserver.next({});
        expect(spectator.service.shutDownInProgress).toBe(false);
    });
    it('sends connect message', () => {
        jest.spyOn(nextFakeSocket$, 'next');
        fakeSocketConfig.openObserver.next({});
        expect(nextFakeSocket$.next).toHaveBeenCalledWith({ support: ['1'], version: '1', msg: api_message_type_enum_1.OutgoingApiMessageType.Connect });
    });
    it('closes connection when isTryingReconnect is true', () => {
        jest.spyOn(nextFakeSocket$, 'next');
        jest.spyOn(nextFakeSocket$, 'complete');
        spectator.service.isTryingReconnect = true;
        spectator.service.shutDownInProgress = true;
        fakeSocketConfig.openObserver.next({});
        expect(spectator.service.shutDownInProgress).toBe(true);
        expect(nextFakeSocket$.next).not.toHaveBeenCalled();
        expect(nextFakeSocket$.complete).toHaveBeenCalled();
    });
    it('sends pings', (0, testing_1.fakeAsync)(() => {
        jest.spyOn(nextFakeSocket$, 'next');
        jest.spyOn(angular2_uuid_1.UUID, 'UUID')
            .mockReturnValueOnce('ping-pong-uuid-1')
            .mockReturnValueOnce('ping-pong-uuid-2')
            .mockReturnValueOnce('ping-pong-uuid-3');
        spectator.service.isConnected$.next(true);
        (0, testing_1.tick)(20 * 1000);
        expect(nextFakeSocket$.next).toHaveBeenNthCalledWith(1, { id: 'ping-pong-uuid-1', msg: api_message_type_enum_1.OutgoingApiMessageType.Ping });
        expect(nextFakeSocket$.next).toHaveBeenCalledTimes(1);
        (0, testing_1.tick)(20 * 1000);
        expect(nextFakeSocket$.next).toHaveBeenNthCalledWith(2, { id: 'ping-pong-uuid-2', msg: api_message_type_enum_1.OutgoingApiMessageType.Ping });
        expect(nextFakeSocket$.next).toHaveBeenCalledTimes(2);
        (0, testing_1.tick)(20 * 1000);
        expect(nextFakeSocket$.next).toHaveBeenNthCalledWith(3, { id: 'ping-pong-uuid-3', msg: api_message_type_enum_1.OutgoingApiMessageType.Ping });
        expect(nextFakeSocket$.next).toHaveBeenCalledTimes(3);
        spectator.service.isConnected$.next(false);
        (0, testing_1.tick)(20 * 1000);
        expect(nextFakeSocket$.next).toHaveBeenCalledTimes(3);
        (0, testing_1.discardPeriodicTasks)();
    }));
    it('resumes calls that were paused because of broken connection', () => {
        jest.spyOn(nextFakeSocket$, 'next');
        spectator.service.isConnected$.next(true);
        spectator.service.send('message-1');
        spectator.service.isConnected$.next(false);
        spectator.service.send('message-2');
        spectator.service.send('message-3');
        expect(nextFakeSocket$.next).toHaveBeenCalledWith('message-1');
        expect(nextFakeSocket$.next).not.toHaveBeenCalledWith('message-2');
        expect(nextFakeSocket$.next).not.toHaveBeenCalledWith('message-3');
        spectator.service.isConnected$.next(true);
        expect(nextFakeSocket$.next).toHaveBeenCalledWith('message-2');
        expect(nextFakeSocket$.next).toHaveBeenCalledWith('message-3');
    });
    it('sets isClosed when close connection and isTryingReconnect is false', () => {
        fakeSocketConfig.openObserver.next({});
        spectator.service.isConnected$.next(true);
        fakeSocketConfig.closeObserver.next({ code: 1006 });
        let isClosed;
        spectator.service.isClosed$.subscribe((value) => isClosed = value);
        expect(isClosed).toBe(true);
    });
    it('sets isAccessRestricted when close connection with code 1008', () => {
        fakeSocketConfig.openObserver.next({});
        spectator.service.isConnected$.next(true);
        fakeSocketConfig.closeObserver.next({ code: 1008 });
        let isAccessRestricted;
        spectator.service.isAccessRestricted$.subscribe((value) => isAccessRestricted = value);
        expect(isAccessRestricted).toBe(true);
    });
    it('trying to reconnect when close connection and isTryingReconnect is false', (0, testing_1.fakeAsync)(() => {
        jest.spyOn(fakeSocketsList[0], 'complete');
        fakeSocketConfig.openObserver.next({});
        spectator.service.isConnected$.next(true);
        fakeSocketConfig.closeObserver.next({ code: 1006 });
        expect(spectator.service.isTryingReconnect).toBe(true);
        expect(fakeSocketsList).toHaveLength(1);
        (0, testing_1.tick)(5 * 1000);
        expect(spectator.service.isTryingReconnect).toBe(false);
        expect(fakeSocketsList).toHaveLength(2);
        expect(fakeSocketsList[0].complete).toHaveBeenCalled();
        (0, testing_1.discardPeriodicTasks)();
    }));
    it('ignores closing when close connection and isTryingReconnect is true', (0, testing_1.fakeAsync)(() => {
        jest.spyOn(fakeSocketsList[0], 'complete');
        fakeSocketConfig.openObserver.next({});
        spectator.service.isConnected$.next(true);
        spectator.service.isTryingReconnect = true;
        fakeSocketConfig.closeObserver.next({ code: 1006 });
        (0, testing_1.tick)(5 * 1000);
        expect(fakeSocketsList).toHaveLength(1);
        expect(fakeSocketsList[0].complete).not.toHaveBeenCalled();
        let isClosed;
        spectator.service.isClosed$.subscribe((value) => isClosed = value);
        expect(isClosed).toBe(false);
        (0, testing_1.discardPeriodicTasks)();
    }));
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21hY2Jvb2sva2FycG92LXdvcmsvVHJ1ZU5BUy93ZWJ1aS9zcmMvYXBwL3NlcnZpY2VzL3dlYnNvY2tldC1jb25uZWN0aW9uLnNlcnZpY2Uuc3BlYy50cyIsIm1hcHBpbmdzIjoiOztBQUFBLG1EQUE4RTtBQUM5RSxpREFBZ0Y7QUFDaEYsaURBQXFDO0FBQ3JDLDhDQUEwRTtBQUMxRSwyRUFBeUU7QUFDekUsbUVBQXlEO0FBQ3pELDRGQUF1RjtBQUV2RixNQUFNLGFBQWEsR0FBRyxxQkFBcUIsQ0FBQztBQUM1QyxJQUFJLGdCQUFpRCxDQUFDO0FBQ3RELElBQUksZUFBNEMsQ0FBQztBQUVqRCxTQUFTLFVBQVUsQ0FBSSxpQkFBNEM7SUFDakUsaUJBQWlCLENBQUMsR0FBRyxHQUFHLGFBQWEsQ0FBQztJQUN0QyxnQkFBZ0IsR0FBRyxpQkFBaUIsQ0FBQztJQUNyQyxNQUFNLFdBQVcsR0FBRyxJQUFJLDRCQUFnQixDQUFJLGlCQUFpQixDQUFDLENBQUM7SUFDL0QsZUFBZSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUNsQyxPQUFPLFdBQVcsQ0FBQztBQUNyQixDQUFDO0FBRUQsUUFBUSxDQUFDLDRCQUE0QixFQUFFLEdBQUcsRUFBRTtJQUMxQyxJQUFJLFNBQXVELENBQUM7SUFDNUQsSUFBSSxlQUEwQyxDQUFDO0lBRS9DLE1BQU0sYUFBYSxHQUFHLElBQUEsMkJBQW9CLEVBQUM7UUFDekMsT0FBTyxFQUFFLHlEQUEwQjtRQUNuQyxTQUFTLEVBQUU7WUFDVDtnQkFDRSxPQUFPLEVBQUUsNEJBQVM7Z0JBQ2xCLFVBQVUsRUFBRSxHQUFHLEVBQUUsQ0FBQyxVQUFVO2FBQzdCO1NBQ0Y7S0FDRixDQUFDLENBQUM7SUFFSCxVQUFVLENBQUMsR0FBRyxFQUFFO1FBQ2QsZUFBZSxHQUFHLEVBQUUsQ0FBQztRQUNyQixTQUFTLEdBQUcsYUFBYSxFQUFFLENBQUM7UUFDNUIsSUFBSSxlQUFlLENBQUMsTUFBTSxFQUFFLENBQUM7WUFDM0IsZUFBZSxHQUFHLGVBQWUsQ0FB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Q3ZGLElBQUksQ0FBQyxLQUFLLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxFQUFFLFVBQVUsQ0FBQyxDQUFDO1FBQzNDLGdCQUFnQixDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsRUFBVyxDQUFDLENBQUM7UUFDaEQsU0FBUyxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsaUJBQWlCLEdBQUcsSUFBSSxDQUFDO1FBRTNDLGdCQUFnQixDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFnQixDQUFDLENBQUM7UUFDbEUsSUFBQSxjQUFJLEVBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDO1FBRWYsTUFBTSxDQUFDLGVBQWUsQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN4QyxNQUFNLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBRTNELElBQUksUUFBUSxDQUFDO1FBQ2IsU0FBUyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxRQUFRLEdBQUcsS0FBSyxDQUFDLENBQUM7UUFDbkUsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUU3QixJQUFBLDhCQUFvQixHQUFFLENBQUM7SUFDekIsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUNOLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9tYWNib29rL2thcnBvdi13b3JrL1RydWVOQVMvd2VidWkvc3JjL2FwcC9zZXJ2aWNlcy93ZWJzb2NrZXQtY29ubmVjdGlvbi5zZXJ2aWNlLnNwZWMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZGlzY2FyZFBlcmlvZGljVGFza3MsIGZha2VBc3luYywgdGljayB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUvdGVzdGluZyc7XG5pbXBvcnQgeyBjcmVhdGVTZXJ2aWNlRmFjdG9yeSwgU3BlY3RhdG9yU2VydmljZSB9IGZyb20gJ0BuZ25lYXQvc3BlY3RhdG9yL2plc3QnO1xuaW1wb3J0IHsgVVVJRCB9IGZyb20gJ2FuZ3VsYXIyLXV1aWQnO1xuaW1wb3J0IHsgV2ViU29ja2V0U3ViamVjdCwgV2ViU29ja2V0U3ViamVjdENvbmZpZyB9IGZyb20gJ3J4anMvd2ViU29ja2V0JztcbmltcG9ydCB7IE91dGdvaW5nQXBpTWVzc2FnZVR5cGUgfSBmcm9tICdhcHAvZW51bXMvYXBpLW1lc3NhZ2UtdHlwZS5lbnVtJztcbmltcG9ydCB7IFdFQlNPQ0tFVCB9IGZyb20gJ2FwcC9oZWxwZXJzL3dlYnNvY2tldC5oZWxwZXInO1xuaW1wb3J0IHsgV2ViU29ja2V0Q29ubmVjdGlvblNlcnZpY2UgfSBmcm9tICdhcHAvc2VydmljZXMvd2Vic29ja2V0LWNvbm5lY3Rpb24uc2VydmljZSc7XG5cbmNvbnN0IGZha2VTb2NrZXRVcmwgPSAnd3M6Ly9sb2NhbGhvc3Q6MTIzNCc7XG5sZXQgZmFrZVNvY2tldENvbmZpZzogV2ViU29ja2V0U3ViamVjdENvbmZpZzx1bmtub3duPjtcbmxldCBmYWtlU29ja2V0c0xpc3Q6IFdlYlNvY2tldFN1YmplY3Q8dW5rbm93bj5bXTtcblxuZnVuY3Rpb24gZmFrZVNvY2tldDxUPih1cmxDb25maWdPclNvdXJjZTogV2ViU29ja2V0U3ViamVjdENvbmZpZzxUPik6IFdlYlNvY2tldFN1YmplY3Q8dW5rbm93bj4ge1xuICB1cmxDb25maWdPclNvdXJjZS51cmwgPSBmYWtlU29ja2V0VXJsO1xuICBmYWtlU29ja2V0Q29uZmlnID0gdXJsQ29uZmlnT3JTb3VyY2U7XG4gIGNvbnN0IGZha2VTb2NrZXQkID0gbmV3IFdlYlNvY2tldFN1YmplY3Q8VD4odXJsQ29uZmlnT3JTb3VyY2UpO1xuICBmYWtlU29ja2V0c0xpc3QucHVzaChmYWtlU29ja2V0JCk7XG4gIHJldHVybiBmYWtlU29ja2V0JDtcbn1cblxuZGVzY3JpYmUoJ1dlYlNvY2tldENvbm5lY3Rpb25TZXJ2aWNlJywgKCkgPT4ge1xuICBsZXQgc3BlY3RhdG9yOiBTcGVjdGF0b3JTZXJ2aWNlPFdlYlNvY2tldENvbm5lY3Rpb25TZXJ2aWNlPjtcbiAgbGV0IG5leHRGYWtlU29ja2V0JDogV2ViU29ja2V0U3ViamVjdDx1bmtub3duPjtcblxuICBjb25zdCBjcmVhdGVTZXJ2aWNlID0gY3JlYXRlU2VydmljZUZhY3Rvcnkoe1xuICAgIHNlcnZpY2U6IFdlYlNvY2tldENvbm5lY3Rpb25TZXJ2aWNlLFxuICAgIHByb3ZpZGVyczogW1xuICAgICAge1xuICAgICAgICBwcm92aWRlOiBXRUJTT0NLRVQsXG4gICAgICAgIHVzZUZhY3Rvcnk6ICgpID0+IGZha2VTb2NrZXQsXG4gICAgICB9LFxuICAgIF0sXG4gIH0pO1xuXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIGZha2VTb2NrZXRzTGlzdCA9IFtdO1xuICAgIHNwZWN0YXRvciA9IGNyZWF0ZVNlcnZpY2UoKTtcbiAgICBpZiAoZmFrZVNvY2tldHNMaXN0Lmxlbmd0aCkge1xuICAgICAgbmV4dEZha2VTb2NrZXQkID0gZmFrZVNvY2tldHNMaXN0W2Zha2VTb2NrZXRzTGlzdC5sZW5ndGggLSAxXTtcbiAgICB9XG4gIH0pO1xuXG4gIGl0KCdjaGVja3Mgc29ja2V0IGNvbmZpZyBwYXJhbXMnLCAoKSA9PiB7XG4gICAgZXhwZWN0KGZha2VTb2NrZXRDb25maWcudXJsKS50b0JlKGZha2VTb2NrZXRVcmwpO1xuICAgIGV4cGVjdCh0eXBlb2YgZmFrZVNvY2tldENvbmZpZy5vcGVuT2JzZXJ2ZXIubmV4dCkudG9CZSgnZnVuY3Rpb24nKTtcbiAgICBleHBlY3QoZmFrZVNvY2tldENvbmZpZy5vcGVuT2JzZXJ2ZXIubmV4dC5uYW1lKS50b0NvbnRhaW4oJ29uT3BlbicpO1xuICAgIGV4cGVjdCh0eXBlb2YgZmFrZVNvY2tldENvbmZpZy5jbG9zZU9ic2VydmVyLm5leHQpLnRvQmUoJ2Z1bmN0aW9uJyk7XG4gICAgZXhwZWN0KGZha2VTb2NrZXRDb25maWcuY2xvc2VPYnNlcnZlci5uZXh0Lm5hbWUpLnRvQ29udGFpbignb25DbG9zZScpO1xuICB9KTtcblxuICBpdCgnc2V0cyBzaHV0RG93bkluUHJvZ3Jlc3MgdG8gZmFsc2Ugd2hlbiBvcGVuIGNvbm5lY3Rpb24nLCAoKSA9PiB7XG4gICAgc3BlY3RhdG9yLnNlcnZpY2Uuc2h1dERvd25JblByb2dyZXNzID0gdHJ1ZTtcbiAgICBleHBlY3Qoc3BlY3RhdG9yLnNlcnZpY2Uuc2h1dERvd25JblByb2dyZXNzKS50b0JlKHRydWUpO1xuXG4gICAgZmFrZVNvY2tldENvbmZpZy5vcGVuT2JzZXJ2ZXIubmV4dCh7fSBhcyBFdmVudCk7XG4gICAgZXhwZWN0KHNwZWN0YXRvci5zZXJ2aWNlLnNodXREb3duSW5Qcm9ncmVzcykudG9CZShmYWxzZSk7XG4gIH0pO1xuXG4gIGl0KCdzZW5kcyBjb25uZWN0IG1lc3NhZ2UnLCAoKSA9PiB7XG4gICAgamVzdC5zcHlPbihuZXh0RmFrZVNvY2tldCQsICduZXh0Jyk7XG4gICAgZmFrZVNvY2tldENvbmZpZy5vcGVuT2JzZXJ2ZXIubmV4dCh7fSBhcyBFdmVudCk7XG5cbiAgICBleHBlY3QobmV4dEZha2VTb2NrZXQkLm5leHQpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHsgc3VwcG9ydDogWycxJ10sIHZlcnNpb246ICcxJywgbXNnOiBPdXRnb2luZ0FwaU1lc3NhZ2VUeXBlLkNvbm5lY3QgfSk7XG4gIH0pO1xuXG4gIGl0KCdjbG9zZXMgY29ubmVjdGlvbiB3aGVuIGlzVHJ5aW5nUmVjb25uZWN0IGlzIHRydWUnLCAoKSA9PiB7XG4gICAgamVzdC5zcHlPbihuZXh0RmFrZVNvY2tldCQsICduZXh0Jyk7XG4gICAgamVzdC5zcHlPbihuZXh0RmFrZVNvY2tldCQsICdjb21wbGV0ZScpO1xuXG4gICAgc3BlY3RhdG9yLnNlcnZpY2UuaXNUcnlpbmdSZWNvbm5lY3QgPSB0cnVlO1xuICAgIHNwZWN0YXRvci5zZXJ2aWNlLnNodXREb3duSW5Qcm9ncmVzcyA9IHRydWU7XG5cbiAgICBmYWtlU29ja2V0Q29uZmlnLm9wZW5PYnNlcnZlci5uZXh0KHt9IGFzIEV2ZW50KTtcbiAgICBleHBlY3Qoc3BlY3RhdG9yLnNlcnZpY2Uuc2h1dERvd25JblByb2dyZXNzKS50b0JlKHRydWUpO1xuICAgIGV4cGVjdChuZXh0RmFrZVNvY2tldCQubmV4dCkubm90LnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgICBleHBlY3QobmV4dEZha2VTb2NrZXQkLmNvbXBsZXRlKS50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gIH0pO1xuXG4gIGl0KCdzZW5kcyBwaW5ncycsIGZha2VBc3luYygoKSA9PiB7XG4gICAgamVzdC5zcHlPbihuZXh0RmFrZVNvY2tldCQsICduZXh0Jyk7XG4gICAgamVzdC5zcHlPbihVVUlELCAnVVVJRCcpXG4gICAgICAubW9ja1JldHVyblZhbHVlT25jZSgncGluZy1wb25nLXV1aWQtMScpXG4gICAgICAubW9ja1JldHVyblZhbHVlT25jZSgncGluZy1wb25nLXV1aWQtMicpXG4gICAgICAubW9ja1JldHVyblZhbHVlT25jZSgncGluZy1wb25nLXV1aWQtMycpO1xuXG4gICAgc3BlY3RhdG9yLnNlcnZpY2UuaXNDb25uZWN0ZWQkLm5leHQodHJ1ZSk7XG5cbiAgICB0aWNrKDIwICogMTAwMCk7XG4gICAgZXhwZWN0KG5leHRGYWtlU29ja2V0JC5uZXh0KS50b0hhdmVCZWVuTnRoQ2FsbGVkV2l0aCgxLCB7IGlkOiAncGluZy1wb25nLXV1aWQtMScsIG1zZzogT3V0Z29pbmdBcGlNZXNzYWdlVHlwZS5QaW5nIH0pO1xuICAgIGV4cGVjdChuZXh0RmFrZVNvY2tldCQubmV4dCkudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpO1xuICAgIHRpY2soMjAgKiAxMDAwKTtcbiAgICBleHBlY3QobmV4dEZha2VTb2NrZXQkLm5leHQpLnRvSGF2ZUJlZW5OdGhDYWxsZWRXaXRoKDIsIHsgaWQ6ICdwaW5nLXBvbmctdXVpZC0yJywgbXNnOiBPdXRnb2luZ0FwaU1lc3NhZ2VUeXBlLlBpbmcgfSk7XG4gICAgZXhwZWN0KG5leHRGYWtlU29ja2V0JC5uZXh0KS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMik7XG4gICAgdGljaygyMCAqIDEwMDApO1xuICAgIGV4cGVjdChuZXh0RmFrZVNvY2tldCQubmV4dCkudG9IYXZlQmVlbk50aENhbGxlZFdpdGgoMywgeyBpZDogJ3BpbmctcG9uZy11dWlkLTMnLCBtc2c6IE91dGdvaW5nQXBpTWVzc2FnZVR5cGUuUGluZyB9KTtcbiAgICBleHBlY3QobmV4dEZha2VTb2NrZXQkLm5leHQpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygzKTtcblxuICAgIHNwZWN0YXRvci5zZXJ2aWNlLmlzQ29ubmVjdGVkJC5uZXh0KGZhbHNlKTtcbiAgICB0aWNrKDIwICogMTAwMCk7XG4gICAgZXhwZWN0KG5leHRGYWtlU29ja2V0JC5uZXh0KS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMyk7XG5cbiAgICBkaXNjYXJkUGVyaW9kaWNUYXNrcygpO1xuICB9KSk7XG5cbiAgaXQoJ3Jlc3VtZXMgY2FsbHMgdGhhdCB3ZXJlIHBhdXNlZCBiZWNhdXNlIG9mIGJyb2tlbiBjb25uZWN0aW9uJywgKCkgPT4ge1xuICAgIGplc3Quc3B5T24obmV4dEZha2VTb2NrZXQkLCAnbmV4dCcpO1xuICAgIHNwZWN0YXRvci5zZXJ2aWNlLmlzQ29ubmVjdGVkJC5uZXh0KHRydWUpO1xuICAgIHNwZWN0YXRvci5zZXJ2aWNlLnNlbmQoJ21lc3NhZ2UtMScpO1xuXG4gICAgc3BlY3RhdG9yLnNlcnZpY2UuaXNDb25uZWN0ZWQkLm5leHQoZmFsc2UpO1xuICAgIHNwZWN0YXRvci5zZXJ2aWNlLnNlbmQoJ21lc3NhZ2UtMicpO1xuICAgIHNwZWN0YXRvci5zZXJ2aWNlLnNlbmQoJ21lc3NhZ2UtMycpO1xuXG4gICAgZXhwZWN0KG5leHRGYWtlU29ja2V0JC5uZXh0KS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgnbWVzc2FnZS0xJyk7XG4gICAgZXhwZWN0KG5leHRGYWtlU29ja2V0JC5uZXh0KS5ub3QudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ21lc3NhZ2UtMicpO1xuICAgIGV4cGVjdChuZXh0RmFrZVNvY2tldCQubmV4dCkubm90LnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCdtZXNzYWdlLTMnKTtcblxuICAgIHNwZWN0YXRvci5zZXJ2aWNlLmlzQ29ubmVjdGVkJC5uZXh0KHRydWUpO1xuICAgIGV4cGVjdChuZXh0RmFrZVNvY2tldCQubmV4dCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ21lc3NhZ2UtMicpO1xuICAgIGV4cGVjdChuZXh0RmFrZVNvY2tldCQubmV4dCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ21lc3NhZ2UtMycpO1xuICB9KTtcblxuICBpdCgnc2V0cyBpc0Nsb3NlZCB3aGVuIGNsb3NlIGNvbm5lY3Rpb24gYW5kIGlzVHJ5aW5nUmVjb25uZWN0IGlzIGZhbHNlJywgKCkgPT4ge1xuICAgIGZha2VTb2NrZXRDb25maWcub3Blbk9ic2VydmVyLm5leHQoe30gYXMgRXZlbnQpO1xuICAgIHNwZWN0YXRvci5zZXJ2aWNlLmlzQ29ubmVjdGVkJC5uZXh0KHRydWUpO1xuXG4gICAgZmFrZVNvY2tldENvbmZpZy5jbG9zZU9ic2VydmVyLm5leHQoeyBjb2RlOiAxMDA2IH0gYXMgQ2xvc2VFdmVudCk7XG5cbiAgICBsZXQgaXNDbG9zZWQ7XG4gICAgc3BlY3RhdG9yLnNlcnZpY2UuaXNDbG9zZWQkLnN1YnNjcmliZSgodmFsdWUpID0+IGlzQ2xvc2VkID0gdmFsdWUpO1xuICAgIGV4cGVjdChpc0Nsb3NlZCkudG9CZSh0cnVlKTtcbiAgfSk7XG5cbiAgaXQoJ3NldHMgaXNBY2Nlc3NSZXN0cmljdGVkIHdoZW4gY2xvc2UgY29ubmVjdGlvbiB3aXRoIGNvZGUgMTAwOCcsICgpID0+IHtcbiAgICBmYWtlU29ja2V0Q29uZmlnLm9wZW5PYnNlcnZlci5uZXh0KHt9IGFzIEV2ZW50KTtcbiAgICBzcGVjdGF0b3Iuc2VydmljZS5pc0Nvbm5lY3RlZCQubmV4dCh0cnVlKTtcblxuICAgIGZha2VTb2NrZXRDb25maWcuY2xvc2VPYnNlcnZlci5uZXh0KHsgY29kZTogMTAwOCB9IGFzIENsb3NlRXZlbnQpO1xuXG4gICAgbGV0IGlzQWNjZXNzUmVzdHJpY3RlZDtcbiAgICBzcGVjdGF0b3Iuc2VydmljZS5pc0FjY2Vzc1Jlc3RyaWN0ZWQkLnN1YnNjcmliZSgodmFsdWUpID0+IGlzQWNjZXNzUmVzdHJpY3RlZCA9IHZhbHVlKTtcbiAgICBleHBlY3QoaXNBY2Nlc3NSZXN0cmljdGVkKS50b0JlKHRydWUpO1xuICB9KTtcblxuICBpdCgndHJ5aW5nIHRvIHJlY29ubmVjdCB3aGVuIGNsb3NlIGNvbm5lY3Rpb24gYW5kIGlzVHJ5aW5nUmVjb25uZWN0IGlzIGZhbHNlJywgZmFrZUFzeW5jKCgpID0+IHtcbiAgICBqZXN0LnNweU9uKGZha2VTb2NrZXRzTGlzdFswXSwgJ2NvbXBsZXRlJyk7XG4gICAgZmFrZVNvY2tldENvbmZpZy5vcGVuT2JzZXJ2ZXIubmV4dCh7fSBhcyBFdmVudCk7XG4gICAgc3BlY3RhdG9yLnNlcnZpY2UuaXNDb25uZWN0ZWQkLm5leHQodHJ1ZSk7XG5cbiAgICBmYWtlU29ja2V0Q29uZmlnLmNsb3NlT2JzZXJ2ZXIubmV4dCh7IGNvZGU6IDEwMDYgfSBhcyBDbG9zZUV2ZW50KTtcbiAgICBleHBlY3Qoc3BlY3RhdG9yLnNlcnZpY2UuaXNUcnlpbmdSZWNvbm5lY3QpLnRvQmUodHJ1ZSk7XG4gICAgZXhwZWN0KGZha2VTb2NrZXRzTGlzdCkudG9IYXZlTGVuZ3RoKDEpO1xuXG4gICAgdGljayg1ICogMTAwMCk7XG4gICAgZXhwZWN0KHNwZWN0YXRvci5zZXJ2aWNlLmlzVHJ5aW5nUmVjb25uZWN0KS50b0JlKGZhbHNlKTtcbiAgICBleHBlY3QoZmFrZVNvY2tldHNMaXN0KS50b0hhdmVMZW5ndGgoMik7XG5cbiAgICBleHBlY3QoZmFrZVNvY2tldHNMaXN0WzBdLmNvbXBsZXRlKS50b0hhdmVCZWVuQ2FsbGVkKCk7XG5cbiAgICBkaXNjYXJkUGVyaW9kaWNUYXNrcygpO1xuICB9KSk7XG5cbiAgaXQoJ2lnbm9yZXMgY2xvc2luZyB3aGVuIGNsb3NlIGNvbm5lY3Rpb24gYW5kIGlzVHJ5aW5nUmVjb25uZWN0IGlzIHRydWUnLCBmYWtlQXN5bmMoKCkgPT4ge1xuICAgIGplc3Quc3B5T24oZmFrZVNvY2tldHNMaXN0WzBdLCAnY29tcGxldGUnKTtcbiAgICBmYWtlU29ja2V0Q29uZmlnLm9wZW5PYnNlcnZlci5uZXh0KHt9IGFzIEV2ZW50KTtcbiAgICBzcGVjdGF0b3Iuc2VydmljZS5pc0Nvbm5lY3RlZCQubmV4dCh0cnVlKTtcbiAgICBzcGVjdGF0b3Iuc2VydmljZS5pc1RyeWluZ1JlY29ubmVjdCA9IHRydWU7XG5cbiAgICBmYWtlU29ja2V0Q29uZmlnLmNsb3NlT2JzZXJ2ZXIubmV4dCh7IGNvZGU6IDEwMDYgfSBhcyBDbG9zZUV2ZW50KTtcbiAgICB0aWNrKDUgKiAxMDAwKTtcblxuICAgIGV4cGVjdChmYWtlU29ja2V0c0xpc3QpLnRvSGF2ZUxlbmd0aCgxKTtcbiAgICBleHBlY3QoZmFrZVNvY2tldHNMaXN0WzBdLmNvbXBsZXRlKS5ub3QudG9IYXZlQmVlbkNhbGxlZCgpO1xuXG4gICAgbGV0IGlzQ2xvc2VkO1xuICAgIHNwZWN0YXRvci5zZXJ2aWNlLmlzQ2xvc2VkJC5zdWJzY3JpYmUoKHZhbHVlKSA9PiBpc0Nsb3NlZCA9IHZhbHVlKTtcbiAgICBleHBlY3QoaXNDbG9zZWQpLnRvQmUoZmFsc2UpO1xuXG4gICAgZGlzY2FyZFBlcmlvZGljVGFza3MoKTtcbiAgfSkpO1xufSk7XG4iXSwidmVyc2lvbiI6M30=