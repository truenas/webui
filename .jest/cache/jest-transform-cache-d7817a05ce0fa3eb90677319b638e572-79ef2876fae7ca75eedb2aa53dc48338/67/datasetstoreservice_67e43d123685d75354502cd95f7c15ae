06870d55427413e75029a36fb2a5df5d
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.DatasetTreeStore = void 0;
const core_1 = require("@angular/core");
const component_store_1 = require("@ngrx/component-store");
const rxjs_1 = require("rxjs");
const operators_1 = require("rxjs/operators");
const get_tree_branch_to_node_utils_1 = require("app/pages/datasets/utils/get-tree-branch-to-node.utils");
const ws_service_1 = require("app/services/ws.service");
const initialState = {
    isLoading: false,
    error: null,
    datasets: [],
    selectedDatasetId: null,
};
let DatasetTreeStore = class DatasetTreeStore extends component_store_1.ComponentStore {
    constructor(ws) {
        super(initialState);
        this.ws = ws;
        this.isLoading$ = this.select((state) => state.isLoading);
        this.error$ = this.select((state) => state.error);
        this.datasets$ = this.select((state) => state.datasets);
        this.selectedBranch$ = this.select((state) => {
            if (!state.selectedDatasetId) {
                return null;
            }
            const selectedBranch = (0, get_tree_branch_to_node_utils_1.getTreeBranchToNode)(state.datasets, (dataset) => dataset.id === state.selectedDatasetId);
            if (!selectedBranch) {
                return null;
            }
            return selectedBranch;
        });
        this.selectedDataset$ = this.select(this.selectedBranch$, (selectedBranch) => (selectedBranch ? selectedBranch[selectedBranch.length - 1] : null));
        this.selectedParentDataset$ = this.select(this.selectedBranch$, (selectedBranch) => (selectedBranch ? selectedBranch[selectedBranch.length - 2] : null));
        this.loadDatasets = this.effect((triggers$) => {
            return triggers$.pipe((0, operators_1.tap)(() => {
                // Not clearing the state on reload on purpose.
                this.patchState({
                    error: null,
                    isLoading: true,
                });
            }), (0, operators_1.switchMap)(() => {
                return this.ws.call('pool.dataset.details')
                    .pipe((0, operators_1.tap)((datasets) => {
                    this.patchState({
                        isLoading: false,
                        datasets,
                    });
                }), (0, operators_1.catchError)((error) => {
                    this.patchState({
                        isLoading: false,
                        error,
                    });
                    return rxjs_1.EMPTY;
                }));
            }));
        });
        this.resetDatasets = this.effect((triggers$) => {
            return triggers$.pipe((0, operators_1.tap)(() => {
                this.patchState({
                    isLoading: false,
                    selectedDatasetId: null,
                    datasets: [],
                });
            }));
        });
        this.datasetUpdated = this.effect((triggers$) => {
            return triggers$.pipe((0, operators_1.tap)(() => this.loadDatasets()));
        });
        this.selectDatasetById = this.updater((state, selectedDatasetId) => {
            return Object.assign(Object.assign({}, state), { selectedDatasetId });
        });
    }
};
exports.DatasetTreeStore = DatasetTreeStore;
DatasetTreeStore.ctorParameters = () => [
    { type: ws_service_1.WebSocketService }
];
exports.DatasetTreeStore = DatasetTreeStore = __decorate([
    (0, core_1.Injectable)({
        providedIn: 'root',
    })
], DatasetTreeStore);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21hY2Jvb2sva2FycG92LXdvcmsvVHJ1ZU5BUy93ZWJ1aS9zcmMvYXBwL3BhZ2VzL2RhdGFzZXRzL3N0b3JlL2RhdGFzZXQtc3RvcmUuc2VydmljZS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBQSx3Q0FBMkM7QUFDM0MsMkRBQXVEO0FBQ3ZELCtCQUF5QztBQUN6Qyw4Q0FFd0I7QUFHeEIsMEdBQTZGO0FBQzdGLHdEQUEyRDtBQVMzRCxNQUFNLFlBQVksR0FBcUI7SUFDckMsU0FBUyxFQUFFLEtBQUs7SUFDaEIsS0FBSyxFQUFFLElBQUk7SUFDWCxRQUFRLEVBQUUsRUFBRTtJQUNaLGlCQUFpQixFQUFFLElBQUk7Q0FDeEIsQ0FBQztBQUtLLElBQU0sZ0JBQWdCLEdBQXRCLE1BQU0sZ0JBQWlCLFNBQVEsZ0NBQWdDO0lBbUZwRSxZQUNVLEVBQW9CO1FBRTVCLEtBQUssQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUZaLE9BQUUsR0FBRixFQUFFLENBQWtCO1FBbkZyQixlQUFVLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3JELFdBQU0sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDN0MsY0FBUyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUNuRCxvQkFBZSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRTtZQUMvQyxJQUFJLENBQUMsS0FBSyxDQUFDLGlCQUFpQixFQUFFLENBQUM7Z0JBQzdCLE9BQU8sSUFBSSxDQUFDO1lBQ2QsQ0FBQztZQUVELE1BQU0sY0FBYyxHQUFHLElBQUEsbURBQW1CLEVBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRSxDQUFDLE9BQU8s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QWhCLGdCQUFnQjtJQUg1QixJQUFBLGlCQUFVLEVBQUM7UUFDVixVQUFVLEVBQUUsTUFBTTtLQUNuQixDQUFDO0dBQ1csZ0JBQWdCLENBd0Y1QiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvbWFjYm9vay9rYXJwb3Ytd29yay9UcnVlTkFTL3dlYnVpL3NyYy9hcHAvcGFnZXMvZGF0YXNldHMvc3RvcmUvZGF0YXNldC1zdG9yZS5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IENvbXBvbmVudFN0b3JlIH0gZnJvbSAnQG5ncngvY29tcG9uZW50LXN0b3JlJztcbmltcG9ydCB7IEVNUFRZLCBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQge1xuICBjYXRjaEVycm9yLCBzd2l0Y2hNYXAsIHRhcCxcbn0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgRGF0YXNldERldGFpbHMgfSBmcm9tICdhcHAvaW50ZXJmYWNlcy9kYXRhc2V0LmludGVyZmFjZSc7XG5pbXBvcnQgeyBXZWJTb2NrZXRFcnJvciB9IGZyb20gJ2FwcC9pbnRlcmZhY2VzL3dlYnNvY2tldC1lcnJvci5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgZ2V0VHJlZUJyYW5jaFRvTm9kZSB9IGZyb20gJ2FwcC9wYWdlcy9kYXRhc2V0cy91dGlscy9nZXQtdHJlZS1icmFuY2gtdG8tbm9kZS51dGlscyc7XG5pbXBvcnQgeyBXZWJTb2NrZXRTZXJ2aWNlIH0gZnJvbSAnYXBwL3NlcnZpY2VzL3dzLnNlcnZpY2UnO1xuXG5leHBvcnQgaW50ZXJmYWNlIERhdGFzZXRUcmVlU3RhdGUge1xuICBpc0xvYWRpbmc6IGJvb2xlYW47XG4gIGVycm9yOiBXZWJTb2NrZXRFcnJvciB8IG51bGw7XG4gIGRhdGFzZXRzOiBEYXRhc2V0RGV0YWlsc1tdO1xuICBzZWxlY3RlZERhdGFzZXRJZDogc3RyaW5nIHwgbnVsbDtcbn1cblxuY29uc3QgaW5pdGlhbFN0YXRlOiBEYXRhc2V0VHJlZVN0YXRlID0ge1xuICBpc0xvYWRpbmc6IGZhbHNlLFxuICBlcnJvcjogbnVsbCxcbiAgZGF0YXNldHM6IFtdLFxuICBzZWxlY3RlZERhdGFzZXRJZDogbnVsbCxcbn07XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnLFxufSlcbmV4cG9ydCBjbGFzcyBEYXRhc2V0VHJlZVN0b3JlIGV4dGVuZHMgQ29tcG9uZW50U3RvcmU8RGF0YXNldFRyZWVTdGF0ZT4ge1xuICByZWFkb25seSBpc0xvYWRpbmckID0gdGhpcy5zZWxlY3QoKHN0YXRlKSA9PiBzdGF0ZS5pc0xvYWRpbmcpO1xuICByZWFkb25seSBlcnJvciQgPSB0aGlzLnNlbGVjdCgoc3RhdGUpID0+IHN0YXRlLmVycm9yKTtcbiAgcmVhZG9ubHkgZGF0YXNldHMkID0gdGhpcy5zZWxlY3QoKHN0YXRlKSA9PiBzdGF0ZS5kYXRhc2V0cyk7XG4gIHJlYWRvbmx5IHNlbGVjdGVkQnJhbmNoJCA9IHRoaXMuc2VsZWN0KChzdGF0ZSkgPT4ge1xuICAgIGlmICghc3RhdGUuc2VsZWN0ZWREYXRhc2V0SWQpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIGNvbnN0IHNlbGVjdGVkQnJhbmNoID0gZ2V0VHJlZUJyYW5jaFRvTm9kZShzdGF0ZS5kYXRhc2V0cywgKGRhdGFzZXQpID0+IGRhdGFzZXQuaWQgPT09IHN0YXRlLnNlbGVjdGVkRGF0YXNldElkKTtcbiAgICBpZiAoIXNlbGVjdGVkQnJhbmNoKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICByZXR1cm4gc2VsZWN0ZWRCcmFuY2g7XG4gIH0pO1xuXG4gIHJlYWRvbmx5IHNlbGVjdGVkRGF0YXNldCQgPSB0aGlzLnNlbGVjdChcbiAgICB0aGlzLnNlbGVjdGVkQnJhbmNoJCxcbiAgICAoc2VsZWN0ZWRCcmFuY2gpID0+IChzZWxlY3RlZEJyYW5jaCA/IHNlbGVjdGVkQnJhbmNoW3NlbGVjdGVkQnJhbmNoLmxlbmd0aCAtIDFdIDogbnVsbCksXG4gICk7XG5cbiAgcmVhZG9ubHkgc2VsZWN0ZWRQYXJlbnREYXRhc2V0JCA9IHRoaXMuc2VsZWN0KFxuICAgIHRoaXMuc2VsZWN0ZWRCcmFuY2gkLFxuICAgIChzZWxlY3RlZEJyYW5jaCkgPT4gKHNlbGVjdGVkQnJhbmNoID8gc2VsZWN0ZWRCcmFuY2hbc2VsZWN0ZWRCcmFuY2gubGVuZ3RoIC0gMl0gOiBudWxsKSxcbiAgKTtcblxuICByZWFkb25seSBsb2FkRGF0YXNldHMgPSB0aGlzLmVmZmVjdCgodHJpZ2dlcnMkOiBPYnNlcnZhYmxlPHZvaWQ+KSA9PiB7XG4gICAgcmV0dXJuIHRyaWdnZXJzJC5waXBlKFxuICAgICAgdGFwKCgpID0+IHtcbiAgICAgICAgLy8gTm90IGNsZWFyaW5nIHRoZSBzdGF0ZSBvbiByZWxvYWQgb24gcHVycG9zZS5cbiAgICAgICAgdGhpcy5wYXRjaFN0YXRlKHtcbiAgICAgICAgICBlcnJvcjogbnVsbCxcbiAgICAgICAgICBpc0xvYWRpbmc6IHRydWUsXG4gICAgICAgIH0pO1xuICAgICAgfSksXG4gICAgICBzd2l0Y2hNYXAoKCkgPT4ge1xuICAgICAgICByZXR1cm4gdGhpcy53cy5jYWxsKCdwb29sLmRhdGFzZXQuZGV0YWlscycpXG4gICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICB0YXAoKGRhdGFzZXRzOiBEYXRhc2V0RGV0YWlsc1tdKSA9PiB7XG4gICAgICAgICAgICAgIHRoaXMucGF0Y2hTdGF0ZSh7XG4gICAgICAgICAgICAgICAgaXNMb2FkaW5nOiBmYWxzZSxcbiAgICAgICAgICAgICAgICBkYXRhc2V0cyxcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycm9yOiBXZWJTb2NrZXRFcnJvcikgPT4ge1xuICAgICAgICAgICAgICB0aGlzLnBhdGNoU3RhdGUoe1xuICAgICAgICAgICAgICAgIGlzTG9hZGluZzogZmFsc2UsXG4gICAgICAgICAgICAgICAgZXJyb3IsXG4gICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgIHJldHVybiBFTVBUWTtcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgICk7XG4gICAgICB9KSxcbiAgICApO1xuICB9KTtcblxuICByZWFkb25seSByZXNldERhdGFzZXRzID0gdGhpcy5lZmZlY3QoKHRyaWdnZXJzJDogT2JzZXJ2YWJsZTx2b2lkPikgPT4ge1xuICAgIHJldHVybiB0cmlnZ2VycyQucGlwZShcbiAgICAgIHRhcCgoKSA9PiB7XG4gICAgICAgIHRoaXMucGF0Y2hTdGF0ZSh7XG4gICAgICAgICAgaXNMb2FkaW5nOiBmYWxzZSxcbiAgICAgICAgICBzZWxlY3RlZERhdGFzZXRJZDogbnVsbCxcbiAgICAgICAgICBkYXRhc2V0czogW10sXG4gICAgICAgIH0pO1xuICAgICAgfSksXG4gICAgKTtcbiAgfSk7XG5cbiAgcmVhZG9ubHkgZGF0YXNldFVwZGF0ZWQgPSB0aGlzLmVmZmVjdCgodHJpZ2dlcnMkOiBPYnNlcnZhYmxlPHZvaWQ+KSA9PiB7XG4gICAgcmV0dXJuIHRyaWdnZXJzJC5waXBlKFxuICAgICAgdGFwKCgpID0+IHRoaXMubG9hZERhdGFzZXRzKCkpLFxuICAgICk7XG4gIH0pO1xuXG4gIHJlYWRvbmx5IHNlbGVjdERhdGFzZXRCeUlkID0gdGhpcy51cGRhdGVyKChzdGF0ZSwgc2VsZWN0ZWREYXRhc2V0SWQ6IHN0cmluZykgPT4ge1xuICAgIHJldHVybiB7XG4gICAgICAuLi5zdGF0ZSxcbiAgICAgIHNlbGVjdGVkRGF0YXNldElkLFxuICAgIH07XG4gIH0pO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgd3M6IFdlYlNvY2tldFNlcnZpY2UsXG4gICkge1xuICAgIHN1cGVyKGluaXRpYWxTdGF0ZSk7XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==