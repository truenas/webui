fe5ac491f33b927b8a10ea62936680ed
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.EncryptionSectionComponent = void 0;
const core_1 = require("@angular/core");
const forms_1 = require("@angular/forms");
const ngx_translate_extract_marker_1 = require("@biesbjerg/ngx-translate-extract-marker");
const until_destroy_1 = require("@ngneat/until-destroy");
const core_2 = require("@ngx-translate/core");
const rxjs_1 = require("rxjs");
const dataset_enum_1 = require("app/enums/dataset.enum");
const encryption_key_format_enum_1 = require("app/enums/encryption-key-format.enum");
const options_operators_1 = require("app/helpers/operators/options.operators");
const dataset_form_1 = require("app/helptext/storage/volumes/datasets/dataset-form");
const password_validation_1 = require("app/modules/forms/ix-forms/validators/password-validation/password-validation");
const ws_service_1 = require("app/services/ws.service");
const i0 = __importStar(require("@angular/core"));
let EncryptionSectionComponent = class EncryptionSectionComponent {
    get inheritEncryptionLabel() {
        return this.parent.encrypted
            ? this.translate.instant('Inherit (encrypted)')
            : this.translate.instant('Inherit (non-encrypted)');
    }
    constructor(formBuilder, translate, ws) {
        this.formBuilder = formBuilder;
        this.translate = translate;
        this.ws = ws;
        this.formValidityChange = (0, core_1.output)();
        // TODO: Add conditional validators
        this.form = this.formBuilder.group({
            inherit_encryption: [true],
            encryption: [true],
            encryption_type: [dataset_enum_1.DatasetEncryptionType.Default],
            generate_key: [true],
            key: ['', [forms_1.Validators.minLength(64), forms_1.Validators.maxLength(64)]],
            passphrase: ['', forms_1.Validators.minLength(8)],
            confirm_passphrase: [''],
            pbkdf2iters: [350000, forms_1.Validators.min(100000)],
            algorithm: ['AES-256-GCM'],
        }, {
            validators: [
                (0, password_validation_1.matchOthersFgValidator)('confirm_passphrase', ['passphrase'], this.translate.instant('Confirm Passphrase value must match Passphrase')),
            ],
        });
        this.helptext = dataset_form_1.helptextDatasetForm;
        this.encryptionTypeOptions$ = (0, rxjs_1.of)([
            { label: (0, ngx_translate_extract_marker_1.marker)('Key'), value: dataset_enum_1.DatasetEncryptionType.Default },
            { label: (0, ngx_translate_extract_marker_1.marker)('Passphrase'), value: dataset_enum_1.DatasetEncryptionType.Passphrase },
        ]);
        this.algorithmOptions$ = this.ws.call('pool.dataset.encryption_algorithm_choices').pipe((0, options_operators_1.choicesToOptions)());
    }
    get hasEncryption() {
        return this.form.controls.encryption.value;
    }
    get isInheritingEncryption() {
        return this.form.controls.inherit_encryption.value;
    }
    get isPassphrase() {
        return this.form.controls.encryption_type.value === dataset_enum_1.DatasetEncryptionType.Passphrase;
    }
    get parentHasPassphrase() {
        return this.parent
            && this.parent.encrypted
            && this.parent.key_format.value === encryption_key_format_enum_1.EncryptionKeyFormat.Passphrase;
    }
    ngOnChanges() {
        if (this.parent) {
            this.setInheritValues();
            this.disableEncryptionIfParentEncrypted();
        }
    }
    ngOnInit() {
        this.form.statusChanges.pipe((0, until_destroy_1.untilDestroyed)(this)).subscribe((status) => {
            this.formValidityChange.emit(status === 'VALID');
        });
    }
    getPayload() {
        if (this.isInheritingEncryption) {
            return {};
        }
        if (!this.hasEncryption) {
            return { encryption: false };
        }
        const values = this.form.value;
        const encryptionOptions = {
            algorithm: values.algorithm,
        };
        if (this.isPassphrase) {
            encryptionOptions.pbkdf2iters = values.pbkdf2iters;
            encryptionOptions.passphrase = values.passphrase;
        }
        else if (values.generate_key) {
            encryptionOptions.generate_key = true;
        }
        else {
            encryptionOptions.key = values.key;
        }
        return {
            encryption: true,
            encryption_options: encryptionOptions,
            inherit_encryption: false,
        };
    }
    setInheritValues() {
        var _a;
        if (this.parentHasPassphrase) {
            this.form.controls.encryption_type.setValue(dataset_enum_1.DatasetEncryptionType.Passphrase);
        }
        if (this.parent.encrypted && ((_a = this.parent.encryption_algorithm) === null || _a === void 0 ? void 0 : _a.value)) {
            this.form.controls.algorithm.setValue(this.parent.encryption_algorithm.value);
        }
    }
    disableEncryptionIfParentEncrypted() {
        var _a;
        if (!((_a = this.parent) === null || _a === void 0 ? void 0 : _a.encrypted)) {
            return;
        }
        this.form.controls.encryption.disable();
    }
};
exports.EncryptionSectionComponent = EncryptionSectionComponent;
EncryptionSectionComponent.ctorParameters = () => [
    { type: forms_1.FormBuilder },
    { type: core_2.TranslateService },
    { type: ws_service_1.WebSocketService }
];
EncryptionSectionComponent.propDecorators = {
    parent: [{ type: core_1.Input }],
    advancedMode: [{ type: core_1.Input }],
    formValidityChange: [{ type: i0.Output, args: ["formValidityChange",] }]
};
exports.EncryptionSectionComponent = EncryptionSectionComponent = __decorate([
    (0, until_destroy_1.UntilDestroy)(),
    (0, core_1.Component)({
        selector: 'ix-encryption-section',
        template: require("./encryption-section.component.html"),
        changeDetection: core_1.ChangeDetectionStrategy.OnPush,
    })
], EncryptionSectionComponent);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21hY2Jvb2sva2FycG92LXdvcmsvVHJ1ZU5BUy93ZWJ1aS9zcmMvYXBwL3BhZ2VzL2RhdGFzZXRzL2NvbXBvbmVudHMvZGF0YXNldC1mb3JtL3NlY3Rpb25zL2VuY3J5cHRpb24tc2VjdGlvbi9lbmNyeXB0aW9uLXNlY3Rpb24uY29tcG9uZW50LnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsd0NBRXVCO0FBQ3ZCLDBDQUF5RDtBQUN6RCwwRkFBc0U7QUFDdEUseURBQXFFO0FBQ3JFLDhDQUF1RDtBQUN2RCwrQkFBMEI7QUFDMUIseURBQStEO0FBQy9ELHFGQUEyRTtBQUMzRSwrRUFBMkU7QUFDM0UscUZBQXlGO0FBRXpGLHVIQUF1SDtBQUN2SCx3REFBMkQ7O0FBUXBELElBQU0sMEJBQTBCLEdBQWhDLE1BQU0sMEJBQTBCO0lBTXJDLElBQUksc0JBQXNCO1FBQ3hCLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTO1lBQzFCLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxxQkFBcUIsQ0FBQztZQUMvQyxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMseUJBQXlCLENBQUMsQ0FBQztJQUN4RCxDQUFDO0lBK0JELFlBQ1UsV0FBd0IsRUFDeEIsU0FBMkIsRUFDM0IsRUFBb0I7UUFGcEIsZ0JBQVcsR0FBWCxXQUFXLENBQWE7UUFDeEIsY0FBUyxHQUFULFNBQVMsQ0FBa0I7UUFDM0IsT0FBRSxHQUFGLEVBQUUsQ0FBa0I7UUF4Q3JCLHVCQUFrQixHQUFHLElBQUEsYUFBTSxHQUFXO1FBUS9DLG1DQUFtQztRQUMxQixTQUFJLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUM7WUFDckMsa0JBQWtCLEVBQUUsQ0FBQyxJQUFJLENBQUM7WUFDMUIsVUFBVSxFQUFFLENBQUMsSUFBSSxDQUFDO1lBQ2xCLGVBQWUsRUFBRSxDQUFDLG9DQUFxQixDQUFDLE9BQU8sQ0FB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SUFBSSxDQUFDLENBQUEsTUFBQSxJQUFJLENBQUMsTUFBTSwwQ0FBRSxTQUFTLENBQUEsRUFBRSxDQUFDO1lBQzVCLE9BQU87UUFDVCxDQUFDO1FBQ0QsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQzFDLENBQUM7O0FBM0hVLGdFQUEwQjs7Ozs7OztxQkFDcEMsWUFBSzsyQkFDTCxZQUFLOzs7cUNBRkssMEJBQTBCO0lBTnRDLElBQUEsNEJBQVksR0FBRTtJQUNkLElBQUEsZ0JBQVMsRUFBQztRQUNULFFBQVEsRUFBRSx1QkFBdUI7UUFDakMsd0RBQWtEO1FBQ2xELGVBQWUsRUFBRSw4QkFBdUIsQ0FBQyxNQUFNO0tBQ2hELENBQUM7R0FDVywwQkFBMEIsQ0E0SHRDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9tYWNib29rL2thcnBvdi13b3JrL1RydWVOQVMvd2VidWkvc3JjL2FwcC9wYWdlcy9kYXRhc2V0cy9jb21wb25lbnRzL2RhdGFzZXQtZm9ybS9zZWN0aW9ucy9lbmNyeXB0aW9uLXNlY3Rpb24vZW5jcnlwdGlvbi1zZWN0aW9uLmNvbXBvbmVudC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneSwgQ29tcG9uZW50LCBJbnB1dCwgT25DaGFuZ2VzLCBPbkluaXQsIG91dHB1dCxcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBGb3JtQnVpbGRlciwgVmFsaWRhdG9ycyB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7IG1hcmtlciBhcyBUIH0gZnJvbSAnQGJpZXNiamVyZy9uZ3gtdHJhbnNsYXRlLWV4dHJhY3QtbWFya2VyJztcbmltcG9ydCB7IFVudGlsRGVzdHJveSwgdW50aWxEZXN0cm95ZWQgfSBmcm9tICdAbmduZWF0L3VudGlsLWRlc3Ryb3knO1xuaW1wb3J0IHsgVHJhbnNsYXRlU2VydmljZSB9IGZyb20gJ0BuZ3gtdHJhbnNsYXRlL2NvcmUnO1xuaW1wb3J0IHsgb2YgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IERhdGFzZXRFbmNyeXB0aW9uVHlwZSB9IGZyb20gJ2FwcC9lbnVtcy9kYXRhc2V0LmVudW0nO1xuaW1wb3J0IHsgRW5jcnlwdGlvbktleUZvcm1hdCB9IGZyb20gJ2FwcC9lbnVtcy9lbmNyeXB0aW9uLWtleS1mb3JtYXQuZW51bSc7XG5pbXBvcnQgeyBjaG9pY2VzVG9PcHRpb25zIH0gZnJvbSAnYXBwL2hlbHBlcnMvb3BlcmF0b3JzL29wdGlvbnMub3BlcmF0b3JzJztcbmltcG9ydCB7IGhlbHB0ZXh0RGF0YXNldEZvcm0gfSBmcm9tICdhcHAvaGVscHRleHQvc3RvcmFnZS92b2x1bWVzL2RhdGFzZXRzL2RhdGFzZXQtZm9ybSc7XG5pbXBvcnQgeyBEYXRhc2V0LCBEYXRhc2V0Q3JlYXRlIH0gZnJvbSAnYXBwL2ludGVyZmFjZXMvZGF0YXNldC5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgbWF0Y2hPdGhlcnNGZ1ZhbGlkYXRvciB9IGZyb20gJ2FwcC9tb2R1bGVzL2Zvcm1zL2l4LWZvcm1zL3ZhbGlkYXRvcnMvcGFzc3dvcmQtdmFsaWRhdGlvbi9wYXNzd29yZC12YWxpZGF0aW9uJztcbmltcG9ydCB7IFdlYlNvY2tldFNlcnZpY2UgfSBmcm9tICdhcHAvc2VydmljZXMvd3Muc2VydmljZSc7XG5cbkBVbnRpbERlc3Ryb3koKVxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnaXgtZW5jcnlwdGlvbi1zZWN0aW9uJyxcbiAgdGVtcGxhdGVVcmw6ICcuL2VuY3J5cHRpb24tc2VjdGlvbi5jb21wb25lbnQuaHRtbCcsXG4gIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoLFxufSlcbmV4cG9ydCBjbGFzcyBFbmNyeXB0aW9uU2VjdGlvbkNvbXBvbmVudCBpbXBsZW1lbnRzIE9uQ2hhbmdlcywgT25Jbml0IHtcbiAgQElucHV0KCkgcGFyZW50OiBEYXRhc2V0O1xuICBASW5wdXQoKSBhZHZhbmNlZE1vZGU6IGJvb2xlYW47XG5cbiAgcmVhZG9ubHkgZm9ybVZhbGlkaXR5Q2hhbmdlID0gb3V0cHV0PGJvb2xlYW4+KCk7XG5cbiAgZ2V0IGluaGVyaXRFbmNyeXB0aW9uTGFiZWwoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5wYXJlbnQuZW5jcnlwdGVkXG4gICAgICA/IHRoaXMudHJhbnNsYXRlLmluc3RhbnQoJ0luaGVyaXQgKGVuY3J5cHRlZCknKVxuICAgICAgOiB0aGlzLnRyYW5zbGF0ZS5pbnN0YW50KCdJbmhlcml0IChub24tZW5jcnlwdGVkKScpO1xuICB9XG5cbiAgLy8gVE9ETzogQWRkIGNvbmRpdGlvbmFsIHZhbGlkYXRvcnNcbiAgcmVhZG9ubHkgZm9ybSA9IHRoaXMuZm9ybUJ1aWxkZXIuZ3JvdXAoe1xuICAgIGluaGVyaXRfZW5jcnlwdGlvbjogW3RydWVdLFxuICAgIGVuY3J5cHRpb246IFt0cnVlXSxcbiAgICBlbmNyeXB0aW9uX3R5cGU6IFtEYXRhc2V0RW5jcnlwdGlvblR5cGUuRGVmYXVsdF0sXG4gICAgZ2VuZXJhdGVfa2V5OiBbdHJ1ZV0sXG4gICAga2V5OiBbJycsIFtWYWxpZGF0b3JzLm1pbkxlbmd0aCg2NCksIFZhbGlkYXRvcnMubWF4TGVuZ3RoKDY0KV1dLFxuICAgIHBhc3NwaHJhc2U6IFsnJywgVmFsaWRhdG9ycy5taW5MZW5ndGgoOCldLFxuICAgIGNvbmZpcm1fcGFzc3BocmFzZTogWycnXSxcbiAgICBwYmtkZjJpdGVyczogWzM1MDAwMCwgVmFsaWRhdG9ycy5taW4oMTAwMDAwKV0sXG4gICAgYWxnb3JpdGhtOiBbJ0FFUy0yNTYtR0NNJ10sXG4gIH0sIHtcbiAgICB2YWxpZGF0b3JzOiBbXG4gICAgICBtYXRjaE90aGVyc0ZnVmFsaWRhdG9yKFxuICAgICAgICAnY29uZmlybV9wYXNzcGhyYXNlJyxcbiAgICAgICAgWydwYXNzcGhyYXNlJ10sXG4gICAgICAgIHRoaXMudHJhbnNsYXRlLmluc3RhbnQoJ0NvbmZpcm0gUGFzc3BocmFzZSB2YWx1ZSBtdXN0IG1hdGNoIFBhc3NwaHJhc2UnKSxcbiAgICAgICksXG4gICAgXSxcbiAgfSk7XG5cbiAgcmVhZG9ubHkgaGVscHRleHQgPSBoZWxwdGV4dERhdGFzZXRGb3JtO1xuXG4gIGVuY3J5cHRpb25UeXBlT3B0aW9ucyQgPSBvZihbXG4gICAgeyBsYWJlbDogVCgnS2V5JyksIHZhbHVlOiBEYXRhc2V0RW5jcnlwdGlvblR5cGUuRGVmYXVsdCB9LFxuICAgIHsgbGFiZWw6IFQoJ1Bhc3NwaHJhc2UnKSwgdmFsdWU6IERhdGFzZXRFbmNyeXB0aW9uVHlwZS5QYXNzcGhyYXNlIH0sXG4gIF0pO1xuICBhbGdvcml0aG1PcHRpb25zJCA9IHRoaXMud3MuY2FsbCgncG9vbC5kYXRhc2V0LmVuY3J5cHRpb25fYWxnb3JpdGhtX2Nob2ljZXMnKS5waXBlKGNob2ljZXNUb09wdGlvbnMoKSk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBmb3JtQnVpbGRlcjogRm9ybUJ1aWxkZXIsXG4gICAgcHJpdmF0ZSB0cmFuc2xhdGU6IFRyYW5zbGF0ZVNlcnZpY2UsXG4gICAgcHJpdmF0ZSB3czogV2ViU29ja2V0U2VydmljZSxcbiAgKSB7fVxuXG4gIGdldCBoYXNFbmNyeXB0aW9uKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmZvcm0uY29udHJvbHMuZW5jcnlwdGlvbi52YWx1ZTtcbiAgfVxuXG4gIGdldCBpc0luaGVyaXRpbmdFbmNyeXB0aW9uKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmZvcm0uY29udHJvbHMuaW5oZXJpdF9lbmNyeXB0aW9uLnZhbHVlO1xuICB9XG5cbiAgZ2V0IGlzUGFzc3BocmFzZSgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5mb3JtLmNvbnRyb2xzLmVuY3J5cHRpb25fdHlwZS52YWx1ZSA9PT0gRGF0YXNldEVuY3J5cHRpb25UeXBlLlBhc3NwaHJhc2U7XG4gIH1cblxuICBnZXQgcGFyZW50SGFzUGFzc3BocmFzZSgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5wYXJlbnRcbiAgICAgICYmIHRoaXMucGFyZW50LmVuY3J5cHRlZFxuICAgICAgJiYgdGhpcy5wYXJlbnQua2V5X2Zvcm1hdC52YWx1ZSA9PT0gRW5jcnlwdGlvbktleUZvcm1hdC5QYXNzcGhyYXNlO1xuICB9XG5cbiAgbmdPbkNoYW5nZXMoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMucGFyZW50KSB7XG4gICAgICB0aGlzLnNldEluaGVyaXRWYWx1ZXMoKTtcbiAgICAgIHRoaXMuZGlzYWJsZUVuY3J5cHRpb25JZlBhcmVudEVuY3J5cHRlZCgpO1xuICAgIH1cbiAgfVxuXG4gIG5nT25Jbml0KCk6IHZvaWQge1xuICAgIHRoaXMuZm9ybS5zdGF0dXNDaGFuZ2VzLnBpcGUodW50aWxEZXN0cm95ZWQodGhpcykpLnN1YnNjcmliZSgoc3RhdHVzKSA9PiB7XG4gICAgICB0aGlzLmZvcm1WYWxpZGl0eUNoYW5nZS5lbWl0KHN0YXR1cyA9PT0gJ1ZBTElEJyk7XG4gICAgfSk7XG4gIH1cblxuICBnZXRQYXlsb2FkKCk6IFBhcnRpYWw8RGF0YXNldENyZWF0ZT4ge1xuICAgIGlmICh0aGlzLmlzSW5oZXJpdGluZ0VuY3J5cHRpb24pIHtcbiAgICAgIHJldHVybiB7fTtcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMuaGFzRW5jcnlwdGlvbikge1xuICAgICAgcmV0dXJuIHsgZW5jcnlwdGlvbjogZmFsc2UgfTtcbiAgICB9XG5cbiAgICBjb25zdCB2YWx1ZXMgPSB0aGlzLmZvcm0udmFsdWU7XG4gICAgY29uc3QgZW5jcnlwdGlvbk9wdGlvbnM6IERhdGFzZXRDcmVhdGVbJ2VuY3J5cHRpb25fb3B0aW9ucyddID0ge1xuICAgICAgYWxnb3JpdGhtOiB2YWx1ZXMuYWxnb3JpdGhtLFxuICAgIH07XG5cbiAgICBpZiAodGhpcy5pc1Bhc3NwaHJhc2UpIHtcbiAgICAgIGVuY3J5cHRpb25PcHRpb25zLnBia2RmMml0ZXJzID0gdmFsdWVzLnBia2RmMml0ZXJzO1xuICAgICAgZW5jcnlwdGlvbk9wdGlvbnMucGFzc3BocmFzZSA9IHZhbHVlcy5wYXNzcGhyYXNlO1xuICAgIH0gZWxzZSBpZiAodmFsdWVzLmdlbmVyYXRlX2tleSkge1xuICAgICAgZW5jcnlwdGlvbk9wdGlvbnMuZ2VuZXJhdGVfa2V5ID0gdHJ1ZTtcbiAgICB9IGVsc2Uge1xuICAgICAgZW5jcnlwdGlvbk9wdGlvbnMua2V5ID0gdmFsdWVzLmtleTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgZW5jcnlwdGlvbjogdHJ1ZSxcbiAgICAgIGVuY3J5cHRpb25fb3B0aW9uczogZW5jcnlwdGlvbk9wdGlvbnMsXG4gICAgICBpbmhlcml0X2VuY3J5cHRpb246IGZhbHNlLFxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIHNldEluaGVyaXRWYWx1ZXMoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMucGFyZW50SGFzUGFzc3BocmFzZSkge1xuICAgICAgdGhpcy5mb3JtLmNvbnRyb2xzLmVuY3J5cHRpb25fdHlwZS5zZXRWYWx1ZShEYXRhc2V0RW5jcnlwdGlvblR5cGUuUGFzc3BocmFzZSk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMucGFyZW50LmVuY3J5cHRlZCAmJiB0aGlzLnBhcmVudC5lbmNyeXB0aW9uX2FsZ29yaXRobT8udmFsdWUpIHtcbiAgICAgIHRoaXMuZm9ybS5jb250cm9scy5hbGdvcml0aG0uc2V0VmFsdWUodGhpcy5wYXJlbnQuZW5jcnlwdGlvbl9hbGdvcml0aG0udmFsdWUpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZGlzYWJsZUVuY3J5cHRpb25JZlBhcmVudEVuY3J5cHRlZCgpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMucGFyZW50Py5lbmNyeXB0ZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5mb3JtLmNvbnRyb2xzLmVuY3J5cHRpb24uZGlzYWJsZSgpO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=