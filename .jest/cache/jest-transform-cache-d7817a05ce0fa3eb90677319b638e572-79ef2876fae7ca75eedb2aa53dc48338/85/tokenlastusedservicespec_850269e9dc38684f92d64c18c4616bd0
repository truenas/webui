1f65dde2e55675f65c904b7f508d5932
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const jest_1 = require("@ngneat/spectator/jest");
const rxjs_1 = require("rxjs");
const time_constant_1 = require("app/constants/time.constant");
const mock_websocket_utils_1 = require("app/core/testing/utils/mock-websocket.utils");
const window_helper_1 = require("app/helpers/window.helper");
const dialog_service_1 = require("app/modules/dialog/dialog.service");
const auth_service_1 = require("app/services/auth/auth.service");
const token_last_used_service_1 = require("app/services/token-last-used.service");
const ws_service_1 = require("app/services/ws.service");
describe('TokenLastUsedService', () => {
    let spectator;
    const mockLocalStorage = {
        getItem: jest.fn(),
        setItem: jest.fn(),
    };
    const createService = (0, jest_1.createServiceFactory)({
        service: token_last_used_service_1.TokenLastUsedService,
        providers: [
            (0, jest_1.mockProvider)(dialog_service_1.DialogService),
            (0, jest_1.mockProvider)(auth_service_1.AuthService, {
                clearAuthToken: jest.fn(),
                logout: jest.fn().mockReturnValue(new rxjs_1.Subject()),
                user$: new rxjs_1.Subject(),
            }),
            (0, mock_websocket_utils_1.mockWebSocket)(),
            {
                provide: window_helper_1.WINDOW,
                useValue: {
                    localStorage: mockLocalStorage,
                    addEventListener: jest.fn(),
                    removeEventListener: jest.fn(),
                },
            },
        ],
    });
    beforeEach(() => {
        spectator = createService();
    });
    describe('isTokenWithinTimeline', () => {
        it('should return false if tokenLastUsed is not set', () => {
            mockLocalStorage.getItem.mockReturnValue(JSON.stringify(null));
            spectator.service.isTokenWithinTimeline$.subscribe((value) => {
                expect(value).toBe(false);
            });
        });
        it('should return true if tokenLastUsed is within 5 minutes', () => {
            const now = new Date();
            const tokenLastUsed = new Date(now.getTime() - 4 * time_constant_1.oneMinuteMillis).toISOString();
            mockLocalStorage.getItem.mockReturnValue(tokenLastUsed);
            spectator.service.isTokenWithinTimeline$.subscribe((value) => {
                expect(value).toBe(true);
            });
        });
        it('should return false if tokenLastUsed is older than 5 minutes', () => {
            const now = new Date();
            const tokenLastUsed = new Date(now.getTime() - 20 * time_constant_1.oneMinuteMillis).toISOString();
            mockLocalStorage.getItem.mockReturnValue(tokenLastUsed);
            spectator.service.isTokenWithinTimeline$.subscribe((value) => {
                expect(value).toBe(false);
            });
        });
    });
    describe('setupTokenLastUsedValue', () => {
        it('should update tokenLastUsed in localStorage on user and WebSocket activity', () => {
            const user$ = spectator.inject(auth_service_1.AuthService).user$;
            const updateTokenLastUsedSpy = jest.spyOn(spectator.service, 'updateTokenLastUsed');
            const ws$ = new rxjs_1.Subject();
            jest.spyOn(spectator.inject(ws_service_1.WebSocketService), 'getWebSocketStream$').mockReturnValue(ws$);
            spectator.service.setupTokenLastUsedValue((0, rxjs_1.of)({}));
            user$.next({});
            expect(updateTokenLastUsedSpy).toHaveBeenCalled();
            ws$.next({});
            expect(updateTokenLastUsedSpy).toHaveBeenCalled();
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21hY2Jvb2sva2FycG92LXdvcmsvVHJ1ZU5BUy93ZWJ1aS9zcmMvYXBwL3NlcnZpY2VzL3Rva2VuLWxhc3QtdXNlZC5zZXJ2aWNlLnNwZWMudHMiLCJtYXBwaW5ncyI6Ijs7QUFBQSxpREFBOEY7QUFDOUYsK0JBQW1DO0FBQ25DLCtEQUE4RDtBQUM5RCxzRkFBNEU7QUFDNUUsNkRBQW1EO0FBRW5ELHNFQUFrRTtBQUNsRSxpRUFBNkQ7QUFDN0Qsa0ZBQTRFO0FBQzVFLHdEQUEyRDtBQUUzRCxRQUFRLENBQUMsc0JBQXNCLEVBQUUsR0FBRyxFQUFFO0lBQ3BDLElBQUksU0FBaUQsQ0FBQztJQUN0RCxNQUFNLGdCQUFnQixHQUFHO1FBQ3ZCLE9BQU8sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1FBQ2xCLE9BQU8sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO0tBQ25CLENBQUM7SUFDRixNQUFNLGFBQWEsR0FBRyxJQUFBLDJCQUFvQixFQUFDO1FBQ3pDLE9BQU8sRUFBRSw4Q0FBb0I7UUFDN0IsU0FBUyxFQUFFO1lBQ1QsSUFBQSxtQkFBWSxFQUFDLDhCQUFhLENBQUM7WUFDM0IsSUFBQSxtQkFBWSxFQUFDLDBCQUFXLEVBQUU7Z0JBQ3hCLGNBQWMsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO2dCQUN6QixNQUFNLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGVBQWUsQ0FBQyxJQUFJLGNBQU8sRUFBRSxDQUFDO2dCQUNoRCxLQUFLLEVBQUUsSUFBSSxjQUFPLEVBQUU7YUFDckIsQ0FBQztZQUNGLElBQUEsb0NBQWEsR0FBRTtZQUNmO2dCQUNFLE9BQU8sRUFBRSxzQkFBTTtnQkFDZixRQUFRLEVBQUU7b0JBQ1IsWUFBWSxFQUFFLGdCQUFnQjtvQkFDOUIsZ0JBQWdCLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtvQkFDM0IsbUJBQW1CLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtpQkFDL0I7YUFDRjtTQUNGO0tBQ0YsQ0FBQyxDQUFDO0lBRUgsVUFBVSxDQUFD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QyxDQUFDLGdCQUFnQixFQUFFLENBQUM7UUFDcEQsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9tYWNib29rL2thcnBvdi13b3JrL1RydWVOQVMvd2VidWkvc3JjL2FwcC9zZXJ2aWNlcy90b2tlbi1sYXN0LXVzZWQuc2VydmljZS5zcGVjLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFNwZWN0YXRvclNlcnZpY2UsIGNyZWF0ZVNlcnZpY2VGYWN0b3J5LCBtb2NrUHJvdmlkZXIgfSBmcm9tICdAbmduZWF0L3NwZWN0YXRvci9qZXN0JztcbmltcG9ydCB7IG9mLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBvbmVNaW51dGVNaWxsaXMgfSBmcm9tICdhcHAvY29uc3RhbnRzL3RpbWUuY29uc3RhbnQnO1xuaW1wb3J0IHsgbW9ja1dlYlNvY2tldCB9IGZyb20gJ2FwcC9jb3JlL3Rlc3RpbmcvdXRpbHMvbW9jay13ZWJzb2NrZXQudXRpbHMnO1xuaW1wb3J0IHsgV0lORE9XIH0gZnJvbSAnYXBwL2hlbHBlcnMvd2luZG93LmhlbHBlcic7XG5pbXBvcnQgeyBMb2dnZWRJblVzZXIgfSBmcm9tICdhcHAvaW50ZXJmYWNlcy9kcy1jYWNoZS5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgRGlhbG9nU2VydmljZSB9IGZyb20gJ2FwcC9tb2R1bGVzL2RpYWxvZy9kaWFsb2cuc2VydmljZSc7XG5pbXBvcnQgeyBBdXRoU2VydmljZSB9IGZyb20gJ2FwcC9zZXJ2aWNlcy9hdXRoL2F1dGguc2VydmljZSc7XG5pbXBvcnQgeyBUb2tlbkxhc3RVc2VkU2VydmljZSB9IGZyb20gJ2FwcC9zZXJ2aWNlcy90b2tlbi1sYXN0LXVzZWQuc2VydmljZSc7XG5pbXBvcnQgeyBXZWJTb2NrZXRTZXJ2aWNlIH0gZnJvbSAnYXBwL3NlcnZpY2VzL3dzLnNlcnZpY2UnO1xuXG5kZXNjcmliZSgnVG9rZW5MYXN0VXNlZFNlcnZpY2UnLCAoKSA9PiB7XG4gIGxldCBzcGVjdGF0b3I6IFNwZWN0YXRvclNlcnZpY2U8VG9rZW5MYXN0VXNlZFNlcnZpY2U+O1xuICBjb25zdCBtb2NrTG9jYWxTdG9yYWdlID0ge1xuICAgIGdldEl0ZW06IGplc3QuZm4oKSxcbiAgICBzZXRJdGVtOiBqZXN0LmZuKCksXG4gIH07XG4gIGNvbnN0IGNyZWF0ZVNlcnZpY2UgPSBjcmVhdGVTZXJ2aWNlRmFjdG9yeSh7XG4gICAgc2VydmljZTogVG9rZW5MYXN0VXNlZFNlcnZpY2UsXG4gICAgcHJvdmlkZXJzOiBbXG4gICAgICBtb2NrUHJvdmlkZXIoRGlhbG9nU2VydmljZSksXG4gICAgICBtb2NrUHJvdmlkZXIoQXV0aFNlcnZpY2UsIHtcbiAgICAgICAgY2xlYXJBdXRoVG9rZW46IGplc3QuZm4oKSxcbiAgICAgICAgbG9nb3V0OiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKG5ldyBTdWJqZWN0KCkpLFxuICAgICAgICB1c2VyJDogbmV3IFN1YmplY3QoKSxcbiAgICAgIH0pLFxuICAgICAgbW9ja1dlYlNvY2tldCgpLFxuICAgICAge1xuICAgICAgICBwcm92aWRlOiBXSU5ET1csXG4gICAgICAgIHVzZVZhbHVlOiB7XG4gICAgICAgICAgbG9jYWxTdG9yYWdlOiBtb2NrTG9jYWxTdG9yYWdlLFxuICAgICAgICAgIGFkZEV2ZW50TGlzdGVuZXI6IGplc3QuZm4oKSxcbiAgICAgICAgICByZW1vdmVFdmVudExpc3RlbmVyOiBqZXN0LmZuKCksXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIF0sXG4gIH0pO1xuXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIHNwZWN0YXRvciA9IGNyZWF0ZVNlcnZpY2UoKTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2lzVG9rZW5XaXRoaW5UaW1lbGluZScsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHJldHVybiBmYWxzZSBpZiB0b2tlbkxhc3RVc2VkIGlzIG5vdCBzZXQnLCAoKSA9PiB7XG4gICAgICBtb2NrTG9jYWxTdG9yYWdlLmdldEl0ZW0ubW9ja1JldHVyblZhbHVlKEpTT04uc3RyaW5naWZ5KG51bGwpKTtcblxuICAgICAgc3BlY3RhdG9yLnNlcnZpY2UuaXNUb2tlbldpdGhpblRpbWVsaW5lJC5zdWJzY3JpYmUoKHZhbHVlKSA9PiB7XG4gICAgICAgIGV4cGVjdCh2YWx1ZSkudG9CZShmYWxzZSk7XG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIHRydWUgaWYgdG9rZW5MYXN0VXNlZCBpcyB3aXRoaW4gNSBtaW51dGVzJywgKCkgPT4ge1xuICAgICAgY29uc3Qgbm93ID0gbmV3IERhdGUoKTtcbiAgICAgIGNvbnN0IHRva2VuTGFzdFVzZWQgPSBuZXcgRGF0ZShub3cuZ2V0VGltZSgpIC0gNCAqIG9uZU1pbnV0ZU1pbGxpcykudG9JU09TdHJpbmcoKTtcbiAgICAgIG1vY2tMb2NhbFN0b3JhZ2UuZ2V0SXRlbS5tb2NrUmV0dXJuVmFsdWUodG9rZW5MYXN0VXNlZCk7XG5cbiAgICAgIHNwZWN0YXRvci5zZXJ2aWNlLmlzVG9rZW5XaXRoaW5UaW1lbGluZSQuc3Vic2NyaWJlKCh2YWx1ZSkgPT4ge1xuICAgICAgICBleHBlY3QodmFsdWUpLnRvQmUodHJ1ZSk7XG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIGZhbHNlIGlmIHRva2VuTGFzdFVzZWQgaXMgb2xkZXIgdGhhbiA1IG1pbnV0ZXMnLCAoKSA9PiB7XG4gICAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpO1xuICAgICAgY29uc3QgdG9rZW5MYXN0VXNlZCA9IG5ldyBEYXRlKG5vdy5nZXRUaW1lKCkgLSAyMCAqIG9uZU1pbnV0ZU1pbGxpcykudG9JU09TdHJpbmcoKTtcbiAgICAgIG1vY2tMb2NhbFN0b3JhZ2UuZ2V0SXRlbS5tb2NrUmV0dXJuVmFsdWUodG9rZW5MYXN0VXNlZCk7XG5cbiAgICAgIHNwZWN0YXRvci5zZXJ2aWNlLmlzVG9rZW5XaXRoaW5UaW1lbGluZSQuc3Vic2NyaWJlKCh2YWx1ZSkgPT4ge1xuICAgICAgICBleHBlY3QodmFsdWUpLnRvQmUoZmFsc2UpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdzZXR1cFRva2VuTGFzdFVzZWRWYWx1ZScsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHVwZGF0ZSB0b2tlbkxhc3RVc2VkIGluIGxvY2FsU3RvcmFnZSBvbiB1c2VyIGFuZCBXZWJTb2NrZXQgYWN0aXZpdHknLCAoKSA9PiB7XG4gICAgICBjb25zdCB1c2VyJCA9IHNwZWN0YXRvci5pbmplY3QoQXV0aFNlcnZpY2UpLnVzZXIkIGFzIFN1YmplY3Q8TG9nZ2VkSW5Vc2VyPjtcbiAgICAgIGNvbnN0IHVwZGF0ZVRva2VuTGFzdFVzZWRTcHkgPSBqZXN0LnNweU9uKHNwZWN0YXRvci5zZXJ2aWNlLCAndXBkYXRlVG9rZW5MYXN0VXNlZCcpO1xuICAgICAgY29uc3Qgd3MkID0gbmV3IFN1YmplY3QoKTtcblxuICAgICAgamVzdC5zcHlPbihzcGVjdGF0b3IuaW5qZWN0KFdlYlNvY2tldFNlcnZpY2UpLCAnZ2V0V2ViU29ja2V0U3RyZWFtJCcpLm1vY2tSZXR1cm5WYWx1ZSh3cyQpO1xuXG4gICAgICBzcGVjdGF0b3Iuc2VydmljZS5zZXR1cFRva2VuTGFzdFVzZWRWYWx1ZShvZih7fSBhcyBMb2dnZWRJblVzZXIpKTtcblxuICAgICAgdXNlciQubmV4dCh7fSBhcyBMb2dnZWRJblVzZXIpO1xuICAgICAgZXhwZWN0KHVwZGF0ZVRva2VuTGFzdFVzZWRTcHkpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcblxuICAgICAgd3MkLm5leHQoe30pO1xuICAgICAgZXhwZWN0KHVwZGF0ZVRva2VuTGFzdFVzZWRTcHkpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdLCJ2ZXJzaW9uIjozfQ==