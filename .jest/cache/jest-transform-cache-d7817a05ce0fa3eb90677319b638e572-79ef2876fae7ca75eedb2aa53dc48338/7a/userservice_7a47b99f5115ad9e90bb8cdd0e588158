affce67f1740034ae7bb4348c9d2ebb4
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.UserService = void 0;
const core_1 = require("@angular/core");
const rxjs_1 = require("rxjs");
const operators_1 = require("rxjs/operators");
const ws_service_1 = require("app/services/ws.service");
let UserService = class UserService {
    constructor(ws) {
        this.ws = ws;
        this.uncachedUserQuery = 'user.get_user_obj';
        this.uncachedGroupQuery = 'group.get_group_obj';
        this.userQuery = 'user.query';
        this.groupQuery = 'group.query';
        this.queryOptions = { limit: 50 };
    }
    groupQueryDsCacheByName(name) {
        if (!(name === null || name === void 0 ? void 0 : name.length)) {
            return (0, rxjs_1.of)([]);
        }
        let queryArgs = [];
        name = name.trim();
        if (name.length > 0) {
            queryArgs = [['name', '=', name]];
        }
        return this.ws.call(this.groupQuery, [queryArgs, Object.assign({}, this.queryOptions)]);
    }
    groupQueryDsCache(search = '', hideBuiltIn = false, offset = 0) {
        let queryArgs = [];
        search = search.trim();
        if (search.length > 0) {
            queryArgs = [['group', '^', search]];
        }
        if (hideBuiltIn) {
            queryArgs = queryArgs.concat([['builtin', '=', false]]);
        }
        return (0, rxjs_1.combineLatest)([
            this.groupQueryDsCacheByName(search),
            this.ws.call(this.groupQuery, [queryArgs, Object.assign(Object.assign({}, this.queryOptions), { offset, order_by: ['builtin'] })]),
        ]).pipe((0, operators_1.map)(([groupSearchedByName, groups]) => {
            const groupIds = groupSearchedByName.map((groupsByName) => groupsByName.id);
            groups = groups.filter((group) => {
                return !groupIds.some((gid) => gid === group.id);
            });
            return [...groups, ...groupSearchedByName];
        }));
    }
    smbGroupQueryDsCache(search = '', hideBuiltIn = false, offset = 0) {
        const queryArgs = [['smb', '=', true]];
        search = search.trim();
        if (search.length > 0) {
            queryArgs.push(['group', '^', search]);
        }
        if (hideBuiltIn) {
            queryArgs.push(['builtin', '=', false]);
        }
        return (0, rxjs_1.combineLatest)([
            this.groupQueryDsCacheByName(search),
            this.ws.call(this.groupQuery, [queryArgs, Object.assign(Object.assign({}, this.queryOptions), { offset, order_by: ['builtin'] })]),
        ]).pipe((0, operators_1.map)(([groupSearchedByName, groups]) => {
            const groupIds = groupSearchedByName.map((groupsByName) => groupsByName.id);
            groups = groups.filter((group) => {
                return !groupIds.some((gid) => gid === group.id);
            });
            return [...groups, ...groupSearchedByName];
        }));
    }
    getGroupByName(groupname) {
        return this.ws.call(this.uncachedGroupQuery, [{ groupname }]);
    }
    userQueryDsCache(search = '', offset = 0) {
        let queryArgs = [];
        search = search.trim();
        if (search.length > 0) {
            queryArgs = [['username', '^', search]];
        }
        return this.ws.call(this.userQuery, [queryArgs, Object.assign(Object.assign({}, this.queryOptions), { offset, order_by: ['builtin'] })]);
    }
    getUserByName(username) {
        return this.ws.call(this.uncachedUserQuery, [{ username }]);
    }
    smbUserQueryDsCache(search = '', offset = 0) {
        const queryArgs = [['smb', '=', true]];
        search = search.trim();
        if (search.length > 0) {
            queryArgs.push(['username', '^', search]);
        }
        return this.ws.call(this.userQuery, [queryArgs, Object.assign(Object.assign({}, this.queryOptions), { offset, order_by: ['builtin'] })]);
    }
};
exports.UserService = UserService;
UserService.namePattern = /^[a-zA-Z0-9_][a-zA-Z0-9_.-]*[$]?$/;
UserService.ctorParameters = () => [
    { type: ws_service_1.WebSocketService }
];
exports.UserService = UserService = __decorate([
    (0, core_1.Injectable)({ providedIn: 'root' })
], UserService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21hY2Jvb2sva2FycG92LXdvcmsvVHJ1ZU5BUy93ZWJ1aS9zcmMvYXBwL3NlcnZpY2VzL3VzZXIuc2VydmljZS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBQSx3Q0FBMkM7QUFDM0MsK0JBQXFEO0FBQ3JELDhDQUFxQztBQUtyQyx3REFBMkQ7QUFHcEQsSUFBTSxXQUFXLEdBQWpCLE1BQU0sV0FBVztJQVF0QixZQUFzQixFQUFvQjtRQUFwQixPQUFFLEdBQUYsRUFBRSxDQUFrQjtRQU5oQyxzQkFBaUIsR0FBRyxtQkFBNEIsQ0FBQztRQUNqRCx1QkFBa0IsR0FBRyxxQkFBOEIsQ0FBQztRQUNwRCxjQUFTLEdBQUcsWUFBcUIsQ0FBQztRQUNsQyxlQUFVLEdBQUcsYUFBc0IsQ0FBQztRQUNwQyxpQkFBWSxHQUFHLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRSxDQUFDO0lBRU0sQ0FBQztJQUV0Qyx1QkFBdUIsQ0FBQyxJQUFZO1FBQzFDLElBQUksQ0FBQyxDQUFBLElBQUksYUFBSixJQUFJLHVCQUFKLElBQUksQ0FBRSxNQUFNLENBQUEsRUFBRSxDQUFDO1lBQ2xCLE9BQU8sSUFBQSxTQUFFLEVBQUMsRUFBRSxDQUFDLENBQUM7UUFDaEIsQ0FBQztRQUNELElBQUksU0FBUyxHQUF5QixFQUFFLENBQUM7UUFDekMsSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNuQixJQUFJLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7WUFDcEIsU0FBUyxHQUFHLENBQUMsQ0FBQyxNQUFNLEVBQUUsR0FBRyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDcEMsQ0FBQztRQUNELE9BQU8sSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDLFNBQVMsb0JBQU8sSUFBSSxDQUFDLFlBQVksRUFBRyxDQUFDLENBQUM7SUFDOUUsQ0FBQztJQUVELGlCQUFpQixDQUFDLE1BQU0sR0FBRyxFQUFFLEVBQUUs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Q0FBQyxDQUFDO0lBQzlELENBQUM7SUFFRCxtQkFBbUIsQ0FBQyxNQUFNLEdBQUcsRUFBRSxFQUFFLE1BQU0sR0FBRyxDQUFDO1FBQ3pDLE1BQU0sU0FBUyxHQUF3QixDQUFDLENBQUMsS0FBSyxFQUFFLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQzVELE1BQU0sR0FBRyxNQUFNLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDdkIsSUFBSSxNQUFNLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDO1lBQ3RCLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxVQUFVLEVBQUUsR0FBRyxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUM7UUFDNUMsQ0FBQztRQUNELE9BQU8sSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDLFNBQVMsa0NBQU8sSUFBSSxDQUFDLFlBQVksS0FBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLENBQUMsU0FBUyxDQUFDLElBQUcsQ0FBQyxDQUFDO0lBQzVHLENBQUM7O0FBNUZVLGtDQUFXO0FBQ04sdUJBQVcsR0FBRyxtQ0FBbUMsQUFBdEMsQ0FBdUM7Ozs7c0JBRHZELFdBQVc7SUFEdkIsSUFBQSxpQkFBVSxFQUFDLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxDQUFDO0dBQ3RCLFdBQVcsQ0E2RnZCIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9tYWNib29rL2thcnBvdi13b3JrL1RydWVOQVMvd2VidWkvc3JjL2FwcC9zZXJ2aWNlcy91c2VyLnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgY29tYmluZUxhdGVzdCwgT2JzZXJ2YWJsZSwgb2YgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IG1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IERzVW5jYWNoZWRHcm91cCwgRHNVbmNhY2hlZFVzZXIgfSBmcm9tICdhcHAvaW50ZXJmYWNlcy9kcy1jYWNoZS5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgR3JvdXAgfSBmcm9tICdhcHAvaW50ZXJmYWNlcy9ncm91cC5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgUXVlcnlGaWx0ZXIgfSBmcm9tICdhcHAvaW50ZXJmYWNlcy9xdWVyeS1hcGkuaW50ZXJmYWNlJztcbmltcG9ydCB7IFVzZXIgfSBmcm9tICdhcHAvaW50ZXJmYWNlcy91c2VyLmludGVyZmFjZSc7XG5pbXBvcnQgeyBXZWJTb2NrZXRTZXJ2aWNlIH0gZnJvbSAnYXBwL3NlcnZpY2VzL3dzLnNlcnZpY2UnO1xuXG5ASW5qZWN0YWJsZSh7IHByb3ZpZGVkSW46ICdyb290JyB9KVxuZXhwb3J0IGNsYXNzIFVzZXJTZXJ2aWNlIHtcbiAgc3RhdGljIHJlYWRvbmx5IG5hbWVQYXR0ZXJuID0gL15bYS16QS1aMC05X11bYS16QS1aMC05Xy4tXSpbJF0/JC87XG4gIHByb3RlY3RlZCB1bmNhY2hlZFVzZXJRdWVyeSA9ICd1c2VyLmdldF91c2VyX29iaicgYXMgY29uc3Q7XG4gIHByb3RlY3RlZCB1bmNhY2hlZEdyb3VwUXVlcnkgPSAnZ3JvdXAuZ2V0X2dyb3VwX29iaicgYXMgY29uc3Q7XG4gIHByb3RlY3RlZCB1c2VyUXVlcnkgPSAndXNlci5xdWVyeScgYXMgY29uc3Q7XG4gIHByb3RlY3RlZCBncm91cFF1ZXJ5ID0gJ2dyb3VwLnF1ZXJ5JyBhcyBjb25zdDtcbiAgcHJvdGVjdGVkIHF1ZXJ5T3B0aW9ucyA9IHsgbGltaXQ6IDUwIH07XG5cbiAgY29uc3RydWN0b3IocHJvdGVjdGVkIHdzOiBXZWJTb2NrZXRTZXJ2aWNlKSB7fVxuXG4gIHByaXZhdGUgZ3JvdXBRdWVyeURzQ2FjaGVCeU5hbWUobmFtZTogc3RyaW5nKTogT2JzZXJ2YWJsZTxHcm91cFtdPiB7XG4gICAgaWYgKCFuYW1lPy5sZW5ndGgpIHtcbiAgICAgIHJldHVybiBvZihbXSk7XG4gICAgfVxuICAgIGxldCBxdWVyeUFyZ3M6IFF1ZXJ5RmlsdGVyPEdyb3VwPltdID0gW107XG4gICAgbmFtZSA9IG5hbWUudHJpbSgpO1xuICAgIGlmIChuYW1lLmxlbmd0aCA+IDApIHtcbiAgICAgIHF1ZXJ5QXJncyA9IFtbJ25hbWUnLCAnPScsIG5hbWVdXTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMud3MuY2FsbCh0aGlzLmdyb3VwUXVlcnksIFtxdWVyeUFyZ3MsIHsgLi4udGhpcy5xdWVyeU9wdGlvbnMgfV0pO1xuICB9XG5cbiAgZ3JvdXBRdWVyeURzQ2FjaGUoc2VhcmNoID0gJycsIGhpZGVCdWlsdEluID0gZmFsc2UsIG9mZnNldCA9IDApOiBPYnNlcnZhYmxlPEdyb3VwW10+IHtcbiAgICBsZXQgcXVlcnlBcmdzOiBRdWVyeUZpbHRlcjxHcm91cD5bXSA9IFtdO1xuICAgIHNlYXJjaCA9IHNlYXJjaC50cmltKCk7XG4gICAgaWYgKHNlYXJjaC5sZW5ndGggPiAwKSB7XG4gICAgICBxdWVyeUFyZ3MgPSBbWydncm91cCcsICdeJywgc2VhcmNoXV07XG4gICAgfVxuICAgIGlmIChoaWRlQnVpbHRJbikge1xuICAgICAgcXVlcnlBcmdzID0gcXVlcnlBcmdzLmNvbmNhdChbWydidWlsdGluJywgJz0nLCBmYWxzZV1dKTtcbiAgICB9XG4gICAgcmV0dXJuIGNvbWJpbmVMYXRlc3QoW1xuICAgICAgdGhpcy5ncm91cFF1ZXJ5RHNDYWNoZUJ5TmFtZShzZWFyY2gpLFxuICAgICAgdGhpcy53cy5jYWxsKHRoaXMuZ3JvdXBRdWVyeSwgW3F1ZXJ5QXJncywgeyAuLi50aGlzLnF1ZXJ5T3B0aW9ucywgb2Zmc2V0LCBvcmRlcl9ieTogWydidWlsdGluJ10gfV0pLFxuICAgIF0pLnBpcGUobWFwKChbZ3JvdXBTZWFyY2hlZEJ5TmFtZSwgZ3JvdXBzXSkgPT4ge1xuICAgICAgY29uc3QgZ3JvdXBJZHMgPSBncm91cFNlYXJjaGVkQnlOYW1lLm1hcCgoZ3JvdXBzQnlOYW1lKSA9PiBncm91cHNCeU5hbWUuaWQpO1xuICAgICAgZ3JvdXBzID0gZ3JvdXBzLmZpbHRlcihcbiAgICAgICAgKGdyb3VwKSA9PiB7XG4gICAgICAgICAgcmV0dXJuICFncm91cElkcy5zb21lKChnaWQpID0+IGdpZCA9PT0gZ3JvdXAuaWQpO1xuICAgICAgICB9LFxuICAgICAgKTtcbiAgICAgIHJldHVybiBbLi4uZ3JvdXBzLCAuLi5ncm91cFNlYXJjaGVkQnlOYW1lXTtcbiAgICB9KSk7XG4gIH1cblxuICBzbWJHcm91cFF1ZXJ5RHNDYWNoZShzZWFyY2ggPSAnJywgaGlkZUJ1aWx0SW4gPSBmYWxzZSwgb2Zmc2V0ID0gMCk6IE9ic2VydmFibGU8R3JvdXBbXT4ge1xuICAgIGNvbnN0IHF1ZXJ5QXJnczogUXVlcnlGaWx0ZXI8R3JvdXA+W10gPSBbWydzbWInLCAnPScsIHRydWVdXTtcbiAgICBzZWFyY2ggPSBzZWFyY2gudHJpbSgpO1xuICAgIGlmIChzZWFyY2gubGVuZ3RoID4gMCkge1xuICAgICAgcXVlcnlBcmdzLnB1c2goWydncm91cCcsICdeJywgc2VhcmNoXSk7XG4gICAgfVxuICAgIGlmIChoaWRlQnVpbHRJbikge1xuICAgICAgcXVlcnlBcmdzLnB1c2goWydidWlsdGluJywgJz0nLCBmYWxzZV0pO1xuICAgIH1cbiAgICByZXR1cm4gY29tYmluZUxhdGVzdChbXG4gICAgICB0aGlzLmdyb3VwUXVlcnlEc0NhY2hlQnlOYW1lKHNlYXJjaCksXG4gICAgICB0aGlzLndzLmNhbGwodGhpcy5ncm91cFF1ZXJ5LCBbcXVlcnlBcmdzLCB7IC4uLnRoaXMucXVlcnlPcHRpb25zLCBvZmZzZXQsIG9yZGVyX2J5OiBbJ2J1aWx0aW4nXSB9XSksXG4gICAgXSkucGlwZShtYXAoKFtncm91cFNlYXJjaGVkQnlOYW1lLCBncm91cHNdKSA9PiB7XG4gICAgICBjb25zdCBncm91cElkcyA9IGdyb3VwU2VhcmNoZWRCeU5hbWUubWFwKChncm91cHNCeU5hbWUpID0+IGdyb3Vwc0J5TmFtZS5pZCk7XG4gICAgICBncm91cHMgPSBncm91cHMuZmlsdGVyKFxuICAgICAgICAoZ3JvdXApID0+IHtcbiAgICAgICAgICByZXR1cm4gIWdyb3VwSWRzLnNvbWUoKGdpZCkgPT4gZ2lkID09PSBncm91cC5pZCk7XG4gICAgICAgIH0sXG4gICAgICApO1xuICAgICAgcmV0dXJuIFsuLi5ncm91cHMsIC4uLmdyb3VwU2VhcmNoZWRCeU5hbWVdO1xuICAgIH0pKTtcbiAgfVxuXG4gIGdldEdyb3VwQnlOYW1lKGdyb3VwbmFtZTogc3RyaW5nKTogT2JzZXJ2YWJsZTxEc1VuY2FjaGVkR3JvdXA+IHtcbiAgICByZXR1cm4gdGhpcy53cy5jYWxsKHRoaXMudW5jYWNoZWRHcm91cFF1ZXJ5LCBbeyBncm91cG5hbWUgfV0pO1xuICB9XG5cbiAgdXNlclF1ZXJ5RHNDYWNoZShzZWFyY2ggPSAnJywgb2Zmc2V0ID0gMCk6IE9ic2VydmFibGU8VXNlcltdPiB7XG4gICAgbGV0IHF1ZXJ5QXJnczogUXVlcnlGaWx0ZXI8VXNlcj5bXSA9IFtdO1xuICAgIHNlYXJjaCA9IHNlYXJjaC50cmltKCk7XG4gICAgaWYgKHNlYXJjaC5sZW5ndGggPiAwKSB7XG4gICAgICBxdWVyeUFyZ3MgPSBbWyd1c2VybmFtZScsICdeJywgc2VhcmNoXV07XG4gICAgfVxuICAgIHJldHVybiB0aGlzLndzLmNhbGwodGhpcy51c2VyUXVlcnksIFtxdWVyeUFyZ3MsIHsgLi4udGhpcy5xdWVyeU9wdGlvbnMsIG9mZnNldCwgb3JkZXJfYnk6IFsnYnVpbHRpbiddIH1dKTtcbiAgfVxuXG4gIGdldFVzZXJCeU5hbWUodXNlcm5hbWU6IHN0cmluZyk6IE9ic2VydmFibGU8RHNVbmNhY2hlZFVzZXI+IHtcbiAgICByZXR1cm4gdGhpcy53cy5jYWxsKHRoaXMudW5jYWNoZWRVc2VyUXVlcnksIFt7IHVzZXJuYW1lIH1dKTtcbiAgfVxuXG4gIHNtYlVzZXJRdWVyeURzQ2FjaGUoc2VhcmNoID0gJycsIG9mZnNldCA9IDApOiBPYnNlcnZhYmxlPFVzZXJbXT4ge1xuICAgIGNvbnN0IHF1ZXJ5QXJnczogUXVlcnlGaWx0ZXI8VXNlcj5bXSA9IFtbJ3NtYicsICc9JywgdHJ1ZV1dO1xuICAgIHNlYXJjaCA9IHNlYXJjaC50cmltKCk7XG4gICAgaWYgKHNlYXJjaC5sZW5ndGggPiAwKSB7XG4gICAgICBxdWVyeUFyZ3MucHVzaChbJ3VzZXJuYW1lJywgJ14nLCBzZWFyY2hdKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMud3MuY2FsbCh0aGlzLnVzZXJRdWVyeSwgW3F1ZXJ5QXJncywgeyAuLi50aGlzLnF1ZXJ5T3B0aW9ucywgb2Zmc2V0LCBvcmRlcl9ieTogWydidWlsdGluJ10gfV0pO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=