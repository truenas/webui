cbb46298c91a2f5fffeead469b505029
"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const testbed_1 = require("@angular/cdk/testing/testbed");
const forms_1 = require("@angular/forms");
const testing_1 = require("@angular/material/button/testing");
const jest_1 = require("@ngneat/spectator/jest");
const testing_2 = require("@ngrx/store/testing");
const rxjs_1 = require("rxjs");
const fake_job_utils_1 = require("app/core/testing/utils/fake-job.utils");
const mock_auth_utils_1 = require("app/core/testing/utils/mock-auth.utils");
const mock_websocket_utils_1 = require("app/core/testing/utils/mock-websocket.utils");
const product_type_enum_1 = require("app/enums/product-type.enum");
const dialog_service_1 = require("app/modules/dialog/dialog.service");
const chained_component_ref_1 = require("app/modules/forms/ix-forms/components/ix-slide-in/chained-component-ref");
const ix_form_harness_1 = require("app/modules/forms/ix-forms/testing/ix-form.harness");
const snackbar_service_1 = require("app/modules/snackbar/services/snackbar.service");
const system_security_form_component_1 = require("app/pages/system/advanced/system-security/system-security-form/system-security-form.component");
const fips_service_1 = require("app/services/fips.service");
const system_general_service_1 = require("app/services/system-general.service");
const ws_service_1 = require("app/services/ws.service");
const ha_info_selectors_1 = require("app/store/ha-info/ha-info.selectors");
const system_info_selectors_1 = require("app/store/system-info/system-info.selectors");
const fakeSystemSecurityConfig = {
    enable_fips: false,
};
describe('SystemSecurityFormComponent', () => {
    let spectator;
    let loader;
    let form;
    const createComponent = (0, jest_1.createComponentFactory)({
        component: system_security_form_component_1.SystemSecurityFormComponent,
        imports: [
            forms_1.ReactiveFormsModule,
        ],
        providers: [
            (0, testing_2.provideMockStore)({
                selectors: [
                    { selector: system_info_selectors_1.selectSystemInfo, value: { hostname: 'host.truenas.com' } },
                    { selector: ha_info_selectors_1.selectIsHaLicensed, value: false },
                ],
            }),
            (0, jest_1.mockProvider)(dialog_service_1.DialogService, {
                confirm: jest.fn(() => (0, rxjs_1.of)()),
            }),
            (0, jest_1.mockProvider)(snackbar_service_1.SnackbarService),
            (0, jest_1.mockProvider)(system_general_service_1.SystemGeneralService, {
                getProductType: () => product_type_enum_1.ProductType.Scale,
            }),
            (0, jest_1.mockProvider)(chained_component_ref_1.ChainedRef, {
                close: jest.fn(),
                getData: jest.fn(() => fakeSystemSecurityConfig),
            }),
            (0, jest_1.mockProvider)(fips_service_1.FipsService, {
                promptForRestart: jest.fn(() => (0, rxjs_1.of)(undefined)),
            }),
            (0, mock_auth_utils_1.mockAuth)(),
            (0, jest_1.mockProvider)(dialog_service_1.DialogService, {
                jobDialog: jest.fn(() => ({
                    afterClosed: () => (0, rxjs_1.of)(undefined),
                })),
            }),
            (0, mock_websocket_utils_1.mockWebSocket)([
                (0, mock_websocket_utils_1.mockJob)('system.security.update', (0, fake_job_utils_1.fakeSuccessfulJob)()),
            ]),
        ],
    });
    describe('System Security config', () => {
        beforeEach(() => __awaiter(void 0, void 0, void 0, function* () {
            spectator = createComponent();
            loader = testbed_1.TestbedHarnessEnvironment.loader(spectator.fixture);
            form = yield loader.getHarness(ix_form_harness_1.IxFormHarness);
        }));
        it('saves FIPS config when form is filled and Save is pressed', () => __awaiter(void 0, void 0, void 0, function* () {
            yield form.fillForm({
                'Enable FIPS': true,
            });
            const saveButton = yield loader.getHarness(testing_1.MatButtonHarness.with({ text: 'Save' }));
            yield saveButton.click();
            expect(spectator.inject(ws_service_1.WebSocketService).job).toHaveBeenCalledWith('system.security.update', [{
                    enable_fips: true,
                }]);
            expect(spectator.inject(snackbar_service_1.SnackbarService).success).toHaveBeenCalledWith('System Security Settings Updated.');
        }));
        it('prompts to reload when settings are saved and HA is not licensed', () => __awaiter(void 0, void 0, void 0, function* () {
            yield form.fillForm({
                'Enable FIPS': true,
            });
            const saveButton = yield loader.getHarness(testing_1.MatButtonHarness.with({ text: 'Save' }));
            yield saveButton.click();
            expect(spectator.inject(fips_service_1.FipsService).promptForRestart).toHaveBeenCalled();
        }));
        it('does not prompt to restart when settings are saved and HA is licensed, because this is handled in HaFipsEffects', () => __awaiter(void 0, void 0, void 0, function* () {
            spectator.inject(testing_2.MockStore).overrideSelector(ha_info_selectors_1.selectIsHaLicensed, true);
            yield form.fillForm({
                'Enable FIPS': true,
            });
            const saveButton = yield loader.getHarness(testing_1.MatButtonHarness.with({ text: 'Save' }));
            yield saveButton.click();
            expect(spectator.inject(fips_service_1.FipsService).promptForRestart).not.toHaveBeenCalled();
        }));
        it('loads and shows current System Security config', () => __awaiter(void 0, void 0, void 0, function* () {
            const values = yield form.getValues();
            expect(values).toEqual({
                'Enable FIPS': false,
            });
        }));
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21hY2Jvb2sva2FycG92LXdvcmsvVHJ1ZU5BUy93ZWJ1aS9zcmMvYXBwL3BhZ2VzL3N5c3RlbS9hZHZhbmNlZC9zeXN0ZW0tc2VjdXJpdHkvc3lzdGVtLXNlY3VyaXR5LWZvcm0vc3lzdGVtLXNlY3VyaXR5LWZvcm0uY29tcG9uZW50LnNwZWMudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFDQSwwREFBeUU7QUFDekUsMENBQXFEO0FBQ3JELDhEQUFvRTtBQUNwRSxpREFBeUY7QUFDekYsaURBQWtFO0FBQ2xFLCtCQUEwQjtBQUMxQiwwRUFBMEU7QUFDMUUsNEVBQWtFO0FBQ2xFLHNGQUFxRjtBQUNyRixtRUFBMEQ7QUFFMUQsc0VBQWtFO0FBQ2xFLG1IQUFxRztBQUNyRyx3RkFBbUY7QUFDbkYscUZBQWlGO0FBQ2pGLGtKQUE0STtBQUM1SSw0REFBd0Q7QUFDeEQsZ0ZBQTJFO0FBQzNFLHdEQUEyRDtBQUMzRCwyRUFBeUU7QUFDekUsdUZBQStFO0FBRS9FLE1BQU0sd0JBQXdCLEdBQXlCO0lBQ3JELFdBQVcsRUFBRSxLQUFLO0NBQ25CLENBQUM7QUFFRixRQUFRLENBQUMsNkJBQTZCLEVBQUUsR0FBRyxFQUFFO0lBQzNDLElBQUksU0FBaUQsQ0FBQztJQUN0RCxJQUFJLE1BQXFCLENBQUM7SUFDMUIsSUFBSSxJQUFtQixDQUFDO0lBRXhCLE1BQU0sZUFBZSxHQUFHLElBQUEsNkJBQXNCLEVBQUM7UUFDN0MsU0FBUyxFQUFFLDREQUEyQjtRQUN0QyxPQUFPLEVBQUU7WUFDUCwyQkFBbUI7U0FDcEI7UUFDRCxTQUFTLEVBQUU7WUFDVCxJQUFBLDBCQUFnQixFQUFDO2dCQUNmLFNBQVMsRUFBRTtvQkFDVCxFQUFFLFFBQVEsRUFBRSx3Q0FBZ0IsRUFBRSxLQUFLLEVBQUUsRUFBRSxRQUFRLEVBQUUsa0JBQWtCLEVBQUUsRUFBRTtvQkFDdkUsRUFBRSxRQUFRLEVBQUUsc0NBQWtCLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRTtpQkFDL0M7YUFDRixDQUFDO1lBQ0YsSUFB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LENBQUM7WUFFekIsTUFBTSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsMEJBQVcsQ0FBQyxDQUFDLGdCQUFnQixDQUFDLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztRQUM1RSxDQUFDLENBQUEsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLGlIQUFpSCxFQUFFLEdBQVMsRUFBRTtZQUMvSCxTQUFTLENBQUMsTUFBTSxDQUFDLG1CQUFTLENBQUMsQ0FBQyxnQkFBZ0IsQ0FBQyxzQ0FBa0IsRUFBRSxJQUFJLENBQUMsQ0FBQztZQUV2RSxNQUFNLElBQUksQ0FBQyxRQUFRLENBQUM7Z0JBQ2xCLGFBQWEsRUFBRSxJQUFJO2FBQ3BCLENBQUMsQ0FBQztZQUVILE1BQU0sVUFBVSxHQUFHLE1BQU0sTUFBTSxDQUFDLFVBQVUsQ0FBQywwQkFBZ0IsQ0FBQyxJQUFJLENBQUMsRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQ3BGLE1BQU0sVUFBVSxDQUFDLEtBQUssRUFBRSxDQUFDO1lBRXpCLE1BQU0sQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLDBCQUFXLENBQUMsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBQ2hGLENBQUMsQ0FBQSxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsZ0RBQWdELEVBQUUsR0FBUyxFQUFFO1lBQzlELE1BQU0sTUFBTSxHQUFHLE1BQU0sSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO1lBRXRDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLENBQUM7Z0JBQ3JCLGFBQWEsRUFBRSxLQUFLO2FBQ3JCLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQSxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9tYWNib29rL2thcnBvdi13b3JrL1RydWVOQVMvd2VidWkvc3JjL2FwcC9wYWdlcy9zeXN0ZW0vYWR2YW5jZWQvc3lzdGVtLXNlY3VyaXR5L3N5c3RlbS1zZWN1cml0eS1mb3JtL3N5c3RlbS1zZWN1cml0eS1mb3JtLmNvbXBvbmVudC5zcGVjLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEhhcm5lc3NMb2FkZXIgfSBmcm9tICdAYW5ndWxhci9jZGsvdGVzdGluZyc7XG5pbXBvcnQgeyBUZXN0YmVkSGFybmVzc0Vudmlyb25tZW50IH0gZnJvbSAnQGFuZ3VsYXIvY2RrL3Rlc3RpbmcvdGVzdGJlZCc7XG5pbXBvcnQgeyBSZWFjdGl2ZUZvcm1zTW9kdWxlIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuaW1wb3J0IHsgTWF0QnV0dG9uSGFybmVzcyB9IGZyb20gJ0Bhbmd1bGFyL21hdGVyaWFsL2J1dHRvbi90ZXN0aW5nJztcbmltcG9ydCB7IGNyZWF0ZUNvbXBvbmVudEZhY3RvcnksIG1vY2tQcm92aWRlciwgU3BlY3RhdG9yIH0gZnJvbSAnQG5nbmVhdC9zcGVjdGF0b3IvamVzdCc7XG5pbXBvcnQgeyBNb2NrU3RvcmUsIHByb3ZpZGVNb2NrU3RvcmUgfSBmcm9tICdAbmdyeC9zdG9yZS90ZXN0aW5nJztcbmltcG9ydCB7IG9mIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBmYWtlU3VjY2Vzc2Z1bEpvYiB9IGZyb20gJ2FwcC9jb3JlL3Rlc3RpbmcvdXRpbHMvZmFrZS1qb2IudXRpbHMnO1xuaW1wb3J0IHsgbW9ja0F1dGggfSBmcm9tICdhcHAvY29yZS90ZXN0aW5nL3V0aWxzL21vY2stYXV0aC51dGlscyc7XG5pbXBvcnQgeyBtb2NrSm9iLCBtb2NrV2ViU29ja2V0IH0gZnJvbSAnYXBwL2NvcmUvdGVzdGluZy91dGlscy9tb2NrLXdlYnNvY2tldC51dGlscyc7XG5pbXBvcnQgeyBQcm9kdWN0VHlwZSB9IGZyb20gJ2FwcC9lbnVtcy9wcm9kdWN0LXR5cGUuZW51bSc7XG5pbXBvcnQgeyBTeXN0ZW1TZWN1cml0eUNvbmZpZyB9IGZyb20gJ2FwcC9pbnRlcmZhY2VzL3N5c3RlbS1zZWN1cml0eS1jb25maWcuaW50ZXJmYWNlJztcbmltcG9ydCB7IERpYWxvZ1NlcnZpY2UgfSBmcm9tICdhcHAvbW9kdWxlcy9kaWFsb2cvZGlhbG9nLnNlcnZpY2UnO1xuaW1wb3J0IHsgQ2hhaW5lZFJlZiB9IGZyb20gJ2FwcC9tb2R1bGVzL2Zvcm1zL2l4LWZvcm1zL2NvbXBvbmVudHMvaXgtc2xpZGUtaW4vY2hhaW5lZC1jb21wb25lbnQtcmVmJztcbmltcG9ydCB7IEl4Rm9ybUhhcm5lc3MgfSBmcm9tICdhcHAvbW9kdWxlcy9mb3Jtcy9peC1mb3Jtcy90ZXN0aW5nL2l4LWZvcm0uaGFybmVzcyc7XG5pbXBvcnQgeyBTbmFja2JhclNlcnZpY2UgfSBmcm9tICdhcHAvbW9kdWxlcy9zbmFja2Jhci9zZXJ2aWNlcy9zbmFja2Jhci5zZXJ2aWNlJztcbmltcG9ydCB7IFN5c3RlbVNlY3VyaXR5Rm9ybUNvbXBvbmVudCB9IGZyb20gJ2FwcC9wYWdlcy9zeXN0ZW0vYWR2YW5jZWQvc3lzdGVtLXNlY3VyaXR5L3N5c3RlbS1zZWN1cml0eS1mb3JtL3N5c3RlbS1zZWN1cml0eS1mb3JtLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBGaXBzU2VydmljZSB9IGZyb20gJ2FwcC9zZXJ2aWNlcy9maXBzLnNlcnZpY2UnO1xuaW1wb3J0IHsgU3lzdGVtR2VuZXJhbFNlcnZpY2UgfSBmcm9tICdhcHAvc2VydmljZXMvc3lzdGVtLWdlbmVyYWwuc2VydmljZSc7XG5pbXBvcnQgeyBXZWJTb2NrZXRTZXJ2aWNlIH0gZnJvbSAnYXBwL3NlcnZpY2VzL3dzLnNlcnZpY2UnO1xuaW1wb3J0IHsgc2VsZWN0SXNIYUxpY2Vuc2VkIH0gZnJvbSAnYXBwL3N0b3JlL2hhLWluZm8vaGEtaW5mby5zZWxlY3RvcnMnO1xuaW1wb3J0IHsgc2VsZWN0U3lzdGVtSW5mbyB9IGZyb20gJ2FwcC9zdG9yZS9zeXN0ZW0taW5mby9zeXN0ZW0taW5mby5zZWxlY3RvcnMnO1xuXG5jb25zdCBmYWtlU3lzdGVtU2VjdXJpdHlDb25maWc6IFN5c3RlbVNlY3VyaXR5Q29uZmlnID0ge1xuICBlbmFibGVfZmlwczogZmFsc2UsXG59O1xuXG5kZXNjcmliZSgnU3lzdGVtU2VjdXJpdHlGb3JtQ29tcG9uZW50JywgKCkgPT4ge1xuICBsZXQgc3BlY3RhdG9yOiBTcGVjdGF0b3I8U3lzdGVtU2VjdXJpdHlGb3JtQ29tcG9uZW50PjtcbiAgbGV0IGxvYWRlcjogSGFybmVzc0xvYWRlcjtcbiAgbGV0IGZvcm06IEl4Rm9ybUhhcm5lc3M7XG5cbiAgY29uc3QgY3JlYXRlQ29tcG9uZW50ID0gY3JlYXRlQ29tcG9uZW50RmFjdG9yeSh7XG4gICAgY29tcG9uZW50OiBTeXN0ZW1TZWN1cml0eUZvcm1Db21wb25lbnQsXG4gICAgaW1wb3J0czogW1xuICAgICAgUmVhY3RpdmVGb3Jtc01vZHVsZSxcbiAgICBdLFxuICAgIHByb3ZpZGVyczogW1xuICAgICAgcHJvdmlkZU1vY2tTdG9yZSh7XG4gICAgICAgIHNlbGVjdG9yczogW1xuICAgICAgICAgIHsgc2VsZWN0b3I6IHNlbGVjdFN5c3RlbUluZm8sIHZhbHVlOiB7IGhvc3RuYW1lOiAnaG9zdC50cnVlbmFzLmNvbScgfSB9LFxuICAgICAgICAgIHsgc2VsZWN0b3I6IHNlbGVjdElzSGFMaWNlbnNlZCwgdmFsdWU6IGZhbHNlIH0sXG4gICAgICAgIF0sXG4gICAgICB9KSxcbiAgICAgIG1vY2tQcm92aWRlcihEaWFsb2dTZXJ2aWNlLCB7XG4gICAgICAgIGNvbmZpcm06IGplc3QuZm4oKCkgPT4gb2YoKSksXG4gICAgICB9KSxcbiAgICAgIG1vY2tQcm92aWRlcihTbmFja2JhclNlcnZpY2UpLFxuICAgICAgbW9ja1Byb3ZpZGVyKFN5c3RlbUdlbmVyYWxTZXJ2aWNlLCB7XG4gICAgICAgIGdldFByb2R1Y3RUeXBlOiAoKSA9PiBQcm9kdWN0VHlwZS5TY2FsZSxcbiAgICAgIH0pLFxuICAgICAgbW9ja1Byb3ZpZGVyKENoYWluZWRSZWYsIHtcbiAgICAgICAgY2xvc2U6IGplc3QuZm4oKSxcbiAgICAgICAgZ2V0RGF0YTogamVzdC5mbigoKSA9PiBmYWtlU3lzdGVtU2VjdXJpdHlDb25maWcpLFxuICAgICAgfSksXG4gICAgICBtb2NrUHJvdmlkZXIoRmlwc1NlcnZpY2UsIHtcbiAgICAgICAgcHJvbXB0Rm9yUmVzdGFydDogamVzdC5mbigoKSA9PiBvZih1bmRlZmluZWQpKSxcbiAgICAgIH0pLFxuICAgICAgbW9ja0F1dGgoKSxcbiAgICAgIG1vY2tQcm92aWRlcihEaWFsb2dTZXJ2aWNlLCB7XG4gICAgICAgIGpvYkRpYWxvZzogamVzdC5mbigoKSA9PiAoe1xuICAgICAgICAgIGFmdGVyQ2xvc2VkOiAoKSA9PiBvZih1bmRlZmluZWQpLFxuICAgICAgICB9KSksXG4gICAgICB9KSxcbiAgICAgIG1vY2tXZWJTb2NrZXQoW1xuICAgICAgICBtb2NrSm9iKCdzeXN0ZW0uc2VjdXJpdHkudXBkYXRlJywgZmFrZVN1Y2Nlc3NmdWxKb2IoKSksXG4gICAgICBdKSxcbiAgICBdLFxuICB9KTtcblxuICBkZXNjcmliZSgnU3lzdGVtIFNlY3VyaXR5IGNvbmZpZycsICgpID0+IHtcbiAgICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcbiAgICAgIHNwZWN0YXRvciA9IGNyZWF0ZUNvbXBvbmVudCgpO1xuICAgICAgbG9hZGVyID0gVGVzdGJlZEhhcm5lc3NFbnZpcm9ubWVudC5sb2FkZXIoc3BlY3RhdG9yLmZpeHR1cmUpO1xuICAgICAgZm9ybSA9IGF3YWl0IGxvYWRlci5nZXRIYXJuZXNzKEl4Rm9ybUhhcm5lc3MpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3NhdmVzIEZJUFMgY29uZmlnIHdoZW4gZm9ybSBpcyBmaWxsZWQgYW5kIFNhdmUgaXMgcHJlc3NlZCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IGZvcm0uZmlsbEZvcm0oe1xuICAgICAgICAnRW5hYmxlIEZJUFMnOiB0cnVlLFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHNhdmVCdXR0b24gPSBhd2FpdCBsb2FkZXIuZ2V0SGFybmVzcyhNYXRCdXR0b25IYXJuZXNzLndpdGgoeyB0ZXh0OiAnU2F2ZScgfSkpO1xuICAgICAgYXdhaXQgc2F2ZUJ1dHRvbi5jbGljaygpO1xuXG4gICAgICBleHBlY3Qoc3BlY3RhdG9yLmluamVjdChXZWJTb2NrZXRTZXJ2aWNlKS5qb2IpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCdzeXN0ZW0uc2VjdXJpdHkudXBkYXRlJywgW3tcbiAgICAgICAgZW5hYmxlX2ZpcHM6IHRydWUsXG4gICAgICB9XSk7XG4gICAgICBleHBlY3Qoc3BlY3RhdG9yLmluamVjdChTbmFja2JhclNlcnZpY2UpLnN1Y2Nlc3MpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICAnU3lzdGVtIFNlY3VyaXR5IFNldHRpbmdzIFVwZGF0ZWQuJyxcbiAgICAgICk7XG4gICAgfSk7XG5cbiAgICBpdCgncHJvbXB0cyB0byByZWxvYWQgd2hlbiBzZXR0aW5ncyBhcmUgc2F2ZWQgYW5kIEhBIGlzIG5vdCBsaWNlbnNlZCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IGZvcm0uZmlsbEZvcm0oe1xuICAgICAgICAnRW5hYmxlIEZJUFMnOiB0cnVlLFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHNhdmVCdXR0b24gPSBhd2FpdCBsb2FkZXIuZ2V0SGFybmVzcyhNYXRCdXR0b25IYXJuZXNzLndpdGgoeyB0ZXh0OiAnU2F2ZScgfSkpO1xuICAgICAgYXdhaXQgc2F2ZUJ1dHRvbi5jbGljaygpO1xuXG4gICAgICBleHBlY3Qoc3BlY3RhdG9yLmluamVjdChGaXBzU2VydmljZSkucHJvbXB0Rm9yUmVzdGFydCkudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ2RvZXMgbm90IHByb21wdCB0byByZXN0YXJ0IHdoZW4gc2V0dGluZ3MgYXJlIHNhdmVkIGFuZCBIQSBpcyBsaWNlbnNlZCwgYmVjYXVzZSB0aGlzIGlzIGhhbmRsZWQgaW4gSGFGaXBzRWZmZWN0cycsIGFzeW5jICgpID0+IHtcbiAgICAgIHNwZWN0YXRvci5pbmplY3QoTW9ja1N0b3JlKS5vdmVycmlkZVNlbGVjdG9yKHNlbGVjdElzSGFMaWNlbnNlZCwgdHJ1ZSk7XG5cbiAgICAgIGF3YWl0IGZvcm0uZmlsbEZvcm0oe1xuICAgICAgICAnRW5hYmxlIEZJUFMnOiB0cnVlLFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHNhdmVCdXR0b24gPSBhd2FpdCBsb2FkZXIuZ2V0SGFybmVzcyhNYXRCdXR0b25IYXJuZXNzLndpdGgoeyB0ZXh0OiAnU2F2ZScgfSkpO1xuICAgICAgYXdhaXQgc2F2ZUJ1dHRvbi5jbGljaygpO1xuXG4gICAgICBleHBlY3Qoc3BlY3RhdG9yLmluamVjdChGaXBzU2VydmljZSkucHJvbXB0Rm9yUmVzdGFydCkubm90LnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgICB9KTtcblxuICAgIGl0KCdsb2FkcyBhbmQgc2hvd3MgY3VycmVudCBTeXN0ZW0gU2VjdXJpdHkgY29uZmlnJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgdmFsdWVzID0gYXdhaXQgZm9ybS5nZXRWYWx1ZXMoKTtcblxuICAgICAgZXhwZWN0KHZhbHVlcykudG9FcXVhbCh7XG4gICAgICAgICdFbmFibGUgRklQUyc6IGZhbHNlLFxuICAgICAgfSk7XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXSwidmVyc2lvbiI6M30=