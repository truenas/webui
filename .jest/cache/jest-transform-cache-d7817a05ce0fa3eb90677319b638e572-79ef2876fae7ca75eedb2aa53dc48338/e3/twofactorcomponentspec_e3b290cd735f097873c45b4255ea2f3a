a74a5c6c0c19a204d4746e1c768b2feb
"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const testbed_1 = require("@angular/cdk/testing/testbed");
const testing_1 = require("@angular/material/button/testing");
const jest_1 = require("@ngneat/spectator/jest");
const ng_mocks_1 = require("ng-mocks");
const rxjs_1 = require("rxjs");
const mock_websocket_utils_1 = require("app/core/testing/utils/mock-websocket.utils");
const _2fa_1 = require("app/helptext/system/2fa");
const copy_button_component_1 = require("app/modules/buttons/copy-button/copy-button.component");
const dialog_service_1 = require("app/modules/dialog/dialog.service");
const ix_warning_component_1 = require("app/modules/forms/ix-forms/components/ix-warning/ix-warning.component");
const qr_viewer_component_1 = require("app/pages/two-factor-auth/components/two-factor/qr-viewer/qr-viewer.component");
const two_factor_component_1 = require("app/pages/two-factor-auth/components/two-factor/two-factor.component");
const auth_service_1 = require("app/services/auth/auth.service");
const ws_service_1 = require("app/services/ws.service");
describe('TwoFactorComponent', () => {
    let spectator;
    let loader;
    let ws;
    const createComponent = (0, jest_1.createComponentFactory)({
        component: two_factor_component_1.TwoFactorComponent,
        declarations: [
            (0, ng_mocks_1.MockComponent)(ix_warning_component_1.IxWarningComponent),
            (0, ng_mocks_1.MockComponent)(qr_viewer_component_1.QrViewerComponent),
            (0, ng_mocks_1.MockComponent)(copy_button_component_1.CopyButtonComponent),
        ],
        providers: [
            (0, jest_1.mockProvider)(dialog_service_1.DialogService, {
                confirm: jest.fn(() => (0, rxjs_1.of)(true)),
            }),
            (0, mock_websocket_utils_1.mockWebSocket)([
                (0, mock_websocket_utils_1.mockCall)('user.renew_2fa_secret'),
            ]),
            (0, jest_1.mockProvider)(auth_service_1.AuthService, {
                user$: (0, rxjs_1.of)({
                    pw_name: 'dummy',
                    two_factor_config: {
                        secret_configured: true,
                    },
                }),
                userTwoFactorConfig$: (0, rxjs_1.of)({
                    provisioning_uri: 'somepath://here/iXsystems:first-test?secret=KYC',
                    interval: 30,
                    otp_digits: 6,
                    secret_configured: true,
                }),
                getGlobalTwoFactorConfig: jest.fn(() => (0, rxjs_1.of)({ enabled: false })),
            }),
        ],
    });
    beforeEach(() => {
        spectator = createComponent();
        loader = testbed_1.TestbedHarnessEnvironment.loader(spectator.fixture);
        ws = spectator.inject(ws_service_1.WebSocketService);
    });
    it('shows warning when global setting is disabled', () => {
        jest.spyOn(spectator.inject(auth_service_1.AuthService), 'getGlobalTwoFactorConfig').mockImplementation(() => (0, rxjs_1.of)({
            enabled: true,
        }));
        const warning = spectator.query(ix_warning_component_1.IxWarningComponent);
        expect(warning).toBeTruthy();
        expect(warning).toHaveAttribute('message', _2fa_1.helptext2fa.two_factor.global_disabled);
    });
    it('shows warning when global setting is enabled but user disabled', () => {
        spectator.component.ngOnInit();
        spectator.component.userTwoFactorAuthConfigured = false;
        spectator.detectChanges();
        const warning = spectator.query(ix_warning_component_1.IxWarningComponent);
        expect(warning).toBeTruthy();
        expect(warning).toHaveAttribute('message', _2fa_1.helptext2fa.two_factor.global_enabled_user_disabled);
    });
    it('shows warning when global setting is enabled and user enabled', () => {
        spectator.component.ngOnInit();
        spectator.detectChanges();
        const warning = spectator.query(ix_warning_component_1.IxWarningComponent);
        expect(warning).toBeTruthy();
        expect(warning).toHaveAttribute('message', _2fa_1.helptext2fa.two_factor.global_enabled_user_enabled);
    });
    it('renews secret when button is clicked', () => __awaiter(void 0, void 0, void 0, function* () {
        const renewBtn = yield loader.getHarness(testing_1.MatButtonHarness.with({ text: 'Renew 2FA Secret' }));
        yield renewBtn.click();
        expect(spectator.inject(dialog_service_1.DialogService).confirm).toHaveBeenCalledWith({
            title: _2fa_1.helptext2fa.two_factor.renewSecret.title,
            message: _2fa_1.helptext2fa.two_factor.renewSecret.message,
            hideCheckbox: true,
            buttonText: _2fa_1.helptext2fa.two_factor.renewSecret.btn,
        });
        expect(ws.call).toHaveBeenCalledWith('user.renew_2fa_secret', ['dummy', {
                interval: 30,
                otp_digits: 6,
            }]);
    }));
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21hY2Jvb2sva2FycG92LXdvcmsvVHJ1ZU5BUy93ZWJ1aS9zcmMvYXBwL3BhZ2VzL3R3by1mYWN0b3ItYXV0aC9jb21wb25lbnRzL3R3by1mYWN0b3IvdHdvLWZhY3Rvci5jb21wb25lbnQuc3BlYy50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUNBLDBEQUF5RTtBQUN6RSw4REFBb0U7QUFDcEUsaURBQXlGO0FBQ3pGLHVDQUF5QztBQUN6QywrQkFBMEI7QUFDMUIsc0ZBQXNGO0FBQ3RGLGtEQUFzRDtBQUd0RCxpR0FBNEY7QUFDNUYsc0VBQWtFO0FBQ2xFLGdIQUEyRztBQUMzRyx1SEFBa0g7QUFDbEgsK0dBQTBHO0FBQzFHLGlFQUE2RDtBQUM3RCx3REFBMkQ7QUFFM0QsUUFBUSxDQUFDLG9CQUFvQixFQUFFLEdBQUcsRUFBRTtJQUNsQyxJQUFJLFNBQXdDLENBQUM7SUFDN0MsSUFBSSxNQUFxQixDQUFDO0lBQzFCLElBQUksRUFBb0IsQ0FBQztJQUV6QixNQUFNLGVBQWUsR0FBRyxJQUFBLDZCQUFzQixFQUFDO1FBQzdDLFNBQVMsRUFBRSx5Q0FBa0I7UUFDN0IsWUFBWSxFQUFFO1lBQ1osSUFBQSx3QkFBYSxFQUFDLHlDQUFrQixDQUFDO1lBQ2pDLElBQUEsd0JBQWEsRUFBQyx1Q0FBaUIsQ0FBQztZQUNoQyxJQUFBLHdCQUFhLEVBQUMsMkNBQW1CLENBQUM7U0FDbkM7UUFDRCxTQUFTLEVBQUU7WUFDVCxJQUFBLG1CQUFZLEVBQUMsOEJBQWEsRUFBRTtnQkFDMUIsT0FBTyxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBQSxTQUFFLEVBQUMsSUFBSSxDQUFDLENBQUM7YUFDakMsQ0FBQztZQUNGLElBQUEsb0NBQWEsRUFBQztnQkFDWixJQUFBLCtCQUFRLEVBQUMsdUJBQXVCLENBQUM7YUFDbEMsQ0FBQztZQUNGLElBQUEsbUJBQVksRUFBQywwQkFBVyxFQUFFO2dCQUN4QixLQUFLLEVBQUUsSUFBQSxTQUFFLEVBQUM7b0JBQ1Is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QUFNLFFBQVEsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUV2QixNQUFNLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyw4QkFBYSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsb0JBQW9CLENBQUM7WUFDbkUsS0FBSyxFQUFFLGtCQUFXLENBQUMsVUFBVSxDQUFDLFdBQVcsQ0FBQyxLQUFLO1lBQy9DLE9BQU8sRUFBRSxrQkFBVyxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsT0FBTztZQUNuRCxZQUFZLEVBQUUsSUFBSTtZQUNsQixVQUFVLEVBQUUsa0JBQVcsQ0FBQyxVQUFVLENBQUMsV0FBVyxDQUFDLEdBQUc7U0FDbkQsQ0FBQyxDQUFDO1FBRUgsTUFBTSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxvQkFBb0IsQ0FBQyx1QkFBdUIsRUFBRSxDQUFDLE9BQU8sRUFBRTtnQkFDdEUsUUFBUSxFQUFFLEVBQUU7Z0JBQ1osVUFBVSxFQUFFLENBQUM7YUFDZCxDQUFDLENBQUMsQ0FBQztJQUNOLENBQUMsQ0FBQSxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvbWFjYm9vay9rYXJwb3Ytd29yay9UcnVlTkFTL3dlYnVpL3NyYy9hcHAvcGFnZXMvdHdvLWZhY3Rvci1hdXRoL2NvbXBvbmVudHMvdHdvLWZhY3Rvci90d28tZmFjdG9yLmNvbXBvbmVudC5zcGVjLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEhhcm5lc3NMb2FkZXIgfSBmcm9tICdAYW5ndWxhci9jZGsvdGVzdGluZyc7XG5pbXBvcnQgeyBUZXN0YmVkSGFybmVzc0Vudmlyb25tZW50IH0gZnJvbSAnQGFuZ3VsYXIvY2RrL3Rlc3RpbmcvdGVzdGJlZCc7XG5pbXBvcnQgeyBNYXRCdXR0b25IYXJuZXNzIH0gZnJvbSAnQGFuZ3VsYXIvbWF0ZXJpYWwvYnV0dG9uL3Rlc3RpbmcnO1xuaW1wb3J0IHsgU3BlY3RhdG9yLCBjcmVhdGVDb21wb25lbnRGYWN0b3J5LCBtb2NrUHJvdmlkZXIgfSBmcm9tICdAbmduZWF0L3NwZWN0YXRvci9qZXN0JztcbmltcG9ydCB7IE1vY2tDb21wb25lbnQgfSBmcm9tICduZy1tb2Nrcyc7XG5pbXBvcnQgeyBvZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgbW9ja0NhbGwsIG1vY2tXZWJTb2NrZXQgfSBmcm9tICdhcHAvY29yZS90ZXN0aW5nL3V0aWxzL21vY2std2Vic29ja2V0LnV0aWxzJztcbmltcG9ydCB7IGhlbHB0ZXh0MmZhIH0gZnJvbSAnYXBwL2hlbHB0ZXh0L3N5c3RlbS8yZmEnO1xuaW1wb3J0IHsgTG9nZ2VkSW5Vc2VyIH0gZnJvbSAnYXBwL2ludGVyZmFjZXMvZHMtY2FjaGUuaW50ZXJmYWNlJztcbmltcG9ydCB7IEdsb2JhbFR3b0ZhY3RvckNvbmZpZywgVXNlclR3b0ZhY3RvckNvbmZpZyB9IGZyb20gJ2FwcC9pbnRlcmZhY2VzL3R3by1mYWN0b3ItY29uZmlnLmludGVyZmFjZSc7XG5pbXBvcnQgeyBDb3B5QnV0dG9uQ29tcG9uZW50IH0gZnJvbSAnYXBwL21vZHVsZXMvYnV0dG9ucy9jb3B5LWJ1dHRvbi9jb3B5LWJ1dHRvbi5jb21wb25lbnQnO1xuaW1wb3J0IHsgRGlhbG9nU2VydmljZSB9IGZyb20gJ2FwcC9tb2R1bGVzL2RpYWxvZy9kaWFsb2cuc2VydmljZSc7XG5pbXBvcnQgeyBJeFdhcm5pbmdDb21wb25lbnQgfSBmcm9tICdhcHAvbW9kdWxlcy9mb3Jtcy9peC1mb3Jtcy9jb21wb25lbnRzL2l4LXdhcm5pbmcvaXgtd2FybmluZy5jb21wb25lbnQnO1xuaW1wb3J0IHsgUXJWaWV3ZXJDb21wb25lbnQgfSBmcm9tICdhcHAvcGFnZXMvdHdvLWZhY3Rvci1hdXRoL2NvbXBvbmVudHMvdHdvLWZhY3Rvci9xci12aWV3ZXIvcXItdmlld2VyLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBUd29GYWN0b3JDb21wb25lbnQgfSBmcm9tICdhcHAvcGFnZXMvdHdvLWZhY3Rvci1hdXRoL2NvbXBvbmVudHMvdHdvLWZhY3Rvci90d28tZmFjdG9yLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBBdXRoU2VydmljZSB9IGZyb20gJ2FwcC9zZXJ2aWNlcy9hdXRoL2F1dGguc2VydmljZSc7XG5pbXBvcnQgeyBXZWJTb2NrZXRTZXJ2aWNlIH0gZnJvbSAnYXBwL3NlcnZpY2VzL3dzLnNlcnZpY2UnO1xuXG5kZXNjcmliZSgnVHdvRmFjdG9yQ29tcG9uZW50JywgKCkgPT4ge1xuICBsZXQgc3BlY3RhdG9yOiBTcGVjdGF0b3I8VHdvRmFjdG9yQ29tcG9uZW50PjtcbiAgbGV0IGxvYWRlcjogSGFybmVzc0xvYWRlcjtcbiAgbGV0IHdzOiBXZWJTb2NrZXRTZXJ2aWNlO1xuXG4gIGNvbnN0IGNyZWF0ZUNvbXBvbmVudCA9IGNyZWF0ZUNvbXBvbmVudEZhY3Rvcnkoe1xuICAgIGNvbXBvbmVudDogVHdvRmFjdG9yQ29tcG9uZW50LFxuICAgIGRlY2xhcmF0aW9uczogW1xuICAgICAgTW9ja0NvbXBvbmVudChJeFdhcm5pbmdDb21wb25lbnQpLFxuICAgICAgTW9ja0NvbXBvbmVudChRclZpZXdlckNvbXBvbmVudCksXG4gICAgICBNb2NrQ29tcG9uZW50KENvcHlCdXR0b25Db21wb25lbnQpLFxuICAgIF0sXG4gICAgcHJvdmlkZXJzOiBbXG4gICAgICBtb2NrUHJvdmlkZXIoRGlhbG9nU2VydmljZSwge1xuICAgICAgICBjb25maXJtOiBqZXN0LmZuKCgpID0+IG9mKHRydWUpKSxcbiAgICAgIH0pLFxuICAgICAgbW9ja1dlYlNvY2tldChbXG4gICAgICAgIG1vY2tDYWxsKCd1c2VyLnJlbmV3XzJmYV9zZWNyZXQnKSxcbiAgICAgIF0pLFxuICAgICAgbW9ja1Byb3ZpZGVyKEF1dGhTZXJ2aWNlLCB7XG4gICAgICAgIHVzZXIkOiBvZih7XG4gICAgICAgICAgcHdfbmFtZTogJ2R1bW15JyxcbiAgICAgICAgICB0d29fZmFjdG9yX2NvbmZpZzoge1xuICAgICAgICAgICAgc2VjcmV0X2NvbmZpZ3VyZWQ6IHRydWUsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSBhcyBMb2dnZWRJblVzZXIpLFxuICAgICAgICB1c2VyVHdvRmFjdG9yQ29uZmlnJDogb2Yoe1xuICAgICAgICAgIHByb3Zpc2lvbmluZ191cmk6ICdzb21lcGF0aDovL2hlcmUvaVhzeXN0ZW1zOmZpcnN0LXRlc3Q/c2VjcmV0PUtZQycsXG4gICAgICAgICAgaW50ZXJ2YWw6IDMwLFxuICAgICAgICAgIG90cF9kaWdpdHM6IDYsXG4gICAgICAgICAgc2VjcmV0X2NvbmZpZ3VyZWQ6IHRydWUsXG4gICAgICAgIH0gYXMgVXNlclR3b0ZhY3RvckNvbmZpZyksXG4gICAgICAgIGdldEdsb2JhbFR3b0ZhY3RvckNvbmZpZzogamVzdC5mbigoKSA9PiBvZih7IGVuYWJsZWQ6IGZhbHNlIH0gYXMgR2xvYmFsVHdvRmFjdG9yQ29uZmlnKSksXG4gICAgICB9KSxcbiAgICBdLFxuICB9KTtcblxuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICBzcGVjdGF0b3IgPSBjcmVhdGVDb21wb25lbnQoKTtcbiAgICBsb2FkZXIgPSBUZXN0YmVkSGFybmVzc0Vudmlyb25tZW50LmxvYWRlcihzcGVjdGF0b3IuZml4dHVyZSk7XG4gICAgd3MgPSBzcGVjdGF0b3IuaW5qZWN0KFdlYlNvY2tldFNlcnZpY2UpO1xuICB9KTtcblxuICBpdCgnc2hvd3Mgd2FybmluZyB3aGVuIGdsb2JhbCBzZXR0aW5nIGlzIGRpc2FibGVkJywgKCkgPT4ge1xuICAgIGplc3Quc3B5T24oc3BlY3RhdG9yLmluamVjdChBdXRoU2VydmljZSksICdnZXRHbG9iYWxUd29GYWN0b3JDb25maWcnKS5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gb2Yoe1xuICAgICAgZW5hYmxlZDogdHJ1ZSxcbiAgICB9IGFzIEdsb2JhbFR3b0ZhY3RvckNvbmZpZykpO1xuICAgIGNvbnN0IHdhcm5pbmcgPSBzcGVjdGF0b3IucXVlcnkoSXhXYXJuaW5nQ29tcG9uZW50KTtcbiAgICBleHBlY3Qod2FybmluZykudG9CZVRydXRoeSgpO1xuICAgIGV4cGVjdCh3YXJuaW5nKS50b0hhdmVBdHRyaWJ1dGUoJ21lc3NhZ2UnLCBoZWxwdGV4dDJmYS50d29fZmFjdG9yLmdsb2JhbF9kaXNhYmxlZCk7XG4gIH0pO1xuXG4gIGl0KCdzaG93cyB3YXJuaW5nIHdoZW4gZ2xvYmFsIHNldHRpbmcgaXMgZW5hYmxlZCBidXQgdXNlciBkaXNhYmxlZCcsICgpID0+IHtcbiAgICBzcGVjdGF0b3IuY29tcG9uZW50Lm5nT25Jbml0KCk7XG4gICAgc3BlY3RhdG9yLmNvbXBvbmVudC51c2VyVHdvRmFjdG9yQXV0aENvbmZpZ3VyZWQgPSBmYWxzZTtcbiAgICBzcGVjdGF0b3IuZGV0ZWN0Q2hhbmdlcygpO1xuICAgIGNvbnN0IHdhcm5pbmcgPSBzcGVjdGF0b3IucXVlcnkoSXhXYXJuaW5nQ29tcG9uZW50KTtcbiAgICBleHBlY3Qod2FybmluZykudG9CZVRydXRoeSgpO1xuICAgIGV4cGVjdCh3YXJuaW5nKS50b0hhdmVBdHRyaWJ1dGUoJ21lc3NhZ2UnLCBoZWxwdGV4dDJmYS50d29fZmFjdG9yLmdsb2JhbF9lbmFibGVkX3VzZXJfZGlzYWJsZWQpO1xuICB9KTtcblxuICBpdCgnc2hvd3Mgd2FybmluZyB3aGVuIGdsb2JhbCBzZXR0aW5nIGlzIGVuYWJsZWQgYW5kIHVzZXIgZW5hYmxlZCcsICgpID0+IHtcbiAgICBzcGVjdGF0b3IuY29tcG9uZW50Lm5nT25Jbml0KCk7XG4gICAgc3BlY3RhdG9yLmRldGVjdENoYW5nZXMoKTtcbiAgICBjb25zdCB3YXJuaW5nID0gc3BlY3RhdG9yLnF1ZXJ5KEl4V2FybmluZ0NvbXBvbmVudCk7XG4gICAgZXhwZWN0KHdhcm5pbmcpLnRvQmVUcnV0aHkoKTtcbiAgICBleHBlY3Qod2FybmluZykudG9IYXZlQXR0cmlidXRlKCdtZXNzYWdlJywgaGVscHRleHQyZmEudHdvX2ZhY3Rvci5nbG9iYWxfZW5hYmxlZF91c2VyX2VuYWJsZWQpO1xuICB9KTtcblxuICBpdCgncmVuZXdzIHNlY3JldCB3aGVuIGJ1dHRvbiBpcyBjbGlja2VkJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHJlbmV3QnRuID0gYXdhaXQgbG9hZGVyLmdldEhhcm5lc3MoTWF0QnV0dG9uSGFybmVzcy53aXRoKHsgdGV4dDogJ1JlbmV3IDJGQSBTZWNyZXQnIH0pKTtcbiAgICBhd2FpdCByZW5ld0J0bi5jbGljaygpO1xuXG4gICAgZXhwZWN0KHNwZWN0YXRvci5pbmplY3QoRGlhbG9nU2VydmljZSkuY29uZmlybSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoe1xuICAgICAgdGl0bGU6IGhlbHB0ZXh0MmZhLnR3b19mYWN0b3IucmVuZXdTZWNyZXQudGl0bGUsXG4gICAgICBtZXNzYWdlOiBoZWxwdGV4dDJmYS50d29fZmFjdG9yLnJlbmV3U2VjcmV0Lm1lc3NhZ2UsXG4gICAgICBoaWRlQ2hlY2tib3g6IHRydWUsXG4gICAgICBidXR0b25UZXh0OiBoZWxwdGV4dDJmYS50d29fZmFjdG9yLnJlbmV3U2VjcmV0LmJ0bixcbiAgICB9KTtcblxuICAgIGV4cGVjdCh3cy5jYWxsKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgndXNlci5yZW5ld18yZmFfc2VjcmV0JywgWydkdW1teScsIHtcbiAgICAgIGludGVydmFsOiAzMCxcbiAgICAgIG90cF9kaWdpdHM6IDYsXG4gICAgfV0pO1xuICB9KTtcbn0pO1xuIl0sInZlcnNpb24iOjN9