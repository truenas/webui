23af97e026dc085ef1a63f1fdb78f60c
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.FormErrorHandlerService = void 0;
const common_1 = require("@angular/common");
const core_1 = require("@angular/core");
const response_error_type_enum_1 = require("app/enums/response-error-type.enum");
const dialog_service_1 = require("app/modules/dialog/dialog.service");
const ix_form_service_1 = require("app/modules/forms/ix-forms/services/ix-form.service");
const error_handler_service_1 = require("app/services/error-handler.service");
let FormErrorHandlerService = class FormErrorHandlerService {
    constructor(dialog, errorHandler, formService, document) {
        this.dialog = dialog;
        this.errorHandler = errorHandler;
        this.formService = formService;
        this.document = document;
        this.isOnErrorFocused = false;
        this.needToShowError = false;
    }
    /**
     * @param error
     * @param formGroup
     * @param fieldsMap Overrides backend field names with frontend field names.
     * TODO: See if second `string` in fieldsMap can be typed to key of formGroup.
     */
    handleWsFormError(error, formGroup, fieldsMap = {}, triggerAnchor = undefined) {
        if (this.errorHandler.isWebSocketError(error) && error.type === response_error_type_enum_1.ResponseErrorType.Validation && error.extra) {
            this.handleValidationError(error, formGroup, fieldsMap, triggerAnchor);
            return;
        }
        if (this.errorHandler.isJobError(error)
            && error.exc_info.type === response_error_type_enum_1.ResponseErrorType.Validation
            && error.exc_info.extra) {
            this.handleValidationError(Object.assign(Object.assign({}, error), { extra: error.exc_info.extra }), formGroup, fieldsMap, triggerAnchor);
            return;
        }
        // Fallback to old error handling
        this.dialog.error(this.errorHandler.parseError(error));
    }
    handleValidationError(error, formGroup, fieldsMap, triggerAnchor) {
        this.isOnErrorFocused = false;
        this.needToShowError = false;
        const extra = error.extra;
        for (const extraItem of extra) {
            const field = extraItem[0].split('.').pop();
            const errorMessage = extraItem[1];
            const control = this.getFormField(formGroup, field, fieldsMap);
            const controlsNames = this.formService.getControlsNames();
            if (triggerAnchor && control && !controlsNames.includes(field)) {
                const triggerAnchorRef = this.document.getElementById(triggerAnchor);
                if (triggerAnchorRef) {
                    triggerAnchorRef.click();
                    setTimeout(() => {
                        this.showValidationError({
                            control: this.getFormField(formGroup, field, fieldsMap),
                            field,
                            errorMessage,
                            error,
                        });
                    });
                    return;
                }
            }
            this.showValidationError({
                control, field, errorMessage, error,
            });
        }
        if (this.needToShowError) {
            // Fallback to default modal error message.
            this.dialog.error(this.errorHandler.parseError(error));
        }
    }
    showValidationError({ control, field, error, errorMessage, }) {
        var _a;
        const controlsNames = this.formService.getControlsNames();
        if (!control || !controlsNames.includes(field)) {
            console.error(`Could not find control ${field}.`);
            this.needToShowError = true;
            return;
        }
        if ((_a = control.controls) === null || _a === void 0 ? void 0 : _a.length) {
            const isExactMatch = (text, match) => new RegExp(`\\b${match}\\b`).test(text);
            control = control.controls
                .find((controlOfArray) => isExactMatch(errorMessage, controlOfArray.value));
        }
        if (!control) {
            this.dialog.error(this.errorHandler.parseError(error));
        }
        else {
            control.setErrors({
                manualValidateError: true,
                manualValidateErrorMsg: errorMessage,
                ixManualValidateError: { message: errorMessage },
            });
            control.markAsTouched();
            const element = this.formService.getElementByControlName(field);
            if (element && !this.isOnErrorFocused) {
                element.scrollIntoView({ behavior: 'smooth' });
                element.focus();
                this.isOnErrorFocused = true;
            }
        }
    }
    getFormField(formGroup, field, fieldsMap) {
        var _a;
        const fieldName = (_a = fieldsMap[field]) !== null && _a !== void 0 ? _a : field;
        return formGroup.get(fieldName);
    }
};
exports.FormErrorHandlerService = FormErrorHandlerService;
FormErrorHandlerService.ctorParameters = () => [
    { type: dialog_service_1.DialogService },
    { type: error_handler_service_1.ErrorHandlerService },
    { type: ix_form_service_1.IxFormService },
    { type: Document, decorators: [{ type: core_1.Inject, args: [common_1.DOCUMENT,] }] }
];
exports.FormErrorHandlerService = FormErrorHandlerService = __decorate([
    (0, core_1.Injectable)({ providedIn: 'root' })
], FormErrorHandlerService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21hY2Jvb2sva2FycG92LXdvcmsvVHJ1ZU5BUy93ZWJ1aS9zcmMvYXBwL21vZHVsZXMvZm9ybXMvaXgtZm9ybXMvc2VydmljZXMvZm9ybS1lcnJvci1oYW5kbGVyLnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUEsNENBQTJDO0FBQzNDLHdDQUFtRDtBQUVuRCxpRkFBdUU7QUFHdkUsc0VBQWtFO0FBQ2xFLHlGQUFvRjtBQUNwRiw4RUFBeUU7QUFHbEUsSUFBTSx1QkFBdUIsR0FBN0IsTUFBTSx1QkFBdUI7SUFJbEMsWUFDVSxNQUFxQixFQUNyQixZQUFpQyxFQUNqQyxXQUEwQixFQUNSLFFBQWtCO1FBSHBDLFdBQU0sR0FBTixNQUFNLENBQWU7UUFDckIsaUJBQVksR0FBWixZQUFZLENBQXFCO1FBQ2pDLGdCQUFXLEdBQVgsV0FBVyxDQUFlO1FBQ1IsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQVB0QyxxQkFBZ0IsR0FBRyxLQUFLLENBQUM7UUFDekIsb0JBQWUsR0FBRyxLQUFLLENBQUM7SUFPN0IsQ0FBQztJQUVKOzs7OztPQUtHO0lBQ0gsaUJBQWlCLENBQ2YsS0FBYyxFQUNkLFNBQTJCLEVBQzNCLFlBQW9DLEVBQUUsRUFDdEMsZ0JBQXdCLFNBQVM7UUFFakMsSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLGdCQUFnQixDQUFDLEtBQUssQ0FBQyxJQUFJLEtBQUssQ0FBQyxJQUFJLEtBQUssNENBQWlCLENBQUMsVUFBVSxJQUFJLEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUM1RyxJQUFJLENBQUMscUJBQXFCLENBQUMsS0FBSyxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsYUFBYSxDQUFDLENBQUM7WUFDdkUsT0FBTztRQUNULENBQUM7UUFFRCxJQUNFLElBQUksQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQztlQUNoQyxLQUFLLENBQUMsUUFBUSxDQUFDLElBQUksS0FBSyw0Q0FBaUIsQ0FBQyxVQUFVO2VBQ3BELEtBQUssQ0FBQyxR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QSxTQUFTLENBQUMsS0FBSyxDQUFDLG1DQUFJLEtBQUssQ0FBQztRQUM1QyxPQUFPLFNBQVMsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDbEMsQ0FBQzs7QUF0SVUsMERBQXVCOzs7OzsyQ0FRL0IsYUFBTSxTQUFDLGlCQUFROztrQ0FSUCx1QkFBdUI7SUFEbkMsSUFBQSxpQkFBVSxFQUFDLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxDQUFDO0dBQ3RCLHVCQUF1QixDQXVJbkMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL21hY2Jvb2sva2FycG92LXdvcmsvVHJ1ZU5BUy93ZWJ1aS9zcmMvYXBwL21vZHVsZXMvZm9ybXMvaXgtZm9ybXMvc2VydmljZXMvZm9ybS1lcnJvci1oYW5kbGVyLnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRE9DVU1FTlQgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuaW1wb3J0IHsgSW5qZWN0LCBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBBYnN0cmFjdENvbnRyb2wsIFVudHlwZWRGb3JtQXJyYXksIFVudHlwZWRGb3JtR3JvdXAgfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XG5pbXBvcnQgeyBSZXNwb25zZUVycm9yVHlwZSB9IGZyb20gJ2FwcC9lbnVtcy9yZXNwb25zZS1lcnJvci10eXBlLmVudW0nO1xuaW1wb3J0IHsgSm9iIH0gZnJvbSAnYXBwL2ludGVyZmFjZXMvam9iLmludGVyZmFjZSc7XG5pbXBvcnQgeyBXZWJTb2NrZXRFcnJvciB9IGZyb20gJ2FwcC9pbnRlcmZhY2VzL3dlYnNvY2tldC1lcnJvci5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgRGlhbG9nU2VydmljZSB9IGZyb20gJ2FwcC9tb2R1bGVzL2RpYWxvZy9kaWFsb2cuc2VydmljZSc7XG5pbXBvcnQgeyBJeEZvcm1TZXJ2aWNlIH0gZnJvbSAnYXBwL21vZHVsZXMvZm9ybXMvaXgtZm9ybXMvc2VydmljZXMvaXgtZm9ybS5zZXJ2aWNlJztcbmltcG9ydCB7IEVycm9ySGFuZGxlclNlcnZpY2UgfSBmcm9tICdhcHAvc2VydmljZXMvZXJyb3ItaGFuZGxlci5zZXJ2aWNlJztcblxuQEluamVjdGFibGUoeyBwcm92aWRlZEluOiAncm9vdCcgfSlcbmV4cG9ydCBjbGFzcyBGb3JtRXJyb3JIYW5kbGVyU2VydmljZSB7XG4gIHByaXZhdGUgaXNPbkVycm9yRm9jdXNlZCA9IGZhbHNlO1xuICBwcml2YXRlIG5lZWRUb1Nob3dFcnJvciA9IGZhbHNlO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgZGlhbG9nOiBEaWFsb2dTZXJ2aWNlLFxuICAgIHByaXZhdGUgZXJyb3JIYW5kbGVyOiBFcnJvckhhbmRsZXJTZXJ2aWNlLFxuICAgIHByaXZhdGUgZm9ybVNlcnZpY2U6IEl4Rm9ybVNlcnZpY2UsXG4gICAgQEluamVjdChET0NVTUVOVCkgcHJpdmF0ZSBkb2N1bWVudDogRG9jdW1lbnQsXG4gICkge31cblxuICAvKipcbiAgICogQHBhcmFtIGVycm9yXG4gICAqIEBwYXJhbSBmb3JtR3JvdXBcbiAgICogQHBhcmFtIGZpZWxkc01hcCBPdmVycmlkZXMgYmFja2VuZCBmaWVsZCBuYW1lcyB3aXRoIGZyb250ZW5kIGZpZWxkIG5hbWVzLlxuICAgKiBUT0RPOiBTZWUgaWYgc2Vjb25kIGBzdHJpbmdgIGluIGZpZWxkc01hcCBjYW4gYmUgdHlwZWQgdG8ga2V5IG9mIGZvcm1Hcm91cC5cbiAgICovXG4gIGhhbmRsZVdzRm9ybUVycm9yKFxuICAgIGVycm9yOiB1bmtub3duLFxuICAgIGZvcm1Hcm91cDogVW50eXBlZEZvcm1Hcm91cCxcbiAgICBmaWVsZHNNYXA6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7fSxcbiAgICB0cmlnZ2VyQW5jaG9yOiBzdHJpbmcgPSB1bmRlZmluZWQsXG4gICk6IHZvaWQge1xuICAgIGlmICh0aGlzLmVycm9ySGFuZGxlci5pc1dlYlNvY2tldEVycm9yKGVycm9yKSAmJiBlcnJvci50eXBlID09PSBSZXNwb25zZUVycm9yVHlwZS5WYWxpZGF0aW9uICYmIGVycm9yLmV4dHJhKSB7XG4gICAgICB0aGlzLmhhbmRsZVZhbGlkYXRpb25FcnJvcihlcnJvciwgZm9ybUdyb3VwLCBmaWVsZHNNYXAsIHRyaWdnZXJBbmNob3IpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmIChcbiAgICAgIHRoaXMuZXJyb3JIYW5kbGVyLmlzSm9iRXJyb3IoZXJyb3IpXG4gICAgICAmJiBlcnJvci5leGNfaW5mby50eXBlID09PSBSZXNwb25zZUVycm9yVHlwZS5WYWxpZGF0aW9uXG4gICAgICAmJiBlcnJvci5leGNfaW5mby5leHRyYVxuICAgICkge1xuICAgICAgdGhpcy5oYW5kbGVWYWxpZGF0aW9uRXJyb3IoXG4gICAgICAgIHsgLi4uZXJyb3IsIGV4dHJhOiBlcnJvci5leGNfaW5mby5leHRyYSBhcyBKb2JbJ2V4dHJhJ10gfSxcbiAgICAgICAgZm9ybUdyb3VwLFxuICAgICAgICBmaWVsZHNNYXAsXG4gICAgICAgIHRyaWdnZXJBbmNob3IsXG4gICAgICApO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIEZhbGxiYWNrIHRvIG9sZCBlcnJvciBoYW5kbGluZ1xuICAgIHRoaXMuZGlhbG9nLmVycm9yKHRoaXMuZXJyb3JIYW5kbGVyLnBhcnNlRXJyb3IoZXJyb3IpKTtcbiAgfVxuXG4gIHByaXZhdGUgaGFuZGxlVmFsaWRhdGlvbkVycm9yKFxuICAgIGVycm9yOiBXZWJTb2NrZXRFcnJvciB8IEpvYixcbiAgICBmb3JtR3JvdXA6IFVudHlwZWRGb3JtR3JvdXAsXG4gICAgZmllbGRzTWFwOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+LFxuICAgIHRyaWdnZXJBbmNob3I6IHN0cmluZyxcbiAgKTogdm9pZCB7XG4gICAgdGhpcy5pc09uRXJyb3JGb2N1c2VkID0gZmFsc2U7XG4gICAgdGhpcy5uZWVkVG9TaG93RXJyb3IgPSBmYWxzZTtcbiAgICBjb25zdCBleHRyYSA9IChlcnJvciBhcyBXZWJTb2NrZXRFcnJvcikuZXh0cmEgYXMgc3RyaW5nW11bXTtcbiAgICBmb3IgKGNvbnN0IGV4dHJhSXRlbSBvZiBleHRyYSkge1xuICAgICAgY29uc3QgZmllbGQgPSBleHRyYUl0ZW1bMF0uc3BsaXQoJy4nKS5wb3AoKTtcbiAgICAgIGNvbnN0IGVycm9yTWVzc2FnZSA9IGV4dHJhSXRlbVsxXTtcblxuICAgICAgY29uc3QgY29udHJvbCA9IHRoaXMuZ2V0Rm9ybUZpZWxkKGZvcm1Hcm91cCwgZmllbGQsIGZpZWxkc01hcCk7XG4gICAgICBjb25zdCBjb250cm9sc05hbWVzID0gdGhpcy5mb3JtU2VydmljZS5nZXRDb250cm9sc05hbWVzKCk7XG5cbiAgICAgIGlmICh0cmlnZ2VyQW5jaG9yICYmIGNvbnRyb2wgJiYgIWNvbnRyb2xzTmFtZXMuaW5jbHVkZXMoZmllbGQpKSB7XG4gICAgICAgIGNvbnN0IHRyaWdnZXJBbmNob3JSZWY6IEhUTUxFbGVtZW50ID0gdGhpcy5kb2N1bWVudC5nZXRFbGVtZW50QnlJZCh0cmlnZ2VyQW5jaG9yKTtcbiAgICAgICAgaWYgKHRyaWdnZXJBbmNob3JSZWYpIHtcbiAgICAgICAgICB0cmlnZ2VyQW5jaG9yUmVmLmNsaWNrKCk7XG4gICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnNob3dWYWxpZGF0aW9uRXJyb3Ioe1xuICAgICAgICAgICAgICBjb250cm9sOiB0aGlzLmdldEZvcm1GaWVsZChmb3JtR3JvdXAsIGZpZWxkLCBmaWVsZHNNYXApLFxuICAgICAgICAgICAgICBmaWVsZCxcbiAgICAgICAgICAgICAgZXJyb3JNZXNzYWdlLFxuICAgICAgICAgICAgICBlcnJvcixcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0pO1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICB0aGlzLnNob3dWYWxpZGF0aW9uRXJyb3Ioe1xuICAgICAgICBjb250cm9sLCBmaWVsZCwgZXJyb3JNZXNzYWdlLCBlcnJvcixcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGlmICh0aGlzLm5lZWRUb1Nob3dFcnJvcikge1xuICAgICAgLy8gRmFsbGJhY2sgdG8gZGVmYXVsdCBtb2RhbCBlcnJvciBtZXNzYWdlLlxuICAgICAgdGhpcy5kaWFsb2cuZXJyb3IodGhpcy5lcnJvckhhbmRsZXIucGFyc2VFcnJvcihlcnJvcikpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgc2hvd1ZhbGlkYXRpb25FcnJvcih7XG4gICAgY29udHJvbCwgZmllbGQsIGVycm9yLCBlcnJvck1lc3NhZ2UsXG4gIH06IHtcbiAgICBjb250cm9sOiBBYnN0cmFjdENvbnRyb2w7XG4gICAgZmllbGQ6IHN0cmluZztcbiAgICBlcnJvck1lc3NhZ2U6IHN0cmluZztcbiAgICBlcnJvcjogV2ViU29ja2V0RXJyb3IgfCBKb2I7XG4gIH0pOiB2b2lkIHtcbiAgICBjb25zdCBjb250cm9sc05hbWVzID0gdGhpcy5mb3JtU2VydmljZS5nZXRDb250cm9sc05hbWVzKCk7XG5cbiAgICBpZiAoIWNvbnRyb2wgfHwgIWNvbnRyb2xzTmFtZXMuaW5jbHVkZXMoZmllbGQpKSB7XG4gICAgICBjb25zb2xlLmVycm9yKGBDb3VsZCBub3QgZmluZCBjb250cm9sICR7ZmllbGR9LmApO1xuICAgICAgdGhpcy5uZWVkVG9TaG93RXJyb3IgPSB0cnVlO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICgoY29udHJvbCBhcyBVbnR5cGVkRm9ybUFycmF5KS5jb250cm9scz8ubGVuZ3RoKSB7XG4gICAgICBjb25zdCBpc0V4YWN0TWF0Y2ggPSAodGV4dDogc3RyaW5nLCBtYXRjaDogc3RyaW5nKTogYm9vbGVhbiA9PiBuZXcgUmVnRXhwKGBcXFxcYiR7bWF0Y2h9XFxcXGJgKS50ZXN0KHRleHQpO1xuXG4gICAgICBjb250cm9sID0gKGNvbnRyb2wgYXMgVW50eXBlZEZvcm1BcnJheSkuY29udHJvbHNcbiAgICAgICAgLmZpbmQoKGNvbnRyb2xPZkFycmF5KSA9PiBpc0V4YWN0TWF0Y2goZXJyb3JNZXNzYWdlLCBjb250cm9sT2ZBcnJheS52YWx1ZSBhcyBzdHJpbmcpKTtcbiAgICB9XG5cbiAgICBpZiAoIWNvbnRyb2wpIHtcbiAgICAgIHRoaXMuZGlhbG9nLmVycm9yKHRoaXMuZXJyb3JIYW5kbGVyLnBhcnNlRXJyb3IoZXJyb3IpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29udHJvbC5zZXRFcnJvcnMoe1xuICAgICAgICBtYW51YWxWYWxpZGF0ZUVycm9yOiB0cnVlLFxuICAgICAgICBtYW51YWxWYWxpZGF0ZUVycm9yTXNnOiBlcnJvck1lc3NhZ2UsXG4gICAgICAgIGl4TWFudWFsVmFsaWRhdGVFcnJvcjogeyBtZXNzYWdlOiBlcnJvck1lc3NhZ2UgfSxcbiAgICAgIH0pO1xuICAgICAgY29udHJvbC5tYXJrQXNUb3VjaGVkKCk7XG5cbiAgICAgIGNvbnN0IGVsZW1lbnQgPSB0aGlzLmZvcm1TZXJ2aWNlLmdldEVsZW1lbnRCeUNvbnRyb2xOYW1lKGZpZWxkKTtcbiAgICAgIGlmIChlbGVtZW50ICYmICF0aGlzLmlzT25FcnJvckZvY3VzZWQpIHtcbiAgICAgICAgZWxlbWVudC5zY3JvbGxJbnRvVmlldyh7IGJlaGF2aW9yOiAnc21vb3RoJyB9KTtcbiAgICAgICAgZWxlbWVudC5mb2N1cygpO1xuICAgICAgICB0aGlzLmlzT25FcnJvckZvY3VzZWQgPSB0cnVlO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZ2V0Rm9ybUZpZWxkKGZvcm1Hcm91cDogVW50eXBlZEZvcm1Hcm91cCwgZmllbGQ6IHN0cmluZywgZmllbGRzTWFwOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+KTogQWJzdHJhY3RDb250cm9sIHtcbiAgICBjb25zdCBmaWVsZE5hbWUgPSBmaWVsZHNNYXBbZmllbGRdID8/IGZpZWxkO1xuICAgIHJldHVybiBmb3JtR3JvdXAuZ2V0KGZpZWxkTmFtZSk7XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==