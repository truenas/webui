{"file":"/Users/macbook/karpov-work/TrueNAS/webui/src/app/modules/forms/ix-forms/components/ix-explorer/create-dataset-dialog/create-dataset-dialog.component.ts","mappings":"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","names":[],"sources":["/Users/macbook/karpov-work/TrueNAS/webui/src/app/modules/forms/ix-forms/components/ix-explorer/create-dataset-dialog/create-dataset-dialog.component.ts"],"sourcesContent":["import { CdkScrollable } from '@angular/cdk/scrolling';\nimport { AsyncPipe } from '@angular/common';\nimport {\n  Component, ChangeDetectionStrategy, Inject, ChangeDetectorRef, OnInit,\n} from '@angular/core';\nimport { Validators, FormsModule, ReactiveFormsModule } from '@angular/forms';\nimport { MatButton } from '@angular/material/button';\nimport {\n  MatDialogRef, MAT_DIALOG_DATA, MatDialogTitle, MatDialogContent, MatDialogActions, MatDialogClose,\n} from '@angular/material/dialog';\nimport { MatProgressBar } from '@angular/material/progress-bar';\nimport { FormBuilder } from '@ngneat/reactive-forms';\nimport { UntilDestroy, untilDestroyed } from '@ngneat/until-destroy';\nimport { TranslateModule } from '@ngx-translate/core';\nimport { BehaviorSubject } from 'rxjs';\nimport { nameValidatorRegex } from 'app/constants/name-validator.constant';\nimport { RequiresRolesDirective } from 'app/directives/requires-roles/requires-roles.directive';\nimport { DatasetCaseSensitivity } from 'app/enums/dataset.enum';\nimport { Role } from 'app/enums/role.enum';\nimport { Dataset, DatasetCreate } from 'app/interfaces/dataset.interface';\nimport { DialogService } from 'app/modules/dialog/dialog.service';\nimport { FormActionsComponent } from 'app/modules/forms/ix-forms/components/form-actions/form-actions.component';\nimport { IxInputComponent } from 'app/modules/forms/ix-forms/components/ix-input/ix-input.component';\nimport { forbiddenValues } from 'app/modules/forms/ix-forms/validators/forbidden-values-validation/forbidden-values-validation';\nimport { TestDirective } from 'app/modules/test-id/test.directive';\nimport { datasetNameTooLong } from 'app/pages/datasets/components/dataset-form/utils/name-length-validation';\nimport { ErrorHandlerService } from 'app/services/error-handler.service';\nimport { WebSocketService } from 'app/services/ws.service';\n\n@UntilDestroy()\n@Component({\n  selector: 'ix-create-dataset-dialog',\n  templateUrl: './create-dataset-dialog.component.html',\n  styleUrls: ['./create-dataset-dialog.component.scss'],\n  changeDetection: ChangeDetectionStrategy.OnPush,\n  standalone: true,\n  imports: [\n    MatDialogTitle,\n    MatProgressBar,\n    CdkScrollable,\n    MatDialogContent,\n    FormsModule,\n    ReactiveFormsModule,\n    IxInputComponent,\n    FormActionsComponent,\n    MatDialogActions,\n    MatButton,\n    MatDialogClose,\n    AsyncPipe,\n    TranslateModule,\n    RequiresRolesDirective,\n    TestDirective,\n  ],\n})\nexport class CreateDatasetDialogComponent implements OnInit {\n  readonly requiredRoles = [Role.DatasetWrite];\n\n  isLoading$ = new BehaviorSubject(false);\n  form = this.fb.group({\n    name: ['', [\n      Validators.required,\n      Validators.pattern(nameValidatorRegex),\n    ]],\n  });\n  parent: Dataset;\n\n  constructor(\n    private fb: FormBuilder,\n    private cdr: ChangeDetectorRef,\n    private ws: WebSocketService,\n    private dialog: DialogService,\n    private errorHandler: ErrorHandlerService,\n    private dialogRef: MatDialogRef<CreateDatasetDialogComponent>,\n    @Inject(MAT_DIALOG_DATA) private data: { parentId: string; dataset: DatasetCreate },\n  ) {}\n\n  ngOnInit(): void {\n    this.loadParentDataset();\n\n    this.isLoading$.pipe(untilDestroyed(this)).subscribe((isLoading) => {\n      if (isLoading) {\n        this.form.controls.name.disable();\n      } else {\n        this.form.controls.name.enable();\n      }\n    });\n  }\n\n  createDataset(): void {\n    this.isLoading$.next(true);\n    this.ws.call('pool.dataset.create', [{ ...this.data.dataset, name: `${this.parent.name}/${this.form.value.name}` }])\n      .pipe(untilDestroyed(this)).subscribe({\n        next: (dataset) => {\n          this.isLoading$.next(false);\n          this.dialogRef.close(dataset);\n        },\n        error: (error) => {\n          this.isLoading$.next(false);\n          this.dialog.error(this.errorHandler.parseError(error));\n        },\n      });\n  }\n\n  loadParentDataset(): void {\n    this.isLoading$.next(true);\n    this.ws.call('pool.dataset.query', [[['id', '=', this.data.parentId]]])\n      .pipe(untilDestroyed(this)).subscribe((parent) => {\n        this.isLoading$.next(false);\n        this.parent = parent[0];\n        this.cdr.markForCheck();\n        this.addNameValidators();\n      });\n  }\n\n  private addNameValidators(): void {\n    const isNameCaseSensitive = this.parent.casesensitivity.value === DatasetCaseSensitivity.Sensitive;\n    const namesInUse = this.parent.children.map((child) => {\n      const childName = /[^/]*$/.exec(child.name)[0];\n      if (isNameCaseSensitive) {\n        return childName.toLowerCase();\n      }\n\n      return childName;\n    });\n\n    this.form.controls.name.addValidators([\n      datasetNameTooLong(this.parent.name),\n      forbiddenValues(namesInUse, isNameCaseSensitive),\n    ]);\n  }\n}\n"],"version":3}