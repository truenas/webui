09a2d7fcfec58776b83798c58b77b9b9
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.TrainCardComponent = void 0;
const common_1 = require("@angular/common");
const core_1 = require("@angular/core");
const forms_1 = require("@angular/forms");
const button_1 = require("@angular/material/button");
const card_1 = require("@angular/material/card");
const progress_spinner_1 = require("@angular/material/progress-spinner");
const tooltip_1 = require("@angular/material/tooltip");
const until_destroy_1 = require("@ngneat/until-destroy");
const core_2 = require("@ngx-translate/core");
const rxjs_1 = require("rxjs");
const requires_roles_directive_1 = require("app/directives/requires-roles/requires-roles.directive");
const role_enum_1 = require("app/enums/role.enum");
const system_update_enum_1 = require("app/enums/system-update.enum");
const filter_async_operator_1 = require("app/helpers/operators/filter-async.operator");
const update_1 = require("app/helptext/system/update");
const dialog_service_1 = require("app/modules/dialog/dialog.service");
const ix_checkbox_component_1 = require("app/modules/forms/ix-forms/components/ix-checkbox/ix-checkbox.component");
const ix_select_component_1 = require("app/modules/forms/ix-forms/components/ix-select/ix-select.component");
const ix_icon_component_1 = require("app/modules/ix-icon/ix-icon.component");
const test_directive_1 = require("app/modules/test-id/test.directive");
const train_service_1 = require("app/pages/system/update/services/train.service");
const update_service_1 = require("app/pages/system/update/services/update.service");
const auth_service_1 = require("app/services/auth/auth.service");
const system_general_service_1 = require("app/services/system-general.service");
let TrainCardComponent = class TrainCardComponent {
    constructor(sysGenService, dialogService, translate, fb, authService, trainService, updateService, cdr) {
        this.sysGenService = sysGenService;
        this.dialogService = dialogService;
        this.translate = translate;
        this.fb = fb;
        this.authService = authService;
        this.trainService = trainService;
        this.updateService = updateService;
        this.cdr = cdr;
        this.isUpdateRunning = false;
        this.checkable = false;
        this.trains = [];
        this.form = this.fb.group({
            auto_check: [false],
            train: ['', forms_1.Validators.required],
        });
        this.requiredRoles = [role_enum_1.Role.FullAdmin];
        this.clickForInformationLink = update_1.helptextSystemUpdate.clickForInformationLink;
        this.SystemUpdateStatus = system_update_enum_1.SystemUpdateStatus;
        this.sysGenService.updateRunning.pipe((0, until_destroy_1.untilDestroyed)(this)).subscribe((isUpdating) => {
            this.isUpdateRunning = isUpdating === 'true';
            this.cdr.markForCheck();
        });
    }
    get trains$() {
        return (0, rxjs_1.of)(this.trains);
    }
    ngOnInit() {
        (0, rxjs_1.forkJoin)([
            this.trainService.getAutoDownload(),
            this.trainService.getTrains(),
        ]).pipe((0, until_destroy_1.untilDestroyed)(this)).subscribe({
            next: ([isAutoDownloadOn, trains]) => {
                var _a;
                this.form.controls.auto_check.patchValue(isAutoDownloadOn);
                this.checkable = true;
                this.cdr.markForCheck();
                this.trainService.fullTrainList$.next(trains.trains);
                this.trainService.trainValue$.next(trains.selected || '');
                this.trainService.selectedTrain$.next(trains.selected);
                if (isAutoDownloadOn) {
                    this.trainService.check();
                }
                this.trains = Object.entries(trains.trains).map(([name, train]) => ({
                    label: train.description,
                    value: name,
                }));
                if (this.trains.length > 0) {
                    this.singleDescription = (_a = Object.values(trains.trains)[0]) === null || _a === void 0 ? void 0 : _a.description;
                }
                let currentTrainDescription = '';
                if (trains.trains[trains.current]) {
                    if (trains.trains[trains.current].description.toLowerCase().includes('[nightly]')) {
                        currentTrainDescription = '[nightly]';
                    }
                    else if (trains.trains[trains.current].description.toLowerCase().includes('[release]')) {
                        currentTrainDescription = '[release]';
                    }
                    else if (trains.trains[trains.current].description.toLowerCase().includes('[prerelease]')) {
                        currentTrainDescription = '[prerelease]';
                    }
                    else {
                        currentTrainDescription = trains.trains[trains.selected].description.toLowerCase();
                    }
                }
                this.trainService.currentTrainDescription$.next(currentTrainDescription);
                // To remember train description if user switches away and then switches back
                this.trainService.trainDescriptionOnPageLoad$.next(currentTrainDescription);
                this.cdr.markForCheck();
            },
            error: (error) => {
                this.dialogService.warn(error.trace.class, this.translate.instant('TrueNAS was unable to reach update servers.'));
            },
        });
        this.trainService.trainValue$.pipe((0, until_destroy_1.untilDestroyed)(this)).subscribe((trainValue) => {
            this.form.controls.train.patchValue(trainValue);
        });
        this.form.controls.train.valueChanges.pipe((0, rxjs_1.pairwise)(), (0, until_destroy_1.untilDestroyed)(this)).subscribe(([prevTrain, newTrain]) => {
            this.trainService.onTrainChanged(newTrain, prevTrain);
        });
        this.form.controls.auto_check.valueChanges.pipe((0, filter_async_operator_1.filterAsync)(() => this.authService.hasRole(role_enum_1.Role.FullAdmin)), (0, until_destroy_1.untilDestroyed)(this)).subscribe(() => {
            this.trainService.toggleAutoCheck(this.form.controls.auto_check.value);
        });
    }
};
exports.TrainCardComponent = TrainCardComponent;
TrainCardComponent.ctorParameters = () => [
    { type: system_general_service_1.SystemGeneralService },
    { type: dialog_service_1.DialogService },
    { type: core_2.TranslateService },
    { type: forms_1.FormBuilder },
    { type: auth_service_1.AuthService },
    { type: train_service_1.TrainService },
    { type: update_service_1.UpdateService },
    { type: core_1.ChangeDetectorRef }
];
exports.TrainCardComponent = TrainCardComponent = __decorate([
    (0, until_destroy_1.UntilDestroy)(),
    (0, core_1.Component)({
        selector: 'ix-train-card',
        template: require("./train-card.component.html"),
        changeDetection: core_1.ChangeDetectionStrategy.OnPush,
        standalone: true,
        imports: [
            card_1.MatCard,
            progress_spinner_1.MatProgressSpinner,
            forms_1.ReactiveFormsModule,
            requires_roles_directive_1.RequiresRolesDirective,
            ix_checkbox_component_1.IxCheckboxComponent,
            ix_select_component_1.IxSelectComponent,
            button_1.MatMiniFabButton,
            tooltip_1.MatTooltip,
            test_directive_1.TestDirective,
            ix_icon_component_1.IxIconComponent,
            core_2.TranslateModule,
            common_1.AsyncPipe,
        ],
    })
], TrainCardComponent);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21hY2Jvb2sva2FycG92LXdvcmsvVHJ1ZU5BUy93ZWJ1aS9zcmMvYXBwL3BhZ2VzL3N5c3RlbS91cGRhdGUvY29tcG9uZW50cy90cmFpbi1jYXJkL3RyYWluLWNhcmQuY29tcG9uZW50LnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBLDRDQUE0QztBQUM1Qyx3Q0FFdUI7QUFDdkIsMENBQThFO0FBQzlFLHFEQUE0RDtBQUM1RCxpREFBaUQ7QUFDakQseUVBQXdFO0FBQ3hFLHVEQUF1RDtBQUN2RCx5REFBcUU7QUFDckUsOENBQXdFO0FBQ3hFLCtCQUVjO0FBQ2QscUdBQWdHO0FBQ2hHLG1EQUEyQztBQUMzQyxxRUFBa0U7QUFDbEUsdUZBQTBFO0FBQzFFLHVEQUFrRTtBQUdsRSxzRUFBa0U7QUFDbEUsbUhBQThHO0FBQzlHLDZHQUF3RztBQUN4Ryw2RUFBd0U7QUFDeEUsdUVBQW1FO0FBQ25FLGtGQUE4RTtBQUM5RSxvRkFBZ0Y7QUFDaEYsaUVBQTZEO0FBQzdELGdGQUEyRTtBQXdCcEUsSUFBTSxrQkFBa0IsR0FBeEIsTUFBTSxrQkFBa0I7SUFlN0IsWUFDVSxhQUFtQyxFQUNuQyxhQUE0QixFQUM1QixTQUEyQixFQUMzQixFQUFlLEVBQ2YsV0FBd0IsRUFDdEIsWUFBMEIsRUFDMUIsYUFBNEIsRUFDOUIsR0FBc0I7UUFQdEIsa0JBQWEsR0FBYixhQUFhLENBQXNCO1FBQ25DLGtCQUFhLEdBQWIsYUFBYSxDQUFlO1FBQzVCLGNBQVMsR0FBVCxTQUFTLENBQWtCO1FBQzNCLE9BQUUsR0FBRixFQUFFLENBQWE7UUFDZixnQkFBVyxHQUFYLFdBQVcsQ0FBYTtRQUN0QixpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQixrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQUM5QixRQUFHLEdBQUgsR0FBRyxDQUFtQjtRQXRCaEMsb0JBQWUsR0FBRyxLQUFLLENBQUM7UUFDeEIsY0FBUyxHQUFHLEtBQUssQ0FBQztRQUVsQixXQUFNLEdBQWEsRUFBRSxDQUFDO1FBRXRCLFNBQUksR0FB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ZUFBZSxFQUFFLDhCQUF1QixDQUFDLE1BQU07UUFDL0MsVUFBVSxFQUFFLElBQUk7UUFDaEIsT0FBTyxFQUFFO1lBQ1AsY0FBTztZQUNQLHFDQUFrQjtZQUNsQiwyQkFBbUI7WUFDbkIsaURBQXNCO1lBQ3RCLDJDQUFtQjtZQUNuQix1Q0FBaUI7WUFDakIseUJBQWdCO1lBQ2hCLG9CQUFVO1lBQ1YsOEJBQWE7WUFDYixtQ0FBZTtZQUNmLHNCQUFlO1lBQ2Ysa0JBQVM7U0FDVjtLQUNGLENBQUM7R0FDVyxrQkFBa0IsQ0F1RzlCIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9tYWNib29rL2thcnBvdi13b3JrL1RydWVOQVMvd2VidWkvc3JjL2FwcC9wYWdlcy9zeXN0ZW0vdXBkYXRlL2NvbXBvbmVudHMvdHJhaW4tY2FyZC90cmFpbi1jYXJkLmNvbXBvbmVudC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBc3luY1BpcGUgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuaW1wb3J0IHtcbiAgQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3ksIENoYW5nZURldGVjdG9yUmVmLCBDb21wb25lbnQsIE9uSW5pdCxcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBGb3JtQnVpbGRlciwgVmFsaWRhdG9ycywgUmVhY3RpdmVGb3Jtc01vZHVsZSB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7IE1hdE1pbmlGYWJCdXR0b24gfSBmcm9tICdAYW5ndWxhci9tYXRlcmlhbC9idXR0b24nO1xuaW1wb3J0IHsgTWF0Q2FyZCB9IGZyb20gJ0Bhbmd1bGFyL21hdGVyaWFsL2NhcmQnO1xuaW1wb3J0IHsgTWF0UHJvZ3Jlc3NTcGlubmVyIH0gZnJvbSAnQGFuZ3VsYXIvbWF0ZXJpYWwvcHJvZ3Jlc3Mtc3Bpbm5lcic7XG5pbXBvcnQgeyBNYXRUb29sdGlwIH0gZnJvbSAnQGFuZ3VsYXIvbWF0ZXJpYWwvdG9vbHRpcCc7XG5pbXBvcnQgeyBVbnRpbERlc3Ryb3ksIHVudGlsRGVzdHJveWVkIH0gZnJvbSAnQG5nbmVhdC91bnRpbC1kZXN0cm95JztcbmltcG9ydCB7IFRyYW5zbGF0ZVNlcnZpY2UsIFRyYW5zbGF0ZU1vZHVsZSB9IGZyb20gJ0BuZ3gtdHJhbnNsYXRlL2NvcmUnO1xuaW1wb3J0IHtcbiAgT2JzZXJ2YWJsZSwgZm9ya0pvaW4sIG9mLCBwYWlyd2lzZSxcbn0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBSZXF1aXJlc1JvbGVzRGlyZWN0aXZlIH0gZnJvbSAnYXBwL2RpcmVjdGl2ZXMvcmVxdWlyZXMtcm9sZXMvcmVxdWlyZXMtcm9sZXMuZGlyZWN0aXZlJztcbmltcG9ydCB7IFJvbGUgfSBmcm9tICdhcHAvZW51bXMvcm9sZS5lbnVtJztcbmltcG9ydCB7IFN5c3RlbVVwZGF0ZVN0YXR1cyB9IGZyb20gJ2FwcC9lbnVtcy9zeXN0ZW0tdXBkYXRlLmVudW0nO1xuaW1wb3J0IHsgZmlsdGVyQXN5bmMgfSBmcm9tICdhcHAvaGVscGVycy9vcGVyYXRvcnMvZmlsdGVyLWFzeW5jLm9wZXJhdG9yJztcbmltcG9ydCB7IGhlbHB0ZXh0U3lzdGVtVXBkYXRlIH0gZnJvbSAnYXBwL2hlbHB0ZXh0L3N5c3RlbS91cGRhdGUnO1xuaW1wb3J0IHsgT3B0aW9uIH0gZnJvbSAnYXBwL2ludGVyZmFjZXMvb3B0aW9uLmludGVyZmFjZSc7XG5pbXBvcnQgeyBXZWJTb2NrZXRFcnJvciB9IGZyb20gJ2FwcC9pbnRlcmZhY2VzL3dlYnNvY2tldC1lcnJvci5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgRGlhbG9nU2VydmljZSB9IGZyb20gJ2FwcC9tb2R1bGVzL2RpYWxvZy9kaWFsb2cuc2VydmljZSc7XG5pbXBvcnQgeyBJeENoZWNrYm94Q29tcG9uZW50IH0gZnJvbSAnYXBwL21vZHVsZXMvZm9ybXMvaXgtZm9ybXMvY29tcG9uZW50cy9peC1jaGVja2JveC9peC1jaGVja2JveC5jb21wb25lbnQnO1xuaW1wb3J0IHsgSXhTZWxlY3RDb21wb25lbnQgfSBmcm9tICdhcHAvbW9kdWxlcy9mb3Jtcy9peC1mb3Jtcy9jb21wb25lbnRzL2l4LXNlbGVjdC9peC1zZWxlY3QuY29tcG9uZW50JztcbmltcG9ydCB7IEl4SWNvbkNvbXBvbmVudCB9IGZyb20gJ2FwcC9tb2R1bGVzL2l4LWljb24vaXgtaWNvbi5jb21wb25lbnQnO1xuaW1wb3J0IHsgVGVzdERpcmVjdGl2ZSB9IGZyb20gJ2FwcC9tb2R1bGVzL3Rlc3QtaWQvdGVzdC5kaXJlY3RpdmUnO1xuaW1wb3J0IHsgVHJhaW5TZXJ2aWNlIH0gZnJvbSAnYXBwL3BhZ2VzL3N5c3RlbS91cGRhdGUvc2VydmljZXMvdHJhaW4uc2VydmljZSc7XG5pbXBvcnQgeyBVcGRhdGVTZXJ2aWNlIH0gZnJvbSAnYXBwL3BhZ2VzL3N5c3RlbS91cGRhdGUvc2VydmljZXMvdXBkYXRlLnNlcnZpY2UnO1xuaW1wb3J0IHsgQXV0aFNlcnZpY2UgfSBmcm9tICdhcHAvc2VydmljZXMvYXV0aC9hdXRoLnNlcnZpY2UnO1xuaW1wb3J0IHsgU3lzdGVtR2VuZXJhbFNlcnZpY2UgfSBmcm9tICdhcHAvc2VydmljZXMvc3lzdGVtLWdlbmVyYWwuc2VydmljZSc7XG5cbkBVbnRpbERlc3Ryb3koKVxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnaXgtdHJhaW4tY2FyZCcsXG4gIHN0eWxlVXJsczogWyd0cmFpbi1jYXJkLmNvbXBvbmVudC5zY3NzJ10sXG4gIHRlbXBsYXRlVXJsOiAnLi90cmFpbi1jYXJkLmNvbXBvbmVudC5odG1sJyxcbiAgY2hhbmdlRGV0ZWN0aW9uOiBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneS5PblB1c2gsXG4gIHN0YW5kYWxvbmU6IHRydWUsXG4gIGltcG9ydHM6IFtcbiAgICBNYXRDYXJkLFxuICAgIE1hdFByb2dyZXNzU3Bpbm5lcixcbiAgICBSZWFjdGl2ZUZvcm1zTW9kdWxlLFxuICAgIFJlcXVpcmVzUm9sZXNEaXJlY3RpdmUsXG4gICAgSXhDaGVja2JveENvbXBvbmVudCxcbiAgICBJeFNlbGVjdENvbXBvbmVudCxcbiAgICBNYXRNaW5pRmFiQnV0dG9uLFxuICAgIE1hdFRvb2x0aXAsXG4gICAgVGVzdERpcmVjdGl2ZSxcbiAgICBJeEljb25Db21wb25lbnQsXG4gICAgVHJhbnNsYXRlTW9kdWxlLFxuICAgIEFzeW5jUGlwZSxcbiAgXSxcbn0pXG5leHBvcnQgY2xhc3MgVHJhaW5DYXJkQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0IHtcbiAgaXNVcGRhdGVSdW5uaW5nID0gZmFsc2U7XG4gIGNoZWNrYWJsZSA9IGZhbHNlO1xuICBzaW5nbGVEZXNjcmlwdGlvbjogc3RyaW5nO1xuICB0cmFpbnM6IE9wdGlvbltdID0gW107XG5cbiAgZm9ybSA9IHRoaXMuZmIuZ3JvdXAoe1xuICAgIGF1dG9fY2hlY2s6IFtmYWxzZV0sXG4gICAgdHJhaW46IFsnJywgVmFsaWRhdG9ycy5yZXF1aXJlZF0sXG4gIH0pO1xuXG4gIHByb3RlY3RlZCByZWFkb25seSByZXF1aXJlZFJvbGVzID0gW1JvbGUuRnVsbEFkbWluXTtcbiAgcHJvdGVjdGVkIHJlYWRvbmx5IGNsaWNrRm9ySW5mb3JtYXRpb25MaW5rID0gaGVscHRleHRTeXN0ZW1VcGRhdGUuY2xpY2tGb3JJbmZvcm1hdGlvbkxpbms7XG4gIHByb3RlY3RlZCByZWFkb25seSBTeXN0ZW1VcGRhdGVTdGF0dXMgPSBTeXN0ZW1VcGRhdGVTdGF0dXM7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBzeXNHZW5TZXJ2aWNlOiBTeXN0ZW1HZW5lcmFsU2VydmljZSxcbiAgICBwcml2YXRlIGRpYWxvZ1NlcnZpY2U6IERpYWxvZ1NlcnZpY2UsXG4gICAgcHJpdmF0ZSB0cmFuc2xhdGU6IFRyYW5zbGF0ZVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBmYjogRm9ybUJ1aWxkZXIsXG4gICAgcHJpdmF0ZSBhdXRoU2VydmljZTogQXV0aFNlcnZpY2UsXG4gICAgcHJvdGVjdGVkIHRyYWluU2VydmljZTogVHJhaW5TZXJ2aWNlLFxuICAgIHByb3RlY3RlZCB1cGRhdGVTZXJ2aWNlOiBVcGRhdGVTZXJ2aWNlLFxuICAgIHByaXZhdGUgY2RyOiBDaGFuZ2VEZXRlY3RvclJlZixcbiAgKSB7XG4gICAgdGhpcy5zeXNHZW5TZXJ2aWNlLnVwZGF0ZVJ1bm5pbmcucGlwZSh1bnRpbERlc3Ryb3llZCh0aGlzKSkuc3Vic2NyaWJlKChpc1VwZGF0aW5nOiBzdHJpbmcpID0+IHtcbiAgICAgIHRoaXMuaXNVcGRhdGVSdW5uaW5nID0gaXNVcGRhdGluZyA9PT0gJ3RydWUnO1xuICAgICAgdGhpcy5jZHIubWFya0ZvckNoZWNrKCk7XG4gICAgfSk7XG4gIH1cblxuICBnZXQgdHJhaW5zJCgpOiBPYnNlcnZhYmxlPE9wdGlvbltdPiB7XG4gICAgcmV0dXJuIG9mKHRoaXMudHJhaW5zKTtcbiAgfVxuXG4gIG5nT25Jbml0KCk6IHZvaWQge1xuICAgIGZvcmtKb2luKFtcbiAgICAgIHRoaXMudHJhaW5TZXJ2aWNlLmdldEF1dG9Eb3dubG9hZCgpLFxuICAgICAgdGhpcy50cmFpblNlcnZpY2UuZ2V0VHJhaW5zKCksXG4gICAgXSkucGlwZSh1bnRpbERlc3Ryb3llZCh0aGlzKSkuc3Vic2NyaWJlKHtcbiAgICAgIG5leHQ6IChbaXNBdXRvRG93bmxvYWRPbiwgdHJhaW5zXSkgPT4ge1xuICAgICAgICB0aGlzLmZvcm0uY29udHJvbHMuYXV0b19jaGVjay5wYXRjaFZhbHVlKGlzQXV0b0Rvd25sb2FkT24pO1xuICAgICAgICB0aGlzLmNoZWNrYWJsZSA9IHRydWU7XG4gICAgICAgIHRoaXMuY2RyLm1hcmtGb3JDaGVjaygpO1xuICAgICAgICB0aGlzLnRyYWluU2VydmljZS5mdWxsVHJhaW5MaXN0JC5uZXh0KHRyYWlucy50cmFpbnMpO1xuXG4gICAgICAgIHRoaXMudHJhaW5TZXJ2aWNlLnRyYWluVmFsdWUkLm5leHQodHJhaW5zLnNlbGVjdGVkIHx8ICcnKTtcbiAgICAgICAgdGhpcy50cmFpblNlcnZpY2Uuc2VsZWN0ZWRUcmFpbiQubmV4dCh0cmFpbnMuc2VsZWN0ZWQpO1xuXG4gICAgICAgIGlmIChpc0F1dG9Eb3dubG9hZE9uKSB7XG4gICAgICAgICAgdGhpcy50cmFpblNlcnZpY2UuY2hlY2soKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMudHJhaW5zID0gT2JqZWN0LmVudHJpZXModHJhaW5zLnRyYWlucykubWFwKChbbmFtZSwgdHJhaW5dKSA9PiAoe1xuICAgICAgICAgIGxhYmVsOiB0cmFpbi5kZXNjcmlwdGlvbixcbiAgICAgICAgICB2YWx1ZTogbmFtZSxcbiAgICAgICAgfSkpO1xuICAgICAgICBpZiAodGhpcy50cmFpbnMubGVuZ3RoID4gMCkge1xuICAgICAgICAgIHRoaXMuc2luZ2xlRGVzY3JpcHRpb24gPSBPYmplY3QudmFsdWVzKHRyYWlucy50cmFpbnMpWzBdPy5kZXNjcmlwdGlvbjtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBjdXJyZW50VHJhaW5EZXNjcmlwdGlvbiA9ICcnO1xuXG4gICAgICAgIGlmICh0cmFpbnMudHJhaW5zW3RyYWlucy5jdXJyZW50XSkge1xuICAgICAgICAgIGlmICh0cmFpbnMudHJhaW5zW3RyYWlucy5jdXJyZW50XS5kZXNjcmlwdGlvbi50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKCdbbmlnaHRseV0nKSkge1xuICAgICAgICAgICAgY3VycmVudFRyYWluRGVzY3JpcHRpb24gPSAnW25pZ2h0bHldJztcbiAgICAgICAgICB9IGVsc2UgaWYgKHRyYWlucy50cmFpbnNbdHJhaW5zLmN1cnJlbnRdLmRlc2NyaXB0aW9uLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoJ1tyZWxlYXNlXScpKSB7XG4gICAgICAgICAgICBjdXJyZW50VHJhaW5EZXNjcmlwdGlvbiA9ICdbcmVsZWFzZV0nO1xuICAgICAgICAgIH0gZWxzZSBpZiAodHJhaW5zLnRyYWluc1t0cmFpbnMuY3VycmVudF0uZGVzY3JpcHRpb24udG9Mb3dlckNhc2UoKS5pbmNsdWRlcygnW3ByZXJlbGVhc2VdJykpIHtcbiAgICAgICAgICAgIGN1cnJlbnRUcmFpbkRlc2NyaXB0aW9uID0gJ1twcmVyZWxlYXNlXSc7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGN1cnJlbnRUcmFpbkRlc2NyaXB0aW9uID0gdHJhaW5zLnRyYWluc1t0cmFpbnMuc2VsZWN0ZWRdLmRlc2NyaXB0aW9uLnRvTG93ZXJDYXNlKCk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHRoaXMudHJhaW5TZXJ2aWNlLmN1cnJlbnRUcmFpbkRlc2NyaXB0aW9uJC5uZXh0KGN1cnJlbnRUcmFpbkRlc2NyaXB0aW9uKTtcbiAgICAgICAgLy8gVG8gcmVtZW1iZXIgdHJhaW4gZGVzY3JpcHRpb24gaWYgdXNlciBzd2l0Y2hlcyBhd2F5IGFuZCB0aGVuIHN3aXRjaGVzIGJhY2tcbiAgICAgICAgdGhpcy50cmFpblNlcnZpY2UudHJhaW5EZXNjcmlwdGlvbk9uUGFnZUxvYWQkLm5leHQoY3VycmVudFRyYWluRGVzY3JpcHRpb24pO1xuXG4gICAgICAgIHRoaXMuY2RyLm1hcmtGb3JDaGVjaygpO1xuICAgICAgfSxcbiAgICAgIGVycm9yOiAoZXJyb3I6IFdlYlNvY2tldEVycm9yKSA9PiB7XG4gICAgICAgIHRoaXMuZGlhbG9nU2VydmljZS53YXJuKFxuICAgICAgICAgIGVycm9yLnRyYWNlLmNsYXNzLFxuICAgICAgICAgIHRoaXMudHJhbnNsYXRlLmluc3RhbnQoJ1RydWVOQVMgd2FzIHVuYWJsZSB0byByZWFjaCB1cGRhdGUgc2VydmVycy4nKSxcbiAgICAgICAgKTtcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICB0aGlzLnRyYWluU2VydmljZS50cmFpblZhbHVlJC5waXBlKHVudGlsRGVzdHJveWVkKHRoaXMpKS5zdWJzY3JpYmUoKHRyYWluVmFsdWUpID0+IHtcbiAgICAgIHRoaXMuZm9ybS5jb250cm9scy50cmFpbi5wYXRjaFZhbHVlKHRyYWluVmFsdWUpO1xuICAgIH0pO1xuXG4gICAgdGhpcy5mb3JtLmNvbnRyb2xzLnRyYWluLnZhbHVlQ2hhbmdlcy5waXBlKHBhaXJ3aXNlKCksIHVudGlsRGVzdHJveWVkKHRoaXMpKS5zdWJzY3JpYmUoKFtwcmV2VHJhaW4sIG5ld1RyYWluXSkgPT4ge1xuICAgICAgdGhpcy50cmFpblNlcnZpY2Uub25UcmFpbkNoYW5nZWQobmV3VHJhaW4sIHByZXZUcmFpbik7XG4gICAgfSk7XG5cbiAgICB0aGlzLmZvcm0uY29udHJvbHMuYXV0b19jaGVjay52YWx1ZUNoYW5nZXMucGlwZShcbiAgICAgIGZpbHRlckFzeW5jKCgpID0+IHRoaXMuYXV0aFNlcnZpY2UuaGFzUm9sZShSb2xlLkZ1bGxBZG1pbikpLFxuICAgICAgdW50aWxEZXN0cm95ZWQodGhpcyksXG4gICAgKS5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgdGhpcy50cmFpblNlcnZpY2UudG9nZ2xlQXV0b0NoZWNrKHRoaXMuZm9ybS5jb250cm9scy5hdXRvX2NoZWNrLnZhbHVlKTtcbiAgICB9KTtcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9