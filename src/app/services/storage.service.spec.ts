import { GiB, TiB } from 'app/constants/bytes.constant';
import { VdevType, TopologyItemType, TopologyWarning } from 'app/enums/v-dev-type.enum';
import { Disk } from 'app/interfaces/disk.interface';
import { PoolTopology } from 'app/interfaces/pool.interface';
import { TopologyDisk, TopologyItem, VDev } from 'app/interfaces/storage.interface';
import { StorageService } from 'app/services/storage.service';
import { ApiService } from 'app/services/websocket/api.service';

describe('StorageService', () => {
  const storageService = new StorageService(
    {} as ApiService,
  );

  describe('getRedundancyLevel', () => {
    it('return width minus one with mirrors', () => {
      const mirror = {
        type: TopologyItemType.Mirror,
        children: [{}, {}, {}] as TopologyDisk[],
      } as VDev;
      const redundancy = storageService.getRedundancyLevel(mirror as TopologyItem);

      expect(redundancy).toBe(2);
    });

    it('return 0 disk redundancy for Stripe and Disk', () => {
      const stripe = storageService.getRedundancyLevel({ type: TopologyItemType.Stripe } as TopologyItem);
      expect(stripe).toBe(0);

      const disk = storageService.getRedundancyLevel({ type: TopologyItemType.Disk } as TopologyItem);
      expect(disk).toBe(0);
    });

    it('return 1 disk redundancy for Raidz and Raidz1', () => {
      const raidz = storageService.getRedundancyLevel({ type: TopologyItemType.Raidz } as TopologyItem);
      expect(raidz).toBe(1);

      const raidz1 = storageService.getRedundancyLevel({ type: TopologyItemType.Raidz1 } as TopologyItem);
      expect(raidz1).toBe(1);
    });

    it('return 2 disk redundancy for Raidz2', () => {
      const raidz2 = storageService.getRedundancyLevel({ type: TopologyItemType.Raidz2 } as TopologyItem);
      expect(raidz2).toBe(2);
    });

    it('return 3 disk redundancy for Raidz3', () => {
      const raidz3 = storageService.getRedundancyLevel({ type: TopologyItemType.Raidz3 } as TopologyItem);
      expect(raidz3).toBe(3);
    });

    it('return -1 for anything else', () => {
      const unsupported: TopologyItemType[] = [
        TopologyItemType.Missing,
        TopologyItemType.File,
        TopologyItemType.L2Cache,
        TopologyItemType.Replacing,
        TopologyItemType.Root,
      ];

      unsupported.forEach((layout: TopologyItemType) => {
        const unsupportedLayout = storageService.getRedundancyLevel({ type: layout } as TopologyItem);
        expect(unsupportedLayout).toBe(-1);
      });
    });
  });

  describe('can check VDEV widths', () => {
    const dataVdevsWidth = 8;
    const topology = {
      data: [
        {
          type: 'RAIDZ2',
          children: [
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sda',
              stats: {
                size: 8796093022208,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sda2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdb',
              stats: {
                size: 8796093022208,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdb2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdc',
              stats: {
                size: 8796093022208,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdc2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdd',
              stats: {
                size: 8796093022208,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdd2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sde',
              stats: {
                size: 8796093022208,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sde2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdf',
              stats: {
                size: 8796093022208,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdf2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdg',
              stats: {
                size: 8796093022208,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdg2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdh',
              stats: {
                size: 8796093022208,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdh2',
              guid: '12345',
              unavail_disk: null,
            },
          ],
          guid: '12345',
          unavail_disk: null,
          stats: {
            size: 52776558133248,
          },
          status: 'ONLINE',
          name: 'RAIDZ2-0',
        },
        {
          type: 'RAIDZ2',
          children: [
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdi',
              stats: {
                size: 8796093022208,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdi2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdj',
              stats: {
                size: 8796093022208,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdj2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdk',
              stats: {
                size: 8796093022208,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdk2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdl',
              stats: {
                size: 8796093022208,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdl2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdm',
              stats: {
                size: 8796093022208,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdm2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdn',
              stats: {
                size: 8796093022208,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdn2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdo',
              stats: {
                size: 8796093022208,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdo2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdp',
              stats: {
                size: 8796093022208,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdp2',
              guid: '12345',
              unavail_disk: null,
            },
          ],
          guid: '12345',
          unavail_disk: null,
          stats: {
            size: 52776558133248,
          },
          status: 'ONLINE',
          name: 'RAIDZ2-1',
        },
        {
          type: 'RAIDZ2',
          children: [
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdq',
              stats: {
                size: 8796093022208,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdq2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdr',
              stats: {
                size: 8796093022208,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdr2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sds',
              stats: {
                size: 8796093022208,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sds2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdt',
              stats: {
                size: 8796093022208,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdt2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdu',
              stats: {
                size: 8796093022208,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdu2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdv',
              stats: {
                size: 8796093022208,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdv2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdw',
              stats: {
                size: 8796093022208,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdw2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdx',
              stats: {
                size: 8796093022208,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdx2',
              guid: '12345',
              unavail_disk: null,
            },
          ],
          guid: '12345',
          unavail_disk: null,
          stats: {
            size: 52776558133248,
          },
          status: 'ONLINE',
          name: 'RAIDZ2-2',
        },
        {
          type: 'RAIDZ2',
          children: [
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdy',
              stats: {
                size: 8796093022208,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdy2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdz',
              stats: {
                size: 8796093022208,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdz2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdaa',
              stats: {
                size: 8796093022208,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdaa2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdab',
              stats: {
                size: 8796093022208,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdab2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdac',
              stats: {
                size: 8796093022208,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdac2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdad',
              stats: {
                size: 8796093022208,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdad2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdae',
              stats: {
                size: 8796093022208,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdae2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdaf',
              stats: {
                size: 8796093022208,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdaf2',
              guid: '12345',
              unavail_disk: null,
            },
          ],
          guid: '12345',
          unavail_disk: null,
          stats: {
            size: 52776558133248,
          },
          status: 'ONLINE',
          name: 'RAIDZ2-3',
        },
        {
          type: 'RAIDZ2',
          children: [
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdag',
              stats: {
                size: 8796093022208,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdag2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdah',
              stats: {
                size: 8796093022208,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdah2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdai',
              stats: {
                size: 8796093022208,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdai2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdaj',
              stats: {
                size: 8796093022208,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdaj2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdak',
              stats: {
                size: 8796093022208,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdak2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdal',
              stats: {
                size: 8796093022208,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdal2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdam',
              stats: {
                size: 8796093022208,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdam2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdan',
              stats: {
                size: 8796093022208,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdan2',
              guid: '12345',
              unavail_disk: null,
            },
          ],
          guid: '12345',
          unavail_disk: null,
          stats: {
            size: 52776558133248,
          },
          status: 'ONLINE',
          name: 'RAIDZ2-4',
        },
        {
          type: 'RAIDZ2',
          children: [
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdao',
              stats: {
                size: 8796093022208,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdao2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdap',
              stats: {
                size: 8796093022208,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdap2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdaq',
              stats: {
                size: 8796093022208,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdaq2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdar',
              stats: {
                size: 8796093022208,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdar2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdas',
              stats: {
                size: 8796093022208,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdas2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdat',
              stats: {
                size: 8796093022208,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdat2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdau',
              stats: {
                size: 8796093022208,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdau2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdav',
              stats: {
                size: 8796093022208,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdav2',
              guid: '12345',
              unavail_disk: null,
            },
          ],
          guid: '12345',
          unavail_disk: null,
          stats: {
            size: 52776558133248,
          },
          status: 'ONLINE',
          name: 'RAIDZ2-5',
        },
      ],
      special: [],
      log: [],
      spare: [],
      cache: [
        {
          type: 'DISK',
          status: 'ONLINE',
          children: [],
          disk: 'sdaw',
          stats: {
            size: null,
          },
          device: null,
          guid: '12345',
          unavail_disk: null,
        },
        {
          type: 'DISK',
          status: 'ONLINE',
          children: [],
          disk: 'sdax',
          stats: {
            size: null,
          },
          device: null,
          guid: '12345',
          unavail_disk: null,
        },
        {
          type: 'DISK',
          status: 'ONLINE',
          children: [],
          disk: 'sday',
          stats: {
            size: null,
          },
          device: null,
          guid: '12345',
          unavail_disk: null,
        },
      ],
      dedup: [],
    } as PoolTopology;

    it('detects width of VDEVs', () => {
      const vdevWidth = storageService.getVdevWidths(topology.data);

      expect(vdevWidth.size).toBe(1);
      expect(vdevWidth.values().next().value).toBe(dataVdevsWidth);
    });

    it('detects width of Stripes and Disks', () => {
      const stripeWidth: Set<number> = storageService.getVdevWidths(topology.cache);

      expect(stripeWidth.size).toBe(1);
      expect(stripeWidth.values().next().value).toBe(1);
    });

    it('detects mixed VDEV widths', () => {
      const mixed = [1, 2, 3];
      const uniform = [1, 1, 1];
      const mixedIsMixed: boolean = storageService.isMixedWidth(new Set(mixed));
      const uniformIsMixed: boolean = storageService.isMixedWidth(new Set(uniform));

      expect(mixedIsMixed).toBe(true);
      expect(uniformIsMixed).toBe(false);
    });
  });

  describe('can check VDEV capacities', () => {
    const dataVdevsDiskSize = 2;
    const topology = {
      data: [
        {
          type: 'MIRROR',
          children: [
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sda',
              stats: {
                size: 4398046511104,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sda2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdb',
              stats: {
                size: 4398046511104,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdb2',
              guid: '12345',
              unavail_disk: null,
            },
          ],
          guid: '12345',
          unavail_disk: null,
          stats: {
            size: 4398046511104,
          },
          status: 'ONLINE',
          name: 'MIRROR-0',
        },
        {
          type: 'MIRROR',
          children: [
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdc',
              stats: {
                size: 2199023255552,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdc2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdd',
              stats: {
                size: 2199023255552,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdd2',
              guid: '12345',
              unavail_disk: null,
            },
          ],
          guid: '12345',
          unavail_disk: null,
          stats: {
            size: 2199023255552,
          },
          status: 'ONLINE',
          name: 'MIRROR-1',
        },
      ],
      special: [],
      log: [],
      spare: [],
      cache: [],
      dedup: [
        {
          type: 'MIRROR',
          children: [
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sde',
              stats: {
                size: 2199023255552,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sde2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdf',
              stats: {
                size: 2199023255552,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdf2',
              guid: '12345',
              unavail_disk: null,
            },
          ],
          guid: '12345',
          unavail_disk: null,
          stats: {
            size: 2199023255552,
          },
          status: 'ONLINE',
          name: 'MIRROR-0',
        },
        {
          type: 'MIRROR',
          children: [
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdg',
              stats: {
                size: 2199023255552,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdg2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdh',
              stats: {
                size: 2199023255552,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdh2',
              guid: '12345',
              unavail_disk: null,
            },
          ],
          guid: '12345',
          unavail_disk: null,
          stats: {
            size: 2199023255552,
          },
          status: 'ONLINE',
          name: 'MIRROR-1',
        },
      ],
    } as PoolTopology;

    const dataVdevCapacities: Set<number> = storageService.getVdevCapacities(topology.data);
    const dedupVdevCapacities: Set<number> = storageService.getVdevCapacities(topology.dedup);

    it('detects VDEV capacity for category', () => {
      const capacities: number[] = Array.from(dataVdevCapacities);
      expect(capacities[0]).toBe((dataVdevsDiskSize + 2) * TiB);

      for (let index = 1; index < capacities.length; index++) {
        expect(capacities[index]).toBe(dataVdevsDiskSize * TiB);
        expect(capacities[index]).toEqual(topology.data[index].stats.size);
      }
    });

    it('detects mixed VDEV capacities in category', () => {
      // Check mixed data VDEVs
      expect(dataVdevCapacities.size).toBe(2);
      const isDataMixed: boolean = storageService.isMixedVdevCapacity(dataVdevCapacities);
      expect(isDataMixed).toBe(true);

      // Check uniform dedup VDEVs
      expect(dedupVdevCapacities.size).toBe(1);
      const isDedupMixed: boolean = storageService.isMixedVdevCapacity(dedupVdevCapacities);
      expect(isDedupMixed).toBe(false);

      // Check mixed VDEV when the difference is less than 2 GiB
      expect(storageService.isMixedVdevCapacity(new Set([GiB, GiB * 3 - 1]))).toBe(false);
      expect(storageService.isMixedVdevCapacity(new Set([GiB, GiB * 3.2]))).toBe(true);
    });
  });

  describe('can check VDEV disk capacities in category', () => {
    const configuredDiskSize = 4;
    const generatedDiskSizeInBytes: number = (configuredDiskSize + 1) * TiB;

    const mockTopology = {
      data: [
        {
          type: 'RAIDZ1',
          children: [
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sda',
              stats: {
                size: 5497558138880,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sda2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdb',
              stats: {
                size: 4398046511104,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdb2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdc',
              stats: {
                size: 4398046511104,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdc2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdd',
              stats: {
                size: 4398046511104,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdd2',
              guid: '12345',
              unavail_disk: null,
            },
          ],
          guid: '12345',
          unavail_disk: null,
          stats: {
            size: 13194139533312,
          },
          status: 'ONLINE',
          name: 'RAIDZ1-0',
        },
      ],
      special: [
        {
          type: 'RAIDZ1',
          children: [
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdm',
              stats: {
                size: 4398046511104,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdm2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdn',
              stats: {
                size: 4398046511104,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdn2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdo',
              stats: {
                size: 4398046511104,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdo2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdp',
              stats: {
                size: 4398046511104,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdp2',
              guid: '12345',
              unavail_disk: null,
            },
          ],
          guid: '12345',
          unavail_disk: null,
          stats: {
            size: 13194139533312,
          },
          status: 'ONLINE',
          name: 'RAIDZ1-0',
        },
      ],
      log: [],
      spare: [],
      cache: [],
      dedup: [
        {
          type: 'RAIDZ1',
          children: [
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sde',
              stats: {
                size: 6597069766656,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sde2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdf',
              stats: {
                size: 6597069766656,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdf2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdg',
              stats: {
                size: 6597069766656,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdg2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdh',
              stats: {
                size: 6597069766656,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdh2',
              guid: '12345',
              unavail_disk: null,
            },
          ],
          guid: '12345',
          unavail_disk: null,
          stats: {
            size: 19791209299968,
          },
          status: 'ONLINE',
          name: 'RAIDZ1-0',
        },
        {
          type: 'RAIDZ1',
          children: [
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdi',
              stats: {
                size: 4398046511104,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdi2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdj',
              stats: {
                size: 4398046511104,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdj2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdk',
              stats: {
                size: 4398046511104,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdk2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdl',
              stats: {
                size: 4398046511104,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdl2',
              guid: '12345',
              unavail_disk: null,
            },
          ],
          guid: '12345',
          unavail_disk: null,
          stats: {
            size: 13194139533312,
          },
          status: 'ONLINE',
          name: 'RAIDZ1-1',
        },
      ],
    } as PoolTopology;

    const mockDisks = [
      {
        identifier: '{uuid}d5433b0f-180b-4706-afd0-476915e8925f0',
        name: 'sda',
        subsystem: 'scsi',
        number: 2080,
        serial: '1234567890abcd0',
        lunid: null,
        size: 5497558138880,
        description: '',
        duplicate_serial: [],
        transfermode: 'Auto',
        hddstandby: 'ALWAYS ON',
        advpowermgmt: 'DISABLED',
        togglesmart: true,
        smartoptions: '',
        expiretime: null,
        critical: null,
        difference: null,
        informational: null,
        model: 'HARDDISK',
        rotationrate: null,
        type: 'HDD',
        zfs_guid: '594160193876939323',
        bus: 'SPI',
        devname: 'sda',
        supports_smart: null,
        pool: 'MOCK_POOL',
      },
      {
        identifier: '{uuid}d5433b0f-180b-4706-afd0-476915e8925f1',
        name: 'sdb',
        subsystem: 'scsi',
        number: 2080,
        serial: '1234567890abcd1',
        lunid: null,
        size: 4398046511104,
        description: '',
        duplicate_serial: [],
        transfermode: 'Auto',
        hddstandby: 'ALWAYS ON',
        advpowermgmt: 'DISABLED',
        togglesmart: true,
        smartoptions: '',
        expiretime: null,
        critical: null,
        difference: null,
        informational: null,
        model: 'HARDDISK',
        rotationrate: null,
        type: 'HDD',
        zfs_guid: '594160193876939323',
        bus: 'SPI',
        devname: 'sdb',
        supports_smart: null,
        pool: 'MOCK_POOL',
      },
      {
        identifier: '{uuid}d5433b0f-180b-4706-afd0-476915e8925f2',
        name: 'sdc',
        subsystem: 'scsi',
        number: 2080,
        serial: '1234567890abcd2',
        lunid: null,
        size: 4398046511104,
        description: '',
        duplicate_serial: [],
        transfermode: 'Auto',
        hddstandby: 'ALWAYS ON',
        advpowermgmt: 'DISABLED',
        togglesmart: true,
        smartoptions: '',
        expiretime: null,
        critical: null,
        difference: null,
        informational: null,
        model: 'HARDDISK',
        rotationrate: null,
        type: 'HDD',
        zfs_guid: '594160193876939323',
        bus: 'SPI',
        devname: 'sdc',
        supports_smart: null,
        pool: 'MOCK_POOL',
      },
      {
        identifier: '{uuid}d5433b0f-180b-4706-afd0-476915e8925f3',
        name: 'sdd',
        subsystem: 'scsi',
        number: 2080,
        serial: '1234567890abcd3',
        lunid: null,
        size: 4398046511104,
        description: '',
        duplicate_serial: [],
        transfermode: 'Auto',
        hddstandby: 'ALWAYS ON',
        advpowermgmt: 'DISABLED',
        togglesmart: true,
        smartoptions: '',
        expiretime: null,
        critical: null,
        difference: null,
        informational: null,
        model: 'HARDDISK',
        rotationrate: null,
        type: 'HDD',
        zfs_guid: '594160193876939323',
        bus: 'SPI',
        devname: 'sdd',
        supports_smart: null,
        pool: 'MOCK_POOL',
      },
      {
        identifier: '{uuid}d5433b0f-180b-4706-afd0-476915e8925f4',
        name: 'sde',
        subsystem: 'scsi',
        number: 2080,
        serial: '1234567890abcd4',
        lunid: null,
        size: 6597069766656,
        description: '',
        duplicate_serial: [],
        transfermode: 'Auto',
        hddstandby: 'ALWAYS ON',
        advpowermgmt: 'DISABLED',
        togglesmart: true,
        smartoptions: '',
        expiretime: null,
        critical: null,
        difference: null,
        informational: null,
        model: 'HARDDISK',
        rotationrate: null,
        type: 'HDD',
        zfs_guid: '594160193876939323',
        bus: 'SPI',
        devname: 'sde',
        supports_smart: null,
        pool: 'MOCK_POOL',
      },
      {
        identifier: '{uuid}d5433b0f-180b-4706-afd0-476915e8925f5',
        name: 'sdf',
        subsystem: 'scsi',
        number: 2080,
        serial: '1234567890abcd5',
        lunid: null,
        size: 6597069766656,
        description: '',
        duplicate_serial: [],
        transfermode: 'Auto',
        hddstandby: 'ALWAYS ON',
        advpowermgmt: 'DISABLED',
        togglesmart: true,
        smartoptions: '',
        expiretime: null,
        critical: null,
        difference: null,
        informational: null,
        model: 'HARDDISK',
        rotationrate: null,
        type: 'HDD',
        zfs_guid: '594160193876939323',
        bus: 'SPI',
        devname: 'sdf',
        supports_smart: null,
        pool: 'MOCK_POOL',
      },
      {
        identifier: '{uuid}d5433b0f-180b-4706-afd0-476915e8925f6',
        name: 'sdg',
        subsystem: 'scsi',
        number: 2080,
        serial: '1234567890abcd6',
        lunid: null,
        size: 6597069766656,
        description: '',
        duplicate_serial: [],
        transfermode: 'Auto',
        hddstandby: 'ALWAYS ON',
        advpowermgmt: 'DISABLED',
        togglesmart: true,
        smartoptions: '',
        expiretime: null,
        critical: null,
        difference: null,
        informational: null,
        model: 'HARDDISK',
        rotationrate: null,
        type: 'HDD',
        zfs_guid: '594160193876939323',
        bus: 'SPI',
        devname: 'sdg',
        supports_smart: null,
        pool: 'MOCK_POOL',
      },
      {
        identifier: '{uuid}d5433b0f-180b-4706-afd0-476915e8925f7',
        name: 'sdh',
        subsystem: 'scsi',
        number: 2080,
        serial: '1234567890abcd7',
        lunid: null,
        size: 6597069766656,
        description: '',
        duplicate_serial: [],
        transfermode: 'Auto',
        hddstandby: 'ALWAYS ON',
        advpowermgmt: 'DISABLED',
        togglesmart: true,
        smartoptions: '',
        expiretime: null,
        critical: null,
        difference: null,
        informational: null,
        model: 'HARDDISK',
        rotationrate: null,
        type: 'HDD',
        zfs_guid: '594160193876939323',
        bus: 'SPI',
        devname: 'sdh',
        supports_smart: null,
        pool: 'MOCK_POOL',
      },
      {
        identifier: '{uuid}d5433b0f-180b-4706-afd0-476915e8925f8',
        name: 'sdi',
        subsystem: 'scsi',
        number: 2080,
        serial: '1234567890abcd8',
        lunid: null,
        size: 4398046511104,
        description: '',
        duplicate_serial: [],
        transfermode: 'Auto',
        hddstandby: 'ALWAYS ON',
        advpowermgmt: 'DISABLED',
        togglesmart: true,
        smartoptions: '',
        expiretime: null,
        critical: null,
        difference: null,
        informational: null,
        model: 'HARDDISK',
        rotationrate: null,
        type: 'HDD',
        zfs_guid: '594160193876939323',
        bus: 'SPI',
        devname: 'sdi',
        supports_smart: null,
        pool: 'MOCK_POOL',
      },
      {
        identifier: '{uuid}d5433b0f-180b-4706-afd0-476915e8925f9',
        name: 'sdj',
        subsystem: 'scsi',
        number: 2080,
        serial: '1234567890abcd9',
        lunid: null,
        size: 4398046511104,
        description: '',
        duplicate_serial: [],
        transfermode: 'Auto',
        hddstandby: 'ALWAYS ON',
        advpowermgmt: 'DISABLED',
        togglesmart: true,
        smartoptions: '',
        expiretime: null,
        critical: null,
        difference: null,
        informational: null,
        model: 'HARDDISK',
        rotationrate: null,
        type: 'HDD',
        zfs_guid: '594160193876939323',
        bus: 'SPI',
        devname: 'sdj',
        supports_smart: null,
        pool: 'MOCK_POOL',
      },
      {
        identifier: '{uuid}d5433b0f-180b-4706-afd0-476915e8925f10',
        name: 'sdk',
        subsystem: 'scsi',
        number: 2080,
        serial: '1234567890abcd10',
        lunid: null,
        size: 4398046511104,
        description: '',
        duplicate_serial: [],
        transfermode: 'Auto',
        hddstandby: 'ALWAYS ON',
        advpowermgmt: 'DISABLED',
        togglesmart: true,
        smartoptions: '',
        expiretime: null,
        critical: null,
        difference: null,
        informational: null,
        model: 'HARDDISK',
        rotationrate: null,
        type: 'HDD',
        zfs_guid: '594160193876939323',
        bus: 'SPI',
        devname: 'sdk',
        supports_smart: null,
        pool: 'MOCK_POOL',
      },
      {
        identifier: '{uuid}d5433b0f-180b-4706-afd0-476915e8925f11',
        name: 'sdl',
        subsystem: 'scsi',
        number: 2080,
        serial: '1234567890abcd11',
        lunid: null,
        size: 4398046511104,
        description: '',
        duplicate_serial: [],
        transfermode: 'Auto',
        hddstandby: 'ALWAYS ON',
        advpowermgmt: 'DISABLED',
        togglesmart: true,
        smartoptions: '',
        expiretime: null,
        critical: null,
        difference: null,
        informational: null,
        model: 'HARDDISK',
        rotationrate: null,
        type: 'HDD',
        zfs_guid: '594160193876939323',
        bus: 'SPI',
        devname: 'sdl',
        supports_smart: null,
        pool: 'MOCK_POOL',
      },
      {
        identifier: '{uuid}d5433b0f-180b-4706-afd0-476915e8925f12',
        name: 'sdm',
        subsystem: 'scsi',
        number: 2080,
        serial: '1234567890abcd12',
        lunid: null,
        size: 4398046511104,
        description: '',
        duplicate_serial: [],
        transfermode: 'Auto',
        hddstandby: 'ALWAYS ON',
        advpowermgmt: 'DISABLED',
        togglesmart: true,
        smartoptions: '',
        expiretime: null,
        critical: null,
        difference: null,
        informational: null,
        model: 'HARDDISK',
        rotationrate: null,
        type: 'HDD',
        zfs_guid: '594160193876939323',
        bus: 'SPI',
        devname: 'sdm',
        supports_smart: null,
        pool: 'MOCK_POOL',
      },
      {
        identifier: '{uuid}d5433b0f-180b-4706-afd0-476915e8925f13',
        name: 'sdn',
        subsystem: 'scsi',
        number: 2080,
        serial: '1234567890abcd13',
        lunid: null,
        size: 4398046511104,
        description: '',
        duplicate_serial: [],
        transfermode: 'Auto',
        hddstandby: 'ALWAYS ON',
        advpowermgmt: 'DISABLED',
        togglesmart: true,
        smartoptions: '',
        expiretime: null,
        critical: null,
        difference: null,
        informational: null,
        model: 'HARDDISK',
        rotationrate: null,
        type: 'HDD',
        zfs_guid: '594160193876939323',
        bus: 'SPI',
        devname: 'sdn',
        supports_smart: null,
        pool: 'MOCK_POOL',
      },
      {
        identifier: '{uuid}d5433b0f-180b-4706-afd0-476915e8925f14',
        name: 'sdo',
        subsystem: 'scsi',
        number: 2080,
        serial: '1234567890abcd14',
        lunid: null,
        size: 4398046511104,
        description: '',
        duplicate_serial: [],
        transfermode: 'Auto',
        hddstandby: 'ALWAYS ON',
        advpowermgmt: 'DISABLED',
        togglesmart: true,
        smartoptions: '',
        expiretime: null,
        critical: null,
        difference: null,
        informational: null,
        model: 'HARDDISK',
        rotationrate: null,
        type: 'HDD',
        zfs_guid: '594160193876939323',
        bus: 'SPI',
        devname: 'sdo',
        supports_smart: null,
        pool: 'MOCK_POOL',
      },
      {
        identifier: '{uuid}d5433b0f-180b-4706-afd0-476915e8925f15',
        name: 'sdp',
        subsystem: 'scsi',
        number: 2080,
        serial: '1234567890abcd15',
        lunid: null,
        size: 4398046511104,
        description: '',
        duplicate_serial: [],
        transfermode: 'Auto',
        hddstandby: 'ALWAYS ON',
        advpowermgmt: 'DISABLED',
        togglesmart: true,
        smartoptions: '',
        expiretime: null,
        critical: null,
        difference: null,
        informational: null,
        model: 'HARDDISK',
        rotationrate: null,
        type: 'HDD',
        zfs_guid: '594160193876939323',
        bus: 'SPI',
        devname: 'sdp',
        supports_smart: null,
        pool: 'MOCK_POOL',
      },
    ] as Disk[];

    const dataDiskSizes = storageService.getVdevDiskCapacities(
      mockTopology.data,
      mockDisks,
    );

    const specialDiskSizes = storageService.getVdevDiskCapacities(
      mockTopology.special,
      mockDisks,
    );

    const dedupDiskSizes = storageService.getVdevDiskCapacities(
      mockTopology.dedup,
      mockDisks,
    );

    it('checks for disk capacity', () => {
      expect(dataDiskSizes[0].has(generatedDiskSizeInBytes)).toBe(true);
      expect(specialDiskSizes[0].has(generatedDiskSizeInBytes)).toBe(false);
      expect(dedupDiskSizes[0].has(generatedDiskSizeInBytes)).toBe(false);
      expect(dedupDiskSizes[1].has(generatedDiskSizeInBytes)).toBe(false);
    });

    it('detects mixed disk capacities within a VDEV', () => {
      const isDataMixed = storageService.isMixedVdevDiskCapacity(dataDiskSizes);
      const isDedupMixed = storageService.isMixedVdevDiskCapacity(dedupDiskSizes);
      const isSpecialMixed = storageService.isMixedVdevDiskCapacity(specialDiskSizes);

      expect(isDataMixed).toBe(true);
      expect(isSpecialMixed).toBe(false);
      expect(isDedupMixed).toBe(false);

      /*
      * NOTE: Disk capacities are checked on a per VDEV basis.
      * This is why Dedup topology returns false even though
      * there are different disk sizes in each VDEV
      * */
    });
  });

  describe('detects mixed VDEV types', () => {
    const mockTopology = {
      data: [
        {
          type: 'RAIDZ1',
          children: [
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sda',
              stats: {
                size: 4398046511104,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sda2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdb',
              stats: {
                size: 4398046511104,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdb2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdc',
              stats: {
                size: 4398046511104,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdc2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdd',
              stats: {
                size: 4398046511104,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdd2',
              guid: '12345',
              unavail_disk: null,
            },
          ],
          guid: '12345',
          unavail_disk: null,
          stats: {
            size: 13194139533312,
          },
          status: 'ONLINE',
          name: 'RAIDZ1-0',
        },
        {
          type: 'MIRROR',
          children: [
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sde',
              stats: {
                size: 4398046511104,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sde2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdf',
              stats: {
                size: 4398046511104,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdf2',
              guid: '12345',
              unavail_disk: null,
            },
          ],
          guid: '12345',
          unavail_disk: null,
          stats: {
            size: 4398046511104,
          },
          status: 'ONLINE',
          name: 'MIRROR-1',
        },
      ],
      special: [
        {
          type: 'RAIDZ1',
          children: [
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdg',
              stats: {
                size: 4398046511104,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdg2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdh',
              stats: {
                size: 4398046511104,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdh2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdi',
              stats: {
                size: 4398046511104,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdi2',
              guid: '12345',
              unavail_disk: null,
            },
            {
              type: 'DISK',
              status: 'ONLINE',
              children: [],
              disk: 'sdj',
              stats: {
                size: 4398046511104,
                timestamp: 164848882662718,
                read_errors: 0,
                write_errors: 0,
                checksum_errors: 0,
              },
              device: 'sdj2',
              guid: '12345',
              unavail_disk: null,
            },
          ],
          guid: '12345',
          unavail_disk: null,
          stats: {
            size: 13194139533312,
          },
          status: 'ONLINE',
          name: 'RAIDZ1-0',
        },
      ],
      log: [],
      spare: [],
      cache: [],
      dedup: [],
    } as PoolTopology;

    const dataLayouts = storageService.getVdevTypes(mockTopology.data);
    const specialLayouts = storageService.getVdevTypes(mockTopology.special);

    it('can detect VDEV layouts', () => {
      expect(dataLayouts.size).toBe(2);
      expect(specialLayouts.size).toBe(1);
    });

    it('can detect mixed layouts', () => {
      const isDataMixed: boolean = storageService.isMixedVdevType(dataLayouts);
      const isSpecialMixed: boolean = storageService.isMixedVdevType(specialLayouts);

      expect(isDataMixed).toBe(true);
      expect(isSpecialMixed).toBe(false);
    });
  });

  describe('VDEV validator', () => {
    /*
    * NOTE:
    * Validator generally only validates a single topology category at a time.
    * The only exception to this is with Special and Dedup VDEVs. Best practices
    * dictate that the redundancy level should match the Data VDEVs. For this reason
    * we also pass in the data topology to the validator.
    * */

    it('generates warning for "No Redundancy"', () => {
      const mockTopology = {
        data: [
          {
            type: 'DISK',
            status: 'ONLINE',
            children: [],
            disk: 'sda',
            stats: {
              size: null,
            },
            device: null,
            guid: '12345',
            unavail_disk: null,
          },
          {
            type: 'DISK',
            status: 'ONLINE',
            children: [],
            disk: 'sdb',
            stats: {
              size: null,
            },
            device: null,
            guid: '12345',
            unavail_disk: null,
          },
          {
            type: 'DISK',
            status: 'ONLINE',
            children: [],
            disk: 'sdc',
            stats: {
              size: null,
            },
            device: null,
            guid: '12345',
            unavail_disk: null,
          },
          {
            type: 'DISK',
            status: 'ONLINE',
            children: [],
            disk: 'sdd',
            stats: {
              size: null,
            },
            device: null,
            guid: '12345',
            unavail_disk: null,
          },
        ],
        special: [],
        log: [],
        spare: [],
        cache: [],
        dedup: [],
      } as PoolTopology;

      const mockDisks = [
        {
          identifier: '{uuid}d5433b0f-180b-4706-afd0-476915e8925f0',
          name: 'sda',
          subsystem: 'scsi',
          number: 2080,
          serial: '1234567890abcd0',
          lunid: null,
          size: 4398046511104,
          description: '',
          duplicate_serial: [],
          transfermode: 'Auto',
          hddstandby: 'ALWAYS ON',
          advpowermgmt: 'DISABLED',
          togglesmart: true,
          smartoptions: '',
          expiretime: null,
          critical: null,
          difference: null,
          informational: null,
          model: 'HARDDISK',
          rotationrate: null,
          type: 'HDD',
          zfs_guid: '594160193876939323',
          bus: 'SPI',
          devname: 'sda',
          supports_smart: null,
          pool: 'MOCK_POOL',
        },
        {
          identifier: '{uuid}d5433b0f-180b-4706-afd0-476915e8925f1',
          name: 'sdb',
          subsystem: 'scsi',
          number: 2080,
          serial: '1234567890abcd1',
          lunid: null,
          size: 4398046511104,
          description: '',
          duplicate_serial: [],
          transfermode: 'Auto',
          hddstandby: 'ALWAYS ON',
          advpowermgmt: 'DISABLED',
          togglesmart: true,
          smartoptions: '',
          expiretime: null,
          critical: null,
          difference: null,
          informational: null,
          model: 'HARDDISK',
          rotationrate: null,
          type: 'HDD',
          zfs_guid: '594160193876939323',
          bus: 'SPI',
          devname: 'sdb',
          supports_smart: null,
          pool: 'MOCK_POOL',
        },
        {
          identifier: '{uuid}d5433b0f-180b-4706-afd0-476915e8925f2',
          name: 'sdc',
          subsystem: 'scsi',
          number: 2080,
          serial: '1234567890abcd2',
          lunid: null,
          size: 4398046511104,
          description: '',
          duplicate_serial: [],
          transfermode: 'Auto',
          hddstandby: 'ALWAYS ON',
          advpowermgmt: 'DISABLED',
          togglesmart: true,
          smartoptions: '',
          expiretime: null,
          critical: null,
          difference: null,
          informational: null,
          model: 'HARDDISK',
          rotationrate: null,
          type: 'HDD',
          zfs_guid: '594160193876939323',
          bus: 'SPI',
          devname: 'sdc',
          supports_smart: null,
          pool: 'MOCK_POOL',
        },
        {
          identifier: '{uuid}d5433b0f-180b-4706-afd0-476915e8925f3',
          name: 'sdd',
          subsystem: 'scsi',
          number: 2080,
          serial: '1234567890abcd3',
          lunid: null,
          size: 4398046511104,
          description: '',
          duplicate_serial: [],
          transfermode: 'Auto',
          hddstandby: 'ALWAYS ON',
          advpowermgmt: 'DISABLED',
          togglesmart: true,
          smartoptions: '',
          expiretime: null,
          critical: null,
          difference: null,
          informational: null,
          model: 'HARDDISK',
          rotationrate: null,
          type: 'HDD',
          zfs_guid: '594160193876939323',
          bus: 'SPI',
          devname: 'sdd',
          supports_smart: null,
          pool: 'MOCK_POOL',
        },
      ] as Disk[];

      const warnings = storageService.validateVdevs(
        VdevType.Data,
        mockTopology.data,
        mockDisks,
      );

      expect(warnings).toHaveLength(1);
      expect(warnings[0]).toBe(TopologyWarning.NoRedundancy);
    });

    it('generates warning for "Mixed VDEV Capacities"', () => {
      const mockDisks = [
        {
          identifier: '{uuid}d5433b0f-180b-4706-afd0-476915e8925f0',
          name: 'sda',
          subsystem: 'scsi',
          number: 2080,
          serial: '1234567890abcd0',
          lunid: null,
          size: 6597069766656,
          description: '',
          duplicate_serial: [],
          transfermode: 'Auto',
          hddstandby: 'ALWAYS ON',
          advpowermgmt: 'DISABLED',
          togglesmart: true,
          smartoptions: '',
          expiretime: null,
          critical: null,
          difference: null,
          informational: null,
          model: 'HARDDISK',
          rotationrate: null,
          type: 'HDD',
          zfs_guid: '594160193876939323',
          bus: 'SPI',
          devname: 'sda',
          supports_smart: null,
          pool: 'MOCK_POOL',
        },
        {
          identifier: '{uuid}d5433b0f-180b-4706-afd0-476915e8925f1',
          name: 'sdb',
          subsystem: 'scsi',
          number: 2080,
          serial: '1234567890abcd1',
          lunid: null,
          size: 6597069766656,
          description: '',
          duplicate_serial: [],
          transfermode: 'Auto',
          hddstandby: 'ALWAYS ON',
          advpowermgmt: 'DISABLED',
          togglesmart: true,
          smartoptions: '',
          expiretime: null,
          critical: null,
          difference: null,
          informational: null,
          model: 'HARDDISK',
          rotationrate: null,
          type: 'HDD',
          zfs_guid: '594160193876939323',
          bus: 'SPI',
          devname: 'sdb',
          supports_smart: null,
          pool: 'MOCK_POOL',
        },
        {
          identifier: '{uuid}d5433b0f-180b-4706-afd0-476915e8925f2',
          name: 'sdc',
          subsystem: 'scsi',
          number: 2080,
          serial: '1234567890abcd2',
          lunid: null,
          size: 4398046511104,
          description: '',
          duplicate_serial: [],
          transfermode: 'Auto',
          hddstandby: 'ALWAYS ON',
          advpowermgmt: 'DISABLED',
          togglesmart: true,
          smartoptions: '',
          expiretime: null,
          critical: null,
          difference: null,
          informational: null,
          model: 'HARDDISK',
          rotationrate: null,
          type: 'HDD',
          zfs_guid: '594160193876939323',
          bus: 'SPI',
          devname: 'sdc',
          supports_smart: null,
          pool: 'MOCK_POOL',
        },
        {
          identifier: '{uuid}d5433b0f-180b-4706-afd0-476915e8925f3',
          name: 'sdd',
          subsystem: 'scsi',
          number: 2080,
          serial: '1234567890abcd3',
          lunid: null,
          size: 4398046511104,
          description: '',
          duplicate_serial: [],
          transfermode: 'Auto',
          hddstandby: 'ALWAYS ON',
          advpowermgmt: 'DISABLED',
          togglesmart: true,
          smartoptions: '',
          expiretime: null,
          critical: null,
          difference: null,
          informational: null,
          model: 'HARDDISK',
          rotationrate: null,
          type: 'HDD',
          zfs_guid: '594160193876939323',
          bus: 'SPI',
          devname: 'sdd',
          supports_smart: null,
          pool: 'MOCK_POOL',
        },
        {
          identifier: '{uuid}d5433b0f-180b-4706-afd0-476915e8925f4',
          name: 'sde',
          subsystem: 'scsi',
          number: 2080,
          serial: '1234567890abcd4',
          lunid: null,
          size: 4398046511104,
          description: '',
          duplicate_serial: [],
          transfermode: 'Auto',
          hddstandby: 'ALWAYS ON',
          advpowermgmt: 'DISABLED',
          togglesmart: true,
          smartoptions: '',
          expiretime: null,
          critical: null,
          difference: null,
          informational: null,
          model: 'HARDDISK',
          rotationrate: null,
          type: 'HDD',
          zfs_guid: '594160193876939323',
          bus: 'SPI',
          devname: 'sde',
          supports_smart: null,
          pool: 'MOCK_POOL',
        },
        {
          identifier: '{uuid}d5433b0f-180b-4706-afd0-476915e8925f5',
          name: 'sdf',
          subsystem: 'scsi',
          number: 2080,
          serial: '1234567890abcd5',
          lunid: null,
          size: 4398046511104,
          description: '',
          duplicate_serial: [],
          transfermode: 'Auto',
          hddstandby: 'ALWAYS ON',
          advpowermgmt: 'DISABLED',
          togglesmart: true,
          smartoptions: '',
          expiretime: null,
          critical: null,
          difference: null,
          informational: null,
          model: 'HARDDISK',
          rotationrate: null,
          type: 'HDD',
          zfs_guid: '594160193876939323',
          bus: 'SPI',
          devname: 'sdf',
          supports_smart: null,
          pool: 'MOCK_POOL',
        },
      ] as Disk[];

      const mockTopology = {
        data: [
          {
            type: 'MIRROR',
            children: [
              {
                type: 'DISK',
                status: 'ONLINE',
                children: [],
                disk: 'sda',
                stats: {
                  size: 6597069766656,
                  timestamp: 164848882662718,
                  read_errors: 0,
                  write_errors: 0,
                  checksum_errors: 0,
                },
                device: 'sda2',
                guid: '12345',
                unavail_disk: null,
              },
              {
                type: 'DISK',
                status: 'ONLINE',
                children: [],
                disk: 'sdb',
                stats: {
                  size: 6597069766656,
                  timestamp: 164848882662718,
                  read_errors: 0,
                  write_errors: 0,
                  checksum_errors: 0,
                },
                device: 'sdb2',
                guid: '12345',
                unavail_disk: null,
              },
            ],
            guid: '12345',
            unavail_disk: null,
            stats: {
              size: 6597069766656,
            },
            status: 'ONLINE',
            name: 'MIRROR-0',
          },
          {
            type: 'MIRROR',
            children: [
              {
                type: 'DISK',
                status: 'ONLINE',
                children: [],
                disk: 'sdc',
                stats: {
                  size: 4398046511104,
                  timestamp: 164848882662718,
                  read_errors: 0,
                  write_errors: 0,
                  checksum_errors: 0,
                },
                device: 'sdc2',
                guid: '12345',
                unavail_disk: null,
              },
              {
                type: 'DISK',
                status: 'ONLINE',
                children: [],
                disk: 'sdd',
                stats: {
                  size: 4398046511104,
                  timestamp: 164848882662718,
                  read_errors: 0,
                  write_errors: 0,
                  checksum_errors: 0,
                },
                device: 'sdd2',
                guid: '12345',
                unavail_disk: null,
              },
            ],
            guid: '12345',
            unavail_disk: null,
            stats: {
              size: 4398046511104,
            },
            status: 'ONLINE',
            name: 'MIRROR-1',
          },
          {
            type: 'MIRROR',
            children: [
              {
                type: 'DISK',
                status: 'ONLINE',
                children: [],
                disk: 'sde',
                stats: {
                  size: 4398046511104,
                  timestamp: 164848882662718,
                  read_errors: 0,
                  write_errors: 0,
                  checksum_errors: 0,
                },
                device: 'sde2',
                guid: '12345',
                unavail_disk: null,
              },
              {
                type: 'DISK',
                status: 'ONLINE',
                children: [],
                disk: 'sdf',
                stats: {
                  size: 4398046511104,
                  timestamp: 164848882662718,
                  read_errors: 0,
                  write_errors: 0,
                  checksum_errors: 0,
                },
                device: 'sdf2',
                guid: '12345',
                unavail_disk: null,
              },
            ],
            guid: '12345',
            unavail_disk: null,
            stats: {
              size: 4398046511104,
            },
            status: 'ONLINE',
            name: 'MIRROR-2',
          },
        ],
        special: [],
        log: [],
        spare: [],
        cache: [],
        dedup: [],
      } as PoolTopology;

      const warnings = storageService.validateVdevs(
        VdevType.Data,
        mockTopology.data,
        mockDisks,
      );

      expect(warnings).toHaveLength(1);
      expect(warnings[0]).toBe(TopologyWarning.MixedVdevCapacity);
    });

    it('generates warning for "Mixed Disk Capacities"', () => {
      const mockDisks = [
        {
          identifier: '{uuid}d5433b0f-180b-4706-afd0-476915e8925f0',
          name: 'sda',
          subsystem: 'scsi',
          number: 2080,
          serial: '1234567890abcd0',
          lunid: null,
          size: 5497558138880,
          description: '',
          duplicate_serial: [],
          transfermode: 'Auto',
          hddstandby: 'ALWAYS ON',
          advpowermgmt: 'DISABLED',
          togglesmart: true,
          smartoptions: '',
          expiretime: null,
          critical: null,
          difference: null,
          informational: null,
          model: 'HARDDISK',
          rotationrate: null,
          type: 'HDD',
          zfs_guid: '594160193876939323',
          bus: 'SPI',
          devname: 'sda',
          supports_smart: null,
          pool: 'MOCK_POOL',
        },
        {
          identifier: '{uuid}d5433b0f-180b-4706-afd0-476915e8925f1',
          name: 'sdb',
          subsystem: 'scsi',
          number: 2080,
          serial: '1234567890abcd1',
          lunid: null,
          size: 4398046511104,
          description: '',
          duplicate_serial: [],
          transfermode: 'Auto',
          hddstandby: 'ALWAYS ON',
          advpowermgmt: 'DISABLED',
          togglesmart: true,
          smartoptions: '',
          expiretime: null,
          critical: null,
          difference: null,
          informational: null,
          model: 'HARDDISK',
          rotationrate: null,
          type: 'HDD',
          zfs_guid: '594160193876939323',
          bus: 'SPI',
          devname: 'sdb',
          supports_smart: null,
          pool: 'MOCK_POOL',
        },
        {
          identifier: '{uuid}d5433b0f-180b-4706-afd0-476915e8925f2',
          name: 'sdc',
          subsystem: 'scsi',
          number: 2080,
          serial: '1234567890abcd2',
          lunid: null,
          size: 5497558138880,
          description: '',
          duplicate_serial: [],
          transfermode: 'Auto',
          hddstandby: 'ALWAYS ON',
          advpowermgmt: 'DISABLED',
          togglesmart: true,
          smartoptions: '',
          expiretime: null,
          critical: null,
          difference: null,
          informational: null,
          model: 'HARDDISK',
          rotationrate: null,
          type: 'HDD',
          zfs_guid: '594160193876939323',
          bus: 'SPI',
          devname: 'sdc',
          supports_smart: null,
          pool: 'MOCK_POOL',
        },
        {
          identifier: '{uuid}d5433b0f-180b-4706-afd0-476915e8925f3',
          name: 'sdd',
          subsystem: 'scsi',
          number: 2080,
          serial: '1234567890abcd3',
          lunid: null,
          size: 4398046511104,
          description: '',
          duplicate_serial: [],
          transfermode: 'Auto',
          hddstandby: 'ALWAYS ON',
          advpowermgmt: 'DISABLED',
          togglesmart: true,
          smartoptions: '',
          expiretime: null,
          critical: null,
          difference: null,
          informational: null,
          model: 'HARDDISK',
          rotationrate: null,
          type: 'HDD',
          zfs_guid: '594160193876939323',
          bus: 'SPI',
          devname: 'sdd',
          supports_smart: null,
          pool: 'MOCK_POOL',
        },
        {
          identifier: '{uuid}d5433b0f-180b-4706-afd0-476915e8925f4',
          name: 'sde',
          subsystem: 'scsi',
          number: 2080,
          serial: '1234567890abcd4',
          lunid: null,
          size: 5497558138880,
          description: '',
          duplicate_serial: [],
          transfermode: 'Auto',
          hddstandby: 'ALWAYS ON',
          advpowermgmt: 'DISABLED',
          togglesmart: true,
          smartoptions: '',
          expiretime: null,
          critical: null,
          difference: null,
          informational: null,
          model: 'HARDDISK',
          rotationrate: null,
          type: 'HDD',
          zfs_guid: '594160193876939323',
          bus: 'SPI',
          devname: 'sde',
          supports_smart: null,
          pool: 'MOCK_POOL',
        },
        {
          identifier: '{uuid}d5433b0f-180b-4706-afd0-476915e8925f5',
          name: 'sdf',
          subsystem: 'scsi',
          number: 2080,
          serial: '1234567890abcd5',
          lunid: null,
          size: 4398046511104,
          description: '',
          duplicate_serial: [],
          transfermode: 'Auto',
          hddstandby: 'ALWAYS ON',
          advpowermgmt: 'DISABLED',
          togglesmart: true,
          smartoptions: '',
          expiretime: null,
          critical: null,
          difference: null,
          informational: null,
          model: 'HARDDISK',
          rotationrate: null,
          type: 'HDD',
          zfs_guid: '594160193876939323',
          bus: 'SPI',
          devname: 'sdf',
          supports_smart: null,
          pool: 'MOCK_POOL',
        },
      ] as Disk[];

      const mockTopology = {
        data: [
          {
            type: 'MIRROR',
            children: [
              {
                type: 'DISK',
                status: 'ONLINE',
                children: [],
                disk: 'sda',
                stats: {
                  size: 5497558138880,
                  timestamp: 164848882662718,
                  read_errors: 0,
                  write_errors: 0,
                  checksum_errors: 0,
                },
                device: 'sda2',
                guid: '12345',
                unavail_disk: null,
              },
              {
                type: 'DISK',
                status: 'ONLINE',
                children: [],
                disk: 'sdb',
                stats: {
                  size: 4398046511104,
                  timestamp: 164848882662718,
                  read_errors: 0,
                  write_errors: 0,
                  checksum_errors: 0,
                },
                device: 'sdb2',
                guid: '12345',
                unavail_disk: null,
              },
            ],
            guid: '12345',
            unavail_disk: null,
            stats: {
              size: 5497558138880,
            },
            status: 'ONLINE',
            name: 'MIRROR-0',
          },
          {
            type: 'MIRROR',
            children: [
              {
                type: 'DISK',
                status: 'ONLINE',
                children: [],
                disk: 'sdc',
                stats: {
                  size: 5497558138880,
                  timestamp: 164848882662718,
                  read_errors: 0,
                  write_errors: 0,
                  checksum_errors: 0,
                },
                device: 'sdc2',
                guid: '12345',
                unavail_disk: null,
              },
              {
                type: 'DISK',
                status: 'ONLINE',
                children: [],
                disk: 'sdd',
                stats: {
                  size: 4398046511104,
                  timestamp: 164848882662718,
                  read_errors: 0,
                  write_errors: 0,
                  checksum_errors: 0,
                },
                device: 'sdd2',
                guid: '12345',
                unavail_disk: null,
              },
            ],
            guid: '12345',
            unavail_disk: null,
            stats: {
              size: 5497558138880,
            },
            status: 'ONLINE',
            name: 'MIRROR-1',
          },
          {
            type: 'MIRROR',
            children: [
              {
                type: 'DISK',
                status: 'ONLINE',
                children: [],
                disk: 'sde',
                stats: {
                  size: 5497558138880,
                  timestamp: 164848882662718,
                  read_errors: 0,
                  write_errors: 0,
                  checksum_errors: 0,
                },
                device: 'sde2',
                guid: '12345',
                unavail_disk: null,
              },
              {
                type: 'DISK',
                status: 'ONLINE',
                children: [],
                disk: 'sdf',
                stats: {
                  size: 4398046511104,
                  timestamp: 164848882662718,
                  read_errors: 0,
                  write_errors: 0,
                  checksum_errors: 0,
                },
                device: 'sdf2',
                guid: '12345',
                unavail_disk: null,
              },
            ],
            guid: '12345',
            unavail_disk: null,
            stats: {
              size: 5497558138880,
            },
            status: 'ONLINE',
            name: 'MIRROR-2',
          },
        ],
        special: [],
        log: [],
        spare: [],
        cache: [],
        dedup: [],
      } as PoolTopology;
      const warnings = storageService.validateVdevs(
        VdevType.Data,
        mockTopology.data,
        mockDisks,
      );

      expect(warnings).toHaveLength(1);
      expect(warnings[0]).toBe(TopologyWarning.MixedDiskCapacity);
    });

    it('generates warning for "Mixed VDEV Width"', () => {
      const mockDisks = [
        {
          identifier: '{uuid}d5433b0f-180b-4706-afd0-476915e8925f0',
          name: 'sda',
          subsystem: 'scsi',
          number: 2080,
          serial: '1234567890abcd0',
          lunid: null,
          size: 4398046511104,
          description: '',
          duplicate_serial: [],
          transfermode: 'Auto',
          hddstandby: 'ALWAYS ON',
          advpowermgmt: 'DISABLED',
          togglesmart: true,
          smartoptions: '',
          expiretime: null,
          critical: null,
          difference: null,
          informational: null,
          model: 'HARDDISK',
          rotationrate: null,
          type: 'HDD',
          zfs_guid: '594160193876939323',
          bus: 'SPI',
          devname: 'sda',
          supports_smart: null,
          pool: 'MOCK_POOL',
        },
        {
          identifier: '{uuid}d5433b0f-180b-4706-afd0-476915e8925f1',
          name: 'sdb',
          subsystem: 'scsi',
          number: 2080,
          serial: '1234567890abcd1',
          lunid: null,
          size: 4398046511104,
          description: '',
          duplicate_serial: [],
          transfermode: 'Auto',
          hddstandby: 'ALWAYS ON',
          advpowermgmt: 'DISABLED',
          togglesmart: true,
          smartoptions: '',
          expiretime: null,
          critical: null,
          difference: null,
          informational: null,
          model: 'HARDDISK',
          rotationrate: null,
          type: 'HDD',
          zfs_guid: '594160193876939323',
          bus: 'SPI',
          devname: 'sdb',
          supports_smart: null,
          pool: 'MOCK_POOL',
        },
        {
          identifier: '{uuid}d5433b0f-180b-4706-afd0-476915e8925f2',
          name: 'sdc',
          subsystem: 'scsi',
          number: 2080,
          serial: '1234567890abcd2',
          lunid: null,
          size: 4398046511104,
          description: '',
          duplicate_serial: [],
          transfermode: 'Auto',
          hddstandby: 'ALWAYS ON',
          advpowermgmt: 'DISABLED',
          togglesmart: true,
          smartoptions: '',
          expiretime: null,
          critical: null,
          difference: null,
          informational: null,
          model: 'HARDDISK',
          rotationrate: null,
          type: 'HDD',
          zfs_guid: '594160193876939323',
          bus: 'SPI',
          devname: 'sdc',
          supports_smart: null,
          pool: 'MOCK_POOL',
        },
        {
          identifier: '{uuid}d5433b0f-180b-4706-afd0-476915e8925f3',
          name: 'sdd',
          subsystem: 'scsi',
          number: 2080,
          serial: '1234567890abcd3',
          lunid: null,
          size: 4398046511104,
          description: '',
          duplicate_serial: [],
          transfermode: 'Auto',
          hddstandby: 'ALWAYS ON',
          advpowermgmt: 'DISABLED',
          togglesmart: true,
          smartoptions: '',
          expiretime: null,
          critical: null,
          difference: null,
          informational: null,
          model: 'HARDDISK',
          rotationrate: null,
          type: 'HDD',
          zfs_guid: '594160193876939323',
          bus: 'SPI',
          devname: 'sdd',
          supports_smart: null,
          pool: 'MOCK_POOL',
        },
        {
          identifier: '{uuid}d5433b0f-180b-4706-afd0-476915e8925f4',
          name: 'sde',
          subsystem: 'scsi',
          number: 2080,
          serial: '1234567890abcd4',
          lunid: null,
          size: 4398046511104,
          description: '',
          duplicate_serial: [],
          transfermode: 'Auto',
          hddstandby: 'ALWAYS ON',
          advpowermgmt: 'DISABLED',
          togglesmart: true,
          smartoptions: '',
          expiretime: null,
          critical: null,
          difference: null,
          informational: null,
          model: 'HARDDISK',
          rotationrate: null,
          type: 'HDD',
          zfs_guid: '594160193876939323',
          bus: 'SPI',
          devname: 'sde',
          supports_smart: null,
          pool: 'MOCK_POOL',
        },
        {
          identifier: '{uuid}d5433b0f-180b-4706-afd0-476915e8925f5',
          name: 'sdf',
          subsystem: 'scsi',
          number: 2080,
          serial: '1234567890abcd5',
          lunid: null,
          size: 4398046511104,
          description: '',
          duplicate_serial: [],
          transfermode: 'Auto',
          hddstandby: 'ALWAYS ON',
          advpowermgmt: 'DISABLED',
          togglesmart: true,
          smartoptions: '',
          expiretime: null,
          critical: null,
          difference: null,
          informational: null,
          model: 'HARDDISK',
          rotationrate: null,
          type: 'HDD',
          zfs_guid: '594160193876939323',
          bus: 'SPI',
          devname: 'sdf',
          supports_smart: null,
          pool: 'MOCK_POOL',
        },
        {
          identifier: '{uuid}d5433b0f-180b-4706-afd0-476915e8925f6',
          name: 'sdg',
          subsystem: 'scsi',
          number: 2080,
          serial: '1234567890abcd6',
          lunid: null,
          size: 4398046511104,
          description: '',
          duplicate_serial: [],
          transfermode: 'Auto',
          hddstandby: 'ALWAYS ON',
          advpowermgmt: 'DISABLED',
          togglesmart: true,
          smartoptions: '',
          expiretime: null,
          critical: null,
          difference: null,
          informational: null,
          model: 'HARDDISK',
          rotationrate: null,
          type: 'HDD',
          zfs_guid: '594160193876939323',
          bus: 'SPI',
          devname: 'sdg',
          supports_smart: null,
          pool: 'MOCK_POOL',
        },
      ] as Disk[];

      const mockTopology = {
        data: [
          {
            type: 'MIRROR',
            children: [
              {
                type: 'DISK',
                status: 'ONLINE',
                children: [],
                disk: 'sda',
                stats: {
                  size: 4398046511104,
                  timestamp: 164848882662718,
                  read_errors: 0,
                  write_errors: 0,
                  checksum_errors: 0,
                },
                device: 'sda2',
                guid: '12345',
                unavail_disk: null,
              },
              {
                type: 'DISK',
                status: 'ONLINE',
                children: [],
                disk: 'sdb',
                stats: {
                  size: 4398046511104,
                  timestamp: 164848882662718,
                  read_errors: 0,
                  write_errors: 0,
                  checksum_errors: 0,
                },
                device: 'sdb2',
                guid: '12345',
                unavail_disk: null,
              },
              {
                type: 'DISK',
                status: 'ONLINE',
                children: [],
                disk: 'sdc',
                stats: {
                  size: 4398046511104,
                  timestamp: 164848882662718,
                  read_errors: 0,
                  write_errors: 0,
                  checksum_errors: 0,
                },
                device: 'sdc2',
                guid: '12345',
                unavail_disk: null,
              },
            ],
            guid: '12345',
            unavail_disk: null,
            stats: {
              size: 4398046511104,
            },
            status: 'ONLINE',
            name: 'MIRROR-0',
          },
          {
            type: 'MIRROR',
            children: [
              {
                type: 'DISK',
                status: 'ONLINE',
                children: [],
                disk: 'sdd',
                stats: {
                  size: 4398046511104,
                  timestamp: 164848882662718,
                  read_errors: 0,
                  write_errors: 0,
                  checksum_errors: 0,
                },
                device: 'sdd2',
                guid: '12345',
                unavail_disk: null,
              },
              {
                type: 'DISK',
                status: 'ONLINE',
                children: [],
                disk: 'sde',
                stats: {
                  size: 4398046511104,
                  timestamp: 164848882662718,
                  read_errors: 0,
                  write_errors: 0,
                  checksum_errors: 0,
                },
                device: 'sde2',
                guid: '12345',
                unavail_disk: null,
              },
            ],
            guid: '12345',
            unavail_disk: null,
            stats: {
              size: 4398046511104,
            },
            status: 'ONLINE',
            name: 'MIRROR-1',
          },
          {
            type: 'MIRROR',
            children: [
              {
                type: 'DISK',
                status: 'ONLINE',
                children: [],
                disk: 'sdf',
                stats: {
                  size: 4398046511104,
                  timestamp: 164848882662718,
                  read_errors: 0,
                  write_errors: 0,
                  checksum_errors: 0,
                },
                device: 'sdf2',
                guid: '12345',
                unavail_disk: null,
              },
              {
                type: 'DISK',
                status: 'ONLINE',
                children: [],
                disk: 'sdg',
                stats: {
                  size: 4398046511104,
                  timestamp: 164848882662718,
                  read_errors: 0,
                  write_errors: 0,
                  checksum_errors: 0,
                },
                device: 'sdg2',
                guid: '12345',
                unavail_disk: null,
              },
            ],
            guid: '12345',
            unavail_disk: null,
            stats: {
              size: 4398046511104,
            },
            status: 'ONLINE',
            name: 'MIRROR-2',
          },
        ],
        special: [],
        log: [],
        spare: [],
        cache: [],
        dedup: [],
      } as PoolTopology;
      const warnings = storageService.validateVdevs(
        VdevType.Data,
        mockTopology.data,
        mockDisks,
      );

      expect(warnings).toHaveLength(1);
      expect(warnings[0]).toBe(TopologyWarning.MixedVdevWidth);
    });

    it('generates warning for "Mixed VDEV Layouts"', () => {
      const mockDisks = [
        {
          identifier: '{uuid}d5433b0f-180b-4706-afd0-476915e8925f0',
          name: 'sda',
          subsystem: 'scsi',
          number: 2080,
          serial: '1234567890abcd0',
          lunid: null,
          size: 4398046511104,
          description: '',
          duplicate_serial: [],
          transfermode: 'Auto',
          hddstandby: 'ALWAYS ON',
          advpowermgmt: 'DISABLED',
          togglesmart: true,
          smartoptions: '',
          expiretime: null,
          critical: null,
          difference: null,
          informational: null,
          model: 'HARDDISK',
          rotationrate: null,
          type: 'HDD',
          zfs_guid: '594160193876939323',
          bus: 'SPI',
          devname: 'sda',
          supports_smart: null,
          pool: 'MOCK_POOL',
        },
        {
          identifier: '{uuid}d5433b0f-180b-4706-afd0-476915e8925f1',
          name: 'sdb',
          subsystem: 'scsi',
          number: 2080,
          serial: '1234567890abcd1',
          lunid: null,
          size: 4398046511104,
          description: '',
          duplicate_serial: [],
          transfermode: 'Auto',
          hddstandby: 'ALWAYS ON',
          advpowermgmt: 'DISABLED',
          togglesmart: true,
          smartoptions: '',
          expiretime: null,
          critical: null,
          difference: null,
          informational: null,
          model: 'HARDDISK',
          rotationrate: null,
          type: 'HDD',
          zfs_guid: '594160193876939323',
          bus: 'SPI',
          devname: 'sdb',
          supports_smart: null,
          pool: 'MOCK_POOL',
        },
        {
          identifier: '{uuid}d5433b0f-180b-4706-afd0-476915e8925f2',
          name: 'sdc',
          subsystem: 'scsi',
          number: 2080,
          serial: '1234567890abcd2',
          lunid: null,
          size: 4398046511104,
          description: '',
          duplicate_serial: [],
          transfermode: 'Auto',
          hddstandby: 'ALWAYS ON',
          advpowermgmt: 'DISABLED',
          togglesmart: true,
          smartoptions: '',
          expiretime: null,
          critical: null,
          difference: null,
          informational: null,
          model: 'HARDDISK',
          rotationrate: null,
          type: 'HDD',
          zfs_guid: '594160193876939323',
          bus: 'SPI',
          devname: 'sdc',
          supports_smart: null,
          pool: 'MOCK_POOL',
        },
        {
          identifier: '{uuid}d5433b0f-180b-4706-afd0-476915e8925f3',
          name: 'sdd',
          subsystem: 'scsi',
          number: 2080,
          serial: '1234567890abcd3',
          lunid: null,
          size: 4398046511104,
          description: '',
          duplicate_serial: [],
          transfermode: 'Auto',
          hddstandby: 'ALWAYS ON',
          advpowermgmt: 'DISABLED',
          togglesmart: true,
          smartoptions: '',
          expiretime: null,
          critical: null,
          difference: null,
          informational: null,
          model: 'HARDDISK',
          rotationrate: null,
          type: 'HDD',
          zfs_guid: '594160193876939323',
          bus: 'SPI',
          devname: 'sdd',
          supports_smart: null,
          pool: 'MOCK_POOL',
        },
        {
          identifier: '{uuid}d5433b0f-180b-4706-afd0-476915e8925f4',
          name: 'sde',
          subsystem: 'scsi',
          number: 2080,
          serial: '1234567890abcd4',
          lunid: null,
          size: 4398046511104,
          description: '',
          duplicate_serial: [],
          transfermode: 'Auto',
          hddstandby: 'ALWAYS ON',
          advpowermgmt: 'DISABLED',
          togglesmart: true,
          smartoptions: '',
          expiretime: null,
          critical: null,
          difference: null,
          informational: null,
          model: 'HARDDISK',
          rotationrate: null,
          type: 'HDD',
          zfs_guid: '594160193876939323',
          bus: 'SPI',
          devname: 'sde',
          supports_smart: null,
          pool: 'MOCK_POOL',
        },
        {
          identifier: '{uuid}d5433b0f-180b-4706-afd0-476915e8925f5',
          name: 'sdf',
          subsystem: 'scsi',
          number: 2080,
          serial: '1234567890abcd5',
          lunid: null,
          size: 4398046511104,
          description: '',
          duplicate_serial: [],
          transfermode: 'Auto',
          hddstandby: 'ALWAYS ON',
          advpowermgmt: 'DISABLED',
          togglesmart: true,
          smartoptions: '',
          expiretime: null,
          critical: null,
          difference: null,
          informational: null,
          model: 'HARDDISK',
          rotationrate: null,
          type: 'HDD',
          zfs_guid: '594160193876939323',
          bus: 'SPI',
          devname: 'sdf',
          supports_smart: null,
          pool: 'MOCK_POOL',
        },
        {
          identifier: '{uuid}d5433b0f-180b-4706-afd0-476915e8925f6',
          name: 'sdg',
          subsystem: 'scsi',
          number: 2080,
          serial: '1234567890abcd6',
          lunid: null,
          size: 4398046511104,
          description: '',
          duplicate_serial: [],
          transfermode: 'Auto',
          hddstandby: 'ALWAYS ON',
          advpowermgmt: 'DISABLED',
          togglesmart: true,
          smartoptions: '',
          expiretime: null,
          critical: null,
          difference: null,
          informational: null,
          model: 'HARDDISK',
          rotationrate: null,
          type: 'HDD',
          zfs_guid: '594160193876939323',
          bus: 'SPI',
          devname: 'sdg',
          supports_smart: null,
          pool: 'MOCK_POOL',
        },
        {
          identifier: '{uuid}d5433b0f-180b-4706-afd0-476915e8925f7',
          name: 'sdh',
          subsystem: 'scsi',
          number: 2080,
          serial: '1234567890abcd7',
          lunid: null,
          size: 4398046511104,
          description: '',
          duplicate_serial: [],
          transfermode: 'Auto',
          hddstandby: 'ALWAYS ON',
          advpowermgmt: 'DISABLED',
          togglesmart: true,
          smartoptions: '',
          expiretime: null,
          critical: null,
          difference: null,
          informational: null,
          model: 'HARDDISK',
          rotationrate: null,
          type: 'HDD',
          zfs_guid: '594160193876939323',
          bus: 'SPI',
          devname: 'sdh',
          supports_smart: null,
          pool: 'MOCK_POOL',
        },
      ] as Disk[];

      const mockTopology = {
        data: [
          {
            type: 'RAIDZ1',
            children: [
              {
                type: 'DISK',
                status: 'ONLINE',
                children: [],
                disk: 'sda',
                stats: {
                  size: 4398046511104,
                  timestamp: 164848882662718,
                  read_errors: 0,
                  write_errors: 0,
                  checksum_errors: 0,
                },
                device: 'sda2',
                guid: '12345',
                unavail_disk: null,
              },
              {
                type: 'DISK',
                status: 'ONLINE',
                children: [],
                disk: 'sdb',
                stats: {
                  size: 4398046511104,
                  timestamp: 164848882662718,
                  read_errors: 0,
                  write_errors: 0,
                  checksum_errors: 0,
                },
                device: 'sdb2',
                guid: '12345',
                unavail_disk: null,
              },
              {
                type: 'DISK',
                status: 'ONLINE',
                children: [],
                disk: 'sdc',
                stats: {
                  size: 4398046511104,
                  timestamp: 164848882662718,
                  read_errors: 0,
                  write_errors: 0,
                  checksum_errors: 0,
                },
                device: 'sdc2',
                guid: '12345',
                unavail_disk: null,
              },
              {
                type: 'DISK',
                status: 'ONLINE',
                children: [],
                disk: 'sdd',
                stats: {
                  size: 4398046511104,
                  timestamp: 164848882662718,
                  read_errors: 0,
                  write_errors: 0,
                  checksum_errors: 0,
                },
                device: 'sdd2',
                guid: '12345',
                unavail_disk: null,
              },
            ],
            guid: '12345',
            unavail_disk: null,
            stats: {
              size: 13194139533312,
            },
            status: 'ONLINE',
            name: 'RAIDZ1-0',
          },
          {
            type: 'MIRROR',
            children: [
              {
                type: 'DISK',
                status: 'ONLINE',
                children: [],
                disk: 'sde',
                stats: {
                  size: 4398046511104,
                  timestamp: 164848882662718,
                  read_errors: 0,
                  write_errors: 0,
                  checksum_errors: 0,
                },
                device: 'sde2',
                guid: '12345',
                unavail_disk: null,
              },
              {
                type: 'DISK',
                status: 'ONLINE',
                children: [],
                disk: 'sdf',
                stats: {
                  size: 4398046511104,
                  timestamp: 164848882662718,
                  read_errors: 0,
                  write_errors: 0,
                  checksum_errors: 0,
                },
                device: 'sdf2',
                guid: '12345',
                unavail_disk: null,
              },
            ],
            guid: '12345',
            unavail_disk: null,
            stats: {
              size: 4398046511104,
            },
            status: 'ONLINE',
            name: 'MIRROR-1',
          },
          {
            type: 'MIRROR',
            children: [
              {
                type: 'DISK',
                status: 'ONLINE',
                children: [],
                disk: 'sdg',
                stats: {
                  size: 4398046511104,
                  timestamp: 164848882662718,
                  read_errors: 0,
                  write_errors: 0,
                  checksum_errors: 0,
                },
                device: 'sdg2',
                guid: '12345',
                unavail_disk: null,
              },
              {
                type: 'DISK',
                status: 'ONLINE',
                children: [],
                disk: 'sdh',
                stats: {
                  size: 4398046511104,
                  timestamp: 164848882662718,
                  read_errors: 0,
                  write_errors: 0,
                  checksum_errors: 0,
                },
                device: 'sdh2',
                guid: '12345',
                unavail_disk: null,
              },
            ],
            guid: '12345',
            unavail_disk: null,
            stats: {
              size: 4398046511104,
            },
            status: 'ONLINE',
            name: 'MIRROR-2',
          },
        ],
        special: [],
        log: [],
        spare: [],
        cache: [],
        dedup: [],
      } as PoolTopology;
      const warnings = storageService.validateVdevs(
        VdevType.Data,
        mockTopology.data,
        mockDisks,
      );

      // Will trigger multiple warnings as VDEV widths will differ.
      // Let's just check to see if the our warning is present
      expect(warnings).toContain(TopologyWarning.MixedVdevLayout);
    });
  });
});
