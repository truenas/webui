<ng-template #pageHeader>
  <ix-page-title-header>
    <mat-button-toggle-group
      aria-label="Tabs"
      [value]="selectedIndex"
      [disabled]="isLoading$ | async"
    >
      <mat-button-toggle
        ix-auto
        ix-auto-type="tab"
        ix-auto-identifier="filter-all"
        [value]="JobTab.All"
        (click)="onTabChange(JobTab.All)"
      >{{ 'All' | translate }}</mat-button-toggle>
      <mat-button-toggle
        ix-auto
        ix-auto-type="tab"
        ix-auto-identifier="filter-active"
        [value]="JobTab.Running"
        (click)="onTabChange(JobTab.Running)"
      >{{ 'Active' | translate }}</mat-button-toggle>
      <mat-button-toggle
        ix-auto
        ix-auto-type="tab"
        ix-auto-identifier="filter-failed"
        [value]="JobTab.Failed"
        (click)="onTabChange(JobTab.Failed)"
      >{{ 'Failed' | translate }}</mat-button-toggle>
    </mat-button-toggle-group>

    <ix-search-input
      [disabled]="isLoading$ | async"
      (search)="onSearch($event)"
    ></ix-search-input>
  </ix-page-title-header>
</ng-template>

<ix-entity-empty
  *ngIf="isLoading$ | async; else loaded"
  [conf]="loadingConfig"
></ix-entity-empty>

<ng-template #loaded>
  <div class="jobs-container">
    <table
      ix-table
      matSort
      matSortActive="id"
      matSortDirection="desc"
      [dataSource]="dataSource"
      [multiTemplateDataRows]="true"
      [trackBy]="trackByJobId"
    >
      <ng-container matColumnDef="name">
        <th
          *matHeaderCellDef
          mat-header-cell
          ix-auto
          ix-auto-type="tab"
          ix-auto-identifier="name"
        >
          {{ 'Name' | translate }}
        </th>
        <td *matCellDef="let job; dataSource: dataSource" mat-cell>
          <div
            class="jobs-item"
            fxFlex="1 1 100%"
            fxLayout="row"
            fxLayoutAlign="space-between center"
            fxLayoutGap="8px"
          >
            <div
              fxFlex
              fxLayout="row"
              fxLayoutGap="8px"
              fxLayoutAlign="start center"
            >
              <div class="jobs-item-icon" [ngSwitch]="job.state">
                <ix-icon
                  *ngSwitchCase="JobState.Success"
                  name="check_circle_outline"
                  class="success"
                ></ix-icon>
                <ix-icon
                  *ngSwitchCase="JobState.Failed"
                  name="highlight_off"
                  class="failed"
                  [matTooltip]="job.error"
                ></ix-icon>
                <mat-spinner
                  *ngSwitchCase="JobState.Running"
                  class="running"
                  [diameter]="22"
                  [matTooltip]="job.progress.description"
                ></mat-spinner>
                <ix-icon *ngSwitchCase="JobState.Waiting" class="waiting" name="schedule"></ix-icon>
                <ix-icon *ngSwitchCase="JobState.Aborted" class="aborted" name="report"></ix-icon>
              </div>

              <div fxFlex="100" fxLayout="column">
                <div
                  fxLayout="row"
                  fxLayoutAlign="space-between baseline"
                  fxLayoutGap="8px"
                >
                  <span>
                    {{ job.description ? job.description : job.method }}
                  </span>
                  <small *ngIf="job.state === JobState.Running">
                    {{ job.progress.percent || 0 | number: '1.2-2' }}%
                  </small>
                </div>

                <mat-progress-bar
                  *ngIf="job.state === JobState.Running"
                  class="jobs-progress"
                  [value]="job.progress.percent"
                  [mode]="job.progress.percent ? 'determinate' : 'indeterminate'"
                  [matTooltip]="job.progress.description"
                ></mat-progress-bar>
              </div>
            </div>

            <button
              *ngIf="job.state === JobState.Running && job.abortable"
              mat-icon-button
              type="button"
              [matTooltip]="'Abort' | translate"
              (click)="onAborted(job)"
            ><ix-icon name="mdi-close-circle"></ix-icon></button>
          </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="state">
        <th
          *matHeaderCellDef
          mat-header-cell
          mat-sort-header
          ix-auto
          ix-auto-type="tab"
          ix-auto-identifier="State"
        >
          {{ 'State' | translate }}
        </th>
        <td *matCellDef="let job; dataSource: dataSource" mat-cell>{{ job.state }}</td>
      </ng-container>

      <ng-container matColumnDef="id">
        <th
          *matHeaderCellDef
          mat-header-cell
          mat-sort-header
          ix-auto
          ix-auto-type="tab"
          ix-auto-identifier="ID"
        >
          {{ 'ID' | translate }}
        </th>
        <td *matCellDef="let job; dataSource: dataSource" mat-cell>
          {{ job.id }}
        </td>
      </ng-container>

      <ng-container matColumnDef="time_started">
        <th
          *matHeaderCellDef
          mat-header-cell
          ix-auto
          ix-auto-type="tab"
          ix-auto-identifier="DateStarted"
        >
          {{ 'Started' | translate }}
        </th>
        <td *matCellDef="let job; dataSource: dataSource" mat-cell>
          {{ job.time_started?.$date ? (job.time_started.$date | formatDateTime) : '–' }}
        </td>
      </ng-container>

      <ng-container matColumnDef="time_finished">
        <th
          *matHeaderCellDef
          mat-header-cell
          ix-auto
          ix-auto-type="tab"
          ix-auto-identifier="DateFinished"
        >
          {{ 'Finished' | translate }}
        </th>
        <td *matCellDef="let job; dataSource: dataSource" mat-cell>
          {{ job.time_finished?.$date ? (job.time_finished.$date | formatDateTime) : '–' }}
        </td>
      </ng-container>

      <ng-container matColumnDef="logs">
        <th
          *matHeaderCellDef
          mat-header-cell
          ix-auto
          ix-auto-type="tab"
          ix-auto-identifier="Logs"
        >{{ 'Logs' | translate }}</th>
        <td mat-cell *matCellDef="let job; dataSource: dataSource">
          <button
            *ngIf="job.logs_path && job.logs_excerpt"
            mat-button
            type="button"
            (click)="$event.stopPropagation(); downloadLogs(job)"
          >{{ 'Download Logs' | translate }}</button>
        </td>
      </ng-container>

      <ix-expand-toggle-column
        [expandedRow]="expandedRow"
        (toggle)="onToggle($event)"
      ></ix-expand-toggle-column>

      <tr *matHeaderRowDef="displayedColumns" mat-header-row></tr>

      <tr
        *matRowDef="let job; columns: displayedColumns"
        mat-row
        [ixDetailRow]="job"
        [ixDetailRowOptions]="{ colspan: displayedColumns.length }"
        [ixDetailRowTemplate]="expandedRowTemplate"
        (toggle)="onToggle($event)"
      ></tr>

      <tr *matNoDataRow class="mat-row no-data-row">
        <td class="mat-cell" [attr.colspan]="displayedColumns.length">
          <ix-entity-empty [conf]="emptyConfig"></ix-entity-empty>
        </td>
      </tr>
    </table>
  </div>

  <ix-table-paginator [dataSource]="dataSource"></ix-table-paginator>
</ng-template>

<ng-template #expandedRowTemplate let-job let-colspan="colspan">
  <ix-job-logs-row [colspan]="colspan" [job]="job"></ix-job-logs-row>
</ng-template>
