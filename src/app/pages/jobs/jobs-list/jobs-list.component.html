<ng-template #pageHeader>
  <ix-page-title-header>
    <ix-search-input
      [disabled]="isLoading$ | async"
      (search)="onSearch($event)"
    ></ix-search-input>
  </ix-page-title-header>
</ng-template>

<div fxLayout="row">
  <mat-tab-group
    animationDuration="0ms"
    fxFlex="100%"
    [selectedIndex]="selectedIndex"
    (focusChange)="onTabChange($event)"
  >
    <mat-tab
      ix-auto
      ix-auto-type="tab"
      ix-auto-identifier="filter-all"
      [label]="'All' | translate"
    ></mat-tab>

    <mat-tab
      ix-auto
      ix-auto-type="tab"
      ix-auto-identifier="filter-active"
      [label]="'Active' | translate"
    ></mat-tab>

    <mat-tab
      ix-auto
      ix-auto-type="tab"
      ix-auto-identifier="filter-failed"
      [label]="'Failed' | translate"
    ></mat-tab>
  </mat-tab-group>
</div>

<ix-entity-empty
  *ngIf="isLoading$ | async; else loaded"
  [conf]="loadingConfig"
></ix-entity-empty>

<ng-template #loaded>
  <div class="jobs-container">
    <table
      ix-table
      matSort
      matSortActive="id"
      matSortDirection="desc"
      [dataSource]="dataSource"
      [multiTemplateDataRows]="true"
      [trackBy]="trackByJobId"
    >
      <ng-container matColumnDef="name">
        <th
          *matHeaderCellDef
          mat-header-cell
          ix-auto
          ix-auto-type="tab"
          ix-auto-identifier="name"
        >
          {{ 'Name' | translate }}
        </th>
        <td *matCellDef="let job; dataSource: dataSource" mat-cell>
          <div
            class="jobs-item"
            fxFlex="1 1 100%"
            fxLayout="row"
            fxLayoutAlign="space-between center"
            fxLayoutGap="8px"
          >
            <div
              fxFlex
              fxLayout="row"
              fxLayoutGap="8px"
              fxLayoutAlign="start center"
            >
              <div class="jobs-item-icon" [ngSwitch]="job.state">
                <mat-icon *ngSwitchCase="JobState.Success" class="state-success">
                  check_circle_outline
                </mat-icon>
                <mat-icon *ngSwitchCase="JobState.Failed" class="state-failed" [matTooltip]="job.error">
                  highlight_off
                </mat-icon>
                <ng-container *ngSwitchCase="JobState.Running">
                  <mat-spinner
                    class="state-running"
                    [diameter]="22"
                    [matTooltip]="job.progress.description"
                  ></mat-spinner>
                </ng-container>
                <mat-icon *ngSwitchCase="JobState.Waiting" class="state-waiting">
                  schedule
                </mat-icon>
                <mat-icon *ngSwitchCase="JobState.Aborted" class="state-aborted">
                  report
                </mat-icon>
              </div>

              <div fxFlex="100" fxLayout="column">
                <div
                  fxLayout="row"
                  fxLayoutAlign="space-between baseline"
                  fxLayoutGap="8px"
                >
                  <span>
                    {{ job.description ? job.description : job.method }}
                  </span>
                  <small *ngIf="job.state === JobState.Running">
                    {{ job.progress.percent || 0 | number: '1.2-2' }}%
                  </small>
                </div>

                <mat-progress-bar
                  *ngIf="job.state === JobState.Running"
                  class="jobs-progress"
                  [value]="job.progress.percent"
                  [mode]="job.progress.percent ? 'determinate' : 'indeterminate'"
                  [matTooltip]="job.progress.description"
                ></mat-progress-bar>
              </div>
            </div>

            <button
              *ngIf="job.state === JobState.Running && job.abortable"
              mat-icon-button
              type="button"
              [matTooltip]="'Abort' | translate"
              (click)="onAborted(job)"
            >
              <mat-icon
                fontSet="mdi-set"
                fontIcon="mdi-close-circle"
              ></mat-icon>
            </button>
          </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="state">
        <th
          *matHeaderCellDef
          mat-header-cell
          mat-sort-header
          ix-auto
          ix-auto-type="tab"
          ix-auto-identifier="State"
        >
          {{ 'State' | translate }}
        </th>
        <td *matCellDef="let job" mat-cell>{{ job.state }}</td>
      </ng-container>

      <ng-container matColumnDef="id">
        <th
          *matHeaderCellDef
          mat-header-cell
          mat-sort-header
          ix-auto
          ix-auto-type="tab"
          ix-auto-identifier="ID"
        >
          {{ 'ID' | translate }}
        </th>
        <td *matCellDef="let job; dataSource: dataSource" mat-cell>
          {{ job.id }}
        </td>
      </ng-container>

      <ng-container matColumnDef="time_started">
        <th
          *matHeaderCellDef
          mat-header-cell
          ix-auto
          ix-auto-type="tab"
          ix-auto-identifier="DateStarted"
        >
          {{ 'Started' | translate }}
        </th>
        <td *matCellDef="let job; dataSource: dataSource" mat-cell>
          {{ job.time_started?.$date ? (job.time_started.$date | formatDateTime) : '–' }}
        </td>
      </ng-container>

      <ng-container matColumnDef="time_finished">
        <th
          *matHeaderCellDef
          mat-header-cell
          ix-auto
          ix-auto-type="tab"
          ix-auto-identifier="DateFinished"
        >
          {{ 'Finished' | translate }}
        </th>
        <td *matCellDef="let job; dataSource: dataSource" mat-cell>
          {{ job.time_finished?.$date ? (job.time_finished.$date | formatDateTime) : '–' }}
        </td>
      </ng-container>

      <ng-container matColumnDef="arguments_logs">
        <th
          *matHeaderCellDef
          mat-header-cell
          ix-auto
          ix-auto-type="tab"
          ix-auto-identifier="Arguments/Logs"
        >
          {{ 'Arguments/Logs' | translate }}
        </th>
        <td *matCellDef="let job; dataSource: dataSource" mat-cell>
          <button mat-button type="button">
            {{ expandedRow === job ? ('Close' | translate) : ('View' | translate) }}
          </button>
          <button
            *ngIf="job.logs_path && job.logs_excerpt"
            mat-button
            type="button"
            (click)="$event.stopPropagation(); downloadLogs(job)"
          >
            {{ 'Download Logs' | translate }}
          </button>
        </td>
      </ng-container>

      <tr *matHeaderRowDef="displayedColumns" mat-header-row></tr>

      <tr
        *matRowDef="let job; columns: displayedColumns"
        mat-row
        [ixDetailRow]="job"
        [ixDetailRowOptions]="{ colspan: displayedColumns.length }"
        [ixDetailRowTemplate]="expandedRowTemplate"
        (toggle)="onToggle($event)"
      ></tr>

      <tr *matNoDataRow class="mat-row no-data-row">
        <td class="mat-cell" [attr.colspan]="displayedColumns.length">
          <ix-entity-empty [conf]="emptyConfig"></ix-entity-empty>
        </td>
      </tr>
    </table>
  </div>

  <ix-table-paginator [dataSource]="dataSource"></ix-table-paginator>
</ng-template>

<ng-template #expandedRowTemplate let-job let-colspan="colspan">
  <ix-job-logs-row [colspan]="colspan" [job]="job"></ix-job-logs-row>
</ng-template>
