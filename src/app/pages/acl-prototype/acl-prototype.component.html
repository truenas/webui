<div class="acl-prototype-container">
  <!-- Split Layout: Main Content + Sidebar -->
  <div class="content-layout">
    <!-- Left side: Main Content (2/3 width) -->
    <div class="main-content">
      <!-- Header with Path and Basic Info -->
      <mat-card class="header-card">
        <div>
          <h3>{{ 'POSIX ACL Editor - New Design' | translate }}</h3>
          <div>{{ 'Prototype for improved UX' | translate }}</div>
        </div>
        <mat-card-content>
          <div class="path-info">
            <ix-icon name="folder" class="path-icon"></ix-icon>
            <strong>{{ selectedPath() }}</strong>
          </div>

          <!-- Owner/Group Selection -->
          <div class="ownership-controls" [formGroup]="ownershipForm">
            <ix-select
              formControlName="owner"
              [label]="'Owner' | translate"
              [options]="userOptions$"
              [required]="true">
            </ix-select>
            <ix-select
              formControlName="group"
              [label]="'Group' | translate"
              [options]="groupOptions$"
              [required]="true">
            </ix-select>
          </div>

          <!-- Quick Stats -->
          <div class="acl-summary">
            <div class="summary-item">
              <span class="summary-label">{{ 'ACCESS Entries' | translate }}:</span>
              <span class="summary-value">{{ accessEntries().length }}</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">{{ 'DEFAULT Entries' | translate }}:</span>
              <span class="summary-value">{{ defaultEntries().length }}</span>
            </div>
            <div class="summary-item" [class.status-valid]="validationResult().isValid" [class.status-invalid]="!validationResult().isValid">
              <span class="summary-label">{{ 'Status' | translate }}:</span>
              <span class="summary-value">
                @if (validationResult().isValid) {
                  <ix-icon name="check_circle" class="status-icon valid"></ix-icon>
                  {{ 'Valid' | translate }}
                } @else {
                  <ix-icon name="error" class="status-icon invalid"></ix-icon>
                  {{ validationResult().errors.length }} {{ 'Errors' | translate }}
                }
              </span>
            </div>
          </div>

          <div>
            <button mat-button (click)="toggleAdvancedOptions()">
              <ix-icon [name]="showAdvancedOptions() ? 'expand_less' : 'expand_more'"></ix-icon>
              {{ showAdvancedOptions() ? 'Hide Advanced Options' : 'Show Advanced Options' | translate }}
            </button>

            <!-- Advanced Options - Collapsed by Default -->
            @if (showAdvancedOptions()) {
              <mat-card class="advanced-options-card">
                <div>
                  <h3>{{ 'Advanced Options' | translate }}</h3>
                  <div>{{ 'Rarely used settings' | translate }}</div>
                </div>
                <mat-card-content>
                  <div class="advanced-controls">

                    <!-- Validation settings -->
                    <div class="advanced-section">
                      <h4>{{ 'Validation Settings' | translate }}</h4>
                      <div class="control-group" [formGroup]="advancedOptionsForm">
                        <ix-checkbox
                          formControlName="validateAcl"
                          [label]="'Validate ACL before saving' | translate"
                          [hint]="'Ensure the ACL configuration is valid before saving' | translate">
                        </ix-checkbox>
                        <ix-checkbox
                          formControlName="applyOwner"
                          [label]="'Apply owner changes' | translate"
                          [hint]="'Change the file owner when saving permissions' | translate">
                        </ix-checkbox>
                        <ix-checkbox
                          formControlName="applyGroup"
                          [label]="'Apply group changes' | translate"
                          [hint]="'Change the file group when saving permissions' | translate">
                        </ix-checkbox>
                      </div>
                    </div>
                  </div>
                </mat-card-content>
              </mat-card>
            }
          </div>
        </mat-card-content>
      </mat-card>
    <!-- Preset Selection Button -->
    <mat-card class="preset-selection-card">
      <mat-card-content>
        <div class="preset-selection">
          <div class="preset-info">
            <h3>{{ 'Quick Setup' | translate }}</h3>
            <p>{{ 'Apply common permission templates for quick configuration' | translate }}</p>
            @if (selectedPreset()) {
              <div class="selected-preset">
                <mat-chip color="primary">{{ selectedPreset()!.name }}</mat-chip>
                <span>{{ selectedPreset()!.description }}</span>
              </div>
            }
          </div>
          <button mat-button color="primary" (click)="openPresetModal()">
            <ix-icon name="settings_suggest"></ix-icon>
            {{ 'Select Preset' | translate }}
          </button>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- ACL Entries - Separated ACCESS and DEFAULT -->
    <div class="acl-sections">
      <!-- ACCESS Entries -->
      <mat-card class="acl-section access-section">
        <div>
          <h3>
            <ix-icon name="security" class="section-icon"></ix-icon>
            {{ 'ACCESS Permissions' | translate }}
          </h3>
          <div>
            {{ 'Controls permissions for the current file/directory' | translate }}
          </div>
        </div>
        <mat-card-content>
          <div class="entries-list">
            @for (entry of accessEntries(); track entry.id) {
              <div class="acl-entry"
                   [class.required]="entry.type === 'USER_OBJ' || entry.type === 'GROUP_OBJ' || entry.type === 'OTHER'"
                   [class.has-full-permissions]="entry.permissions.read && entry.permissions.write && entry.permissions.execute"
                   [class.has-no-permissions]="!entry.permissions.read && !entry.permissions.write && !entry.permissions.execute">
                <div class="entry-type">
                  <ix-icon class="type-icon" [name]="getTypeIcon(entry.type)"></ix-icon>
                  <div class="type-info">
                    <span class="type-name">{{ getTypeDisplayName(entry.type) }}</span>
                    @if (entry.name) {
                      <span class="entity-name">({{ entry.name }})</span>
                    } @else if (entry.type === 'USER_OBJ') {
                      <span class="entity-name">({{ currentOwner() }})</span>
                    } @else if (entry.type === 'GROUP_OBJ') {
                      <span class="entity-name">({{ currentGroup() }})</span>
                    }
                    @if (entry.type === 'USER_OBJ' || entry.type === 'GROUP_OBJ' || entry.type === 'OTHER') {
                      <mat-chip class="required-chip" color="primary">Required</mat-chip>
                    }
                  </div>
                </div>
                <div class="permissions">
                  <div class="permission-display">{{ getPermissionString(entry.permissions) }}</div>
                </div>
                <div class="entry-actions">
                  <button mat-icon-button
                          color="primary"
                          matTooltip="Edit entry"
                          [attr.aria-label]="'Edit ' + getTypeDisplayName(entry.type) + (entry.name ? ' ' + entry.name : '')"
                          (click)="editEntry(entry)">
                    <ix-icon name="edit"></ix-icon>
                  </button>
                  @if (entry.type !== 'USER_OBJ' && entry.type !== 'GROUP_OBJ' && entry.type !== 'OTHER') {
                    <button mat-icon-button
                            color="warn"
                            matTooltip="Remove entry"
                            [attr.aria-label]="'Remove ' + getTypeDisplayName(entry.type) + (entry.name ? ' ' + entry.name : '')"
                            (click)="removeEntry(entry.id)">
                      <ix-icon name="mdi-delete"></ix-icon>
                    </button>
                  }
                </div>
              </div>
            }
          </div>

          <!-- Add Entry Button -->
          <div class="add-entry">
            <button mat-button
                    color="primary"
                    matTooltip="Add a new user or group access entry"
                    (click)="addNewEntry('USER')">
              <ix-icon name="add"></ix-icon>
              {{ 'Add ACCESS Entry' | translate }}
            </button>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- DEFAULT Entries -->
      <mat-card class="acl-section default-section">
        <div>
          <h3>
            <ix-icon name="content_copy" class="section-icon"></ix-icon>
            {{ 'DEFAULT Permissions' | translate }}
          </h3>
          <div>
            {{ 'Template for new files and directories (directories only)' | translate }}
          </div>
        </div>
        <mat-card-content>
          <div class="entries-list">
            @if (defaultEntries().length > 0) {
              @for (entry of defaultEntries(); track entry.id) {
                <div class="acl-entry default-entry">
                  <div class="entry-type">
                    <ix-icon class="type-icon" [name]="getTypeIcon(entry.type)"></ix-icon>
                    <div class="type-info">
                      <span class="type-name">{{ getTypeDisplayName(entry.type) }}</span>
                      @if (entry.name) {
                        <span class="entity-name">({{ entry.name }})</span>
                      } @else if (entry.type === 'USER_OBJ') {
                        <span class="entity-name">({{ currentOwner() }})</span>
                      } @else if (entry.type === 'GROUP_OBJ') {
                        <span class="entity-name">({{ currentGroup() }})</span>
                      }
                      <mat-chip class="default-chip" color="accent">Default</mat-chip>
                    </div>
                  </div>
                  <div class="permissions">
                    <div class="permission-display">{{ getPermissionString(entry.permissions) }}</div>
                  </div>
                  <div class="entry-actions">
                    <button mat-icon-button
                            color="primary"
                            matTooltip="Edit default entry"
                            [attr.aria-label]="'Edit default ' + getTypeDisplayName(entry.type) + (entry.name ? ' ' + entry.name : '')"
                            (click)="editEntry(entry)">
                      <ix-icon name="edit"></ix-icon>
                    </button>
                    <button mat-icon-button
                            color="warn"
                            matTooltip="Remove default entry"
                            [attr.aria-label]="'Remove default ' + getTypeDisplayName(entry.type) + (entry.name ? ' ' + entry.name : '')"
                            (click)="removeEntry(entry.id, true)">
                      <ix-icon name="mdi-delete"></ix-icon>
                    </button>
                  </div>
                </div>
              }
            } @else {
              <div class="empty-state">
                <ix-icon class="info-icon" name="info"></ix-icon>
                <p>{{ 'No default permissions set. New files and directories will inherit minimal permissions.' | translate }}</p>
              </div>
            }
          </div>

          <!-- Quick Actions for DEFAULT -->
          <div class="default-actions">
            <button mat-button (click)="copyAccessToDefault()">
              <ix-icon name="content_copy"></ix-icon>
              {{ 'Copy from ACCESS' | translate }}
            </button>
            <button mat-button
                    color="primary"
                    matTooltip="Add a new default entry for inheritance"
                    (click)="addNewEntry('USER', '', true)">
              <ix-icon name="add"></ix-icon>
              {{ 'Add DEFAULT Entry' | translate }}
            </button>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Validation Feedback -->
    @if (validationResult().errors.length > 0 || validationResult().warnings.length > 0) {
      <mat-card class="validation-card" [class.has-errors]="validationResult().errors.length > 0">
        <div>
          <h3>
            <ix-icon
              [name]="validationResult().errors.length > 0 ? 'error' : 'warning'"
              [class.error-icon]="validationResult().errors.length > 0"
              [class.warning-icon]="validationResult().warnings.length > 0">
            </ix-icon>
            {{ validationResult().errors.length > 0 ? 'Configuration Errors' : 'Configuration Warnings' | translate }}
          </h3>
        </div>
        <mat-card-content>
          @if (validationResult().errors.length > 0) {
            <div class="validation-section errors">
              <h4>{{ 'Errors (must be fixed)' | translate }}:</h4>
              <ul>
                @for (error of validationResult().errors; track error) {
                  <li class="error-item">{{ error }}</li>
                }
              </ul>
            </div>
          }
          @if (validationResult().warnings.length > 0) {
            <div class="validation-section warnings">
              <h4>{{ 'Warnings (recommended to fix)' | translate }}:</h4>
              <ul>
                @for (warning of validationResult().warnings; track warning) {
                  <li class="warning-item">{{ warning }}</li>
                }
              </ul>
            </div>
          }
        </mat-card-content>
      </mat-card>
    }
    </div>

    <!-- Right side: Sticky Sidebar (1/3 width) -->
    <div class="sidebar-content">
      <!-- Educational Content -->
      <mat-card class="info-card">
        <div>
          <h3>
            <ix-icon class="info-icon" name="help"></ix-icon>
            {{ 'Understanding Your Permissions' | translate }}
          </h3>
        </div>
        <mat-card-content>
          <mat-expansion-panel>
            <mat-expansion-panel-header>
              <div>{{ 'Effective Permissions Explanation' | translate }}</div>
            </mat-expansion-panel-header>
            <p>{{ getEffectivePermissionsExplanation() }}</p>
            <div class="permission-legend">
              <h4>{{ 'Permission Codes' | translate }}:</h4>
              <ul>
                <li><strong>r</strong> - {{ 'Read: View file contents or list directory' | translate }}</li>
                <li><strong>w</strong> - {{ 'Write: Modify file contents or create/delete files in directory' | translate }}</li>
                <li><strong>x</strong> - {{ 'Execute: Run file as program or access directory contents' | translate }}</li>
              </ul>
            </div>
          </mat-expansion-panel>

          <mat-expansion-panel>
            <mat-expansion-panel-header>
              <div>{{ 'ACCESS vs DEFAULT Permissions' | translate }}</div>
            </mat-expansion-panel-header>
            <div class="acl-explanation">
              <div class="explanation-section">
                <h4>{{ 'ACCESS Permissions' | translate }}</h4>
                <p>{{ 'Control who can access this file or directory right now. These are the active permissions.' | translate }}</p>
              </div>
              <div class="explanation-section">
                <h4>{{ 'DEFAULT Permissions' | translate }}</h4>
                <p>{{ 'Template permissions for new files and directories created inside this directory. Only applies to directories.' | translate }}</p>
              </div>
            </div>
          </mat-expansion-panel>
        </mat-card-content>
      </mat-card>

      <!-- Save Actions - Sticky -->
      <mat-card class="save-card">
        <mat-card-content>
          <div class="save-actions">
            <button mat-button
                    color="primary"
                    class="save-button full-width"
                    [disabled]="!validationResult().isValid"
                    [matTooltip]="validationResult().isValid ? 'Save ACL configuration' : 'Fix validation errors before saving'"
                    [attr.aria-label]="validationResult().isValid ? 'Save ACL configuration' : 'Cannot save: validation errors present'">
              <ix-icon name="save"></ix-icon>
              {{ 'Save Permissions' | translate }}
              @if (validationResult().errors.length > 0) {
                <ix-icon name="error" class="save-error-icon"></ix-icon>
              }
            </button>
            <button mat-button class="full-width">
              <ix-icon name="bookmark_add"></ix-icon>
              {{ 'Save as Preset' | translate }}
            </button>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</div>
