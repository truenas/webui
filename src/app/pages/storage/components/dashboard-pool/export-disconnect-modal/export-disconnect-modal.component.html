<h1 mat-dialog-title class="export-disconnect-modal-title">
  {{ 'Disconnect Pool: {pool}' | translate: { pool: pool.name } }}
</h1>

@if (isFormLoading) {
  <mat-progress-bar mode="indeterminate"></mat-progress-bar>
}

<form
  class="ix-form-container"
  [formGroup]="form"
  (submit)="startExportDisconnectJob()"
>
  <div mat-dialog-content class="export-disconnect-modal-content">
    <div class="disconnect-options">
      <h4>{{ 'Disconnect Options' | translate }}</h4>
      <div class="option-cards">
        <div
          class="option-card export-option"
          [class.selected]="isExportSelected"
          (click)="selectOption(exportOption)"
        >
          <h3>{{ 'Export Pool' | translate }}</h3>
          <p>{{ 'Do this to import pool on another TrueNAS system' | translate }}</p>
        </div>

        <div
          class="option-card delete-option"
          [class.selected]="isDeleteSelected"
          (click)="selectOption(deleteOption)"
        >
          <h3>{{ 'Delete Pool' | translate }}</h3>
          <p>{{ 'Wipes all data stored in the pool' | translate }}</p>
        </div>
      </div>
    </div>

    @if (selectedOption()) {
      <div class="selected-content">
        <div class="warnings-section">
          @if (isExportSelected) {
            <div class="warning export-warning">
              <span class="warning-text">
                {{ 'WARNING' | translate }}:
              </span>
              {{ 'You will not be able to access the exported pool\'s data until you import it again. Back up critical data before exporting your pool!' | translate }}
            </div>
          }

          @if (isDeleteSelected) {
            <div class="warning delete-warning">
              <span class="warning-text">
                {{ 'WARNING' | translate }}:
              </span>
              {{ 'All data will be deleted from the pool. Back up critical data before deleting your pool!' | translate }}
            </div>
          }

          @if (shouldShowSystemDatasetWarning) {
            <div class="warning system-dataset-warning">
              <span [innerHTML]="helptext.exportDialog.warningSysDataset | translate"></span>
            </div>
          }

          @if (showUnknownStatusDetachWarning) {
            <div class="warning unknown-status-warning">
              <span [innerHTML]="helptext.exportDialog.unknownState | translate: { pool: pool.name }"></span>
            </div>
          }
        </div>

        @if (showSysDatasetWarning && isExportSelected) {
          <mat-expansion-panel class="expansion-panel" [expanded]="hasOtherPools && destinationPool">
            <mat-expansion-panel-header>
              <mat-panel-title>
                @if (hasOtherPools && destinationPool) {
                  @if (isDestinationPoolEncrypted) {
                    {{ 'System files will be moved to Encrypted Pool: {pool}' | translate: { pool: destinationPool.name } }}
                  } @else {
                    {{ 'System files will be moved to Pool: {pool}' | translate: { pool: destinationPool.name } }}
                  }
                } @else {
                  {{ 'System files will be moved to boot device' | translate }}
                }
              </mat-panel-title>
            </mat-expansion-panel-header>

            <div class="expansion-content">
              @if (hasOtherPools && destinationPool) {
                <p>{{ 'Security keys, user permissions, and system debugging files will be automatically relocated to pool {pool}.' | translate: { pool: destinationPool.name } }}</p>

                @if (isDestinationPoolEncrypted) {
                  <div class="encrypted-pool-warning">
                    <div class="warning-icon">âš </div>
                    <div class="warning-content">
                      <strong>{{ 'Important:' | translate }}</strong>
                      {{ 'While system files are stored on your encrypted pool {pool}, you will not be able to lock it. Check \'Use boot device instead\' to reenable locking.' | translate: { pool: destinationPool.name } }}
                    </div>
                  </div>

                  <ix-checkbox
                    formControlName="useBootDevice"
                    [label]="'Use boot device instead' | translate"
                  ></ix-checkbox>
                }
              } @else {
                <p>{{ 'The system dataset contains configuration files and other system data. When this pool is exported, these files will be moved to the boot device to ensure system functionality.' | translate }}</p>
              }
            </div>
          </mat-expansion-panel>
        }

        @if (attachments.length || process.knownProcesses.length || process.unknownProcesses.length) {
          <mat-expansion-panel class="expansion-panel">
            <mat-expansion-panel-header>
              <mat-panel-title>
                {{ 'These services and processes depend on this pool' | translate }}
              </mat-panel-title>
            </mat-expansion-panel-header>

            <div class="expansion-content">
              @if (attachments.length) {
                <div class="attachments">
                  {{ 'These services depend on pool {name} and will be disrupted if the pool is detached:' | translate: { name: pool.name } }}
                  <ul class="services">
                    @for (service of attachments; track service) {
                      <li>
                        <span class="service-name">{{ service.type }}:</span>
                        <ul class="service-attachments">
                          @for (attachment of service.attachments; track attachment) {
                            @for (item of attachment.split(','); track item) {
                              <li> {{ item }}</li>
                            }
                          }
                        </ul>
                      </li>
                    }
                  </ul>
                </div>
              }

              @if (process.knownProcesses.length) {
                <div class="known-processes">
                  {{ 'These running processes are using {name}:' | translate: { name: pool.name } }}
                  <ul>
                    @for (process of process.knownProcesses; track process) {
                      <li> {{ process.name }}</li>
                    }
                  </ul>
                </div>
              }

              @if (process.unknownProcesses.length) {
                <div class="unknown-processes">
                  {{ 'These unknown processes are using the pool:' | translate }}
                  <ul>
                    @for (process of process.unknownProcesses; track process) {
                      <li>
                        {{ process.pid || ('Unknown PID' | translate) }} -
                        {{ process.cmdline?.substring(0, 40) }}
                      </li>
                    }
                  </ul>
                  <div class="process-will-be-terminated">
                    <span class="warning-text">
                      {{ 'WARNING' | translate }}:
                    </span>
                    {{ 'These unknown processes will be terminated while exporting the pool.' | translate }}
                  </div>
                </div>
              }
            </div>
          </mat-expansion-panel>
        }

        <ix-fieldset>
          @if (isExportSelected) {
            <ix-checkbox
              formControlName="cascade"
              [label]="helptext.exportDialog.cascade.label | translate"
              [tooltip]="helptext.exportDialog.cascade.tooltip | translate"
            ></ix-checkbox>

            <ix-checkbox
              formControlName="confirm"
              [label]="'Confirm Export Pool' | translate"
              [required]="true"
            ></ix-checkbox>
          }

          @if (isDeleteSelected) {
            <ix-checkbox
              formControlName="cascade"
              [label]="'Remove all related configurations' | translate"
              [tooltip]="helptext.exportDialog.cascade.tooltip | translate"
            ></ix-checkbox>

            <ix-checkbox
              formControlName="confirm"
              [label]="'Confirm Delete Pool' | translate"
              [required]="true"
            ></ix-checkbox>
          }

          @if (isDeleteSelected && form.value.destroy) {
            <ix-input
              formControlName="nameInput"
              [label]="helptext.exportDialog.enterName | translate: { pool: pool.name }"
            ></ix-input>
          }
        </ix-fieldset>
      </div>
    }
  </div>

  <ix-form-actions>
    <button
      type="button"
      mat-button
      name="cancel_button"
      ixTest="cancel"
      (click)="cancel()"
    >
      {{ 'Cancel' | translate }}
    </button>
    <button
      *ixRequiresRoles="[Role.PoolWrite]"
      type="submit"
      mat-button
      ixTest="disconnect"
      [color]="isDeleteSelected ? 'warn' : 'primary'"
      [disabled]="!canProceed()"
    >
      {{ 'Disconnect' | translate }}
    </button>
  </ix-form-actions>
</form>
