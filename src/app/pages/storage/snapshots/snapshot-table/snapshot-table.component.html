<entity-empty *ngIf="isLoading$ | async; else loaded" [conf]="loadingConfig"></entity-empty>

<ng-template #loaded>
  <div *ngIf="selection.selected.length" class="batch-actions-toolbar">
    <div class="title">
      <strong>{{ 'Batch Operations' | translate }}</strong>
    </div>

    <div class="actions">
      <button
        mat-button
        (click)="doMultiDelete(this.selection.selected);"
        [matTooltip]="'Delete selections' | translate"
        matTooltipPosition="below"
      >
        <mat-icon>delete</mat-icon>
        {{ 'Delete' | translate }}
      </button>
    </div>

    <div *ngIf="selection.selected.length !== dataSource.data.length" class="select-all" fxLayout="row" fxLayoutAlign="start center" fxLayoutGap="8px">
      <span>{{ 'All {n} snapshots on this page are selected.' | translate: { n: selection.selected.length } }}</span>
      <button mat-stroked-button (click)="selectAll()">{{ 'Select all {n} snapshots' | translate: { n: dataSource.data.length } }} </button>
    </div>
  </div>

  <table
    ix-table
    [dataSource]="dataSource"
    matSort
    matSortDisableClear="true"
    [matSortActive]="defaultSort.active"
    [matSortDirection]="defaultSort.direction"
    [multiTemplateDataRows]="true"
    [fixedLayout]="true"
  >
    <ix-checkbox-column [selection]="selection" [dataSource]="dataSource"></ix-checkbox-column>

    <ng-container matColumnDef="dataset">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> {{ 'Dataset' | translate }} </th>
      <td mat-cell *matCellDef="let snapshot; dataSource: dataSource" [matTooltip]="snapshot.dataset">{{ snapshot.dataset }}</td>
    </ng-container>

    <ng-container matColumnDef="snapshot">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> {{ 'Snapshot' | translate }} </th>
      <td mat-cell *matCellDef="let snapshot; dataSource: dataSource" [matTooltip]="snapshot.snapshot">{{ snapshot.snapshot }}</td>
    </ng-container>

    <ng-container matColumnDef="used">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> {{ 'Used' | translate }} </th>
      <td mat-cell *matCellDef="let snapshot; dataSource: dataSource">{{
        snapshot?.used ? (snapshot.used | convertBytestoHumanReadable) : ('N/A' | translate)
      }}</td>
    </ng-container>

    <ng-container matColumnDef="created">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> {{ 'Date created' | translate }} </th>
      <td mat-cell *matCellDef="let snapshot; dataSource: dataSource">{{
        snapshot?.created ? (snapshot.created | formatDateTime) : ('N/A' | translate)
      }}</td>
    </ng-container>

    <ng-container matColumnDef="referenced">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> {{ 'Referenced' | translate }} </th>
      <td mat-cell *matCellDef="let snapshot; dataSource: dataSource">{{
        snapshot?.referenced ? (snapshot?.referenced | convertBytestoHumanReadable) : ('N/A' | translate)
      }}</td>
    </ng-container>

    <ng-container *ngIf="showExtraColumns$ | async; else expandRowButton" matColumnDef="actions">
      <th mat-header-cell *matHeaderCellDef></th>
      <td mat-cell *matCellDef="let snapshot; dataSource: dataSource">
        <button
          [title]="'Settings' | translate"
          mat-icon-button
          [matMenuTriggerFor]="actionsMenu"
        >
          <mat-icon>more_vert</mat-icon>
        </button>
        <mat-menu #actionsMenu="matMenu">
          <a mat-menu-item (click)="doDelete(snapshot)">{{ 'Delete' | translate }}</a>
          <a mat-menu-item (click)="doClone(snapshot)">{{ 'Clone To New Dataset' | translate }}</a>
          <a mat-menu-item (click)="doRollback(snapshot)">{{ 'Rollback' | translate }}</a>
        </mat-menu>
      </td>
    </ng-container>

    <ng-template #expandRowButton>
      <ix-expand-toggle-column [expandedRow]="expandedRow" (toggle)="expandRow($event)"></ix-expand-toggle-column>

      <app-snapshot-details
        [expandedRow]="expandedRow"
        [dataSource]="dataSource"
        [colspan]="displayedColumns.length"
        (actionPressed)="onAction($event)"
      ></app-snapshot-details>
    </ng-template>

    <tr class="mat-row mat-no-data-row" *matNoDataRow>
      <td class="mat-cell" [attr.colspan]="displayedColumns.length">
        <entity-empty *ngIf="isEmpty$ | async" [conf]="emptyConfig"></entity-empty>
        <entity-empty *ngIf="error$ | async" [conf]="errorConfig"></entity-empty>
      </td>
    </tr>

    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let element; columns: displayedColumns;" class="element-row"></tr>
  </table>

  <ix-table-paginator [dataSource]="dataSource" [pageSize]="10"></ix-table-paginator>
</ng-template>
