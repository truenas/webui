<mat-card class="card">
  <mat-card-header>
    <h3 mat-card-title>
      {{ 'Application Info' | translate }}
    </h3>
    <div class="actions">
      <button
        id="edit-app"
        mat-button
        [ixTest]="[app().name, 'edit']"
        [disabled]="isExternalApp()"
        [matTooltip]="isExternalApp() ? ('Manage by deployment tool' | translate) : ''"
        (click)="editButtonPressed()"
      >
        {{ 'Edit' | translate }}
      </button>

      <button
        mat-icon-button
        ixTest="app-info-menu"
        [matMenuTriggerFor]="appInfoMenu"
        [matTooltip]="'More Options' | translate"
        [attr.aria-label]="'More Options' | translate"
      >
        <ix-icon name="more_vert"></ix-icon>
      </button>
      <mat-menu #appInfoMenu="matMenu">
        <button
          *ixRequiresRoles="requiredRoles"
          mat-menu-item
          [ixTest]="[app().name, 'update']"
          [disabled]="!app().upgrade_available || isExternalApp()"
          [matTooltip]="isExternalApp() ? ('Manage by deployment tool' | translate) : ''"
          (click)="updateButtonPressed()"
        >
          {{ 'Update' | translate }}
        </button>
        <button
          *ixRequiresRoles="requiredRoles"
          mat-menu-item
          [ixTest]="[app().name, 'convert']"
          [disabled]="app().custom_app || isExternalApp()"
          [matTooltip]="isExternalApp() ? ('Manage by deployment tool' | translate) : ''"
          (click)="openConvertDialog()"
        >{{ 'Convert to custom app' | translate}}</button>
      </mat-menu>
    </div>
  </mat-card-header>
  <mat-card-content>
    <div class="info-container">
      <a class="app-logo" [ixTest]="[app().name, 'image-details']" [routerLink]="appDetailsRouterUrl()">
        <img [src]="app().metadata.icon" [src-fallback]="imagePlaceholder" />
      </a>
      <div class="details-list">
        <div class="details-item">
          <div class="label">{{ 'Name' | translate }}:</div>
          @if (app().custom_app) {
            <span class="value">{{ name() | orNotAvailable }}</span>
          } @else {
            <a class="value" [ixTest]="[app().name, 'name-details']" [routerLink]="appDetailsRouterUrl()">
              {{ name() | orNotAvailable }}
            </a>
          }
        </div>
        @if (isExternalApp()) {
          <div class="details-item">
            <div class="label">{{ 'Deployment' | translate }}:</div>
            <div class="value">
              {{ 'Deployed via External Tool' | translate }}
            </div>
          </div>
        } @else {
          <div class="details-item">
            <div class="label">{{ 'App Version' | translate }}:</div>
            <div class="value">
              {{ app().metadata.app_version | orNotAvailable }}
            </div>
          </div>
          <div class="details-item">
            <div class="label">{{ 'Version' | translate }}:</div>
            <div class="value">
              {{ app().version | orNotAvailable }}
            </div>
          </div>
        }
        @if (!isExternalApp()) {
          <div class="details-item sources">
            <div class="label">{{ 'Source' | translate }}:</div>
            <div class="value">
              <div>
                @for (source of app().metadata.sources; track source; let last = $last) {
                  <a
                    class="source-link"
                    target="_blank"
                    [href]="source"
                    [title]="source"
                    [ixTest]="[app().name, 'source']"
                  >{{ source | cleanLink }}</a>
                  @if (!last) {
                    <span>, </span>
                  }
                } @empty {
                  {{ 'N/A' | translate }}
                }
              </div>
          </div>
          </div>

          <div class="details-item">
            <div class="label">{{ 'Train' | translate }}:</div>
            <div class="value">
              {{ app().metadata.train | orNotAvailable }}
            </div>
          </div>
        }
        @if (sortedPortals().length > 0) {
          <div class="portals" [class.has-many]="sortedPortals().length > 1">
            @for (portal of sortedPortals(); track portal.label) {
              <button
                mat-button
                class="portal-button"
                [ixTest]="['portal', app().name, portal.label]"
                [matTooltip]="portal.url"
                (click)="openPortalLink(app(), portal.label)"
              >
                {{ portal.label }}
              </button>
            }
          </div>
        }
      </div>
    </div>
  </mat-card-content>

  @if (app()) {
    <mat-card-actions>
      <div class="cell cell-action cell-status-actions">
        <ng-container *ixRequiresRoles="requiredRoles">
          @if (isAppStopped()) {
            <button
              mat-button
              matTooltipPosition="above"
              [ixTest]="[app().name, 'start']"
              [matTooltip]="isExternalApp() ? ('Manage by deployment tool' | translate) : ('Start' | translate)"
              [disabled]="inProgress() || isExternalApp()"
              (click)="startApp.emit(); $event.stopPropagation()"
            >
              <ix-icon name="mdi-play-circle"></ix-icon> {{ 'Start' | translate }}
            </button>
          }
        </ng-container>
        <ng-container *ixRequiresRoles="requiredRoles">
          @if (!isAppStopped()) {
            <button
              mat-button
              matTooltipPosition="above"
              [ixTest]="[app().name, 'stop']"
              [matTooltip]="isExternalApp() ? ('Manage by deployment tool' | translate) : ('Stop' | translate)"
              [disabled]="inProgress() || isExternalApp()"
              (click)="stopApp.emit(); $event.stopPropagation()"
            >
              <ix-icon name="mdi-stop-circle"></ix-icon> {{ 'Stop' | translate }}
            </button>
          }
        </ng-container>
      </div>

      @if (isRollbackPossible() && !isExternalApp()) {
        <button
          *ixRequiresRoles="requiredRoles"
          mat-button
          [ixTest]="[app().name, 'rollback']"
          (click)="rollbackApp()"
        >
          {{ 'Roll Back' | translate }}
        </button>
      }

      <button
        *ixRequiresRoles="requiredRoles"
        mat-button
        [ixTest]="[app().name, 'delete']"
        [disabled]="isExternalApp()"
        [matTooltip]="isExternalApp() ? ('Manage by deployment tool' | translate) : ''"
        (click)="deleteButtonPressed()"
      >
        {{ 'Delete' | translate }}
      </button>
    </mat-card-actions>
  }
</mat-card>
