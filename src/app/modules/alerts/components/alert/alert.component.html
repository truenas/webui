<div [class]="['alert-icon', alertLevelColor]">
  <ix-icon
    class="alert-icon"
    [name]="icon"
    [matTooltip]="iconTooltip"
  ></ix-icon>
</div>

<div class="alert-body">
  @if (!alert().dismissed) {
    <h3 [class]="['alert-level', alertLevelColor]">
      {{ levelLabel() }}
    </h3>
  }
  <h4
    #alertMessage
    class="alert-message"
    [class.collapsed]="isCollapsed()"
    [innerHTML]="alert().formatted"
  ></h4>
  @if (isExpandable()) {
    <button
      mat-button
      class="expand-collapse-button"
      [ixTest]="[alert().key, 'expand']"
      [class.collapsed]="isCollapsed()"
      (click)="toggleCollapse()"
    >
      {{ isCollapsed() ? ('View More' | translate) : ('Collapse' | translate) }}
    </button>
  }
  @if (isHaLicensed()) {
    <div class="alert-node">{{ alert().node }}</div>
  }
  <div class="alert-time">
    {{ alert().datetime.$date | formatDateTime }}
    @if (timezone$ | async; as timezone) {
      ({{ timezone }})
    }
  </div>

  @let enhanced = enhancedAlert();
  @if (enhanced.contextualHelp && !alert().dismissed) {
    <div class="context-help">
      <button
        mat-button
        class="context-help-toggle"
        [ixTest]="[alert().key, 'toggle-help']"
        (click)="toggleContextHelp()"
      >
        <ix-icon [name]="showContextHelp() ? 'mdi-chevron-up' : 'mdi-chevron-down'"></ix-icon>
        {{ showContextHelp() ? ('Hide Details' | translate) : ('Why am I seeing this?' | translate) }}
      </button>
      @if (showContextHelp()) {
        <div class="context-help-content">
          <p>{{ enhanced.contextualHelp }}</p>
          @if (enhanced.documentationUrl) {
            <a
              class="action-link"
              target="_blank"
              rel="noopener noreferrer"
              [href]="enhanced.documentationUrl"
            >
              {{ 'Learn More' | translate }}
              <ix-icon name="mdi-open-in-new"></ix-icon>
            </a>
          }
        </div>
      }
    </div>
  }

  @if (enhanced.actions && enhanced.actions.length > 0 && !alert().dismissed && showActions()) {
    <div class="smart-actions">
      @for (action of enhanced.actions; track action.label) {
        <button
          mat-button
          [class.primary-action]="action.primary"
          [ixTest]="[alert().key, 'action', action.label]"
          (click)="onSmartActionClick(action.handler)"
        >
          <ix-icon [name]="action.icon"></ix-icon>
          {{ action.label | translate }}
        </button>
      }
    </div>
  }

  <div class="links">
    @if (alert().dismissed) {
      <a
        *ixRequiresRoles="requiredRoles"
        tabindex="0"
        role="button"
        class="action-link"
        [ixTest]="[alert().key, 'reopen']"
        (click)="onReopen()"
      >
        {{ 'Re-Open' | translate }}
      </a>
    } @else {
      <a
        *ixRequiresRoles="requiredRoles"
        tabindex="0"
        role="button"
        class="action-link"
        [ixTest]="[alert().key, 'dismiss']"
        (click)="onDismiss()"
      >
        {{ 'Dismiss' | translate }}
      </a>
    }

    @let linkLabel = link()?.label;
    @let hasSmartEnhancement = enhanced.category || (enhanced.actions && enhanced.actions.length > 0);
    @if (linkLabel && !hasSmartEnhancement) {
      <a
        [ixTest]="[alert().key, 'open-link']"
        (click)="openLink()"
      >
        {{ linkLabel | translate }}
      </a>
    }
  </div>
</div>
