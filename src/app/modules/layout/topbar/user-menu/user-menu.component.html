@if ((loggedInUser$ | async); as user) {
  <div class="user-menu-wrapper">
    <button
      name="Settings"
      mat-icon-button
      class="topbar-button-right"
      ixTest="user-menu"
      [matTooltip]="tooltips.settings | translate"
      [ixUiSearch]="searchableElements.elements.userMenu"
      [matMenuTriggerFor]="userMenu"
    >
      @if (user.pw_name) {
        <span
          class="username"
          [matTooltip]="user.pw_name"
          [matMenuTriggerFor]="userMenu"
        >
          {{ user.pw_name }}
        </span>
      }
      <tn-icon size="lg" name="account-circle" library="mdi"></tn-icon>
    </button>

    <mat-menu #userMenu="matMenu">
      @if (user.account_attributes?.includes(AccountAttribute.Local)) {
        <button
          name="settings-change-password"
          mat-menu-item
          ixTest="change-password"
          [ixUiSearch]="searchableElements.elements.changePassword"
          (click)="openChangePasswordDialog()"
        >
          <tn-icon size="lg" name="dialpad" library="mdi"></tn-icon>
          {{ 'Change Password' | translate }}
        </button>
      }

      @if (isTwoFactorEnabledGlobally$ | async) {
        <button
          name="settings-2fa"
          mat-menu-item
          ixTest="2fa"
          (click)="onTwoFactorAuth()"
        >
          <tn-icon size="lg" name="tn-two-factor-auth"></tn-icon>
          {{ 'Two-Factor Authentication' | translate }}
        </button>
      }

      <a
        name="settings-api"
        ixTest="api-keys"
        mat-menu-item
        [routerLink]="['/credentials/users/api-keys']"
        [queryParams]="{ userName: user.pw_name }"
        [ixUiSearch]="searchableElements.elements.myApiKeys"
      >
        <tn-icon size="lg" name="laptop" library="mdi"></tn-icon>
        {{ 'My API Keys' | translate }}
      </a>

      <a
        name="settings-guide"
        mat-menu-item
        href="https://www.truenas.com/docs/"
        target="_blank"
        ixTest="guide"
        [ixUiSearch]="searchableElements.elements.guide"
      >
        <tn-icon size="lg" name="book-multiple" library="mdi"></tn-icon>
        {{ 'Guide' | translate }}
      </a>

      <!-- Inline styles because mat-menu contents are rendered outside of the component -->
      <mat-divider style="margin: 5px 0;"></mat-divider>

      <button
        name="power-log-out"
        mat-menu-item
        ixTest="log-out"
        [ixUiSearch]="searchableElements.elements.logOut"
        (click)="onSignOut()"
      >
        <tn-icon size="lg" name="logout" library="mdi"></tn-icon>
        {{ 'Log Out' | translate }}
      </button>
    </mat-menu>
  </div>
}
