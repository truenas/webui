<div
  class="job-item"
  [class.abortable]="job().state === JobState.Running && job().abortable"
  [class.interactive]="clickable()"
  [matTooltip]="job().state === JobState.Failed ? job().error : null"
  [matTooltipPosition]="'left'"
>
  <div class="job-item-body" (click)="clickable() && open()">
    <div class="description-line">
      <span class="job-description">
        {{ job().description ? job().description : job().method }}
      </span>
      @if (job().state === JobState.Running) {
        <small class="job-progress-percent">
          {{ job().progress.percent || 0 | number: '1.2-2' }}%
        </small>
      }
    </div>

    @if (job().state === JobState.Running) {
      <mat-progress-bar
        class="job-progress"
        [value]="job().progress.percent"
        [mode]="job().progress.percent ? 'determinate' : 'indeterminate'"
      ></mat-progress-bar>
    }

    <div>
      @switch (job().state) {
        @case (JobState.Running) {
          @if (job().progress.description) {
            <div class="job-progress-description">
              {{ job().progress.description }}
            </div>
          }
          @if (!job().progress.description) {
            <div class="job-time">
              {{ job().state | jobStateDisplay }}:
              <strong>
                {{ job().time_started?.$date ? (job().time_started.$date | formatDateTime) : '–' }}
              </strong>
            </div>
          }
        }
        @case (JobState.Waiting) {
          <div class="job-time">
            {{ job().state | jobStateDisplay }}:
            <strong>
              {{ job().time_started?.$date ? (job().time_started.$date | formatDateTime) : '–' }}
            </strong>
          </div>
        }
        @case (JobState.Success) {
           <div class="job-time">
              {{ job().state | jobStateDisplay }}:
              <strong>
                {{ job().time_finished?.$date ? (job().time_finished.$date | formatDateTime) : '–' }}
              </strong>
            </div>
        }
        @case (JobState.Failed) {
          <div class="job-time">
            {{ job().state | jobStateDisplay }}:
            <strong>
              @let timeFinished = job().time_finished?.$date;
              {{ timeFinished ? (timeFinished | formatDateTime) : '–' }}
            </strong>
          </div>
        }
        @case (JobState.Aborted) {
          <div class="job-time">
            {{ job().state | jobStateDisplay }}:
            <strong>
              @let timeFinished = job().time_finished?.$date;
              {{ timeFinished ? (timeFinished | formatDateTime) : '–' }}
            </strong>
          </div>
        }
      }
    </div>

    @if (job().credentials; as credentials) {
      <div>
        <div class="job-credentials">
          {{
          'Created by: {creationSource} ({creationType})' | translate: {
          creationSource: getCredentialsCreationSource(credentials),
          creationType: (credentials.type | mapValue: credentialTypeLabels | translate)
        }
        }}
      </div>
    </div>
  }
</div>

@if (job().state === JobState.Running && job().abortable) {
  <tn-icon-button
    class="job-button-abort"
    type="button"
    name="stop-circle"
    library="mdi"
    [class.job-icon-abort]="true"
    [ixTest]="['abort', job().description, job().method]"
    [matTooltip]="'Abort' | translate"
    (click)="abort()"
  ></tn-icon-button>
}

@if (job().state === JobState.Waiting) {
  <tn-icon-button
    type="button"
    name="clock-outline"
    library="mdi"
    [class.job-icon-waiting]="true"
    [ixTest]="['waiting', job().description, job().method]"
    [disabled]="true"
  ></tn-icon-button>
}

@if (job().state === JobState.Failed) {
  <tn-icon-button
    type="button"
    name="close-circle"
    library="mdi"
    matTooltipPosition="left"
    [class.job-icon-failed]="true"
    [ixTest]="['failed', job().description, job().method]"
    [matTooltip]="job().error"
    [disabled]="true"
  ></tn-icon-button>
}

@if (job().state === JobState.Success) {
  <tn-icon-button
    type="button"
    name="check-circle"
    library="mdi"
    [class.job-icon-success]="true"
    [ixTest]="['success', job().description, job().method]"
    [disabled]="true"
  ></tn-icon-button>
}
</div>
